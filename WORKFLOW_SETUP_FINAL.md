# ‚úÖ Workflow "RentProg Cars Snapshot" - –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

**–î–∞—Ç–∞:** 2025-11-03  
**Workflow ID:** j7UEBJvTzjhHrzR4  
**–°—Ç–∞—Ç—É—Å:** –ù–µ–∞–∫—Ç–∏–≤–µ–Ω (manual trigger)

---

## üéØ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –û–±–Ω–æ–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ MCP
‚úÖ –ù–æ–¥–∞ **"Prepare Branches"** - –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ä–µ–∞–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã —Ñ–∏–ª–∏–∞–ª–æ–≤:
- `tbilisi`: 91b83b93963633649f29a04b612bab3f9fbb0471b5928622
- `batumi`: 7ad345720f8d92f10c187122427c6a2c2bb9494c6bf14e8d
- `kutaisi`: 5599ebb7b94827fdfd49ca3a5b7e259cfa99d8ea78edeb50
- `service-center`: 5y4j4gcs75o9n5s1e2vrxx4a

‚úÖ –ù–æ–¥–∞ **"Fetch Cars Page"** - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
- URL: `https://rentprog.net/api/v1/public/all_cars_full?limit=20&page={{ $json.page }}`
- Authentication: `none`
- Headers: `Authorization: Bearer {{ $json.token }}`
- Timeout: 15 —Å–µ–∫—É–Ω–¥

### 2. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
‚úÖ –°–æ–∑–¥–∞–Ω–∞ –±–∞–∑–æ–≤–∞—è —Å—Ö–µ–º–∞ –ë–î (–≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã)
‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `data` (JSONB) –≤ —Ç–∞–±–ª–∏—Ü—É `cars`
‚úÖ –ó–∞–ø–æ–ª–Ω–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `branches` (4 —Ñ–∏–ª–∏–∞–ª–∞)

---

## ‚öôÔ∏è –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤—Ä—É—á–Ω—É—é

### 1. –í—ã–±—Ä–∞—Ç—å PostgreSQL credential

–û—Ç–∫—Ä–æ–π—Ç–µ workflow –≤ n8n UI:
https://n8n.rentflow.rentals/workflow/j7UEBJvTzjhHrzR4

**–î–ª—è –Ω–æ–¥—ã "Upsert Cars to PostgreSQL":**
1. –û—Ç–∫—Ä–æ–π—Ç–µ –Ω–æ–¥—É
2. –í –ø–æ–ª–µ **"Credential to connect with"** –Ω–∞–∂–º–∏—Ç–µ "Select Credential"
3. –í—ã–±–µ—Ä–∏—Ç–µ **"Postgres account"** (Neon PostgreSQL)
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ

**–î–ª—è –Ω–æ–¥—ã "Upsert External Refs":**
1. –û—Ç–∫—Ä–æ–π—Ç–µ –Ω–æ–¥—É
2. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —à–∞–≥–∏ –≤—ã—à–µ
3. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ

### 2. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å workflow
–ù–∞–∂–º–∏—Ç–µ **"Save"** –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É.

---

## üöÄ –ó–∞–ø—É—Å–∫ workflow

### –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫
1. –û—Ç–∫—Ä–æ–π—Ç–µ workflow
2. –ù–∞–∂–º–∏—Ç–µ **"Execute workflow"**
3. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏ –≤ –∫–∞–∂–¥–æ–π –Ω–æ–¥–µ

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
```
‚úì –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ —Ñ–∏–ª–∏–∞–ª–æ–≤: 4
‚úì –ü–æ–ª—É—á–µ–Ω —Ç–æ–∫–µ–Ω –¥–ª—è —Ñ–∏–ª–∏–∞–ª–∞: tbilisi
üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ 1: –ø–æ–ª—É—á–µ–Ω–æ 20 –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ 2: –ø–æ–ª—É—á–µ–Ω–æ 20 –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
...
‚úì –ó–∞–≤–µ—Ä—à–µ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è —Ñ–∏–ª–∏–∞–ª–∞ tbilisi: –≤—Å–µ–≥–æ 156 –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
üîÑ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ 156 –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –¥–ª—è upsert (—Ñ–∏–ª–∏–∞–ª: tbilisi)
‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∏–ª–∏–∞–ª–∞: tbilisi
   üìä –í—Å—Ç–∞–≤–ª–µ–Ω–æ/–æ–±–Ω–æ–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π: 156
...
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üéâ –ò–ú–ü–û–†–¢ –ó–ê–í–ï–†–®–ï–ù
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìä –í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ñ–∏–ª–∏–∞–ª–æ–≤: 4
üöó –í—Å–µ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π: 624
...
```

---

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### SQL –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

```sql
-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º
SELECT 
  b.code AS branch,
  COUNT(c.id) AS cars_count
FROM cars c
LEFT JOIN branches b ON c.branch_id = b.id
GROUP BY b.code
ORDER BY b.code;

-- –ü—Ä–∏–º–µ—Ä –∑–∞–ø–∏—Å–µ–π –≤ cars
SELECT 
  c.id,
  c.plate,
  c.model,
  c.vin,
  b.code AS branch,
  c.data->>'id' AS rentprog_id,
  c.created_at
FROM cars c
LEFT JOIN branches b ON c.branch_id = b.id
LIMIT 10;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ external_refs
SELECT 
  er.system,
  er.entity_type,
  er.external_id,
  er.branch_code,
  c.plate,
  c.model
FROM external_refs er
LEFT JOIN cars c ON er.entity_id = c.id
WHERE er.system = 'rentprog'
  AND er.entity_type = 'car'
LIMIT 10;
```

---

## üîß Troubleshooting

### –û—à–∏–±–∫–∞: "Credential to connect with is required"
- **–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ –≤—ã–±—Ä–∞–Ω PostgreSQL credential
- **–†–µ—à–µ–Ω–∏–µ:** –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –≤ —Ä–∞–∑–¥–µ–ª–µ "–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤—Ä—É—á–Ω—É—é"

### –û—à–∏–±–∫–∞: "401 Unauthorized" –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞
- **–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–≤–µ—Ä–Ω—ã–π company token
- **–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω—ã –≤ –Ω–æ–¥–µ "Prepare Branches"

### –û—à–∏–±–∫–∞: "relation 'cars' does not exist"
- **–ü—Ä–∏—á–∏–Ω–∞:** –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Å–æ–∑–¥–∞–Ω–∞
- **–†–µ—à–µ–Ω–∏–µ:** –£–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ - –±–∞–∑–∞ —Å–æ–∑–¥–∞–Ω–∞ —á–µ—Ä–µ–∑ `create_base_schema.mjs`

### –û—à–∏–±–∫–∞: "429 Too Many Requests"
- **–ü—Ä–∏—á–∏–Ω–∞:** –ü—Ä–µ–≤—ã—à–µ–Ω rate limit RentProg API (60 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É)
- **–†–µ—à–µ–Ω–∏–µ:** Workflow –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–¥–µ—Ä–∂–∫—É 1 —Å–µ–∫—É–Ω–¥—É –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏

---

## üìÅ –§–∞–π–ª—ã

- **Workflow JSON:** `n8n-workflows/rentprog-cars-snapshot-updated.json`
- **–ú–∏–≥—Ä–∞—Ü–∏—è:** `setup/migrations/001_add_cars_data_field.sql`
- **–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º—ã:** `setup/create_base_schema.mjs`
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** `docs/RENTPROG_CARS_SNAPSHOT_GUIDE.md`

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [x] Workflow –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ n8n
- [x] –¢–æ–∫–µ–Ω—ã —Ñ–∏–ª–∏–∞–ª–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω—ã
- [x] –ù–æ–¥–∞ "Fetch Cars Page" –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
- [x] –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞
- [x] –ú–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
- [x] –¢–∞–±–ª–∏—Ü–∞ `branches` –∑–∞–ø–æ–ª–Ω–µ–Ω–∞
- [ ] PostgreSQL credentials –≤—ã–±—Ä–∞–Ω—ã (–≤—Ä—É—á–Ω—É—é)
- [ ] Workflow —Å–æ—Ö—Ä–∞–Ω–µ–Ω (–≤—Ä—É—á–Ω—É—é)
- [ ] –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω (–≤—Ä—É—á–Ω—É—é)

---

**–ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üéâ

