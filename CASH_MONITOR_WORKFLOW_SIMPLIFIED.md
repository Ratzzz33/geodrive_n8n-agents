# ‚úÖ Workflow "Company Cash Monitor" —É–ø—Ä–æ—â—ë–Ω

**–î–∞—Ç–∞:** 2025-11-08  
**Workflow ID:** `w8g8cJb0ccReaqIE`  
**URL:** https://n8n.rentflow.rentals/workflow/w8g8cJb0ccReaqIE

---

## üéØ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

–£–¥–∞–ª–µ–Ω—ã –ª–∏—à–Ω–∏–µ –Ω–æ–¥—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω—ã, —Ç–∞–∫ –∫–∞–∫ –¥–∞–Ω–Ω—ã–µ –≤—Å–µ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥—è—Ç –æ—Ç API.

---

## ‚ùå –£–¥–∞–ª—ë–Ω–Ω—ã–µ –Ω–æ–¥—ã

### 1. **Switch** (`switch-data`)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è `payment_id` (–æ—Ç–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç "–ø—É—Å—Ç—ã—Ö" –æ—Ç–≤–µ—Ç–æ–≤)
- **–ü–æ—á–µ–º—É —É–¥–∞–ª–µ–Ω–∞:** –í—Å–µ–≥–¥–∞ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ, –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –Ω—É–∂–Ω–∞

### 2. **No Data** (`no-data`)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** NoOp –Ω–æ–¥–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–ª—É—á–∞–µ–≤ –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö
- **–ü–æ—á–µ–º—É —É–¥–∞–ª–µ–Ω–∞:** –ë–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è Switch

---

## ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –∫–æ–¥ –≤ "Merge & Process"

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

```javascript
// –ë–´–õ–û: —Å–æ–∑–¥–∞–≤–∞–ª item —Å status: 'no_data' –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ payments
if (payments.length === 0) {
  console.log('‚ö†Ô∏è  No payments found, marking as no_data');
  processed.push({ json: { branch: branchName, status: 'no_data' } });
  return;
}

// –°–¢–ê–õ–û: –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Ñ–∏–ª–∏–∞–ª –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ payments
if (payments.length === 0) {
  console.log('‚ö†Ô∏è  No payments found for this branch, skipping');
  return;
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–µ–ø–µ—Ä—å –∫–æ–¥ —Ç–æ–ª—å–∫–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç payments, –Ω–µ —Å–æ–∑–¥–∞–≤–∞—è "–ø—É—Å—Ç—ã—Ö" –∑–∞–ø–∏—Å–µ–π —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º.

---

## üîß –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤—Ä—É—á–Ω—É—é

### ‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å connection –≤ UI

–ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è Switch –Ω–æ–¥—ã –ø—Ä–æ–ø–∞–ª–∞ —Å–≤—è–∑—å –º–µ–∂–¥—É `Merge & Process` ‚Üí `Split In Batches`.

**–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:**

1. –û—Ç–∫—Ä—ã—Ç—å workflow: https://n8n.rentflow.rentals/workflow/w8g8cJb0ccReaqIE
2. –ù–∞–π—Ç–∏ –Ω–æ–¥—É **"Merge & Process"**
3. –ü–æ—Ç—è–Ω—É—Ç—å connection –æ—Ç –≤—ã—Ö–æ–¥–∞ –Ω–æ–¥—ã **"Merge & Process"** ‚Üí –∫ –Ω–æ–¥–µ **"Split In Batches"**
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å workflow

**–í–∏–∑—É–∞–ª—å–Ω–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:**

```
Merge & Process ‚Üí Split In Batches ‚Üí Save Payment to DB ‚Üí Pass Through Data
                                   ‚Üì
                                Format Result ‚Üí If Error ‚Üí Success/Send Error Alert
```

---

## üìä –¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ workflow

### –ü–æ–ª–Ω—ã–π –ø–æ—Ç–æ–∫:

```
Every 3 Minutes (Schedule)
    ‚Üì
[Parallel execution]
    ‚îú‚Üí Tbilisi Pages ‚Üí Get Tbilisi ‚îÄ‚îÄ‚îê
    ‚îú‚Üí Batumi Pages ‚Üí Get Batumi ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
    ‚îú‚Üí Kutaisi Pages ‚Üí Get Kutaisi ‚îÄ‚îÄ‚î§
    ‚îî‚Üí Service Pages ‚Üí Get Service ‚îÄ‚îÄ‚îò
                ‚Üì
        Merge & Process
                ‚Üì
    [–ù–£–ñ–ù–û –î–û–ë–ê–í–ò–¢–¨ CONNECTION!]
                ‚Üì
        Split In Batches (batch_size=20)
        ‚Üì                   ‚Üì
  Save Payment to DB   Format Result
        ‚Üì                   ‚Üì
  Pass Through Data    If Error
        ‚Üì                   ‚Üì
  [Loop back to      Success / Send Error Alert
   Split In Batches]
```

---

## üîç –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏

### 1. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (4 —Ñ–∏–ª–∏–∞–ª–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)
```javascript
GET https://rentprog.net/api/v1/company_counts_v2?start_date=YYYY-MM-DD&end_date=YYYY-MM-DD
Headers: Authorization: Bearer <token>
```

### 2. Merge & Process
- –°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ –æ—Ç–≤–µ—Ç—ã –æ—Ç 4 —Ñ–∏–ª–∏–∞–ª–æ–≤
- –ü–∞—Ä—Å–∏—Ç —Ä–∞–∑–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç–≤–µ—Ç–∞:
  - `counts.data[]`
  - `counts[]`
  - `data[]`
  - direct `[]`
- –ï—Å–ª–∏ payments –Ω–∞–π–¥–µ–Ω—ã ‚Üí –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
- –ï—Å–ª–∏ payments –ù–ï–¢ ‚Üí **–ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Ñ–∏–ª–∏–∞–ª** (–Ω–æ–≤–∞—è –ª–æ–≥–∏–∫–∞!)

### 3. Split In Batches (20 payments –∑–∞ —Ä–∞–∑)
- –†–∞–∑–±–∏–≤–∞–µ—Ç –Ω–∞ –±–∞—Ç—á–∏ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- –ö–∞–∂–¥—ã–π –±–∞—Ç—á ‚Üí Save Payment to DB

### 4. Save Payment to DB
```sql
INSERT INTO payments (...) VALUES (...)
ON CONFLICT (branch, payment_id) 
DO UPDATE SET ...
```

### 5. Format Result
- –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º
- –§–æ—Ä–º–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ:
  ```
  üí∞ COMPANY CASH
  TBILISI: 15 ‚úì
  BATUMI: 8 ‚úì
  KUTAISI: 12 ‚úì
  SERVICE-CENTER: 5 ‚úì
  
  –í—Å–µ–≥–æ: 40 / 40
  ```

### 6. If Error ‚Üí Send Error Alert
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `success === false`
- –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ Telegram

---

## üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å | –î–æ | –ü–æ—Å–ª–µ | –ò–∑–º–µ–Ω–µ–Ω–∏–µ |
|------------|-----|--------|-----------|
| –í—Å–µ–≥–æ –Ω–æ–¥ | 19 | 17 | -2 (Switch, No Data) |
| Connections | ~25 | ~23 | -2 |
| –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö | 2 —É—Ä–æ–≤–Ω—è (Switch + No Data) | 0 —É—Ä–æ–≤–Ω–µ–π | –£–ø—Ä–æ—â–µ–Ω–æ |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Å—Ç—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ | –°–æ–∑–¥–∞–≤–∞–ª `{status: 'no_data'}` | –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Ñ–∏–ª–∏–∞–ª | –ß–∏—â–µ |

---

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

1. **–ú–µ–Ω—å—à–µ –Ω–æ–¥** ‚Üí –ø—Ä–æ—â–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å
2. **–ß–∏—â–µ –ª–æ–≥–∏–∫–∞** ‚Üí –Ω–µ—Ç –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
3. **–ë—ã—Å—Ç—Ä–µ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ** ‚Üí –º–µ–Ω—å—à–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö –Ω–æ–¥
4. **–ù–µ—Ç "–º—É—Å–æ—Ä–Ω—ã—Ö" –¥–∞–Ω–Ω—ã—Ö** ‚Üí –Ω–µ —Å–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å–∏ —Å `status: 'no_data'`

---

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è connection:

1. **–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é** (Test Workflow)
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏** "Merge & Process":
   ```
   === TBILISI ===
   Items received: 1
   Found counts.data: 15
   ‚úì Processing 15 payments
   ```
3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å "Format Result"**:
   ```
   üí∞ COMPANY CASH
   TBILISI: 15 ‚úì
   ...
   ```
4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î**:
   ```sql
   SELECT branch, COUNT(*) 
   FROM payments 
   WHERE created_at > NOW() - INTERVAL '1 hour'
   GROUP BY branch;
   ```

---

## üìù –ò—Ç–æ–≥

**Workflow —É–ø—Ä–æ—â—ë–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!**

**‚ö†Ô∏è –ù–ï –ó–ê–ë–£–î–¨:** –î–æ–±–∞–≤–∏—Ç—å connection `Merge & Process` ‚Üí `Split In Batches` –≤ UI!

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ workflow –º–æ–∂–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å: –æ–Ω –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∫–∞—Å—Å—ã –∫–∞–∂–¥—ã–µ 3 –º–∏–Ω—É—Ç—ã –∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –ë–î.

---

**–°–æ–∑–¥–∞–Ω–æ:** 2025-11-08 12:09 UTC  
**–ê–≤—Ç–æ—Ä:** Cursor Agent

