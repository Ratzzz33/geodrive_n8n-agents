# Upsert Processor - Ð¡Ñ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ 3 Ð²ÐµÑ€ÑÐ¸Ð¹

**Ð”Ð°Ñ‚Ð°:** 2025-01-16  
**Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:** âœ… Ð’ÑÐµ Ð²ÐµÑ€ÑÐ¸Ð¸ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹ Ðº Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÑŽ

---

## ðŸ“Š Ð¡Ñ€Ð°Ð²Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð°

| Ð¥Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð¸ÑÑ‚Ð¸ÐºÐ° | Sequential | Parallel | Cached |
|----------------|------------|----------|--------|
| **Webhook URL** | `/upsert-processor` | `/upsert-processor-parallel` | `/upsert-processor-cached` |
| **n8n ID** | `tx0QQ0soDfPzQuUp` | `iM41CzhGqyaMl5AL` | `W1H6oc4RlS0BJYir` |
| **ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð½Ð¾Ð´** | 20 | 11 | 18 |
| **Code Ð½Ð¾Ð´** | 0 | 2 | 3 |
| **Ð¡Ñ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ñ Ð¿Ð¾Ð¸ÑÐºÐ°** | ÐŸÐ¾ÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ | ÐŸÐ°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð¾ | ÐšÑÑˆ + fallback |
| **Ð¡ÐºÐ¾Ñ€Ð¾ÑÑ‚ÑŒ (best case)** | ~200ms | ~200ms | ~100ms (cache hit) |
| **Ð¡ÐºÐ¾Ñ€Ð¾ÑÑ‚ÑŒ (worst case)** | ~1500ms | ~300ms | ~300ms (cache miss) |
| **Ð—Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ðº API (best)** | 1 | 4 | 1 (cached) |
| **Ð—Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ðº API (worst)** | 4 | 4 | 4 (cache miss) |
| **Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð‘Ð”** | `external_refs` | `external_refs` | `external_refs` + `entity_branch_cache` |
| **ÐŸÑ€ÐµÐ¸Ð¼ÑƒÑ‰ÐµÑÑ‚Ð²Ð°** | ÐŸÑ€Ð¾ÑÑ‚Ð¾Ñ‚Ð°, Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² | Ð¡ÐºÐ¾Ñ€Ð¾ÑÑ‚ÑŒ, Ð½Ð°Ð´ÐµÐ¶Ð½Ð¾ÑÑ‚ÑŒ | ÐžÐ¿Ñ‚Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ ÑÐºÐ¾Ñ€Ð¾ÑÑ‚ÑŒ |
| **ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚ÐºÐ¸** | ÐœÐµÐ´Ð»ÐµÐ½Ð½Ð¾ Ð¿Ñ€Ð¸ Ð½ÐµÑƒÐ´Ð°Ñ‡Ðµ | Ð’ÑÐµÐ³Ð´Ð° 4 Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° | Ð¡Ð»Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ, ÐºÑÑˆ Ð¼Ð¾Ð¶ÐµÑ‚ ÑƒÑÑ‚Ð°Ñ€ÐµÑ‚ÑŒ |

---

## ðŸ”„ Ð’ÐµÑ€ÑÐ¸Ñ 1: Sequential (ÐŸÐ¾ÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð¿Ð¾Ð¸ÑÐº)

### Ð›Ð¾Ð³Ð¸ÐºÐ°
```
Webhook â†’ Prepare Data
  â†“
Try Tbilisi â†’ Success? â†’ YES â†’ Save â†’ Respond âœ… (ÐšÐžÐÐ•Ð¦)
               â†“ NO
            Try Batumi â†’ Success? â†’ YES â†’ Save â†’ Respond âœ… (ÐšÐžÐÐ•Ð¦)
                          â†“ NO
                       Try Kutaisi â†’ Success? â†’ YES â†’ Save â†’ Respond âœ… (ÐšÐžÐÐ•Ð¦)
                                      â†“ NO
                                   Try Service Center â†’ Success? â†’ YES â†’ Save â†’ Respond âœ…
                                                          â†“ NO â†’ Alert âŒ
```

### Ð¥Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð¸ÑÑ‚Ð¸ÐºÐ¸
- **20 Ð½Ð¾Ð´** (Ð²ÑÐµ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ðµ)
- **0 Code Ð½Ð¾Ð´**
- ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ÑÑ Ð¿Ñ€Ð¸ Ð¿ÐµÑ€Ð²Ð¾Ð¼ ÑƒÑÐ¿ÐµÑ…Ðµ
- ÐœÐ¸Ð½Ð¸Ð¼Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ðº API

### ÐŸÑ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ
| Ð¡Ñ†ÐµÐ½Ð°Ñ€Ð¸Ð¹ | Ð’Ñ€ÐµÐ¼Ñ | Ð—Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² |
|----------|-------|----------|
| ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ Ð² Tbilisi | ~200ms | 1 |
| ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ Ð² Batumi | ~400ms | 2 |
| ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ Ð² Kutaisi | ~600ms | 3 |
| ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ Ð² Service Center | ~800ms | 4 |
| ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ | ~1000ms | 4 |

### ÐšÐ¾Ð³Ð´Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ
- âœ… Ð‘Ð¾Ð»ÑŒÑˆÐ¸Ð½ÑÑ‚Ð²Ð¾ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚ÐµÐ¹ Ð² Ð¿ÐµÑ€Ð²Ð¾Ð¼ Ñ„Ð¸Ð»Ð¸Ð°Ð»Ðµ (Tbilisi)
- âœ… ÐÑƒÐ¶Ð½Ð° Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ñ‚Ð° Ð¸ Ð¿Ð¾Ð½ÑÑ‚Ð½Ð¾ÑÑ‚ÑŒ
- âœ… Ð­ÐºÐ¾Ð½Ð¾Ð¼Ð¸Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ðº API

### URL
```
https://n8n.rentflow.rentals/workflow/tx0QQ0soDfPzQuUp
```

---

## âš¡ Ð’ÐµÑ€ÑÐ¸Ñ 2: Parallel (ÐŸÐ°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð¿Ð¾Ð¸ÑÐº)

### Ð›Ð¾Ð³Ð¸ÐºÐ°
```
Webhook â†’ Prepare Data
  â†“
Create 4 items (branches)
  â†“
Try All 4 Branches ÐŸÐÐ ÐÐ›Ð›Ð•Ð›Ð¬ÐÐž
  â†“
Filter Success â†’ Get First â†’ Save â†’ Respond âœ…
  â†“ (if none) â†’ Alert âŒ
```

### Ð¥Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð¸ÑÑ‚Ð¸ÐºÐ¸
- **11 Ð½Ð¾Ð´** (9 ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ñ… + 2 Code)
- **2 Code Ð½Ð¾Ð´Ñ‹:**
  1. Create Branch Items - ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ 4 ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð² Ð´Ð»Ñ Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
  2. Get First Success - Ð²Ñ‹Ð±Ð¾Ñ€ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð³Ð¾ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°
- Ð’ÑÐµÐ³Ð´Ð° Ð´ÐµÐ»Ð°ÐµÑ‚ 4 Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð¾
- Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð½ÐµÐ·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ Ð¾Ñ‚ Ñ„Ð¸Ð»Ð¸Ð°Ð»Ð°

### ÐŸÑ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ
| Ð¡Ñ†ÐµÐ½Ð°Ñ€Ð¸Ð¹ | Ð’Ñ€ÐµÐ¼Ñ | Ð—Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² |
|----------|-------|----------|
| ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ Ð² Ð»ÑŽÐ±Ð¾Ð¼ Ñ„Ð¸Ð»Ð¸Ð°Ð»Ðµ | ~200-300ms | 4 |
| ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ | ~300ms | 4 |

### ÐšÐ¾Ð³Ð´Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ
- âœ… Ð¡ÐºÐ¾Ñ€Ð¾ÑÑ‚ÑŒ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ð°
- âœ… Ð¡ÑƒÑ‰Ð½Ð¾ÑÑ‚Ð¸ Ñ€Ð°ÑÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ñ‹ Ñ€Ð°Ð²Ð½Ð¾Ð¼ÐµÑ€Ð½Ð¾ Ð¿Ð¾ Ñ„Ð¸Ð»Ð¸Ð°Ð»Ð°Ð¼
- âœ… API Ð²Ñ‹Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ

### URL
```
https://n8n.rentflow.rentals/workflow/iM41CzhGqyaMl5AL
```

---

## ðŸš€ Ð’ÐµÑ€ÑÐ¸Ñ 3: Cached (Ð¡ ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼)

### Ð›Ð¾Ð³Ð¸ÐºÐ°
```
Webhook â†’ Prepare Data
  â†“
Check Cache (entity_branch_cache)
  â†“
Cache HIT? â†’ YES â†’ Try Cached Branch â†’ Success? â†’ YES â†’ Update Timestamp â†’ Respond âœ… (cached)
                                         â†“ NO (moved/deleted)
                                      Fallback: Try All 4 Branches â†’ Save to Cache
  â†“ NO (cache miss)
Fallback: Try All 4 Branches ÐŸÐÐ ÐÐ›Ð›Ð•Ð›Ð¬ÐÐž
  â†“
Filter Success â†’ Get First â†’ Save to Cache â†’ Save Data â†’ Respond âœ…
  â†“ (if none) â†’ Alert âŒ
```

### Ð¥Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð¸ÑÑ‚Ð¸ÐºÐ¸
- **18 Ð½Ð¾Ð´** (15 ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ñ… + 3 Code)
- **3 Code Ð½Ð¾Ð´Ñ‹:**
  1. Create Fallback Items - ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð² Ð´Ð»Ñ fallback
  2. Get Fallback First Success - Ð²Ñ‹Ð±Ð¾Ñ€ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð³Ð¾ Ð¸Ð· fallback
  3. (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾) Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… ÐºÑÑˆÐ°
- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ `entity_branch_cache`
- ÐšÑÑˆ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ÑÑ Ð¿Ñ€Ð¸ ÐºÐ°Ð¶Ð´Ð¾Ð¼ Ð·Ð°Ð¿Ñ€Ð¾ÑÐµ
- Fallback Ð½Ð° Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð¿Ð¾Ð¸ÑÐº Ð¿Ñ€Ð¸ cache miss

### ÐŸÑ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ
| Ð¡Ñ†ÐµÐ½Ð°Ñ€Ð¸Ð¹ | Ð’Ñ€ÐµÐ¼Ñ | Ð—Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² | ÐšÑÑˆ |
|----------|-------|----------|-----|
| Cache HIT + Success | ~100ms | 1 | âœ… |
| Cache HIT + Moved | ~300ms | 5 (1 cache + 4 fallback) | âŒ â†’ âœ… |
| Cache MISS | ~300ms | 4 | âŒ â†’ âœ… |
| ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ | ~300ms | 4-5 | âŒ |

### ÐŸÐ¾Ð»Ð¸Ñ‚Ð¸ÐºÐ° ÐºÑÑˆÐ°
- **TTL:** 30 Ð´Ð½ÐµÐ¹ (Ð·Ð°Ð¿Ð¸ÑÐ¸ ÑÑ‚Ð°Ñ€ÑˆÐµ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÑŽÑ‚ÑÑ)
- **ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ:** ÐŸÑ€Ð¸ ÐºÐ°Ð¶Ð´Ð¾Ð¼ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¼ Ð¿Ð¾Ð¸ÑÐºÐµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ÑÑ `last_seen_at`
- **Ð˜Ð½Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ:** ÐŸÑ€Ð¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ð¸Ð¸ Ð¼ÐµÐ¶Ð´Ñƒ Ñ„Ð¸Ð»Ð¸Ð°Ð»Ð°Ð¼Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ÑÑ `branch`

### ÐšÐ¾Ð³Ð´Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ
- âœ… Ð§Ð°ÑÑ‚Ñ‹Ðµ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ðº Ð¾Ð´Ð½Ð¸Ð¼ Ð¸ Ñ‚ÐµÐ¼ Ð¶Ðµ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚ÑÐ¼
- âœ… ÐÑƒÐ¶Ð½Ð° Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ
- âœ… Ð“Ð¾Ñ‚Ð¾Ð²Ñ‹ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒ ÐºÑÑˆÐµÐ¼

### URL
```
https://n8n.rentflow.rentals/workflow/W1H6oc4RlS0BJYir
```

---

## ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ

### Ð¢ÐµÑÑ‚ 1: Sequential

```bash
curl -X POST "http://46.224.17.15:5678/webhook/upsert-processor" \
  -H "Content-Type: application/json" \
  -d '{
    "rentprog_id": "65311",
    "entity_type": "car"
  }'
```

**ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚:**
```json
{
  "ok": true,
  "processed": true,
  "branch": "kutaisi"
}
```

---

### Ð¢ÐµÑÑ‚ 2: Parallel

```bash
curl -X POST "http://46.224.17.15:5678/webhook/upsert-processor-parallel" \
  -H "Content-Type: application/json" \
  -d '{
    "rentprog_id": "65311",
    "entity_type": "car"
  }'
```

**ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚:**
```json
{
  "ok": true,
  "processed": true,
  "branch": "kutaisi"
}
```

---

### Ð¢ÐµÑÑ‚ 3: Cached (Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ñ€Ð°Ð· - cache miss)

```bash
curl -X POST "http://46.224.17.15:5678/webhook/upsert-processor-cached" \
  -H "Content-Type: application/json" \
  -d '{
    "rentprog_id": "65311",
    "entity_type": "car"
  }'
```

**ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ (cache miss):**
```json
{
  "ok": true,
  "processed": true,
  "branch": "kutaisi",
  "cached": false
}
```

---

### Ð¢ÐµÑÑ‚ 4: Cached (Ð²Ñ‚Ð¾Ñ€Ð¾Ð¹ Ñ€Ð°Ð· - cache hit)

```bash
# ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ñ‚ Ð¶Ðµ Ð·Ð°Ð¿Ñ€Ð¾Ñ ÑÑ€Ð°Ð·Ñƒ Ð¿Ð¾ÑÐ»Ðµ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾
curl -X POST "http://46.224.17.15:5678/webhook/upsert-processor-cached" \
  -H "Content-Type: application/json" \
  -d '{
    "rentprog_id": "65311",
    "entity_type": "car"
  }'
```

**ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ (cache hit):**
```json
{
  "ok": true,
  "processed": true,
  "branch": "kutaisi",
  "cached": true
}
```

---

### Ð¢ÐµÑÑ‚ 5: ÐÐµÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð°Ñ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚ÑŒ (Ð²ÑÐµ Ð²ÐµÑ€ÑÐ¸Ð¸)

```bash
curl -X POST "http://46.224.17.15:5678/webhook/upsert-processor" \
  -H "Content-Type: application/json" \
  -d '{
    "rentprog_id": "999999999",
    "entity_type": "car"
  }'
```

**ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚:**
```json
{
  "ok": false,
  "error": "Not found in any branch"
}
```

+ Telegram Ð°Ð»ÐµÑ€Ñ‚ Ð² Ñ‡Ð°Ñ‚

---

## ðŸ“Š ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÑÑˆÐ°

### ÐŸÐ¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ ÐºÑÑˆÐ°

```sql
SELECT 
  entity_type,
  rentprog_id,
  branch,
  company_id,
  last_seen_at,
  created_at
FROM entity_branch_cache
ORDER BY last_seen_at DESC
LIMIT 20;
```

### ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ ÐºÑÑˆ (ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾)

```sql
-- Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ð·Ð°Ð¿Ð¸ÑÐ¸
TRUNCATE entity_branch_cache;

-- Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸ (> 30 Ð´Ð½ÐµÐ¹)
DELETE FROM entity_branch_cache 
WHERE last_seen_at < NOW() - INTERVAL '30 days';

-- Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð¿Ð¾ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð¼Ñƒ Ñ‚Ð¸Ð¿Ñƒ
DELETE FROM entity_branch_cache 
WHERE entity_type = 'car';
```

---

## ðŸŽ¯ Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸

### Ð”Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐµÐ½Ð°

**Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Cached Ð²ÐµÑ€ÑÐ¸ÑŽ:**
- âœ… ÐžÐ¿Ñ‚Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ
- âœ… ÐœÐ¸Ð½Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ðº API
- âœ… ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ðµ (ÐºÑÑˆ Ð½Ð°ÐºÐ°Ð¿Ð»Ð¸Ð²Ð°ÐµÑ‚ÑÑ)

**ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³:**
- Ð¡Ð»ÐµÐ´Ð¸Ñ‚Ðµ Ð·Ð° hit rate ÐºÑÑˆÐ°
- ÐŸÐµÑ€Ð¸Ð¾Ð´Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¾Ñ‡Ð¸Ñ‰Ð°Ð¹Ñ‚Ðµ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸
- ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐ¹Ñ‚Ðµ Ñ€Ð°Ð·Ð¼ÐµÑ€ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ `entity_branch_cache`

---

### Ð”Ð»Ñ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸/Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ

**Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Sequential Ð²ÐµÑ€ÑÐ¸ÑŽ:**
- âœ… ÐŸÑ€Ð¾Ñ‰Ðµ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ°
- âœ… ÐŸÐ¾Ð½ÑÑ‚Ð½Ñ‹Ð¹ flow
- âœ… ÐœÐµÐ½ÑŒÑˆÐµ Ð¿Ð¾Ð±Ð¾Ñ‡Ð½Ñ‹Ñ… ÑÑ„Ñ„ÐµÐºÑ‚Ð¾Ð²

---

### Ð”Ð»Ñ Ð²Ñ‹ÑÐ¾ÐºÐ¾Ð½Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ñ‹Ñ… ÑÐ¸ÑÑ‚ÐµÐ¼

**Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Parallel Ð²ÐµÑ€ÑÐ¸ÑŽ:**
- âœ… ÐŸÑ€ÐµÐ´ÑÐºÐ°Ð·ÑƒÐµÐ¼Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ Ð¾Ñ‚Ð²ÐµÑ‚Ð°
- âœ… ÐÐµ Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚ Ð¿Ð¾Ñ€ÑÐ´ÐºÐ° Ñ„Ð¸Ð»Ð¸Ð°Ð»Ð¾Ð²
- âœ… Ð“Ð¾Ñ‚Ð¾Ð²Ð° Ðº Ð¼Ð°ÑÑˆÑ‚Ð°Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÑŽ

---

## ðŸ“ Ð¤Ð°Ð¹Ð»Ñ‹

### Workflows
- `n8n-workflows/rentprog-upsert-processor-new.json` (Sequential)
- `n8n-workflows/rentprog-upsert-processor-parallel.json` (Parallel)
- `n8n-workflows/rentprog-upsert-processor-cached.json` (Cached)

### ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸
- `setup/migrate_entity_branch_cache.mjs` (ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ ÐºÑÑˆÐ°)

### Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ
- `docs/UPSERT_PROCESSOR_MULTI_BRANCH.md` (Ð´ÐµÑ‚Ð°Ð»Ð¸ Ð±Ð°Ð·Ð¾Ð²Ð¾Ð¹ Ð²ÐµÑ€ÑÐ¸Ð¸)
- `docs/UPSERT_PROCESSOR_COMPARISON.md` (ÑÑ‚Ð¾Ñ‚ Ñ„Ð°Ð¹Ð»)

### Ð¡ÐºÑ€Ð¸Ð¿Ñ‚Ñ‹
- `setup/import_new_workflow.mjs` (Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚ workflow Ð² n8n)

---

## âœ… Ð˜Ñ‚Ð¾Ð³

**Ð’ÑÐµ 3 Ð²ÐµÑ€ÑÐ¸Ð¸ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹ Ð¸ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹ Ð² n8n!**

| Ð’ÐµÑ€ÑÐ¸Ñ | URL | ID |
|--------|-----|-----|
| Sequential | https://n8n.rentflow.rentals/workflow/tx0QQ0soDfPzQuUp | `tx0QQ0soDfPzQuUp` |
| Parallel | https://n8n.rentflow.rentals/workflow/iM41CzhGqyaMl5AL | `iM41CzhGqyaMl5AL` |
| Cached | https://n8n.rentflow.rentals/workflow/W1H6oc4RlS0BJYir | `W1H6oc4RlS0BJYir` |

**Ð“Ð¾Ñ‚Ð¾Ð²Ð¾ Ðº Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐµÐ½Ñƒ! ðŸš€**

