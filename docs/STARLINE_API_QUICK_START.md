# üöÄ Starline API - –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

**–î–∞—Ç–∞:** 2025-01-XX  
**AppId:** 40884  
**Secret:** 55t6wDYPs800o3UCRfjd_kW27f2eI1fL

---

## üìã –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

1. ‚úÖ –ò–∑—É—á–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Starline API
2. ‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π workflow `starline-api-sync.json` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API –Ω–∞–ø—Ä—è–º—É—é
3. ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è `0023_starline_api_tables.sql` –¥–ª—è –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü –∏ –ø–æ–ª–µ–π
4. ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ endpoints

---

## üéØ –û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –ù–æ–≤—ã–π workflow –≤–º–µ—Å—Ç–æ —Å—Ç–∞—Ä–æ–≥–æ

**–°—Ç–∞—Ä—ã–π:** `starline-gps-monitor.json` ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π API `/starline/update-gps` (Playwright/–±—Ä–∞—É–∑–µ—Ä)

**–ù–æ–≤—ã–π:** `starline-api-sync.json` ‚Üí –Ω–∞–ø—Ä—è–º—É—é –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ Starline API (HTTP –∑–∞–ø—Ä–æ—Å—ã)

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚ö° –ë—ã—Å—Ç—Ä–µ–µ (–Ω–µ—Ç –∑–∞–¥–µ—Ä–∂–µ–∫ –±—Ä–∞—É–∑–µ—Ä–∞)
- üîí –ù–∞–¥–µ–∂–Ω–µ–µ (–Ω–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å —Å–µ—Å—Å–∏—è–º–∏)
- üìä –ë–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö (—Å–æ–±—ã—Ç–∏—è, –º–∞—Ä—à—Ä—É—Ç—ã)

---

## üìä –ù–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã

### 1. `starline_api_tokens`
–•—Ä–∞–Ω–∏—Ç —Ç–æ–∫–µ–Ω—ã –¥–æ—Å—Ç—É–ø–∞ –∫ API

### 2. `starline_events`
–ò—Å—Ç–æ—Ä–∏—è —Å–æ–±—ã—Ç–∏–π –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (–æ—Ö—Ä–∞–Ω–∞, –∑–∞–∂–∏–≥–∞–Ω–∏–µ, –¥–≤–∏–≥–∞—Ç–µ–ª—å, –¥–≤–µ—Ä–∏, GPS, –ê–ö–ë, –≥–µ–æ–∑–æ–Ω—ã)

### 3. `starline_routes`
–ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö —Ç–æ—á–µ–∫ GPS —Å –º–∞—Ä—à—Ä—É—Ç–∞

---

## üîß –ù–æ–≤—ã–µ –ø–æ–ª—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö

### `gps_tracking`:
- `course` - –ö—É—Ä—Å –¥–≤–∏–∂–µ–Ω–∏—è (0-360¬∞)
- `alarm_state` - –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ö—Ä–∞–Ω—ã
- `geofence_status` - –°—Ç–∞—Ç—É—Å –≥–µ–æ–∑–æ–Ω—ã

### `starline_devices`:
- `last_api_sync` - –ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ API
- `api_token_expires_at` - –í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞

---

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### –®–∞–≥ 1: –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î
psql $DATABASE_URL

# –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
\i setup/migrations/0023_starline_api_tables.sql
```

–ò–ª–∏ —á–µ—Ä–µ–∑ Node.js:

```bash
node -e "
import postgres from 'postgres';
const sql = postgres(process.env.DATABASE_URL);
const migration = await import('fs').then(f => f.readFileSync('setup/migrations/0023_starline_api_tables.sql', 'utf8'));
await sql.unsafe(migration);
console.log('‚úÖ Migration completed');
"
```

### –®–∞–≥ 2: –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å workflow –≤ n8n

```bash
node setup/import_workflow_2025.mjs n8n-workflows/starline-api-sync.json
```

### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å credentials –≤ n8n

1. –û—Ç–∫—Ä—ã—Ç—å workflow –≤ n8n UI
2. –ü—Ä–∏–≤—è–∑–∞—Ç—å **PostgreSQL** credentials –∫ –Ω–æ–¥–µ "Upsert GPS Tracking"
3. –ü—Ä–∏–≤—è–∑–∞—Ç—å **Telegram** credentials –∫ –Ω–æ–¥–µ "Send Telegram Alert"

### –®–∞–≥ 4: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

1. –ó–∞–ø—É—Å—Ç–∏—Ç—å workflow –≤—Ä—É—á–Ω—É—é
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –ë–î:
   ```sql
   SELECT * FROM gps_tracking ORDER BY last_sync DESC LIMIT 5;
   ```

### –®–∞–≥ 5: –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å workflow.

---

## üìù –ß—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å–µ–π—á–∞—Å

### –í `gps_tracking`:
- ‚úÖ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (lat, lng)
- ‚úÖ –°–∫–æ—Ä–æ—Å—Ç—å
- ‚úÖ –ö—É—Ä—Å –¥–≤–∏–∂–µ–Ω–∏—è (–Ω–æ–≤–æ–µ)
- ‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ö—Ä–∞–Ω—ã (–Ω–æ–≤–æ–µ)
- ‚úÖ GPS/GSM —É—Ä–æ–≤–µ–Ω—å —Å–∏–≥–Ω–∞–ª–∞
- ‚úÖ –ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ –ê–ö–ë
- ‚úÖ –ó–∞–∂–∏–≥–∞–Ω–∏–µ/–¥–≤–∏–≥–∞—Ç–µ–ª—å/—Ä—É—á–Ω–∏–∫
- ‚úÖ –°—Ç–∞—Ç—É—Å (moving/parked/offline)
- ‚úÖ –°—Å—ã–ª–∫–∞ –Ω–∞ Google Maps

### –í `starline_devices`:
- ‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- ‚úÖ –ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ API (–Ω–æ–≤–æ–µ)

---

## üîÆ –ß—Ç–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –±—É–¥—É—â–µ–º

### 1. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π

–°–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π workflow –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π:

```javascript
// –ü–æ–ª—É—á–∏—Ç—å —Å–æ–±—ã—Ç–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω—É—Ç
POST /json/v1/device/{device_id}/events
{
  "from": timestamp - 300,
  "to": timestamp
}
```

–°–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ `starline_events`.

### 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–æ–≤

–°–æ–∑–¥–∞—Ç—å workflow –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–≤:

```javascript
// –ü–æ–ª—É—á–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç –∑–∞ –¥–µ–Ω—å
POST /json/v1/device/{device_id}/route
{
  "from": startOfDay,
  "to": endOfDay
}
```

–°–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ `starline_routes`.

### 3. –ú–µ—Ç—Ä–∏–∫–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–±—ã—Ç–∏–π –ø–æ —Ç–∏–ø–∞–º
- –°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å –ø–æ–µ–∑–¥–æ–∫
- –û–±—â–∏–π –ø—Ä–æ–±–µ–≥
- –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –¥–≤–∏–≥–∞—Ç–µ–ª—è
- –í—Ä–µ–º—è –≤ –≥–µ–æ–∑–æ–Ω–∞—Ö

### 4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤

–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ —á–µ—Ä–µ–∑ `refresh_token` –ø–µ—Ä–µ–¥ –∏—Å—Ç–µ—á–µ–Ω–∏–µ–º.

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **Rate Limiting:**
   - –ù–µ –±–æ–ª–µ–µ 5 –∑–∞–ø—Ä–æ—Å–æ–≤/—Å–µ–∫ –∫ Starline API
   - –¢–µ–∫—É—â–∏–π workflow –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ

2. **–¢–æ–∫–µ–Ω—ã:**
   - –¢–æ–∫–µ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 1 —á–∞—Å
   - –ù—É–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å —á–µ—Ä–µ–∑ `refresh_token`
   - –ü–æ–∫–∞ —á—Ç–æ —Ç–æ–∫–µ–Ω –ø–æ–ª—É—á–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑ (–º–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å)

3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
   - –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ - –∞–ª–µ—Ä—Ç –≤ Telegram
   - –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ - –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è —Å–æ —Å–ª–µ–¥—É—é—â–∏–º
   - –í—Å–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ `health` —Ç–∞–±–ª–∏—Ü—É

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [STARLINE_API_INTEGRATION.md](./STARLINE_API_INTEGRATION.md) - –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ API
- [STARLINE_API_REFERENCE_FOR_BOTS.md](./STARLINE_API_REFERENCE_FOR_BOTS.md) - –°–ø—Ä–∞–≤–∫–∞ –¥–ª—è –±–æ—Ç–æ–≤
- [STARLINE_QUICK_REFERENCE.md](./STARLINE_QUICK_REFERENCE.md) - –ë—ã—Å—Ç—Ä–∞—è —Å–ø—Ä–∞–≤–∫–∞

---

**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–î–∞—Ç–∞:** 2025-01-XX

