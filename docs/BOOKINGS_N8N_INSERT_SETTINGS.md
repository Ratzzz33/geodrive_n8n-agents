# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Insert or Update –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã bookings

## –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ

**–û—à–∏–±–∫–∞:** `Column 'booking_id' does not exist in selected table`

**–ü—Ä–∏—á–∏–Ω–∞:** –í —Ç–∞–±–ª–∏—Ü–µ `bookings` **–ù–ï–¢** –ø–æ–ª—è `booking_id`. –≠—Ç–æ –ø–æ–ª–µ –∏–∑ API RentProg, –∫–æ—Ç–æ—Ä–æ–µ –Ω—É–∂–Ω–æ –º–∞–ø–ø–∏—Ç—å –Ω–∞ –¥—Ä—É–≥–æ–µ –ø–æ–ª–µ –∏–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å.

---

## ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è "Save to DB"

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

```yaml
Operation: Insert or Update
Schema: public
Table: bookings
Mapping Column Mode: Map Automatically
```

### Columns to match on (–¥–ª—è ON CONFLICT)

**–í–ê–ñ–ù–û:** –ò—Å–ø–æ–ª—å–∑—É–π **–¢–û–õ–¨–ö–û —ç—Ç–∏ 2 –ø–æ–ª—è** –¥–ª—è match:

```
‚úÖ branch
‚úÖ number
```

**–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π `id`** - —ç—Ç–æ UUID auto-generated!

---

## –ú–∞–ø–ø–∏–Ω–≥ –ø–æ–ª–µ–π –∏–∑ API ‚Üí –ë–î

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (–µ—Å—Ç—å –≤ API –∏ –ë–î)

| –ü–æ–ª–µ –∏–∑ Process All Bookings | –ü–æ–ª–µ –≤ –ë–î | –¢–∏–ø –≤ –ë–î | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|------------------------------|-----------|----------|-------------|
| `branch` | `branch` | text | ‚úÖ Match column |
| `number` | `number` | bigint | ‚úÖ Match column |
| `is_active` | `is_active` | boolean | –ê–∫—Ç–∏–≤–Ω–∞—è/–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞—è |
| `start_date` | `start_date` | text | –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ (—Å—Ç—Ä–æ–∫–∞) |
| `end_date` | `end_date` | text | –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è |
| `start_date_formatted` | `start_date_formatted` | text | ISO —Ñ–æ—Ä–º–∞—Ç |
| `end_date_formatted` | `end_date_formatted` | text | ISO —Ñ–æ—Ä–º–∞—Ç |
| `client_name` | `client_name` | text | –§–ò–û –∫–ª–∏–µ–Ω—Ç–∞ |
| `client_category` | `client_category` | text | –ö–∞—Ç–µ–≥–æ—Ä–∏—è (–õ–æ—è–ª—å–Ω—ã–π –∏ —Ç.–¥.) |
| `car_name` | `car_name` | text | –ù–∞–∑–≤–∞–Ω–∏–µ –∞–≤—Ç–æ |
| `car_code` | `car_code` | text | –ö–æ–¥ –∞–≤—Ç–æ |
| `location_start` | `location_start` | text | –ú–µ—Å—Ç–æ –≤—ã–¥–∞—á–∏ |
| `location_end` | `location_end` | text | –ú–µ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—Ç–∞ |
| `total` | `total` | numeric | –û–±—â–∞—è —Å—É–º–º–∞ |
| `deposit` | `deposit` | numeric | –î–µ–ø–æ–∑–∏—Ç |
| `rental_cost` | `rental_cost` | bigint | –°—Ç–æ–∏–º–æ—Å—Ç—å –∞—Ä–µ–Ω–¥—ã |
| `days` | `days` | numeric | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π |
| `state` | `state` | text | –°–æ—Å—Ç–æ—è–Ω–∏–µ (–ê–∫—Ç–∏–≤–Ω–∞—è) |
| `in_rent` | `in_rent` | boolean | –í –∞—Ä–µ–Ω–¥–µ |
| `archive` | `archive` | boolean | –ê—Ä—Ö–∏–≤–Ω–∞—è |
| `start_worker_id` | `start_worker_id` | text | ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–≤—ã–¥–∞—á–∞) |
| `end_worker_id` | `end_worker_id` | text | ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–≤–æ–∑–≤—Ä–∞—Ç) |
| `responsible` | `responsible` | text | –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π |
| `description` | `description` | text | –û–ø–∏—Å–∞–Ω–∏–µ |
| `source` | `source` | text | –ò—Å—Ç–æ—á–Ω–∏–∫ (–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –∏ —Ç.–¥.) |
| `data` | `data` | jsonb | –ü–æ–ª–Ω—ã–π JSON –∏–∑ API |
| `is_technical` | `is_technical` | boolean | –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –±—Ä–æ–Ω—å |
| `technical_type` | `technical_type` | text | –¢–∏–ø (regular/technical/technical_repair) |
| `technical_purpose` | `technical_purpose` | text | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |

### ‚ùå –ü–æ–ª—è –∫–æ—Ç–æ—Ä—ã–µ –ù–ï –Ω—É–∂–Ω–æ –º–∞–ø–ø–∏—Ç—å

–≠—Ç–∏ –ø–æ–ª—è –∏–∑ API **–ù–ï —Å—É—â–µ—Å—Ç–≤—É—é—Ç** –≤ –ë–î –Ω–∞–ø—Ä—è–º—É—é:

- `booking_id` - –∏—Å–ø–æ–ª—å–∑—É–π `number` –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ!
- `client_id` (—Å—Ç—Ä–æ–∫–∞) - –≤ –ë–î –µ—Å—Ç—å `client_id` (UUID), –Ω–æ —ç—Ç–æ –¥—Ä—É–≥–æ–µ –ø–æ–ª–µ
- `car_id` (—Å—Ç—Ä–æ–∫–∞) - –≤ –ë–î –µ—Å—Ç—å `car_id` (UUID), –Ω–æ —ç—Ç–æ –¥—Ä—É–≥–æ–µ –ø–æ–ª–µ

### üîÑ –ü–æ–ª—è –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

–≠—Ç–∏ –ø–æ–ª—è **–ù–ï –Ω—É–∂–Ω–æ** —É–∫–∞–∑—ã–≤–∞—Ç—å –≤ –º–∞–ø–ø–∏–Ω–≥–µ:

- `id` - UUID, auto-generated (PRIMARY KEY)
- `created_at` - timestamp, default `now()`
- `updated_at` - timestamp, default `now()` (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

---

## –ü–æ—à–∞–≥–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ n8n UI

### 1. Credential to connect with
```
Postgres account (—É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
```

### 2. Operation
```
Insert or Update
```

### 3. Schema
```
From list ‚Üí public
```

### 4. Table
```
From list ‚Üí bookings
```

### 5. Mapping Column Mode
```
Map Automatically
```

### 6. Columns to match on

**–ö–ª–∏–∫–Ω–∏ –Ω–∞ –ø–æ–ª–µ –∏ –≤—ã–±–µ—Ä–∏:**
```
‚úÖ branch
‚úÖ number
```

**–£–±–µ—Ä–∏:**
```
‚ùå id (—É–¥–∞–ª–∏ —ç—Ç–æ—Ç —á–µ–∫–±–æ–∫—Å!)
```

### 7. Options
```
No properties (–æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º)
```

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞–ø–ø–∏–Ω–≥–∞

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏ (INPUT) —Ç—ã —É–≤–∏–¥–∏—à—å –¥–∞–Ω–Ω—ã–µ –∏–∑ "Process All Bookings".

**–£–±–µ–¥–∏—Å—å —á—Ç–æ:**

1. ‚úÖ –ü–æ–ª–µ `booking_id` **–ù–ï –º–∞–ø–ø–∏—Ç—Å—è** (–∏–ª–∏ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è)
2. ‚úÖ –ü–æ–ª–µ `number` –º–∞–ø–ø–∏—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. ‚úÖ –ü–æ–ª–µ `branch` –º–∞–ø–ø–∏—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
4. ‚úÖ –í "Columns to match on" —Ç–æ–ª—å–∫–æ `branch` –∏ `number`
5. ‚úÖ –ü–æ–ª–µ `data` (JSONB) –º–∞–ø–ø–∏—Ç—Å—è –∫–∞–∫ –æ–±—ä–µ–∫—Ç, –Ω–µ —Å—Ç—Ä–æ–∫–∞

---

## –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏

### ‚ùå "Column 'booking_id' does not exist"
**–ü—Ä–∏—á–∏–Ω–∞:** –ü—ã—Ç–∞–µ—à—å—Å—è –≤—Å—Ç–∞–≤–∏—Ç—å –ø–æ–ª–µ `booking_id`, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç –≤ –ë–î.  
**–†–µ—à–µ–Ω–∏–µ:** –£–¥–∞–ª–∏ `booking_id` –∏–∑ –º–∞–ø–ø–∏–Ω–≥–∞ –∏–ª–∏ –ø–µ—Ä–µ–∏–º–µ–Ω—É–π –≤ `number`.

### ‚ùå "Column 'id' does not exist in input"
**–ü—Ä–∏—á–∏–Ω–∞:** `id` –¥–æ–±–∞–≤–ª–µ–Ω –≤ "Columns to match on", –Ω–æ –µ–≥–æ –Ω–µ—Ç –≤ input data.  
**–†–µ—à–µ–Ω–∏–µ:** –£–±–µ—Ä–∏ `id` –∏–∑ "Columns to match on". –û—Å—Ç–∞–≤—å —Ç–æ–ª—å–∫–æ `branch` –∏ `number`.

### ‚ùå "Duplicate key value violates unique constraint"
**–ü—Ä–∏—á–∏–Ω–∞:** –ü–æ–ø—ã—Ç–∫–∞ –≤—Å—Ç–∞–≤–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç –±–µ–∑ ON CONFLICT.  
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –≤ "Columns to match on" —É–∫–∞–∑–∞–Ω—ã `branch` –∏ `number`.

---

## –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:

1. ‚úÖ –ü–µ—Ä–≤–∞—è –≤—Å—Ç–∞–≤–∫–∞ —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏
2. ‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—É—Å–∫–∏ –æ–±–Ω–æ–≤—è—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ (ON CONFLICT ‚Üí UPDATE)
3. ‚úÖ –†—É—Å—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã ("–°–æ—Ç—Ä—É–¥–Ω–∏–∫", "–õ–æ—è–ª—å–Ω—ã–π") —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
4. ‚úÖ JSONB –ø–æ–ª–µ `data` —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ –æ–±—ä–µ–∫—Ç
5. ‚úÖ NULL –∑–Ω–∞—á–µ–Ω–∏—è –±—É–¥—É—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

**–¢–µ—Å—Ç–∏—Ä—É–π –Ω–∞ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏:**

1. –ö–ª–∏–∫–Ω–∏ "Test step" –Ω–∞ –Ω–æ–¥–µ "Save to DB"
2. –î–æ–ª–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
3. –ü—Ä–æ–≤–µ—Ä—å –≤ –ë–î:

```sql
SELECT * FROM bookings 
WHERE branch = 'tbilisi' AND number = 3993 
LIMIT 1;
```

4. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ `source = '–°–æ—Ç—Ä—É–¥–Ω–∏–∫'` (–Ω–µ —Å–ª–æ–º–∞–ª–æ—Å—å –Ω–∞ –∫–∏—Ä–∏–ª–ª–∏—Ü–µ)

---

## –ò—Ç–æ–≥–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```yaml
Save to DB:
  type: postgres
  operation: insert (or update)
  schema: public
  table: bookings
  mappingMode: autoMapInputData
  matchingColumns:
    - branch
    - number
  # –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è –º–∞–ø–ø—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ input
```

**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª–µ–π –¥–ª—è –º–∞–ø–ø–∏–Ω–≥–∞:** ~29 (–∏–∑ Process All Bookings)  
**–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –ø–æ–ª—è:** `booking_id` (—É–¥–∞–ª–∏—Ç—å), `client_id`/`car_id` (—Å—Ç—Ä–æ–∫–∏, –Ω–µ UUID)

---

## üéØ –ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ

**–í "Columns to match on" –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¢–û–õ–¨–ö–û:**
- `branch`
- `number`

**–≠—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç UNIQUE constraint –≤ –ë–î:**
```sql
UNIQUE (branch, number)
```

