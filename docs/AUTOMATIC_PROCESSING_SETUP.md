# ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö - –ù–∞—Å—Ç—Ä–æ–µ–Ω–æ

**–î–∞—Ç–∞:** 2025-11-10  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã

---

## üéØ –¶–µ–ª—å

–û–±–µ—Å–ø–µ—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –±—ç–∫—Ñ–∏–ª–æ–≤:
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–ø–∏—Å—å –≤ Entity Timeline
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ –≤ Event Links
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö

---

## üìä –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º –¥–∞–Ω–Ω—ã—Ö

### 1. –ü–ª–∞—Ç–µ–∂–∏ –∏–∑ RentProg History ‚úÖ

**–§–∞–π–ª:** `src/services/historyProcessor.ts` ‚Üí `extractPayment()`

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ü–ª–∞—Ç–µ–∂ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É `payments`
2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞–ª–∏—á–∏–µ —Å–≤—è–∑–µ–π –≤ `event_links`
3. –ï—Å–ª–∏ —Å–≤—è–∑–µ–π –Ω–µ—Ç ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `linkPayment()` –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–æ–±—ã—Ç–∏–π –æ bookings
4. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞–ª–∏—á–∏–µ –∑–∞–ø–∏—Å–∏ –≤ `entity_timeline`
5. –ï—Å–ª–∏ –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `addPaymentToTimeline()`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ –ø–ª–∞—Ç–µ–∂–∏ –∏–∑ history –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø–∞–¥–∞—é—Ç –≤ timeline –∏ —Å–≤—è–∑—ã–≤–∞—é—Ç—Å—è

---

### 2. –ü–ª–∞—Ç–µ–∂–∏ —á–µ—Ä–µ–∑ API (savePaymentFromRentProg) ‚úÖ

**–§–∞–π–ª:** `src/db/payments.ts` ‚Üí `savePaymentFromRentProg()`

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞:
   - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `linkPayment()`
   - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `addPaymentToTimeline()`

2. –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–ª–∞—Ç–µ–∂–∞:
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞–ª–∏—á–∏–µ —Å–≤—è–∑–µ–π, –µ—Å–ª–∏ –Ω–µ—Ç ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `linkPayment()`
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞–ª–∏—á–∏–µ –≤ timeline, –µ—Å–ª–∏ –Ω–µ—Ç ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `addPaymentToTimeline()`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ –ø–ª–∞—Ç–µ–∂–∏ —á–µ—Ä–µ–∑ API –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è

---

### 3. –í–µ–±—Ö—É–∫–∏ –æ—Ç RentProg ‚úÖ

**–§–∞–π–ª:** `src/orchestrator/rentprog-handler.ts` ‚Üí `handleRentProgEvent()`

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–±—ã—Ç–∏—è –æ booking:
   - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `addWebhookToTimeline()` –¥–ª—è booking
   - ‚úÖ –í–∫–ª—é—á–∞–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ (car, client)

2. –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–±—ã—Ç–∏—è –æ car:
   - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `addWebhookToTimeline()` –¥–ª—è car

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ –≤–µ–±—Ö—É–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø–∞–¥–∞—é—Ç –≤ timeline

---

### 4. GPS –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç Starline ‚úÖ

**–§–∞–π–ª:** `src/services/starline-monitor.ts` ‚Üí `updateGPSData()`

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ GPS –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏):
   - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `addGPSToTimeline()`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ GPS —Å–æ–±—ã—Ç–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø–∞–¥–∞—é—Ç –≤ timeline

---

## üîÑ –ü–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### –ü–ª–∞—Ç–µ–∂–∏

```
–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö
    ‚Üì
[History Processor] ‚Üí extractPayment()
    ‚Üì
INSERT/UPDATE payments
    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:            ‚îÇ
‚îÇ 1. linkPayment() - –ø–æ–∏—Å–∫ —Å–≤—è–∑–µ–π     ‚îÇ
‚îÇ 2. addPaymentToTimeline() - timeline ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚Üì
‚úÖ –ì–æ—Ç–æ–≤–æ (–±–µ–∑ –±—ç–∫—Ñ–∏–ª–∞)
```

### –í–µ–±—Ö—É–∫–∏

```
RentProg Webhook
    ‚Üì
[Orchestrator] ‚Üí handleRentProgEvent()
    ‚Üì
Upsert entity (car/booking/client)
    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:            ‚îÇ
‚îÇ addWebhookToTimeline() - timeline   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚Üì
‚úÖ –ì–æ—Ç–æ–≤–æ (–±–µ–∑ –±—ç–∫—Ñ–∏–ª–∞)
```

### GPS

```
Starline API
    ‚Üì
[Starline Monitor] ‚Üí updateGPSData()
    ‚Üì
–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:            ‚îÇ
‚îÇ addGPSToTimeline() - timeline       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚Üì
‚úÖ –ì–æ—Ç–æ–≤–æ (–±–µ–∑ –±—ç–∫—Ñ–∏–ª–∞)
```

---

## üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

### Entity Timeline

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º:**
```typescript
// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ —É–∂–µ –≤ timeline
const existingTimeline = await db.execute(sql`
  SELECT id FROM entity_timeline
  WHERE entity_type = 'payment'
    AND entity_id = ${paymentId}
  LIMIT 1
`);

if (!existingTimeline || existingTimeline.length === 0) {
  // –î–æ–±–∞–≤–∏—Ç—å –≤ timeline
  await addPaymentToTimeline(...);
}
```

### Event Links

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ–º:**
```typescript
// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å–≤—è–∑–∏
const existingLinks = await getLinksForPayment(paymentId);

if (existingLinks.length === 0) {
  // –°–æ–∑–¥–∞—Ç—å —Å–≤—è–∑—å
  await linkPayment(...);
}
```

**–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ `linkPayment()`:**
```typescript
// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å–≤—è–∑—å
const existingLink = await db
  .select()
  .from(eventLinks)
  .where(eq(eventLinks.payment_id, paymentId))
  .limit(1);

if (existingLink.length > 0) {
  return { created: false, ...existingLink[0] };
}
```

---

## üìã –¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞ (–≤—Å–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã)

| –ò—Å—Ç–æ—á–Ω–∏–∫ | –§—É–Ω–∫—Ü–∏—è | Timeline | Event Links | –°—Ç–∞—Ç—É—Å |
|----------|---------|---------|-------------|--------|
| History Processor | `extractPayment()` | ‚úÖ | ‚úÖ | ‚úÖ |
| API (savePayment) | `savePaymentFromRentProg()` | ‚úÖ | ‚úÖ | ‚úÖ |
| –í–µ–±—Ö—É–∫–∏ | `handleRentProgEvent()` | ‚úÖ | - | ‚úÖ |
| GPS | `updateGPSData()` | ‚úÖ | - | ‚úÖ |
| Batch Import | `savePaymentsBatch()` | ‚úÖ | ‚úÖ | ‚úÖ |

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

**–¢–µ–ø–µ—Ä—å –≤—Å–µ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è:**

1. ‚úÖ **–ü–ª–∞—Ç–µ–∂–∏** ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ timeline + —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ
2. ‚úÖ **–í–µ–±—Ö—É–∫–∏** ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ timeline
3. ‚úÖ **GPS** ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ timeline
4. ‚úÖ **–ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤** ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º
5. ‚úÖ **–û–±–Ω–æ–≤–ª–µ–Ω–∏—è** ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

**–ë—ç–∫—Ñ–∏–ª—ã –±–æ–ª—å—à–µ –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è!** üéâ

---

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–∫—Ä—ã—Ç–∏–µ
node setup/check_entity_timeline_status.mjs

# –î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å:
# - –ü–æ–∫—Ä—ã—Ç–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π: 100%
# - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ: —Ä–∞–±–æ—Ç–∞–µ—Ç
# - –ù–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
```

---

**–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ:** AI Agent  
**–î–∞—Ç–∞:** 2025-11-10

