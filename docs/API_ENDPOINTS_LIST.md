# –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö API endpoints Jarvis API

**Base URL:** `http://46.224.17.15:3000` (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å–µ—Ä–≤–µ—Ä)  
**–î–ª—è Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:** `http://172.18.0.1:3000` (Docker Gateway IP)

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [Health Checks](#health-checks)
2. [RentProg Integration](#rentprog-integration)
3. [–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö](#—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è-–¥–∞–Ω–Ω—ã—Ö)
4. [Entity Timeline](#entity-timeline)
5. [Event Links](#event-links)
6. [Umnico Integration](#umnico-integration)
7. [Starline Integration](#starline-integration)
8. [–¶–µ–Ω—ã –∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏](#—Ü–µ–Ω—ã-–∏-–∞–≤—Ç–æ–º–æ–±–∏–ª–∏)
9. [AmoCRM Integration](#amocrm-integration)
10. [–í–µ–±—Ö—É–∫–∏](#–≤–µ–±—Ö—É–∫–∏)

---

## Health Checks

### `GET /health`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ API —Å–µ—Ä–≤–µ—Ä–∞  
**–ü—Ä–æ—Ü–µ—Å—Å:** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å "ok" –∏ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è  
**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, health checks –æ—Ç n8n

**–û—Ç–≤–µ—Ç:**
```json
{
  "status": "ok",
  "timestamp": "2025-11-12T08:05:27.890Z"
}
```

### `GET /`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ö–æ—Ä–Ω–µ–≤–æ–π endpoint  
**–ü—Ä–æ—Ü–µ—Å—Å:** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Ä–≤–∏—Å–µ  
**–û—Ç–≤–µ—Ç:**
```json
{
  "status": "ok",
  "service": "jarvis-bot"
}
```

---

## RentProg Integration

### `GET /rentprog/health`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ RentProg –ø–æ –≤—Å–µ–º —Ñ–∏–ª–∏–∞–ª–∞–º  
**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å RentProg API –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∏–ª–∏–∞–ª–∞ (tbilisi, batumi, kutaisi, service-center)
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ n8n workflow "Health & Status"
3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –≤ —Ç–∞–±–ª–∏—Ü—É `health`

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ n8n workflow "Health & Status" (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)

**–û—Ç–≤–µ—Ç:**
```json
{
  "ok": true,
  "perBranch": {
    "tbilisi": { "ok": true },
    "batumi": { "ok": true, "error": "..." },
    "kutaisi": { "ok": false, "error": "..." },
    "service-center": { "ok": true }
  }
}
```

---

## –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

### `POST /sync-bookings`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –∏–∑ RentProg  
**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ò—Ç–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø–æ –≤—Å–µ–º 4 —Ñ–∏–ª–∏–∞–ª–∞–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
2. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ –ø–∞–≥–∏–Ω–∞—Ü–∏—é (10 –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É, –∑–∞–¥–µ—Ä–∂–∫–∞ 1.5 —Å–µ–∫)
3. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç upsert –≤ –ë–î —á–µ—Ä–µ–∑ `upsertBookingFromRentProg`
4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –∫–∞–∂–¥–æ–º—É —Ñ–∏–ª–∏–∞–ª—É

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** 30-60+ –º–∏–Ω—É—Ç (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π, ~3000+ –Ω–∞ —Ñ–∏–ª–∏–∞–ª)

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ n8n workflow "–ü–∞—Ä—Å–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–æ–Ω–µ–π —Ä–∞–∑ –≤ —á–∞—Å"

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "summary": {
    "total_bookings": 12000,
    "total_created": 50,
    "total_updated": 11950,
    "total_errors": 0
  },
  "per_branch": [
    {
      "branch": "tbilisi",
      "total": 3000,
      "created": 10,
      "updated": 2990,
      "errors": 0
    },
    ...
  ]
}
```

### `POST /sync-employee-cash`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞—Å—Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏–∑ RentProg  
**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏–∑ –≤—Å–µ—Ö —Ñ–∏–ª–∏–∞–ª–æ–≤ RentProg
2. –ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ –∫–∞—Å—Å–∞—Ö (GEL, USD, EUR)
3. –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ –ë–î
4. –ù–∞—Ö–æ–¥–∏—Ç —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç—á–µ—Ç

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ n8n workflow –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –∏–Ω–∫–∞—Å—Å–∞—Ü–∏–∏

**–û—Ç–≤–µ—Ç:**
```json
{
  "ok": true,
  "discrepancies": [
    {
      "employeeId": "uuid",
      "rentprogId": "123",
      "branch": "tbilisi",
      "name": "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
      "field": "gel",
      "rentprogValue": 1000,
      "dbValue": 500,
      "difference": 500
    }
  ],
  "summary": {
    "total": 50,
    "discrepancies": 5,
    "updated": 45
  }
}
```

---

## Entity Timeline

### `GET /entity-timeline/entity/:entityType/:entityId`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ–ª—É—á–∏—Ç—å timeline (–∏—Å—Ç–æ—Ä–∏—é —Å–æ–±—ã—Ç–∏–π) –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—É—â–Ω–æ—Å—Ç–∏  
**–ü—Ä–æ—Ü–µ—Å—Å:** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ —Å–æ–±—ã—Ç–∏—è, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Å—É—â–Ω–æ—Å—Ç—å—é (car, client, booking, payment)

**Query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `limit` (default: 100) - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
- `offset` (default: 0) - —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
- `eventTypes` - —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø–∞–º —Å–æ–±—ã—Ç–∏–π
- `sourceTypes` - —Ñ–∏–ª—å—Ç—Ä –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º (rentprog, amocrm, etc.)
- `startDate` - –Ω–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞
- `endDate` - –∫–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** UI –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Å—É—â–Ω–æ—Å—Ç–∏

**–û—Ç–≤–µ—Ç:**
```json
{
  "ok": true,
  "data": [
    {
      "id": "uuid",
      "entityType": "car",
      "entityId": "uuid",
      "eventType": "car.moved",
      "sourceType": "rentprog",
      "timestamp": "2025-11-12T08:00:00Z",
      "metadata": {}
    }
  ],
  "count": 50
}
```

### `POST /entity-timeline/related`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ–ª—É—á–∏—Ç—å timeline –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π  
**–ü—Ä–æ—Ü–µ—Å—Å:** –ê–≥—Ä–µ–≥–∏—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏—è –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π –≤ –æ–¥–∏–Ω timeline

**Body:**
```json
{
  "entities": [
    { "type": "car", "id": "uuid" },
    { "type": "booking", "id": "uuid" }
  ],
  "limit": 100,
  "offset": 0,
  "startDate": "2025-11-01",
  "endDate": "2025-11-12"
}
```

### `GET /entity-timeline/stats`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ timeline  
**Query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `entityType` - —Ç–∏–ø —Å—É—â–Ω–æ—Å—Ç–∏
- `branchCode` - –∫–æ–¥ —Ñ–∏–ª–∏–∞–ª–∞
- `startDate` - –Ω–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞
- `endDate` - –∫–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞

---

## Event Links

### `POST /event-links/payment/:paymentId`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–≤—è–∑–∞—Ç—å –ø–ª–∞—Ç–µ–∂ —Å —Å–æ–±—ã—Ç–∏—è–º–∏ –∏ –∏—Å—Ç–æ—Ä–∏–µ–π  
**–ü—Ä–æ—Ü–µ—Å—Å:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –≤ –æ–∫–Ω–µ –≤—Ä–µ–º–µ–Ω–∏ (default: 300 —Å–µ–∫)

**Body:**
```json
{
  "branch": "tbilisi",
  "rpPaymentId": "12345",
  "paymentDate": "2025-11-12T08:00:00Z",
  "timeWindowSeconds": 300
}
```

### `POST /event-links/event/:eventId`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–≤—è–∑–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏ –∏ –∏—Å—Ç–æ—Ä–∏–µ–π  
**–ü—Ä–æ—Ü–µ—Å—Å:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –≤ –æ–∫–Ω–µ –≤—Ä–µ–º–µ–Ω–∏

**Body:**
```json
{
  "branch": "tbilisi",
  "rpEntityId": "12345",
  "entityType": "booking",
  "eventTime": "2025-11-12T08:00:00Z",
  "timeWindowSeconds": 300
}
```

### `GET /event-links/payment/:paymentId`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å–≤—è–∑–∏ –¥–ª—è –ø–ª–∞—Ç–µ–∂–∞

### `GET /event-links/stats`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–≤—è–∑–µ–π (—Å–∫–æ–ª—å–∫–æ —Å–æ–±—ã—Ç–∏–π —Å–≤—è–∑–∞–Ω–æ —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏)

### `GET /event-links/unlinked`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ–ª—É—á–∏—Ç—å –Ω–µ—Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ (—á–µ—Ä–µ–∑ SQL view `unlinked_records`)  
**–ü—Ä–æ—Ü–µ—Å—Å:** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–æ 100 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –Ω–µ—Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π

---

## Umnico Integration

### `POST /api/umnico/send`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É —á–µ—Ä–µ–∑ Umnico  
**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Playwright Service (–ø–æ—Ä—Ç 3001)
2. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ë–î (—Ç–∞–±–ª–∏—Ü–∞ `messages`)

**Body:**
```json
{
  "conversationId": "umnico-conversation-id",
  "text": "–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è"
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ Telegram –±–æ—Ç–∞ –∏–ª–∏ n8n workflow

### `GET /api/umnico/conversations/:id`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ —Å –∫–ª–∏–µ–Ω—Ç–æ–º  
**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–∏–∞–ª–æ–≥–µ –∏–∑ –ë–î
2. –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (–ø–∞–≥–∏–Ω–∞—Ü–∏—è)
3. –ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–≤—è–∑–∞–Ω–Ω–æ–π –±—Ä–æ–Ω–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)

**Query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `limit` (default: 50, max: 200) - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
- `offset` (default: 0) - —Å–º–µ—â–µ–Ω–∏–µ

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** UI –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞

---

## Starline Integration

### `GET /starline/diagnose`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Starline scraper  
**–ü—Ä–æ—Ü–µ—Å—Å:** –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å Playwright –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Starline

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –û—Ç–ª–∞–¥–∫–∞ –ø—Ä–æ–±–ª–µ–º —Å GPS –¥–∞–Ω–Ω—ã–º–∏

### `POST /starline/update-gps`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –û–±–Ω–æ–≤–∏—Ç—å GPS –¥–∞–Ω–Ω—ã–µ –∏–∑ Starline  
**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ó–∞–ø—É—Å–∫–∞–µ—Ç Playwright –±—Ä–∞—É–∑–µ—Ä
2. –ü–∞—Ä—Å–∏—Ç –¥–∞–Ω–Ω—ã–µ –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –º–∞—à–∏–Ω –∏–∑ Starline
3. –û–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –ë–î

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è GPS (—á–µ—Ä–µ–∑ n8n cron)

### `POST /starline/sync-devices`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ Starline –≤ —Ç–∞–±–ª–∏—Ü—É `starline_devices`  
**–ü—Ä–æ—Ü–µ—Å—Å:** –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏–∑ Starline –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î

### `POST /starline/match-devices`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ Starline —Å –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º–∏  
**–ü—Ä–æ—Ü–µ—Å—Å:** –°–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ –Ω–æ–º–µ—Ä–∞–º –º–∞—à–∏–Ω

### `GET /starline/sync-status`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ Starline

### `GET /starline/match-cars` (legacy)
**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å –º–∞—à–∏–Ω—ã Starline —Å —Ç–∞–±–ª–∏—Ü–µ–π cars (legacy endpoint)

---

## –¶–µ–Ω—ã –∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏

### `GET /sync-prices/:branch`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ü–µ–Ω —Ñ–∏–ª–∏–∞–ª–∞ –∏–∑ RentProg  
**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ —Ñ–∏–ª–∏–∞–ª–∞
2. –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ü–µ–Ω—ã –Ω–∞ —Å–µ–∑–æ–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è
3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î (—Ç–∞–±–ª–∏—Ü–∞ `car_season_prices`)

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `:branch` - tbilisi, batumi, kutaisi, service-center

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ü–µ–Ω (—á–µ—Ä–µ–∑ n8n cron)

**–û—Ç–≤–µ—Ç:**
```json
{
  "ok": true,
  "branch": "tbilisi",
  "inserted": 100,
  "updated": 50,
  "skipped": 10,
  "errors": 0
}
```

### `GET /check-cars-without-prices`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –±–µ–∑ —Ü–µ–Ω –Ω–∞ —Å–µ–∑–æ–Ω—ã (–≤—Å–µ —Ñ–∏–ª–∏–∞–ª—ã)  
**–ü—Ä–æ—Ü–µ—Å—Å:** –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ü–µ–Ω—ã –Ω–∞ —Å–µ–∑–æ–Ω—ã

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–ª–Ω–æ—Ç—ã –¥–∞–Ω–Ω—ã—Ö –æ —Ü–µ–Ω–∞—Ö

**–û—Ç–≤–µ—Ç:**
```json
{
  "ok": true,
  "branches": [
    {
      "branch": "tbilisi",
      "total": 100,
      "withoutPrices": 5
    }
  ],
  "summary": {
    "total": 400,
    "withoutPrices": 20,
    "withPrices": 380
  }
}
```

### `GET /check-cars-without-prices/:branch`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –±–µ–∑ —Ü–µ–Ω –Ω–∞ —Å–µ–∑–æ–Ω—ã (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∏–ª–∏–∞–ª)

### `POST /restore-cars`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞—à–∏–Ω –∏–∑ RentProg  
**–ü—Ä–æ—Ü–µ—Å—Å:** –í—ã–ø–æ–ª–Ω—è–µ—Ç `setup/restore_cars_from_rentprog.mjs` –¥–ª—è –≤—Å–µ—Ö —Ñ–∏–ª–∏–∞–ª–æ–≤

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** 10-30 –º–∏–Ω—É—Ç

**–û—Ç–≤–µ—Ç:**
```json
{
  "ok": true,
  "stats": {
    "totalCars": 400,
    "inserted": 10,
    "updated": 390,
    "skipped": 0
  },
  "branches": [
    {
      "branch": "tbilisi",
      "total": 100,
      "inserted": 2,
      "updated": 98,
      "skipped": 0
    }
  ]
}
```

---

## AmoCRM Integration

### `POST /amocrm/process-webhook`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–µ–±—Ö—É–∫–æ–≤ –æ—Ç AmoCRM  
**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ë—ã—Å—Ç—Ä—ã–π ACK (200 OK)
2. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è —Å–¥–µ–ª–æ–∫ (leads) –∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
3. –í—ã–ø–æ–ª–Ω—è–µ—Ç upsert –≤ –ë–î (TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —á–∞—Å—Ç–∏—á–Ω–æ)

**Body:**
```json
{
  "event_type": "lead.add",
  "entity_type": "lead",
  "amocrm_entity_id": "12345",
  "payload": {},
  "details": {}
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ n8n workflow –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –≤–µ–±—Ö—É–∫–∞ –æ—Ç AmoCRM

---

## –í–µ–±—Ö—É–∫–∏

### `POST /webhook/rentprog`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü—Ä–∏–µ–º –≤–µ–±—Ö—É–∫–æ–≤ –æ—Ç RentProg (—á–µ—Ä–µ–∑ Nginx)  
**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –≤–µ–±—Ö—É–∫ –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
2. –†–æ—É—Ç–∏—Ç –≤ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

**Body:**
```json
{
  "type": "booking.issue.planned",
  "payload": {
    "id": "12345",
    ...
  },
  "timestamp": "2025-11-12T08:00:00Z"
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ Nginx –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –≤–µ–±—Ö—É–∫–∞ –æ—Ç RentProg

### `POST /process-webhook`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –≤–µ–±—Ö—É–∫–æ–≤ –∏–∑ n8n (–±—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞)  
**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –≤–µ–±—Ö—É–∫
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–∏ –≤ –ë–î
3. –í—ã–ø–æ–ª–Ω—è–µ—Ç –±—ã—Å—Ç—Ä—ã–π update –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `needsUpsert=true` –¥–ª—è –ø–æ–ª–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

**Body:**
```json
{
  "event": "booking.issue.planned",
  "rentprog_id": "12345",
  "company_id": "company-id",
  "entity_type": "booking",
  "operation": "update",
  "payload": {}
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ n8n workflow "RentProg Webhooks Monitor" –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

**–û—Ç–≤–µ—Ç:**
```json
{
  "ok": true,
  "processed": true,
  "updated": true,
  "entityId": "uuid",
  "changes": ["status", "start_at"]
}
```

–∏–ª–∏

```json
{
  "ok": true,
  "processed": false,
  "needsUpsert": true,
  "rentprog_id": "12345",
  "event": "booking.issue.planned"
}
```

### `POST /process-event`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –∏–∑ n8n (upsert processor)  
**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ
2. –í—ã–ø–æ–ª–Ω—è–µ—Ç auto-fetch –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ RentProg API
3. –í—ã–ø–æ–ª–Ω—è–µ—Ç upsert –≤ –ë–î —á–µ—Ä–µ–∑ `handleRentProgEvent`

**Body:**
```json
{
  "type": "booking.issue.planned",
  "rentprog_id": "12345",
  "eventId": 123
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ n8n workflow "RentProg Upsert Processor" –¥–ª—è –ø–æ–ª–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π

**–û—Ç–≤–µ—Ç:**
```json
{
  "ok": true,
  "processed": true,
  "entityIds": ["uuid-car", "uuid-client", "uuid-booking"],
  "error": null
}
```

---

## Upsert Endpoints

### `POST /upsert-car`
**–û–ø–∏—Å–∞–Ω–∏–µ:** Upsert –∞–≤—Ç–æ–º–æ–±–∏–ª—è (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ n8n workflow)  
**–ü—Ä–æ—Ü–µ—Å—Å:** –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∞–≤—Ç–æ–º–æ–±–∏–ª—å –≤ –ë–î

**Body:**
```json
{
  "rentprog_id": "12345",
  "data_hex": "hex-encoded-json-data"
}
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** `data_hex` - —ç—Ç–æ hex-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON —Å –¥–∞–Ω–Ω—ã–º–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è

### `POST /upsert-client`
**–û–ø–∏—Å–∞–Ω–∏–µ:** Upsert –∫–ª–∏–µ–Ω—Ç–∞ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ n8n workflow)  
**–ü—Ä–æ—Ü–µ—Å—Å:** –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –≤ –ë–î

**Body:**
```json
{
  "rentprog_id": "12345",
  "data_hex": "hex-encoded-json-data"
}
```

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ Endpoints

### `POST /scrape-exchange-rates`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–∞—Ä—Å–∏–Ω–≥ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç –∏–∑ RentProg —á–µ—Ä–µ–∑ Playwright  
**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ó–∞–ø—É—Å–∫–∞–µ—Ç Playwright –±—Ä–∞—É–∑–µ—Ä
2. –ü–∞—Ä—Å–∏—Ç –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç –∏–∑ RentProg –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ñ–∏–ª–∏–∞–ª–∞
3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫—É—Ä—Å—ã

**Body:**
```json
{
  "branch": "tbilisi"
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "branch": "tbilisi",
  "rates": {
    "USD": 2.65,
    "EUR": 2.85
  },
  "timestamp": "2025-11-12T08:00:00Z"
}
```

---

## –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã

### `GET /conversations/*`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –°—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–∑–¥–∞—á–∞ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–∏–∞–ª–æ–≥–æ–≤  
**–ü—Ä–æ—Ü–µ—Å—Å:** –û—Ç–¥–∞–µ—Ç —Ñ–∞–π–ª—ã –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `web/`

---

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

1. **–¢–∞–π–º–∞—É—Ç—ã:** –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ endpoints –∏–º–µ—é—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ç–∞–π–º–∞—É—Ç. –î–ª—è –¥–æ–ª–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (`/sync-bookings`, `/restore-cars`) —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É–≤–µ–ª–∏—á–∏—Ç—å —Ç–∞–π–º–∞—É—Ç –¥–æ 1 —á–∞—Å–∞.

2. **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:** –í —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ API –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å–µ—Ä–≤–µ—Ä). –î–ª—è production —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å API –∫–ª—é—á–∏.

3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –í—Å–µ endpoints –ª–æ–≥–∏—Ä—É—é—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ `logger`. –õ–æ–≥–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ `/var/log/jarvis-api.log` –∏–ª–∏ —á–µ—Ä–µ–∑ `journalctl -u jarvis-api`.

4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:** –í—Å–µ endpoints –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç JSON —Å –ø–æ–ª–µ–º `ok: true/false` –∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º `error`.

5. **–ü–∞–≥–∏–Ω–∞—Ü–∏—è:** Endpoints, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –ø–∞–≥–∏–Ω–∞—Ü–∏—é —á–µ—Ä–µ–∑ `limit` –∏ `offset`.

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-11-12

