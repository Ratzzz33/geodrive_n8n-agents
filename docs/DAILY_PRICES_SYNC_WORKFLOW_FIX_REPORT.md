# ‚úÖ –û—Ç—á–µ—Ç: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ workflow "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ü–µ–Ω –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏"

**Workflow ID:** ihRLR0QCJySx319b  
**URL:** https://n8n.rentflow.rentals/workflow/ihRLR0QCJySx319b  
**–ù–∞–∑–≤–∞–Ω–∏–µ:** ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ü–µ–Ω –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π (RentProg) —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ê–∫—Ç–∏–≤–µ–Ω

---

## üìä –ü–†–û–ë–õ–ï–ú–´ –î–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### 1. ‚ùå –¢—Ä–∏–≥–≥–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
- **–ë—ã–ª–æ:** `"0 * * * *"` (–∫–∞–∂–¥—ã–π —á–∞—Å)
- **–ù—É–∂–Ω–æ:** –†–∞–∑ –≤ —Å—É—Ç–∫–∏

### 2. ‚ùå –¶–µ–Ω—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å
- –ù–æ–¥–∞ "Remove Price Values" —É–¥–∞–ª—è–ª–∞ –≤—Å–µ –ø–æ–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Ü–µ–Ω–∞–º–∏
- –ù–µ –±—ã–ª–æ –Ω–æ–¥ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ü–µ–Ω –≤ —Ç–∞–±–ª–∏—Ü—É `car_prices`

### 3. ‚ùå Workflow –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω
- `active: false` - workflow –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### 4. ‚ùå –ù–µ—Ç –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ü–µ–Ω –∏–∑ API
- –ù–æ–¥–∞ "Normalize Cars" –Ω–µ –∏–∑–≤–ª–µ–∫–∞–ª–∞ —Ü–µ–Ω—ã –∏–∑ `included`

---

## ‚úÖ –ü–†–ò–ú–ï–ù–ï–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ç—Ä–∏–≥–≥–µ—Ä
- **–ò–∑–º–µ–Ω–µ–Ω–æ:** `"0 2 * * *"` (—Ä–∞–∑ –≤ —Å—É—Ç–∫–∏ –≤ 2:00 –Ω–æ—á–∏)
- **–ù–æ–¥–∞:** "Daily Trigger"

### 2. –î–æ–±–∞–≤–ª–µ–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ü–µ–Ω –≤ –Ω–æ–¥–µ "Normalize Cars"
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ `included` (—Ü–µ–Ω—ã –∏ —Å–µ–∑–æ–Ω—ã) –∏–∑ –æ—Ç–≤–µ—Ç–∞ API
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞ (–º–∞—Å—Å–∏–≤, –æ–±—ä–µ–∫—Ç —Å `cars`/`data`)
- –°–æ–∑–¥–∞–Ω–∏–µ –º–∞–ø–ø–∏–Ω–≥–∞ —Ü–µ–Ω –ø–æ `car_id`
- –°–æ–∑–¥–∞–Ω–∏–µ –º–∞–ø–ø–∏–Ω–≥–∞ —Å–µ–∑–æ–Ω–æ–≤ –ø–æ ID
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ü–µ–Ω
- –í–æ–∑–≤—Ä–∞—Ç –∏ –º–∞—à–∏–Ω, –∏ —Ü–µ–Ω –≤ –æ–¥–Ω–æ–º –ø–æ—Ç–æ–∫–µ

### 3. –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–¥–∞ "Split Cars and Prices"
- –†–∞–∑–¥–µ–ª—è–µ—Ç –º–∞—à–∏–Ω—ã –∏ —Ü–µ–Ω—ã –ø–æ –Ω–∞–ª–∏—á–∏—é `price_id`
- True branch (—Ü–µ–Ω—ã) ‚Üí "Find Car ID"
- False branch (–º–∞—à–∏–Ω—ã) ‚Üí "Has Data?"

### 4. –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–¥–∞ "Find Car ID"
- –ò—â–µ—Ç `car_id` –≤ —Ç–∞–±–ª–∏—Ü–µ `cars` –ø–æ `rentprog_id`
- –ï—Å–ª–∏ `car_id` –Ω–µ –Ω–∞–π–¥–µ–Ω, –∑–∞–ø–∏—Å—å –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç –¥–∞–ª—å—à–µ

### 5. –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–¥–∞ "Merge Car ID"
- –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ —Ü–µ–Ω–µ —Å –Ω–∞–π–¥–µ–Ω–Ω—ã–º `car_id`
- **–ó–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π:**
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π `price_id`
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π `season_id`
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ `values`

### 6. –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–¥–∞ "Format Price Values"
- –§–æ—Ä–º–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É `price_values` –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
- **–ó–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π:**
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π `car_id`
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π `price_id`
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π `season_id`
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ `values`
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤—Å–µ –Ω—É–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ `values`

### 7. –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–¥–∞ "Save Prices"
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ü–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü—É `car_prices` —á–µ—Ä–µ–∑ upsert
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `matchingColumns: ['car_id', 'season_id']`
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç:
  - `car_id`
  - `rentprog_price_id`
  - `season_id`
  - `season_name`
  - `season_start_date`
  - `season_end_date`
  - `price_values` (JSONB —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)

### 8. –û–±–Ω–æ–≤–ª–µ–Ω—ã connections
- `Normalize Cars` ‚Üí `Split Cars and Prices`
- `Split Cars and Prices` (True - —Ü–µ–Ω—ã) ‚Üí `Find Car ID` ‚Üí `Merge Car ID` ‚Üí `Format Price Values` ‚Üí `Save Prices` ‚Üí `Format Result`
- `Split Cars and Prices` (False - –º–∞—à–∏–Ω—ã) ‚Üí `Has Data?` ‚Üí `Save Snapshot` ‚Üí `Remove Price Values` ‚Üí `Save Cars` ‚Üí `Format Result`

### 9. Workflow –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω
- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω `active: true` —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–π endpoint

---

## üîÑ –ù–û–í–´–ô –ü–û–¢–û–ö –í–´–ü–û–õ–ù–ï–ù–ò–Ø

```
Daily Trigger (2:00 –Ω–æ—á–∏)
  ‚Üì
4 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤–µ—Ç–∫–∏ (Tbilisi, Batumi, Kutaisi, Service Center):
  Context ‚Üí Get Token ‚Üí Fetch Cars ‚Üí Wrap Cars
  ‚Üì
Merge All Branches
  ‚Üì
Normalize Cars (–∏–∑–≤–ª–µ–∫–∞–µ—Ç –º–∞—à–∏–Ω—ã –ò —Ü–µ–Ω—ã)
  ‚Üì
Split Cars and Prices
  ‚îú‚îÄ True branch (—Ü–µ–Ω—ã):
  ‚îÇ   Find Car ID ‚Üí Merge Car ID ‚Üí Format Price Values ‚Üí Save Prices ‚Üí Format Result
  ‚îÇ
  ‚îî‚îÄ False branch (–º–∞—à–∏–Ω—ã):
      Has Data?
        ‚îú‚îÄ True (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö): Format Result
        ‚îî‚îÄ False (–µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ): Save Snapshot ‚Üí Remove Price Values ‚Üí Save Cars ‚Üí Format Result
  ‚Üì
Format Result ‚Üí If Error ‚Üí Send Alert / Success
```

---

## üõ°Ô∏è –ó–ê–©–ò–¢–ê –û–¢ –ü–£–°–¢–´–• –ó–ù–ê–ß–ï–ù–ò–ô

### –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞:

1. **–ù–æ–¥–∞ "Normalize Cars":**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ `values` –Ω–µ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –Ω–µ –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω—É–ª–µ–≤—ã–µ

2. **–ù–æ–¥–∞ "Merge Car ID":**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `car_id`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `price_id`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `season_id`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `values`

3. **–ù–æ–¥–∞ "Format Price Values":**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `car_id`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `price_id`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `season_id`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `values`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –Ω–µ –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω—É–ª–µ–≤—ã–µ

4. **–ù–æ–¥–∞ "Save Prices":**
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç upsert —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –ø–æ `(car_id, season_id)`

---

## üìã –°–¢–†–£–ö–¢–£–†–ê –î–ê–ù–ù–´–•

### –¶–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É `car_prices`:

```sql
INSERT INTO car_prices (
  car_id,              -- UUID –∏–∑ —Ç–∞–±–ª–∏—Ü—ã cars
  rentprog_price_id,   -- ID —Ü–µ–Ω—ã –≤ RentProg
  season_id,           -- ID —Å–µ–∑–æ–Ω–∞ –≤ RentProg
  season_name,         -- –ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ–∑–æ–Ω–∞
  season_start_date,   -- –ù–∞—á–∞–ª–æ —Å–µ–∑–æ–Ω–∞
  season_end_date,     -- –ö–æ–Ω–µ—Ü —Å–µ–∑–æ–Ω–∞
  price_values         -- JSONB —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å —Ü–µ–Ω–∞–º–∏
)
VALUES (...)
ON CONFLICT (car_id, season_id) DO UPDATE SET ...
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ `price_values`:

```json
{
  "periods": ["1-3 –¥–Ω—è", "4-7 –¥–Ω–µ–π", "8-15 –¥–Ω–µ–π", "16-30 –¥–Ω–µ–π", "31+ –¥–Ω–µ–π"],
  "values": [151, 146, 140, 135, 116, 94],
  "currency": "GEL",
  "exchange_rate": 2.7,
  "items": [
    {
      "period": "1-3 –¥–Ω—è",
      "price_per_day": 151,
      "price_gel": 151,
      "price_usd": 55.93,
      "currency": "GEL"
    },
    ...
  ],
  "season": {
    "name": "–ù–∏–∑–∫–∏–π —Å–µ–∑–æ–Ω",
    "start_date": "2025-01-01",
    "end_date": "2025-03-31"
  }
}
```

---

## ‚úÖ –ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê

### ‚úÖ –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
- –¢—Ä–∏–≥–≥–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏ (2:00 –Ω–æ—á–∏)
- –î–æ–±–∞–≤–ª–µ–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ü–µ–Ω –∏–∑ API –æ—Ç–≤–µ—Ç–∞
- –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–¥—ã –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ü–µ–Ω –≤ `car_prices`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
- Workflow –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω
- Connections –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ

### ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
- –ó–∞–ø—É—Å—Ç–∏—Ç—å workflow –≤—Ä—É—á–Ω—É—é –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ü–µ–Ω—ã –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –∏–∑ API
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ü–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `car_prices`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –ë–î

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### 1. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å workflow –≤—Ä—É—á–Ω—É—é
- –ó–∞–ø—É—Å—Ç–∏—Ç—å workflow —á–µ—Ä–µ–∑ UI
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å execution –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ü–µ–Ω
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API endpoint
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `all_cars_full` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `included` —Å —Ü–µ–Ω–∞–º–∏
- –ï—Å–ª–∏ –Ω–µ—Ç, –≤–æ–∑–º–æ–∂–Ω–æ, –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π endpoint

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ workflow –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ü–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å workflow –≤—Ä—É—á–Ω—É—é –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã.

