# üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä—ã –ë–î

**–î–∞—Ç–∞:** 2025-11-14  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç

---

## üéØ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –¢—Ä–∏–≥–≥–µ—Ä—ã –ë–î (—Ä–∞–±–æ—Ç–∞—é—Ç –í–°–ï–ì–î–ê)

**–¢—Ä–∏–≥–≥–µ—Ä—ã –≤—Å—Ç—Ä–æ–µ–Ω—ã –≤ PostgreSQL –∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:**

- ‚úÖ `auto_process_event_trigger` –Ω–∞ —Ç–∞–±–ª–∏—Ü–µ `events`
- ‚úÖ `auto_process_history_trigger` –Ω–∞ —Ç–∞–±–ª–∏—Ü–µ `history`

**–û–Ω–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç:**
- –ü—Ä–∏ INSERT –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏
- –ü—Ä–∏ UPDATE –∑–∞–ø–∏—Å–∏ (–µ—Å–ª–∏ `processed = false`)

**–¢—Ä–∏–≥–≥–µ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç –ù–ï–ó–ê–í–ò–°–ò–ú–û –æ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π** - —ç—Ç–æ —á–∞—Å—Ç—å PostgreSQL!

---

### 2. –ß—Ç–æ –¥–µ–ª–∞—é—Ç —Ç—Ä–∏–≥–≥–µ—Ä—ã

#### –î–ª—è `events`:
1. –ù–æ—Ä–º–∞–ª–∏–∑—É—é—Ç `payload` (–º–∞—Å—Å–∏–≤—ã ‚Üí –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
2. –û–ø—Ä–µ–¥–µ–ª—è—é—Ç `branch` –ø–æ `company_id`
3. –ò–∑–≤–ª–µ–∫–∞—é—Ç `ext_id` –∏–∑ payload
4. –û—Ç–ø—Ä–∞–≤–ª—è—é—Ç `pg_notify` –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
5. **–ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö –æ—Å—Ç–∞–≤–ª—è—é—Ç `processed = false`**

#### –î–ª—è `history`:
1. –ü–∞—Ä—Å—è—Ç `description` (–∏–∑–≤–ª–µ–∫–∞—é—Ç —Ç–∏–ø —Å—É—â–Ω–æ—Å—Ç–∏, ID, –æ–ø–µ—Ä–∞—Ü–∏—é)
2. –ü—Ä–∏–º–µ–Ω—è—é—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º —Ç–∞–±–ª–∏—Ü–∞–º (`cars`, `clients`, `bookings`)
3. –û–±–Ω–æ–≤–ª—è—é—Ç `entity_type` –∏ `entity_id` –µ—Å–ª–∏ –ø—É—Å—Ç—ã–µ
4. –û—Ç–ø—Ä–∞–≤–ª—è—é—Ç `pg_notify` –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
5. **–ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö –æ—Å—Ç–∞–≤–ª—è—é—Ç `processed = false`**

---

### 3. –°–ª—É—à–∞—Ç–µ–ª–∏ pg_notify (–Ω—É–∂–µ–Ω –∑–∞–ø—É—â–µ–Ω–Ω—ã–π Jarvis API)

**–î–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ `pg_notify` –Ω—É–∂–µ–Ω –∑–∞–ø—É—â–µ–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å:**

- `eventProcessor` - —Å–ª—É—à–∞–µ—Ç `rentprog_event_auto_process`
- `historyEventProcessor` - —Å–ª—É—à–∞–µ—Ç `history_item_processed`

**–û–Ω–∏ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ Jarvis API.**

---

### 4. Fallback –º–µ—Ö–∞–Ω–∏–∑–º

**–î–∞–∂–µ –µ—Å–ª–∏ `pg_notify` –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –µ—Å—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:**

- `eventProcessor`: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ `events` –∫–∞–∂–¥—ã–µ **30 —Å–µ–∫—É–Ω–¥**
- `historyEventProcessor`: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ `history` –∫–∞–∂–¥—É—é **–º–∏–Ω—É—Ç—É**

**–≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–∂–µ –µ—Å–ª–∏:**
- Jarvis API –±—ã–ª –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω
- –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î –±—ã–ª–æ –ø–æ—Ç–µ—Ä—è–Ω–æ
- `pg_notify` –Ω–µ –¥–æ—à–µ–ª

---

## ‚ö†Ô∏è –í–ê–ñ–ù–û: Jarvis API –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –ø–æ—Å—Ç–æ—è–Ω–Ω–æ

### –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å

**–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω Jarvis API —á–µ—Ä–µ–∑ systemd:**

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
systemctl status jarvis-api.service

# –ï—Å–ª–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω - –∑–∞–ø—É—Å—Ç–∏—Ç—å
systemctl start jarvis-api.service

# –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫
systemctl enable jarvis-api.service
```

**–ò–ª–∏ —á–µ—Ä–µ–∑ docker-compose** (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä).

---

## üìä –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ë–ï–ó Jarvis API

‚úÖ **–¢—Ä–∏–≥–≥–µ—Ä—ã –ë–î —Ä–∞–±–æ—Ç–∞—é—Ç –≤—Å–µ–≥–¥–∞:**
- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è payload
- –ü–∞—Ä—Å–∏–Ω–≥ description
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö
- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫ `cars`, `clients`, `bookings`

‚ùå **–ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ë–ï–ó Jarvis API:**
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ `pg_notify` (–Ω–æ –µ—Å—Ç—å fallback)
- –í—ã–∑–æ–≤ `handleRentProgEvent` –¥–ª—è —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ RentProg API

---

## üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Ç—Ä–∏–≥–≥–µ—Ä—ã —Å–æ–∑–¥–∞–Ω—ã
SELECT 
  trigger_name, 
  event_object_table, 
  action_timing, 
  event_manipulation
FROM information_schema.triggers
WHERE trigger_name LIKE '%auto_process%';
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–π

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ Jarvis API –∑–∞–ø—É—â–µ–Ω
systemctl status jarvis-api.service

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
journalctl -u jarvis-api.service -f

# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è:
# ‚úÖ Event processor started, listening for pg_notify events
# ‚úÖ History processor started, listening for pg_notify events
```

### 3. –¢–µ—Å—Ç–æ–≤–∞—è –≤—Å—Ç–∞–≤–∫–∞

```sql
-- –¢–µ—Å—Ç–æ–≤–∞—è –≤—Å—Ç–∞–≤–∫–∞ –≤ events (—Ç—Ä–∏–≥–≥–µ—Ä —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
INSERT INTO events (branch, type, ext_id, payload, company_id)
VALUES ('tbilisi', 'car_update', '12345', '{"id": 12345}'::jsonb, 9247);

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
SELECT id, processed, ok, reason FROM events WHERE ext_id = '12345';
```

---

## üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è production:

1. ‚úÖ **Jarvis API –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –∫–∞–∫ systemd —Å–µ—Ä–≤–∏—Å**
   - –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏

2. ‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–±–æ—Ç—ã —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤**
   - –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏

3. ‚úÖ **Fallback –º–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ–≥–¥–∞**
   - –î–∞–∂–µ –µ—Å–ª–∏ `pg_notify` –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∑–∞–ø–∏—Å–∏ –æ–±—Ä–∞–±–æ—Ç–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É

---

## üìù –ò—Ç–æ–≥

**–¢—Ä–∏–≥–≥–µ—Ä—ã –ë–î —Ä–∞–±–æ—Ç–∞—é—Ç –í–°–ï–ì–î–ê** - —ç—Ç–æ —á–∞—Å—Ç—å PostgreSQL.

**–°–ª—É—à–∞—Ç–µ–ª–∏ `pg_notify` —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ–≥–¥–∞ Jarvis API –∑–∞–ø—É—â–µ–Ω** - –Ω–æ –µ—Å—Ç—å fallback —á–µ—Ä–µ–∑ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É.

**–°–∏—Å—Ç–µ–º–∞ –Ω–∞–¥–µ–∂–Ω–∞:** –¥–∞–∂–µ –µ—Å–ª–∏ Jarvis API —É–ø–∞–ª, –∑–∞–ø–∏—Å–∏ –æ–±—Ä–∞–±–æ—Ç–∞—é—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–µ (30 —Å–µ–∫ –¥–ª—è events, 1 –º–∏–Ω –¥–ª—è history).

