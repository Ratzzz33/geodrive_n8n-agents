# RentProg Car States Reconciliation

**Workflow ID:** `j6yLX6GZcE9t5ZcO`  
**URL:** https://n8n.rentflow.rentals/workflow/j6yLX6GZcE9t5ZcO

---

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π (state) –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –º–µ–∂–¥—É RentProg API –∏ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏. –ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç –≤ Telegram.

---

## ‚è∞ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ

**–ó–∞–ø—É—Å–∫:** –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ **04:00** –ø–æ –¢–±–∏–ª–∏—Å–∏  
**–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å:** Asia/Tbilisi

---

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã

1. **Prepare Branches** - –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ —Ñ–∏–ª–∏–∞–ª–æ–≤ —Å company tokens
2. **Get RentProg Token** - –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ –¥–ª—è API
3. **Merge Branch & Token** - –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ñ–∏–ª–∏–∞–ª–∞ –∏ —Ç–æ–∫–µ–Ω–∞
4. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ:**
   - **Get All Cars from RentProg API** - –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –º–∞—à–∏–Ω —á–µ—Ä–µ–∑ `/all_cars`
   - **Get Cars from DB** - –ü–æ–ª—É—á–µ–Ω–∏–µ –º–∞—à–∏–Ω –∏–∑ –ë–î —á–µ—Ä–µ–∑ external_refs
5. **Merge API & DB Data** - –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ API –∏ –ë–î
6. **Compare States** - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –º–∞—à–∏–Ω
7. **If Has Discrepancy** - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π
8. **Format Alert** - –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è Telegram
9. **Send Telegram Alert** - –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ —á–∞—Ç `-5004140602`

---

## üîë API Endpoint

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ endpoint `/all_cars`

**URL:** `https://rentprog.net/api/v1/public/all_cars`

**–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:**
- –ó–∞–≥–æ–ª–æ–≤–æ–∫: `Authorization: {–≤—Ä–µ–º–µ–Ω–Ω—ã–π_—Ç–æ–∫–µ–Ω}`
- –ó–∞–≥–æ–ª–æ–≤–æ–∫: `Accept: application/json`

**Company Tokens (–¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞):**
- **Tbilisi:** `91b83b93963633649f29a04b612bab3f9fbb0471b5928622`
- **Batumi:** `7ad345720f8d92f10c187122427c6a2c2bb9494c6bf14e8d`
- **Kutaisi:** `5599ebb7b94827fdfd49ca3a5b7e259cfa99d8ea78edeb50`
- **Service Center:** `5y4j4gcs75o9n5s1e2vrxx4a`

---

## üìä –¢–∏–ø—ã —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π

### 1. State Mismatch (–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π)
–ú–∞—à–∏–Ω–∞ –µ—Å—Ç—å –∏ –≤ RentProg –∏ –≤ –ë–î, –Ω–æ –∑–Ω–∞—á–µ–Ω–∏—è `state` —Ä–∞–∑–ª–∏—á–∞—é—Ç—Å—è.

**–ü—Ä–∏–º–µ—Ä:**
```
üöó FK288FF (Toyota Camry)
   RentProg: –ú–æ–∂–Ω–æ –≤—ã–¥–∞–≤–∞—Ç—å (üü¢)
   –ë–î: –í —Ä–µ–º–æ–Ω—Ç–µ (‚ö´)
```

### 2. Missing in DB (–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –ë–î)
–ú–∞—à–∏–Ω–∞ –µ—Å—Ç—å –≤ RentProg, –Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –ë–î.

**–ü—Ä–∏–º–µ—Ä:**
```
üöó GG134HG (Hyundai Elantra)
   ‚ö†Ô∏è –ï—Å—Ç—å –≤ RentProg, –ù–ï–¢ –≤ –ë–î
   State –≤ RentProg: –ú–æ–∂–Ω–æ –≤—ã–¥–∞–≤–∞—Ç—å (üü¢)
```

---

## üé® –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ state

| State | –ó–Ω–∞—á–µ–Ω–∏–µ | –¶–≤–µ—Ç | –≠–º–æ–¥–∑–∏ |
|-------|----------|------|--------|
| 1 | –ú–æ–∂–Ω–æ –≤—ã–¥–∞–≤–∞—Ç—å | –ó–µ–ª—ë–Ω—ã–π | üü¢ |
| 2 | –í —Ä–µ–º–æ–Ω—Ç–µ | –°–µ—Ä—ã–π | ‚ö´ |
| 3 | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ | –ö—Ä–∞—Å–Ω—ã–π | üî¥ |
| 4 | –í –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π –∞—Ä–µ–Ω–¥–µ | –†–æ–∑–æ–≤—ã–π | ü©∑ |
| 5 | –ù–µ –≤—ã–¥–∞–≤–∞—Ç—å | –ì–æ–ª—É–±–æ–π | üîµ |
| 6 | –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ | –û—Ä–∞–Ω–∂–µ–≤—ã–π | üü† |
| null/undefined | –ù–µ —É–∫–∞–∑–∞–Ω | - | - |

---

## üì± –§–æ—Ä–º–∞—Ç Telegram –∞–ª–µ—Ä—Ç–∞

```
‚ö†Ô∏è –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π

üè¢ –§–∏–ª–∏–∞–ª: –¢–±–∏–ª–∏—Å–∏ (tbilisi)
üìä –ú–∞—à–∏–Ω –≤ RentProg: 45
üìä –ú–∞—à–∏–Ω –≤ –ë–î: 40
‚ùå –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π: 8

üìã –î–µ—Ç–∞–ª–∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π:

üöó FK288FF (Toyota Camry)
   RentProg: –ú–æ–∂–Ω–æ –≤—ã–¥–∞–≤–∞—Ç—å (üü¢)
   –ë–î: –ù–µ —É–∫–∞–∑–∞–Ω

üöó GG134HG (Hyundai Elantra)
   RentProg: –í —Ä–µ–º–æ–Ω—Ç–µ (‚ö´)
   –ë–î: –ú–æ–∂–Ω–æ –≤—ã–¥–∞–≤–∞—Ç—å (üü¢)

... –∏ –µ—â—ë 6 –º–∞—à–∏–Ω

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üïê 09.11.2025, 04:00:15
```

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –¥–æ 20 —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π
- –ü—Ä–∏ –±–æ–ª—å—à–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –≤—ã–≤–æ–¥–∏—Ç—Å—è: `... –∏ –µ—â—ë N –º–∞—à–∏–Ω`

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –¢—Ä–µ–±—É–µ–º—ã–µ Credentials

1. **PostgreSQL (Neon)** 
   - Credential ID: `postgres_neon`
   - –ù–∞–∑–≤–∞–Ω–∏–µ: `PostgreSQL (Neon)`

2. **Telegram Bot**
   - Credential ID: `telegram_alert_bot`
   - –ù–∞–∑–≤–∞–Ω–∏–µ: `Telegram Alert Bot`
   - –ß–∞—Ç –¥–ª—è –∞–ª–µ—Ä—Ç–æ–≤: `-5004140602`

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º

1. –û—Ç–∫—Ä–æ–π—Ç–µ workflow –≤ n8n
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—Å–µ –Ω–æ–¥—ã –∑–µ–ª—ë–Ω—ã–µ (–±–µ–∑ –∫—Ä–∞—Å–Ω—ã—Ö —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤)
3. –ï—Å–ª–∏ –µ—Å—Ç—å –∫—Ä–∞—Å–Ω—ã–µ –Ω–æ–¥—ã - –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ credentials
4. –°–¥–µ–ª–∞–π—Ç–µ **Test Run** –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
5. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ workflow

---

## üöÄ –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫

### –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ workflow

1. –û—Ç–∫—Ä–æ–π—Ç–µ: https://n8n.rentflow.rentals/workflow/j6yLX6GZcE9t5ZcO
2. –ù–∞–∂–º–∏—Ç–µ **"Execute Workflow"** (–ø—Ä–∞–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª)
3. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –∫–∞–∂–¥–æ–π –Ω–æ–¥–µ
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram —á–∞—Ç –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∞–ª–µ—Ä—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è)

### –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –æ–¥–Ω–æ–π –Ω–æ–¥—ã

–î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –∫–∞–∂–¥—É—é –Ω–æ–¥—É –æ—Ç–¥–µ–ª—å–Ω–æ:

1. –í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–¥—É
2. –ù–∞–∂–º–∏—Ç–µ **"Execute Node"**
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ OUTPUT —Å–ø—Ä–∞–≤–∞

---

## üîç SQL Query –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

Workflow –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π SQL –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–∞—à–∏–Ω –∏–∑ –ë–î:

```sql
SELECT 
  c.id,
  c.plate,
  c.model,
  c.data->>'state' as state_in_db,
  er.external_id as rentprog_id
FROM cars c
INNER JOIN external_refs er ON er.entity_id = c.id
INNER JOIN branches b ON b.id = c.branch_id
WHERE er.system = 'rentprog'
  AND er.entity_type = 'car'
  AND b.code = '{{ $json.branchCode }}'
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è External References pattern
- –°–≤—è–∑—å —á–µ—Ä–µ–∑ `external_refs.external_id` = RentProg ID
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ñ–∏–ª–∏–∞–ª—É —á–µ—Ä–µ–∑ `branches.code`
- State —á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ JSONB –ø–æ–ª—è `data->>'state'`

---

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ì–¥–µ —Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

1. **Telegram —á–∞—Ç** `-5004140602` - –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è—Ö
2. **n8n Executions** - –∏—Å—Ç–æ—Ä–∏—è –∑–∞–ø—É—Å–∫–æ–≤ workflow
3. **–ë–î —Ç–∞–±–ª–∏—Ü–∞ `cars`** - —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–∞—à–∏–Ω –≤ data->>'state'

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è—Ö

1. **State Mismatch:**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∞—à–∏–Ω—ã
   - –û–±–Ω–æ–≤–∏—Ç—å state –≤ RentProg –∏–ª–∏ –ë–î

2. **Missing in DB:**
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å Cars Snapshot workflow –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å external_refs

---

## üîß Troubleshooting

### –û—à–∏–±–∫–∞: "Invalid credentials"

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π company token  
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –≤ –Ω–æ–¥–µ "Prepare Branches"

### –û—à–∏–±–∫–∞: "The resource you are requesting could not be found"

**–ü—Ä–∏—á–∏–Ω–∞:** Endpoint `/all_cars` –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω  
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å URL –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω

### –û—à–∏–±–∫–∞: "Connection to PostgreSQL failed"

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ credentials –¥–ª—è –ë–î  
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å credential `postgres_neon`

### –ù–µ—Ç –∞–ª–µ—Ä—Ç–æ–≤ –≤ Telegram

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ—Ç —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π credential  
**–†–µ—à–µ–Ω–∏–µ:** 
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å credential `telegram_alert_bot`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å chat ID `-5004140602`
- –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–≤–æ–¥ –Ω–æ–¥—ã "If Has Discrepancy"

---

## üìù –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

**2025-11-09:**
- ‚úÖ –°–æ–∑–¥–∞–Ω workflow
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã company tokens –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ
- ‚úÖ –ò–∑–º–µ–Ω—ë–Ω endpoint —Å `/cars?per_page=100` –Ω–∞ `/all_cars`
- ‚úÖ –ò–∑–º–µ–Ω—ë–Ω –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å `X-Request-Token` –Ω–∞ `Authorization`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∑–∞–≥–æ–ª–æ–≤–æ–∫ `Accept: application/json`

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [AGENTS.md](../AGENTS.md) - –û–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö –∞–≥–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã
- [STRUCTURE.md](../STRUCTURE.md) - –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –ë–î
- [RENTPROG_ENV_VALUES.md](../RENTPROG_ENV_VALUES.md) - Company tokens –¥–ª—è RentProg

---

## üéØ TODO

- [ ] –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ state –≤ –ë–î –ø—Ä–∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è—Ö
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º (—Å–∫–æ–ª—å–∫–æ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –ø–æ –∫–∞–∂–¥–æ–º—É)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π state (audit log)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É deleted –º–∞—à–∏–Ω

