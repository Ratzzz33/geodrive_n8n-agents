# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è Entity Timeline & Event Links - –ó–∞–≤–µ—Ä—à–µ–Ω–æ

**–î–∞—Ç–∞:** 2025-11-10  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã

---

## üéØ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–¥ –∏—Å–∫–∞–ª —Å–æ–±—ã—Ç–∏—è —Å `entity_type = 'payment'`, –Ω–æ —Ç–∞–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π –Ω–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ `events`.

**–†–µ—à–µ–Ω–∏–µ:** –ò–∑–º–µ–Ω–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –≤ `src/db/eventLinks.ts`:

1. **–ü–æ–∏—Å–∫ —á–µ—Ä–µ–∑ booking_id:**
   - –ù–∞—Ö–æ–¥–∏—Ç `booking_id` –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ `external_refs` –∏ `payments`
   - –ò—â–µ—Ç —Å–æ–±—ã—Ç–∏—è –æ bookings (`entity_type = 'booking'`) —Å —ç—Ç–∏–º `booking_id`
   - –§–∏–ª—å—Ç—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏—è –ø–æ —Ç–∏–ø–∞–º: `issue`, `return`, `prolong`, `update`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–ª–∞—Ç–µ–∂–∞—Ö –≤ `payload`

2. **–ü—Ä—è–º–æ–π –ø–æ–∏—Å–∫ –≤ payload:**
   - –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —á–µ—Ä–µ–∑ booking, –∏—â–µ—Ç `payment_id` –Ω–∞–ø—Ä—è–º—É—é –≤ `payload` —Å–æ–±—ã—Ç–∏–π
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–ª—è: `id`, `payment_id`, `count_id`

3. **–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –≤ history:**
   - –ò—â–µ—Ç –∑–∞–ø–∏—Å–∏ –æ –ø–ª–∞—Ç–µ–∂–∞—Ö (`entity_type = 'payment'`)
   - –ò–ª–∏ –∑–∞–ø–∏—Å–∏ –æ bookings (`entity_type = 'booking'`) —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –ø–ª–∞—Ç–µ–∂–æ–º

**–§–∞–π–ª:** `src/db/eventLinks.ts` (—Å—Ç—Ä–æ–∫–∏ 144-276)

---

### 2. –û–±—Ä–∞–±–æ—Ç–∞–Ω—ã –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:** 77 —Å–æ–±—ã—Ç–∏–π –±—ã–ª–∏ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã (`processed = false`).

**–†–µ—à–µ–Ω–∏–µ:** 
- –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `setup/process_unprocessed_events_direct.mjs`
- –í—Å–µ 77 —Å–æ–±—ã—Ç–∏–π –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ
- –û—Å—Ç–∞–ª–æ—Å—å –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö: **0**

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –†–µ–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ n8n workflow "RentProg Upsert Processor", –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è.

---

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### Entity Timeline
- ‚úÖ **–ü–æ–∫—Ä—ã—Ç–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π:** 95.5% (3,633 –∏–∑ 3,804)
- ‚úÖ **GPS —Å–æ–±—ã—Ç–∏—è:** 10,803 (Starline)
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–ø–∏—Å—å:** –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π, GPS –∏ –≤–µ–±—Ö—É–∫–æ–≤

### Event Links
- ‚úÖ **–õ–æ–≥–∏–∫–∞ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞, —Ç–µ–ø–µ—Ä—å –∏—â–µ—Ç —Å–æ–±—ã—Ç–∏—è –æ bookings
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ:** –ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è:** 100% (507 –∏–∑ 507)

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

**–§–∞–π–ª:** `src/db/eventLinks.ts`

**–û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**

1. **–ü–æ–∏—Å–∫ booking_id –ø–ª–∞—Ç–µ–∂–∞:**
```typescript
// –ù–∞—Ö–æ–¥–∏—Ç booking_id —á–µ—Ä–µ–∑ external_refs –∏ payments
// –ó–∞—Ç–µ–º –∏—â–µ—Ç booking_rp_id –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–æ–±—ã—Ç–∏–π
```

2. **–ü–æ–∏—Å–∫ —Å–æ–±—ã—Ç–∏–π –æ bookings:**
```sql
SELECT id, ts, rentprog_id, payload, type
FROM events
WHERE 
  entity_type = 'booking'
  AND rentprog_id = ${bookingRpId}
  AND company_id = ${companyId}
  AND (
    type LIKE '%issue%' 
    OR type LIKE '%return%' 
    OR type LIKE '%prolong%'
    OR type LIKE '%update%'
  )
  AND ABS(EXTRACT(EPOCH FROM (ts - ${paymentDate}::timestamptz))) < ${timeWindowSeconds}
  AND (
    payload::text LIKE '%payment%'
    OR payload::text LIKE '%count%'
    OR payload::text LIKE '%${rpPaymentId}%'
  )
```

3. **–ü—Ä—è–º–æ–π –ø–æ–∏—Å–∫ –≤ payload:**
```sql
-- –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —á–µ—Ä–µ–∑ booking, –∏—â–µ–º –Ω–∞–ø—Ä—è–º—É—é
payload::text LIKE '%"id":${rpPaymentId}%'
OR payload::text LIKE '%"payment_id":${rpPaymentId}%'
OR payload::text LIKE '%"count_id":${rpPaymentId}%'
```

---

## üöÄ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ‚ùå –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ: 0% (–Ω–µ —Ä–∞–±–æ—Ç–∞–ª–æ)
- ‚ö†Ô∏è –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è: 77

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ: –ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ (–ª–æ–≥–∏–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞)
- ‚úÖ –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è: 0 (–≤—Å–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã)

---

## üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### 1. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
- –°–æ–∑–¥–∞—é—Ç—Å—è –ª–∏ —Å–≤—è–∑–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- –†–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –ø–æ–∏—Å–∫ —Å–æ–±—ã—Ç–∏–π –æ bookings
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å–≤—è–∑—ã–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ `booking_id`

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –ß–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è
node setup/check_entity_timeline_status.mjs
```

### 2. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –±—ç–∫—Ñ–∏–ª –ø–ª–∞—Ç–µ–∂–µ–π

–î–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è 100% –ø–æ–∫—Ä—ã—Ç–∏—è Entity Timeline –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Å—Ç–∞–≤—à–∏–µ—Å—è 171 –ø–ª–∞—Ç–µ–∂:

```bash
node setup/backfill_entity_timeline.mjs
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ë—ç–∫—Ñ–∏–ª –Ω–µ –∫—Ä–∏—Ç–∏—á–µ–Ω, —Ç–∞–∫ –∫–∞–∫ –ø–æ–∫—Ä—ã—Ç–∏–µ —É–∂–µ —Ö–æ—Ä–æ—à–µ–µ (95.5%).

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è

–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã —Å–≤—è–∑—ã–≤–∞–Ω–∏—è –º–æ–∂–Ω–æ:
1. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ workflow
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Å–≤—è–∑–∏ —á–µ—Ä–µ–∑ API:
   ```bash
   curl http://46.224.17.15:3000/event-links/payment/{paymentId}
   ```
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:
   ```bash
   curl http://46.224.17.15:3000/event-links/stats
   ```

---

## üìù –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **`setup/process_unprocessed_events.mjs`** - –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ Jarvis API (—Ç—Ä–µ–±—É–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API)
2. **`setup/process_unprocessed_events_direct.mjs`** - –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ –ë–î ‚úÖ
3. **`docs/ENTITY_TIMELINE_EVENT_LINKS_AUDIT_REPORT.md`** - –û—Ç—á–µ—Ç –æ –ø—Ä–æ–≤–µ—Ä–∫–µ
4. **`docs/ENTITY_TIMELINE_EVENT_LINKS_FIXES_COMPLETE.md`** - –≠—Ç–æ—Ç –æ—Ç—á–µ—Ç

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å

**–í—Å–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:**

1. ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è** - —Ç–µ–ø–µ—Ä—å –∏—â–µ—Ç —Å–æ–±—ã—Ç–∏—è –æ bookings
2. ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∞–Ω—ã –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è** - –≤—Å–µ 77 —Å–æ–±—ã—Ç–∏–π –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ
3. ‚úÖ **–ö–æ–¥ –≥–æ—Ç–æ–≤ –∫ –¥–µ–ø–ª–æ—é** - –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ `src/db/eventLinks.ts`

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!** üöÄ

---

**–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ:** AI Agent  
**–î–∞—Ç–∞:** 2025-11-10

