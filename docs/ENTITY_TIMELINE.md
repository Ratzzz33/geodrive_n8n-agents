# Entity Timeline - –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ª–æ–≥ —Å–æ–±—ã—Ç–∏–π

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-11-09  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

`entity_timeline` - –¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –µ–¥–∏–Ω–æ–π –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ª–∏–Ω–∏–∏ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π –ø–æ —Å—É—â–Ω–æ—Å—Ç—è–º –ø—Ä–æ–∫–∞—Ç–∞. –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (events, history, payments, starline) –≤ –µ–¥–∏–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –¥–ª—è —É–¥–æ–±–Ω–æ–π —Ä–∞–±–æ—Ç—ã –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏ –∞–≥–µ–Ω—Ç–æ–≤.

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã

```sql
CREATE TABLE entity_timeline (
  id BIGSERIAL PRIMARY KEY,
  ts TIMESTAMPTZ NOT NULL DEFAULT now(),
  
  -- –°–≤—è–∑—å —Å —Å—É—â–Ω–æ—Å—Ç—å—é
  entity_type TEXT NOT NULL,  -- 'car' | 'booking' | 'client' | 'employee' | 'payment' | 'branch'
  entity_id UUID NOT NULL,    -- UUID –∏–∑ –±–∞–∑–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü
  
  -- –ò—Å—Ç–æ—á–Ω–∏–∫ —Å–æ–±—ã—Ç–∏—è
  source_type TEXT NOT NULL,  -- 'rentprog_webhook' | 'rentprog_history' | 'starline' | 'telegram' | 'manual' | 'system'
  source_id TEXT,              -- ID –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
  
  -- –¢–∏–ø —Å–æ–±—ã—Ç–∏—è
  event_type TEXT NOT NULL,   -- 'booking.created' | 'car.gps_updated' | 'payment.received'
  operation TEXT,              -- 'create' | 'update' | 'delete' | 'move' | 'status_change'
  
  -- –î–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
  summary TEXT,               -- –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
  details JSONB,              -- –î–µ—Ç–∞–ª–∏ —Å–æ–±—ã—Ç–∏—è
  
  -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  branch_code TEXT,           -- –ö–æ–¥ —Ñ–∏–ª–∏–∞–ª–∞
  user_name TEXT,             -- –ö—Ç–æ –≤—ã–ø–æ–ª–Ω–∏–ª –æ–ø–µ—Ä–∞—Ü–∏—é
  confidence TEXT,            -- 'high' | 'medium' | 'low'
  
  -- –°–≤—è–∑–∏ —Å –¥—Ä—É–≥–∏–º–∏ —Å—É—â–Ω–æ—Å—Ç—è–º–∏
  related_entities JSONB,     -- [{"type": "booking", "id": "uuid"}, ...]
  
  created_at TIMESTAMPTZ DEFAULT now()
);
```

---

## üîç –ò–Ω–¥–µ–∫—Å—ã

- `idx_entity_timeline_entity` - –ø–æ–∏—Å–∫ –ø–æ —Å—É—â–Ω–æ—Å—Ç–∏ –∏ –≤—Ä–µ–º–µ–Ω–∏
- `idx_entity_timeline_source` - –ø–æ–∏—Å–∫ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫—É
- `idx_entity_timeline_event` - –ø–æ–∏—Å–∫ –ø–æ —Ç–∏–ø—É —Å–æ–±—ã—Ç–∏—è
- `idx_entity_timeline_branch` - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ñ–∏–ª–∏–∞–ª—É
- `idx_entity_timeline_ts` - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
- `idx_entity_timeline_entity_ts` - –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- GIN –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è JSONB –ø–æ–ª–µ–π (`details`, `related_entities`)

---

## üì° API Endpoints

### GET `/entity-timeline/entity/:entityType/:entityId`

–ü–æ–ª—É—á–∏—Ç—å timeline –¥–ª—è —Å—É—â–Ω–æ—Å—Ç–∏.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `entityType` - —Ç–∏–ø —Å—É—â–Ω–æ—Å—Ç–∏ (car, booking, client, etc)
- `entityId` - UUID —Å—É—â–Ω–æ—Å—Ç–∏

**Query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `limit` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 100)
- `offset` - —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
- `eventTypes` - —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø–∞–º —Å–æ–±—ã—Ç–∏–π (–º–∞—Å—Å–∏–≤)
- `sourceTypes` - —Ñ–∏–ª—å—Ç—Ä –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º (–º–∞—Å—Å–∏–≤)
- `startDate` - –Ω–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞
- `endDate` - –∫–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞

**–ü—Ä–∏–º–µ—Ä:**
```bash
curl "http://localhost:3000/entity-timeline/entity/car/123e4567-e89b-12d3-a456-426614174000?limit=50&startDate=2025-11-01"
```

---

### POST `/entity-timeline/related`

–ü–æ–ª—É—á–∏—Ç—å timeline –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –ø–æ –±—Ä–æ–Ω–∏ –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–º –º–∞—à–∏–Ω–µ/–∫–ª–∏–µ–Ω—Ç—É).

**Body:**
```json
{
  "entities": [
    { "type": "booking", "id": "uuid" },
    { "type": "car", "id": "uuid" },
    { "type": "client", "id": "uuid" }
  ],
  "limit": 100,
  "offset": 0,
  "startDate": "2025-11-01T00:00:00Z",
  "endDate": "2025-11-09T23:59:59Z"
}
```

---

### GET `/entity-timeline/stats`

–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ timeline.

**Query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `entityType` - —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É —Å—É—â–Ω–æ—Å—Ç–∏
- `branchCode` - —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ñ–∏–ª–∏–∞–ª—É
- `startDate` - –Ω–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞
- `endDate` - –∫–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞

**–ü—Ä–∏–º–µ—Ä:**
```bash
curl "http://localhost:3000/entity-timeline/stats?entityType=car&branchCode=tbilisi"
```

---

## üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–ø–∏—Å—å –≤ timeline

### 1. –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ `savePaymentFromRentProg()` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ timeline:

```typescript
await addPaymentToTimeline(paymentId, branch, {
  amount: "1000",
  currency: "GEL",
  description: "–û–ø–ª–∞—Ç–∞ –±—Ä–æ–Ω–∏",
  bookingId: "...",
  clientId: "...",
});
```

**–°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å:**
- `entity_type`: `'payment'`
- `source_type`: `'rentprog_history'`
- `event_type`: `'payment.received'`
- `operation`: `'create'`
- `related_entities`: `[{type: 'booking', id: '...'}, {type: 'client', id: '...'}]`

---

### 2. –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–µ–±—Ö—É–∫–æ–≤

–ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–µ–±—Ö—É–∫–∞ —á–µ—Ä–µ–∑ `handleRentProgEvent()` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å:

```typescript
await addWebhookToTimeline('booking', bookingId, {
  eventType: 'booking.issue.planned',
  operation: 'update',
  summary: '–ë—Ä–æ–Ω—å booking.issue.planned: 470049',
  details: { rentprog_id: '470049', ... },
  branchCode: 'tbilisi',
  relatedEntities: [{type: 'car', id: '...'}, {type: 'client', id: '...'}],
});
```

**–°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å:**
- `entity_type`: `'booking'` (–∏–ª–∏ `'car'`, `'client'`)
- `source_type`: `'rentprog_webhook'`
- `event_type`: –∏–∑ –≤–µ–±—Ö—É–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `'booking.issue.planned'`)
- `operation`: `'create'` | `'update'` | `'delete'`

---

### 3. –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ GPS

–ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ GPS –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —á–µ—Ä–µ–∑ `updateGPSData()` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º–∞—à–∏–Ω–∞ –¥–≤–∏–∂–µ—Ç—Å—è –∏–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å):

```typescript
await addGPSToTimeline(carId, {
  lat: 41.7151,
  lng: 44.8271,
  isMoving: true,
  distance: 150,
  speed: 60,
  branchCode: 'tbilisi',
});
```

**–°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å:**
- `entity_type`: `'car'`
- `source_type`: `'starline'`
- `event_type`: `'car.gps_updated'`
- `operation`: `'update'`
- `details`: `{lat, lng, isMoving, distance, speed}`

---

## üìà SQL Views

### `entity_timeline_stats`

–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–±—ã—Ç–∏–π –ø–æ —Ç–∏–ø–∞–º:

```sql
SELECT * FROM entity_timeline_stats;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- `entity_type` - —Ç–∏–ø —Å—É—â–Ω–æ—Å—Ç–∏
- `event_type` - —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è
- `source_type` - –∏—Å—Ç–æ—á–Ω–∏–∫
- `operation` - –æ–ø–µ—Ä–∞—Ü–∏—è
- `total_events` - –≤—Å–µ–≥–æ —Å–æ–±—ã—Ç–∏–π
- `unique_entities` - —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
- `first_event` - –ø–µ—Ä–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ
- `last_event` - –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–±—ã—Ç–∏–µ

---

### `entity_timeline_recent`

–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–π —Å—É—â–Ω–æ—Å—Ç–∏:

```sql
SELECT * FROM entity_timeline_recent;
```

---

## üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π

–§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ –∑–∞–ø–∏—Å–µ–π —Å—Ç–∞—Ä—à–µ N –¥–Ω–µ–π:

```sql
SELECT cleanup_old_timeline_entries(365); -- –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å–∏ —Å—Ç–∞—Ä—à–µ 1 –≥–æ–¥–∞
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å cron job –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–∞–∑ –≤ –º–µ—Å—è—Ü).

---

## üí° –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –î–ª—è –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞

```typescript
// –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –ø–æ –º–∞—à–∏–Ω–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
const timeline = await getTimelineForEntity('car', carId, {
  limit: 100,
  startDate: new Date(Date.now() - 3600000),
});

// –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –ø–æ –±—Ä–æ–Ω–∏ –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–º —Å—É—â–Ω–æ—Å—Ç—è–º
const relatedTimeline = await getTimelineForRelatedEntities([
  { type: 'booking', id: bookingId },
  { type: 'car', id: carId },
  { type: 'client', id: clientId },
], {
  limit: 200,
});
```

### –î–ª—è –∞–≥–µ–Ω—Ç–æ–≤

```typescript
// –ê–≥–µ–Ω—Ç –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä –±—Ä–æ–Ω–µ–π - –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –ø–æ –±—Ä–æ–Ω–∏
const bookingEvents = await getTimelineForEntity('booking', bookingId, {
  eventTypes: ['booking.issue.planned', 'booking.return.planned'],
  limit: 50,
});

// –ê–≥–µ–Ω—Ç —Å–ª—É–∂–µ–±–Ω—ã—Ö –ø–æ–µ–∑–¥–æ–∫ - –ø–æ–ª—É—á–∏—Ç—å GPS —Å–æ–±—ã—Ç–∏—è
const gpsEvents = await getTimelineForEntity('car', carId, {
  sourceTypes: ['starline'],
  eventTypes: ['car.gps_updated'],
  limit: 100,
});
```

---

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –¥–æ—Å—Ç—É–ø–∞** - –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
2. **–ë—ã—Å—Ç—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã** - –±–µ–∑ JOIN –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏
3. **–•—Ä–æ–Ω–æ–ª–æ–≥–∏—è** - –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –≤ –ø–æ—Ä—è–¥–∫–µ –≤—Ä–µ–º–µ–Ω–∏
4. **–ì–∏–±–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è** - –ø–æ —Ç–∏–ø—É, –∏—Å—Ç–æ—á–Ω–∏–∫—É, —Ñ–∏–ª–∏–∞–ª—É
5. **–°–≤—è–∑–∞–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏** - –ª–µ–≥–∫–æ –Ω–∞–π—Ç–∏ –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –ø–æ —Å–≤—è–∑–∞–Ω–Ω—ã–º –æ–±—ä–µ–∫—Ç–∞–º

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è** - –¥–∞–Ω–Ω—ã–µ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è –∏–∑ –∏—Å—Ö–æ–¥–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —á—Ç–µ–Ω–∏—è
2. **–ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ** - –∑–∞–ø–∏—Å—å –≤ timeline –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é (try/catch)
3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è** - —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π
4. **–ò–Ω–¥–µ–∫—Å—ã** - –≤—Å–µ –∏–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π (cron)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ timeline –¥–ª—è –¥—Ä—É–≥–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (telegram, manual)
- [ ] –°–æ–∑–¥–∞—Ç—å –¥–∞—à–±–æ—Ä–¥ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ timeline
- [ ] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö

