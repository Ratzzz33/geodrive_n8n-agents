# ‚úÖ –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ Workflow: –ü–∞—Ä—Å–∏–Ω–≥ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π

**Workflow ID:** `u3cOUuoaH5RSw7hm`  
**URL:** https://n8n.rentflow.rentals/workflow/u3cOUuoaH5RSw7hm  
**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 2025-01-21

---

## üìã –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### 1. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∑–∞—Ç–∏—Ä–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –Ω–æ–¥–µ "Save Snapshot"

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –í `DO UPDATE SET` –Ω–µ –±—ã–ª–æ –∑–∞—â–∏—Ç—ã –æ—Ç –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫ `''` –∏ `NULL`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è —Ç–æ–ª—å–∫–æ `NULLIF($X, 'null')`, —á—Ç–æ –∑–∞—â–∏—â–∞–ª–æ —Ç–æ–ª—å–∫–æ –æ—Ç —Å—Ç—Ä–æ–∫–∏ `'null'`
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∑–∞—Ç–∏—Ä–∞–ª–∏—Å—å –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—É—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –∏–∑ API

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–ª–µ–Ω `COALESCE` –≤ `DO UPDATE SET` –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π:
```sql
DO UPDATE SET
  car_name = COALESCE(NULLIF(EXCLUDED.car_name, ''), tgt.car_name),
  code = COALESCE(NULLIF(EXCLUDED.code, ''), tgt.code),
  vin = COALESCE(NULLIF(EXCLUDED.vin, ''), tgt.vin),
  ...
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ü—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –Ω–µ –∑–∞—Ç–∏—Ä–∞—é—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ
- ‚úÖ `NULL` –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ –∑–∞—Ç–∏—Ä–∞—é—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

---

### 2. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è `undefined` –∑–Ω–∞—á–µ–Ω–∏–π –≤ –Ω–æ–¥–µ "Merge & Process"

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ API –ø–æ–ª—è —Å `undefined` –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ø–µ—Ä–µ–¥–∞–≤–∞–ª–∏—Å—å –≤ SQL
- –≠—Ç–æ –º–æ–≥–ª–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –∑–∞—Ç–∏—Ä–∞–Ω–∏—é –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–∏ `undefined` ‚Üí –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `safeValue` –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ `undefined`, `null` –∏ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫:
```javascript
const safeValue = (value) => {
  if (value === undefined || value === null || value === '') {
    return undefined;  // –ù–µ –ø–µ—Ä–µ–¥–∞–µ–º –≤ SQL, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Ç–µ—Ä–µ—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ
  }
  return value;
};
```

–ü—Ä–∏–º–µ–Ω–µ–Ω–∞ –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –ø–æ–ª–µ–π:
- `car_name`, `code`, `number`, `vin`, `color`
- `transmission`, `fuel`, `car_type`, `car_class`, `state`
- `tire_size`, `last_inspection`, `purchase_date`
- `engine_capacity`, `pts`, `registration_certificate`, `body_number`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ `undefined` –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ SQL
- ‚úÖ –ü—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ SQL
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞—Ç–∏—Ä–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —É—Ä–æ–≤–Ω–µ JavaScript

---

### 3. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –æ—Å–Ω–æ–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É `cars`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –≤ `rentprog_car_states_snapshot` (snapshot —Ç–∞–±–ª–∏—Ü–∞)
- –¶–µ–Ω—ã –Ω–µ –º–æ–≥–ª–∏ –±—ã—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã, —Ç.–∫. –Ω–æ–¥–∞ "Find Car ID" –∏—â–µ—Ç –º–∞—à–∏–Ω—É –≤ —Ç–∞–±–ª–∏—Ü–µ `cars`
- –î–∞–Ω–Ω—ã–µ –±—ã–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤, —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö —Å —Ç–∞–±–ª–∏—Ü–µ–π `cars`

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–¥–∞ "Save to Cars" –ø–æ—Å–ª–µ "Save Snapshot":
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `dynamic_upsert_entity` –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –æ—Å–Ω–æ–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É `cars`
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ `data` (JSONB)
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –≤ –ø–æ—Ç–æ–∫: `Save Snapshot` ‚Üí `Save to Cars` ‚Üí `Pass Through Data`

**SQL –∑–∞–ø—Ä–æ—Å:**
```sql
SELECT * FROM dynamic_upsert_entity(
  'cars'::TEXT,
  $1::TEXT,  -- rentprog_id
  $2::JSONB  -- data
);
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –æ—Å–Ω–æ–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É `cars`
- ‚úÖ –¶–µ–Ω—ã –º–æ–≥—É—Ç –±—ã—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã (–º–∞—à–∏–Ω–∞ –Ω–∞–π–¥–µ–Ω–∞ –≤ `cars`)
- ‚úÖ –î–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤

---

## üîó –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –°–¢–†–£–ö–¢–£–†–ê WORKFLOW

### –ü–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏:
1. **Every 5 min** ‚Üí –∑–∞–ø—É—Å–∫–∞–µ—Ç 4 –≤–µ—Ç–∫–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
2. **Get Tbilisi/Batumi/Kutaisi/Service** ‚Üí HTTP –∑–∞–ø—Ä–æ—Å—ã –∫ RentProg API
3. **Wait for All Branches** ‚Üí –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
4. **Merge & Process** ‚Üí –ø–∞—Ä—Å–∏—Ç –¥–∞–Ω–Ω—ã–µ, —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç `undefined` ‚úÖ
5. **Split Cars and Prices** ‚Üí —Ä–∞–∑–¥–µ–ª—è–µ—Ç –º–∞—à–∏–Ω—ã –∏ —Ü–µ–Ω—ã
6. **Save Snapshot** ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ snapshot —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –∑–∞—Ç–∏—Ä–∞–Ω–∏—è ‚úÖ
7. **Save to Cars** ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –æ—Å–Ω–æ–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É `cars` ‚úÖ
8. **Pass Through Data** ‚Üí –ø–µ—Ä–µ–¥–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–∞–ª—å—à–µ
9. **Format Result** ‚Üí —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
10. **If Error** ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ—à–∏–±–∫–∏
11. **Send Alert / Success** ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### –ù–æ–≤—ã–µ connections:
- `Save Snapshot` ‚Üí `Save to Cars` ‚Üí `Pass Through Data`

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:
1. ‚úÖ –ù–æ–¥–∞ "Save Snapshot" –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —Å `COALESCE` –≤ `DO UPDATE SET`
2. ‚úÖ –ù–æ–¥–∞ "Merge & Process" –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —Å —Ñ—É–Ω–∫—Ü–∏–µ–π `safeValue`
3. ‚úÖ –ù–æ–¥–∞ "Save to Cars" –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞
4. ‚úÖ Connections –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
5. ‚úÖ Workflow —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–∞–ª–∏–¥–Ω–∞

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
- **–í—Å–µ–≥–æ –Ω–æ–¥:** 28
- **Connections:** 25
- **–ù–æ–≤—ã–µ –Ω–æ–¥—ã:** 1 ("Save to Cars")
- **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –Ω–æ–¥—ã:** 2 ("Save Snapshot", "Merge & Process")

---

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚ùå –ó–∞—Ç–∏—Ä–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
- ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –æ—Å–Ω–æ–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É `cars`
- ‚ùå –¶–µ–Ω—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å (–º–∞—à–∏–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ `cars`)

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞—Ç–∏—Ä–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (COALESCE + safeValue)
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –æ—Å–Ω–æ–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É `cars`
- ‚úÖ –¶–µ–Ω—ã –º–æ–≥—É—Ç –±—ã—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
- ‚úÖ –î–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤

---

## üìù –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. ‚úÖ **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å workflow** - –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
2. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö** - —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞—Ç–∏—Ä–∞—é—Ç—Å—è
3. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ü–µ–Ω** - —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ü–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
4. ‚úÖ **–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å workflow** - –≤–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç

---

**–í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!** üéâ

