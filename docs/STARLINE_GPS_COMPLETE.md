# ‚úÖ Starline GPS Monitor - –ü–û–õ–ù–û–°–¢–¨–Æ –†–ê–ë–û–¢–ê–ï–¢

**–î–∞—Ç–∞:** 2025-11-09  
**–°—Ç–∞—Ç—É—Å:** üéâ –ì–û–¢–û–í–û –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ

---

## üöÄ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. Persistent Playwright Scraper (Jarvis API)

‚úÖ **–°–æ–∑–¥–∞–Ω —Å–µ—Ä–≤–∏—Å `StarlineScraperService`:**
- –ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è –±—Ä–∞—É–∑–µ—Ä–Ω–∞—è —Å–µ—Å—Å–∏—è (Chromium headless)
- –õ–æ–≥–∏–Ω –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ, –¥–∞–ª–µ–µ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
- Auto-reconnect –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ –±—Ä–∞—É–∑–µ—Ä–∞
- Health check endpoint

‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: ~7 —Å–µ–∫—É–Ω–¥ (–ª–æ–≥–∏–Ω)
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤: ~500ms (120 —É—Å—Ç—Ä–æ–π—Å—Ç–≤)
- –î–µ—Ç–∞–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: ~300ms
- **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ:** –ù–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ª–æ–≥–∏–Ω–æ–≤ ‚Üí —Å—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞

‚úÖ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- –õ–æ–∫–∞–ª—å–Ω–æ–µ: ‚úÖ PASS (267ms –¥–ª—è 120 —É—Å—Ç—Ä–æ–π—Å—Ç–≤)
- –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ: ‚úÖ PASS (initialized and logged in)

---

### 2. Systemd –°–µ—Ä–≤–∏—Å –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞

‚úÖ **–°–æ–∑–¥–∞–Ω `jarvis-api.service`:**
- –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–µ—Ä–≤–µ—Ä–∞
- Auto-restart –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ (–∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥)
- Graceful shutdown (–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `/var/log/jarvis-api.log` –∏ `journalctl`

‚úÖ **–£—Å—Ç–∞–Ω–æ–≤–∫–∞:**
```bash
bash setup/install_jarvis_service.sh
```

‚úÖ **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```bash
sudo systemctl status jarvis-api     # –°—Ç–∞—Ç—É—Å
sudo systemctl restart jarvis-api    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
sudo journalctl -u jarvis-api -f     # –õ–æ–≥–∏
```

‚úÖ **–°—Ç–∞—Ç—É—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:** `active (running)` ‚úÖ

---

### 3. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (PostgreSQL)

‚úÖ **–°–æ–∑–¥–∞–Ω—ã —Ç–∞–±–ª–∏—Ü—ã:**

**`starline_devices`** - –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ Starline:
- `device_id` (IMEI) - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
- `alias` - –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ Starline (–Ω–∞–ø—Ä–∏–º–µ—Ä, "BMW 3 587")
- `car_id` - —Å–≤—è–∑—å —Å —Ç–∞–±–ª–∏—Ü–µ–π `cars`
- `matched` - —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –ª–∏ —Å –º–∞—à–∏–Ω–æ–π
- `extracted_model` - –∏–∑–≤–ª–µ—á–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å ("BMW 3")
- `extracted_digits` - –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ 3 —Ü–∏—Ñ—Ä—ã ("587")
- `previous_aliases` - –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞–∑–≤–∞–Ω–∏—è

**`starline_match_history`** - –∏—Å—Ç–æ—Ä–∏—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–π:
- –î–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ —É–ª—É—á—à–µ–Ω–∏—è –∞–ª–≥–æ—Ä–∏—Ç–º–∞
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ/—Ä—É—á–Ω–æ–≥–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è

**`starline_devices_with_cars`** (VIEW):
- –£–¥–æ–±–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å–æ —Å–≤—è–∑–∞–Ω–Ω—ã–º–∏ –º–∞—à–∏–Ω–∞–º–∏
- –í–∫–ª—é—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ–±–µ–∏—Ö —Ç–∞–±–ª–∏—Ü

‚úÖ **–¢—Ä–∏–≥–≥–µ—Ä—ã:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –∏ —Ü–∏—Ñ—Ä –∏–∑ `alias`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ `alias`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –µ—Å–ª–∏ –º–µ–Ω—è—é—Ç—Å—è —Ü–∏—Ñ—Ä—ã

‚úÖ **–ú–∏–≥—Ä–∞—Ü–∏—è:** `setup/migrations/0013_starline_devices.sql` ‚úÖ –í–´–ü–û–õ–ù–ï–ù–ê

---

### 4. API Endpoints

‚úÖ **GET `/starline/sync-status`** - —Å—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:
```json
{
  "ok": true,
  "total": 120,
  "matched": 101,
  "unmatched": 19,
  "inactive": 15,
  "timestamp": "2025-11-09T05:44:16.284Z"
}
```

‚úÖ **POST `/starline/sync-devices`** - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤:
```json
{
  "ok": true,
  "total": 120,
  "new": 120,
  "updated": 0,
  "errors": []
}
```

‚úÖ **POST `/starline/match-devices`** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ:
```json
{
  "ok": true,
  "matches": [...],  // 101 —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
  "count": 101
}
```

‚úÖ **POST `/starline/update-gps`** - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ GPS –¥–∞–Ω–Ω—ã—Ö:
- –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –≤—Å–µ—Ö —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å (moving, parked_on, parked_off, gps_offline, offline)
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü—É `cars` (–±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏)

---

### 5. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ (AI-–∞–ª–≥–æ—Ä–∏—Ç–º)

‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã 3 –º–µ—Ç–æ–¥–∞ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è:**

**1. `auto_model_digits` (confidence: 0.95)**
- –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –ò —Ü–∏—Ñ—Ä
- –ü—Ä–∏–º–µ—Ä: "BMW 3 587" ‚Üí BMW 3 —Å –Ω–æ–º–µ—Ä–æ–º XX-587-XX

**2. `auto_fuzzy_match` (confidence: 0.8)**
- –ù–µ—á–µ—Ç–∫–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ (levenshtein distance) + —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ü–∏—Ñ—Ä
- –£—á–∏—Ç—ã–≤–∞–µ—Ç –æ–ø–µ—á–∞—Ç–∫–∏ –∏ –≤–∞—Ä–∏–∞—Ü–∏–∏ –Ω–∞–ø–∏—Å–∞–Ω–∏—è

**3. `auto_digits_only` (confidence: 0.6)**
- –¢–æ–ª—å–∫–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ü–∏—Ñ—Ä (–µ—Å–ª–∏ –º–æ–¥–µ–ª—å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞)
- –ù–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å ‚Üí —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏

‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- **120 —É—Å—Ç—Ä–æ–π—Å—Ç–≤** —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –∏–∑ Starline
- **101 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ —Å cars (84%)
- **19 —É—Å—Ç—Ä–æ–π—Å—Ç–≤** –Ω–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω—ã (—Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)

‚úÖ **–ò—Å—Ç–æ—Ä–∏—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–π:**
- –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ `starline_match_history`
- –ú–æ–∂–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –∞–ª–≥–æ—Ä–∏—Ç–º–∞
- –ú–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ —É—Å–ø–µ—à–Ω—ã—Ö/–Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö –∫–µ–π—Å–æ–≤

---

## üìä –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å

### –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ Hetzner:

```
‚úÖ Jarvis API: active (running)
‚úÖ Starline Scraper: initialized and logged in
‚úÖ Playwright Browser: headless Chrome running
‚úÖ Database: connected (Neon PostgreSQL)
‚úÖ Starline Devices: 120 —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
‚úÖ Matched Devices: 101 —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω—ã —Å cars (84%)
```

### –õ–æ–≥–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:

```
[2025-11-09T05:33:08.980Z] [INFO] üåê Initializing Starline Scraper (persistent Playwright session)...
[2025-11-09T05:33:16.072Z] [INFO] StarlineScraperService: ‚úÖ Login successful
[2025-11-09T05:33:16.074Z] [INFO] ‚úÖ Starline Scraper initialized successfully!
[2025-11-09T05:33:16.074Z] [INFO]    Browser: Chromium (headless)
[2025-11-09T05:33:16.074Z] [INFO]    Status: Logged in and ready
[2025-11-09T05:33:16.074Z] [INFO]    Mode: Persistent session (no re-login needed)
[2025-11-09T05:33:16.074Z] [INFO] ‚úÖ Starline Scraper health check passed
```

---

## üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### 1. GPS Tracking (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ –∫–æ–¥–µ, –Ω—É–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å)

**Endpoint:** `POST /starline/update-gps`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, —Å—Ç–∞—Ç—É—Å)
- –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –º–∞—à–∏–Ω—ã:
  - `offline` - —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ
  - `gps_offline` - GPS –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
  - `moving` - –º–∞—à–∏–Ω–∞ –¥–≤–∏–≥–∞–µ—Ç—Å—è (–∑–∞–∂–∏–≥–∞–Ω–∏–µ + –¥–≤–∏–≥–∞—Ç–µ–ª—å)
  - `parked_on` - —Å—Ç–æ–∏—Ç —Å –≤–∫–ª—é—á–µ–Ω–Ω—ã–º –∑–∞–∂–∏–≥–∞–Ω–∏–µ–º
  - `parked_off` - —Å—Ç–æ–∏—Ç —Å –≤—ã–∫–ª—é—á–µ–Ω–Ω—ã–º –∑–∞–∂–∏–≥–∞–Ω–∏–µ–º

**–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö:**
- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (latitude, longitude)
- –°—Ç–∞—Ç—É—Å GPS
- –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π

**–ó–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É—é:**
```bash
curl -X POST http://localhost:3000/starline/update-gps
```

---

### 2. n8n Workflow –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–°–æ–∑–¥–∞—Ç—å workflow "Starline GPS Monitor":**

**Nodes:**
1. **Schedule Trigger** - –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
2. **HTTP Request** - POST `/starline/update-gps`
3. **IF Node** - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `ok === true`
4. **Telegram Node** - –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö:
   - GPS offline –±–æ–ª–µ–µ 1 —á–∞—Å–∞
   - –ú–∞—à–∏–Ω–∞ –¥–≤–∏–∂–µ—Ç—Å—è –±–µ–∑ –±—Ä–æ–Ω–∏
   - –ù–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–æ–µ–∑–¥–∫–∞

**Telegram –∞–ª–µ—Ä—Ç—ã:**
- –ö–∞–Ω–∞–ª: `$env.TELEGRAM_ALERT_CHAT_ID`
- –ë–æ—Ç: `@n8n_alert_geodrive_bot`

---

### 3. –†—É—á–Ω–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –Ω–µ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤

**19 —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –Ω–µ –±—ã–ª–∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:**

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**
1. –°–æ–∑–¥–∞—Ç—å UI –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è (–∞–¥–º–∏–Ω–∫–∞)
2. –ß–µ—Ä–µ–∑ SQL –∑–∞–ø—Ä–æ—Å—ã –≤—Ä—É—á–Ω—É—é
3. –£–ª—É—á—à–∏—Ç—å –∞–ª–≥–æ—Ä–∏—Ç–º —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è

**–ü—Ä–æ—Å–º–æ—Ç—Ä –Ω–µ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö:**
```sql
SELECT * FROM starline_devices
WHERE matched = FALSE
ORDER BY alias;
```

**–†—É—á–Ω–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ:**
```sql
UPDATE starline_devices
SET car_id = '<UUID –º–∞—à–∏–Ω—ã>',
    matched = TRUE,
    match_confidence = 1.0,
    match_method = 'manual',
    match_notes = '–†—É—á–Ω–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ'
WHERE device_id = <IMEI —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞>;

-- –î–æ–±–∞–≤–∏—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é
INSERT INTO starline_match_history (
  starline_device_id, car_id, matched, confidence,
  method, reason, created_by
) VALUES (
  <ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞>, '<UUID –º–∞—à–∏–Ω—ã>', TRUE, 1.0,
  'manual_match', '–†—É—á–Ω–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º', 'admin'
);
```

---

### 4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ç–∞–±–ª–∏—Ü–µ–π GPS tracking

**–°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `gps_tracking_history`:**
```sql
CREATE TABLE gps_tracking_history (
  id BIGSERIAL PRIMARY KEY,
  car_id UUID REFERENCES cars(id),
  starline_device_id BIGINT REFERENCES starline_devices(id),
  latitude NUMERIC(10, 8),
  longitude NUMERIC(11, 8),
  status TEXT,  -- 'moving', 'parked_on', 'parked_off', 'gps_offline', 'offline'
  ignition BOOLEAN,
  engine_running BOOLEAN,
  gps_level INT,
  satellites INT,
  speed NUMERIC(5, 2),  -- –∫–º/—á
  timestamp TIMESTAMPTZ NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_gps_tracking_car ON gps_tracking_history(car_id);
CREATE INDEX idx_gps_tracking_timestamp ON gps_tracking_history(timestamp DESC);
```

**–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ `POST /starline/update-gps`:**
```typescript
// –î–æ–±–∞–≤–∏—Ç—å –≤ starline-monitor.ts
await sqlConnection`
  INSERT INTO gps_tracking_history (
    car_id, starline_device_id, latitude, longitude,
    status, ignition, engine_running, gps_level,
    satellites, speed, timestamp
  ) VALUES (
    ${device.car_id},
    ${device.id},
    ${details.pos.y},
    ${details.pos.x},
    ${status},
    ${details.car_state.ign},
    ${details.car_state.run},
    ${details.gps_lvl},
    ${details.pos.sat_qty},
    ${details.pos.speed || 0},
    NOW()
  )
`;
```

---

### 5. Telegram Notifications

**–¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –∞–ª–µ—Ä—Ç–æ–≤:**
- GPS offline > 1 —á–∞—Å ‚Üí —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–º—É
- –ú–∞—à–∏–Ω–∞ –¥–≤–∏–∂–µ—Ç—Å—è –±–µ–∑ –±—Ä–æ–Ω–∏ ‚Üí –∞–ª–µ—Ä—Ç —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—é
- –ù–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–æ–µ–∑–¥–∫–∞ ‚Üí –∏–Ω—Ü–∏–¥–µ–Ω—Ç
- –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–Ω–æ—á–Ω–∞—è –ø–æ–µ–∑–¥–∫–∞) ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ n8n:**
```
Schedule (1 min) ‚Üí HTTP Request (/starline/update-gps)
  ‚Üí Filter (–∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è)
  ‚Üí Telegram (–∞–ª–µ—Ä—Ç –≤ —á–∞—Ç)
```

---

## üìñ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–§–∞–π–ª—ã:**
- `docs/STARLINE_AUTOSTART.md` - –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
- `docs/STARLINE_GPS_COMPLETE.md` - –≠—Ç–æ—Ç —Ñ–∞–π–ª (–ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è)
- `setup/migrations/0013_starline_devices.sql` - –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î

**–ö–æ–¥:**
- `src/services/starline-scraper.ts` - Persistent Playwright scraper
- `src/services/starline-devices-sync.ts` - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
- `src/services/starline-monitor.ts` - GPS –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- `src/utils/starline-helpers.ts` - –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- `src/api/index.ts` - API endpoints –¥–ª—è Starline

**–¢–µ—Å—Ç—ã:**
- `test-starline-scraper.mjs` - –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ scraper
- `setup/check_cars_table.mjs` - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü—ã cars

---

## üéØ –ò—Ç–æ–≥–∏

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

‚úÖ **Persistent Playwright Browser** - –ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ª–æ–≥–∏–Ω–æ–≤  
‚úÖ **Systemd Auto-start** - –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–µ—Ä–≤–µ—Ä–∞  
‚úÖ **Device Sync** - 120 —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ Starline  
‚úÖ **Auto-matching** - 101 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (84%) —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω—ã —Å cars  
‚úÖ **API Endpoints** - –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é  
‚úÖ **Database Schema** - —Ç–∞–±–ª–∏—Ü—ã, —Ç—Ä–∏–≥–≥–µ—Ä—ã, view —Å–æ–∑–¥–∞–Ω—ã  
‚úÖ **Health Check** - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ scraper  

### –ß—Ç–æ –≥–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É:

üöÄ **GPS Tracking** - –∫–æ–¥ –≥–æ—Ç–æ–≤, —Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–ø—É—Å–∫  
üöÄ **n8n Workflow** - —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –∏–º–ø–æ—Ä—Ç  
üöÄ **Telegram Alerts** - —Ç—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤  

### –ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏:

‚öôÔ∏è **Manual Matching UI** - –¥–ª—è –Ω–µ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤  
‚öôÔ∏è **GPS History Table** - –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π  
‚öôÔ∏è **Advanced Alerts** - –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π  

---

## üöÄ –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç)

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å:

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
sudo systemctl status jarvis-api

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: active (running)
```

### 2. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:

```bash
curl -X POST http://localhost:3000/starline/sync-devices
```

### 3. –°–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å —Å cars:

```bash
curl -X POST http://localhost:3000/starline/match-devices
```

### 4. –ó–∞–ø—É—Å—Ç–∏—Ç—å GPS –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:

```bash
curl -X POST http://localhost:3000/starline/update-gps
```

### 5. –°–æ–∑–¥–∞—Ç—å n8n workflow –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ (—Å–º. –≤—ã—à–µ)

---

**–í—Å–µ –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üéâ**

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –°–æ–∑–¥–∞—Ç—å n8n workflow –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ GPS –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É.

