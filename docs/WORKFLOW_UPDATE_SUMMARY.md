# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Workflow: –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Bookings

**–î–∞—Ç–∞:** 2025-11-19  
**Workflow:** [‚úÖ–ü–∞—Ä—Å–∏–Ω–≥ –±—Ä–æ–Ω–µ–π RentProg (–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ, –ë–∞—Ç—É–º–∏)](https://n8n.rentflow.rentals/workflow/FDMvu8P8DKilQTOK)

---

## ‚úÖ –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

### 1. **Process All Bookings** (–∫–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω)
- ‚úÖ `rentprog_id` ‚Äî –≥–ª–æ–±–∞–ª—å–Ω—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (–∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)
- ‚úÖ `location_start` / `location_end` ‚Äî –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ –ë–î (–¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ñ–∏–ª–∏–∞–ª–∞ —á–µ—Ä–µ–∑ cities)
- ‚úÖ `branch_id` ‚Äî fallback —á–µ—Ä–µ–∑ `company_id` –º–∞–ø–ø–∏–Ω–≥
- ‚úÖ `branch` ‚Äî –¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è `rentprog_id` (–∫—Ä–∏—Ç–∏—á–Ω–æ) + warning –¥–ª—è `number`

**Company ID ‚Üí Branch ID –º–∞–ø–ø–∏–Ω–≥:**
```javascript
const COMPANY_ID_TO_BRANCH_ID = {
  9247: '277eaada-1428-4c04-9cd7-5e614e43bedc',   // tbilisi
  9248: '5e551b32-934c-498f-a4a1-a90079985c0a',   // kutaisi
  9506: '627c4c88-d8a1-47bf-b9a6-2e9ad33112a4',   // batumi
  11163: '6026cff7-eee8-4fb9-be26-604f308911f0',  // service-center
};
```

### 2. **Save to DB** (UPSERT –ø–æ rentprog_id)
**–ë—ã–ª–æ:**
```json
"matchingColumns": ["branch", "number"]
```

**–°—Ç–∞–ª–æ:**
```json
"matchingColumns": ["rentprog_id"]
```

---

## üéØ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ë—Ä–æ–Ω–∏ - –°–ö–í–û–ó–ù–´–ï –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏ (–∫–∞–∫ –ø–ª–∞—Ç–µ–∂–∏, —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏)

```
bookings —Ç–∞–±–ª–∏—Ü–∞:
‚îú‚îÄ‚îÄ rentprog_id (text NOT NULL UNIQUE) ‚Üê –ò–°–¢–û–ß–ù–ò–ö –ò–°–¢–ò–ù–´
‚îú‚îÄ‚îÄ location_start/end (text) ‚Üê –ò–°–¢–û–ß–ù–ò–ö –ò–°–¢–ò–ù–´ –¥–ª—è —Ñ–∏–ª–∏–∞–ª–∞
‚îú‚îÄ‚îÄ branch_id (UUID FK) ‚Üê FALLBACK —á–µ—Ä–µ–∑ cities –∏–ª–∏ company_id
‚îî‚îÄ‚îÄ branch (text) ‚Üê –î–ï–ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
```

### –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ñ–∏–ª–∏–∞–ª–∞

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**
1. üéØ **location_start** ‚Üí `cities` —Ç–∞–±–ª–∏—Ü–∞ ‚Üí `branch` (–æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫)
2. üîÑ **company_id** ‚Üí `branch_id` FK (fallback, –µ—Å–ª–∏ location –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ cities)
3. üìù **branch** TEXT (–¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)

---

## üìä –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ë–î

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ constraints:
- ‚úÖ `UNIQUE (rentprog_id)` ‚Äî –≥–ª–æ–±–∞–ª—å–Ω—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
- ‚úÖ `NOT NULL` –Ω–∞ `rentprog_id`, `branch`, `number`
- ‚ùå –ù–ï–¢ `bookings_branch_number_unique` (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π constraint —É–¥–∞–ª–µ–Ω)

### –ú–∏–≥—Ä–∞—Ü–∏—è:
```bash
node setup/fix_bookings_architecture.mjs
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—è:**
1. –£–¥–∞–ª—è–µ—Ç `bookings_branch_number_unique` (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π)
2. –°–æ–∑–¥–∞–µ—Ç `bookings_rentprog_id_unique` (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π)
3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `NOT NULL` –Ω–∞ `rentprog_id`
4. –î–æ–±–∞–≤–ª—è–µ—Ç `branch_id` FK (–µ—Å–ª–∏ –Ω–µ—Ç)
5. –î–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –∫–æ–ª–æ–Ω–∫–∞–º

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î:
```bash
node check_bookings_ready.mjs
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- ‚úÖ UNIQUE constraint –Ω–∞ `rentprog_id`
- ‚úÖ –ù–ï–¢ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ constraint (`branch+number`)
- ‚úÖ `rentprog_id` NOT NULL

### 2. –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ workflow:
- –û—Ç–∫—Ä–æ–π—Ç–µ: https://n8n.rentflow.rentals/workflow/FDMvu8P8DKilQTOK
- –ù–∞–∂–º–∏—Ç–µ "Execute Workflow" (–≤—Ä—É—á–Ω—É—é)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ execution log

### 3. –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:
- ‚úÖ –ë—Ä–æ–Ω–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø–æ `rentprog_id` (UPSERT)
- ‚úÖ –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –±—Ä–æ–Ω–∏ ‚Äî –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è
- ‚úÖ –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –±—Ä–æ–Ω–∏ ‚Äî INSERT
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ constraint violation

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –û–±–Ω–æ–≤–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ 16 workflows:
1. ‚úÖ–ü–∞—Ä—Å–∏–Ω–≥ –±—Ä–æ–Ω–µ–π RentProg (–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ, –ë–∞—Ç—É–º–∏) ‚Äî **–û–ë–ù–û–í–õ–ï–ù**
2. ‚úÖ–ü–∞—Ä—Å–∏–Ω–≥ –±—Ä–æ–Ω–µ–π RentProg (–∞–∫—Ç–∏–≤–Ω—ã–µ, –ë–∞—Ç—É–º–∏)
3. ‚úÖ–ü–∞—Ä—Å–∏–Ω–≥ –±—Ä–æ–Ω–µ–π RentProg (–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ, –¢–±–∏–ª–∏—Å–∏)
4. ‚úÖ–ü–∞—Ä—Å–∏–Ω–≥ –±—Ä–æ–Ω–µ–π RentProg (–∞–∫—Ç–∏–≤–Ω—ã–µ, –¢–±–∏–ª–∏—Å–∏)
5. ‚úÖ–ü–∞—Ä—Å–∏–Ω–≥ –±—Ä–æ–Ω–µ–π RentProg (–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ, –ö—É—Ç–∞–∏—Å–∏)
6. ‚úÖ–ü–∞—Ä—Å–∏–Ω–≥ –±—Ä–æ–Ω–µ–π RentProg (–∞–∫—Ç–∏–≤–Ω—ã–µ, –ö—É—Ç–∞–∏—Å–∏)
7. ... (–µ—â–µ 11 workflows)

**–î–ª—è –∫–∞–∂–¥–æ–≥–æ workflow:**
- –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ "Process All Bookings" (–∏–∑–º–µ–Ω–∏—Ç—å `CURRENT_COMPANY_ID`)
- –û–±–Ω–æ–≤–∏—Ç—å "Save to DB" (`matchingColumns: ["rentprog_id"]`)
- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é
- –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **`CURRENT_COMPANY_ID`** ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É–∫–∞–∑–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ workflow:
   - Batumi: `9506`
   - Tbilisi: `9247`
   - Kutaisi: `9248`
   - Service Center: `11163`

2. **Fallback –ª–æ–≥–∏–∫–∞** —Ä–∞–±–æ—Ç–∞–µ—Ç –¢–û–õ–¨–ö–û –µ—Å–ª–∏ `company_id` –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ payload RentProg

3. **`location_start`** ‚Äî –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ –±—É–¥—É—â–µ–º –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ñ–∏–ª–∏–∞–ª–∞ —á–µ—Ä–µ–∑ `cities` —Ç–∞–±–ª–∏—Ü—É

4. **–°—Ç–∞—Ä—ã–µ –±—Ä–æ–Ω–∏** ‚Äî –æ—Å—Ç–∞–Ω—É—Ç—Å—è —Å `(branch, number)` –∫–∞–∫ –µ—Å—Ç—å, –Ω–æ–≤—ã–µ –±—É–¥—É—Ç –ø–æ `rentprog_id`

---

## üöÄ –°—Ç–∞—Ç—É—Å

- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î –≥–æ—Ç–æ–≤–∞
- ‚úÖ Workflow –æ–±–Ω–æ–≤–ª–µ–Ω
- üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî **–í –ü–†–û–¶–ï–°–°–ï**
- ‚è≥ –û—Å—Ç–∞–ª—å–Ω—ã–µ workflows ‚Äî **–û–ñ–ò–î–ê–Æ–¢**

