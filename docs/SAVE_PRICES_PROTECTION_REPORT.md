# üîí –û—Ç—á–µ—Ç: –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –≤ —Ç–∞–±–ª–∏—Ü–µ car_prices

**–î–∞—Ç–∞:** 2025-11-21  
**Workflow:** https://n8n.rentflow.rentals/workflow/u3cOUuoaH5RSw7hm  
**–ó–∞–¥–∞—á–∞:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –æ–±–µ—Å–ø–µ—á–∏—Ç—å –∑–∞—â–∏—Ç—É –æ—Ç –ø–æ–ø–∞–¥–∞–Ω–∏—è –ø—É—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –≤ —Ç–∞–±–ª–∏—Ü—É `car_prices`

---

## üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–†–û–í–ï–†–ö–ò –ë–î

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã `car_prices`

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (NOT NULL):**
- `id` (UUID) - –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á
- `car_id` (UUID) - —Å–≤—è–∑—å —Å –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–º

**Nullable –ø–æ–ª—è:**
- `rentprog_price_id` (TEXT) - –º–æ–∂–µ—Ç –±—ã—Ç—å NULL
- `season_id` (INTEGER) - –º–æ–∂–µ—Ç –±—ã—Ç—å NULL
- `price_values` (JSONB) - –º–æ–∂–µ—Ç –±—ã—Ç—å NULL (–Ω–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å NOT NULL!)

**–ü—Ä–æ–±–ª–µ–º–∞:** `price_values` –æ–±—ä—è–≤–ª–µ–Ω–æ –∫–∞–∫ nullable, –Ω–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å NOT NULL –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã.

---

## üîç –ü–†–û–í–ï–†–ö–ê –°–£–©–ï–°–¢–í–£–Æ–©–ò–• –î–ê–ù–ù–´–•

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
- **–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π:** 1406
- **NULL car_id:** 0 ‚úÖ
- **NULL/–ø—É—Å—Ç–æ–π rentprog_price_id:** 0 ‚úÖ
- **NULL season_id:** 4 ‚ö†Ô∏è (—Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –æ—Ç 16-17 –Ω–æ—è–±—Ä—è)
- **NULL/–ø—É—Å—Ç–æ–π price_values:** 0 ‚úÖ

### –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –∑–∞–ø–∏—Å–∏:
–ù–∞–π–¥–µ–Ω–æ **4 –∑–∞–ø–∏—Å–∏** —Å `NULL season_id` (—Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏):
1. `e6f0b4a4-e595-4ba4-b375-94863e081e13` - 2025-11-17 08:32:10
2. `3006afaf-2f38-49d2-ac0e-493ec9d6fea9` - 2025-11-16 20:06:36
3. `94844258-343b-4147-b6d5-d88991215da9` - 2025-11-16 20:06:27
4. `0b96c3a0-13c5-4399-9f50-3524336c7874` - 2025-11-16 20:02:13

**–í—ã–≤–æ–¥:** –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –∑–∞–ø–∏—Å–∏ —Å—Ç–∞—Ä—ã–µ, –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ —Å –ø—É—Å—Ç—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è.

---

## ‚úÖ –ü–†–ò–ú–ï–ù–ï–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### 1. –ù–æ–¥–∞ "Format Price Values"

**–î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π `price_id` (null, undefined, '')
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π `season_id` (null, undefined, '')
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ `values` (null, undefined, [])
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤—Å–µ –Ω—É–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ `values` (–≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è = 0, null, undefined, '')

**–ö–æ–¥:**
```javascript
// –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø–∏—Å—å, –µ—Å–ª–∏ –µ—Å—Ç—å –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
if (!priceData.car_id) {
  return [];
}

if (!priceData.price_id || priceData.price_id === '' || priceData.price_id === null) {
  return [];
}

if (!priceData.season_id || priceData.season_id === null || priceData.season_id === '') {
  return [];
}

const values = priceData.values || [];
if (!Array.isArray(values) || values.length === 0) {
  return [];
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –º–∞—Å—Å–∏–≤–µ –Ω–µ –ø—É—Å—Ç—ã–µ
if (values.every(v => v === null || v === undefined || v === '' || v === 0)) {
  return [];
}
```

### 2. –ù–æ–¥–∞ "Merge Car ID"

**–î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π `price_id` (null, undefined, '')
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π `season_id` (null, undefined, '')
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ `values` (null, undefined, [])

**–ö–æ–¥:**
```javascript
// –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø–∏—Å—å, –µ—Å–ª–∏ –µ—Å—Ç—å –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
if (!priceData.price_id || priceData.price_id === '' || priceData.price_id === null) {
  return [];
}

if (!priceData.season_id || priceData.season_id === null || priceData.season_id === '') {
  return [];
}

const values = priceData.values || [];
if (!Array.isArray(values) || values.length === 0) {
  return [];
}
```

---

## üõ°Ô∏è –ó–ê–©–ò–¢–ê –û–¢ –ü–£–°–¢–´–• –ó–ù–ê–ß–ï–ù–ò–ô

### –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞:

1. **–ù–æ–¥–∞ "Merge & Process":**
   - –§–∏–ª—å—Ç—Ä—É–µ—Ç `undefined`, `null`, –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ —á–µ—Ä–µ–∑ `safeValue()`
   - –ù–µ —Å–æ–∑–¥–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã —Å `price_id`, –µ—Å–ª–∏ —Ü–µ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã

2. **–ù–æ–¥–∞ "Split Cars and Prices":**
   - –†–∞–∑–¥–µ–ª—è–µ—Ç –º–∞—à–∏–Ω—ã –∏ —Ü–µ–Ω—ã –ø–æ –Ω–∞–ª–∏—á–∏—é `price_id`
   - –¢–æ–ª—å–∫–æ —ç–ª–µ–º–µ–Ω—Ç—ã —Å `price_id` –ø—Ä–æ—Ö–æ–¥—è—Ç –≤ True branch

3. **–ù–æ–¥–∞ "Find Car ID":**
   - –ò—â–µ—Ç `car_id` –ø–æ `rentprog_id`
   - –ï—Å–ª–∏ `car_id` –Ω–µ –Ω–∞–π–¥–µ–Ω, –∑–∞–ø–∏—Å—å –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç –¥–∞–ª—å—à–µ

4. **–ù–æ–¥–∞ "Merge Car ID":** ‚úÖ **–û–ë–ù–û–í–õ–ï–ù–û**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `car_id`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `price_id`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `season_id`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `values`

5. **–ù–æ–¥–∞ "Format Price Values":** ‚úÖ **–û–ë–ù–û–í–õ–ï–ù–û**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `car_id`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `price_id`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `season_id`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `values`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –Ω–µ –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω—É–ª–µ–≤—ã–µ

6. **–ù–æ–¥–∞ "Save Prices":**
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç upsert —Å `matchingColumns: ['car_id', 'season_id']`
   - PostgreSQL –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ø–æ `(car_id, season_id)`

---

## üìã –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### 1. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–î–æ–±–∞–≤–∏—Ç—å NOT NULL –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø–æ–ª–µ–π:**
```sql
ALTER TABLE car_prices 
  ALTER COLUMN price_values SET NOT NULL,
  ALTER COLUMN season_id SET NOT NULL;
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –≠—Ç–æ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ 4 –∑–∞–ø–∏—Å—è–º–∏ —Å NULL season_id. –ù—É–∂–Ω–æ –ª–∏–±–æ —É–¥–∞–ª–∏—Ç—å –∏—Ö, –ª–∏–±–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è–º–∏.

### 2. –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –∑–∞–ø–∏—Å–∏

```sql
DELETE FROM car_prices 
WHERE season_id IS NULL;
```

### 3. –î–æ–±–∞–≤–∏—Ç—å CHECK constraint (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```sql
ALTER TABLE car_prices 
  ADD CONSTRAINT check_price_values_not_empty 
  CHECK (price_values IS NOT NULL AND price_values::text != '{}');
```

---

## ‚úÖ –ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
- –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
- –ü—Ä–æ–≤–µ—Ä–∫–∏ –≤ –Ω–æ–¥–∞—Ö "Format Price Values" –∏ "Merge Car ID"
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤ –Ω–æ–¥–µ "Merge & Process"
- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –≤ –Ω–æ–¥–µ "Split Cars and Prices"

### ‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ:
- 4 —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ —Å NULL `season_id` (–æ—Ç 16-17 –Ω–æ—è–±—Ä—è)
- `price_values` –æ–±—ä—è–≤–ª–µ–Ω–æ –∫–∞–∫ nullable (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å NOT NULL)

### üéØ –í—ã–≤–æ–¥:
**–ó–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ workflow. –ù–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ —Å –ø—É—Å—Ç—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –Ω–µ –±—É–¥—É—Ç –ø–æ–ø–∞–¥–∞—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É `car_prices`.**

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å workflow –≤—Ä—É—á–Ω—É—é –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞—â–∏—Ç—ã.

