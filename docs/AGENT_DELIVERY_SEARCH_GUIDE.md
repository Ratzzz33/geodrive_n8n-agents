# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –∞–≥–µ–Ω—Ç–∞ –ø–æ–∏—Å–∫–∞ –∞–≤—Ç–æ —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π

## –û–±–∑–æ—Ä

–ê–≥–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –∏—Å–∫–∞—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–µ –º–∞—à–∏–Ω—ã –Ω–µ —Ç–æ–ª—å–∫–æ –≤ —Ç–µ–∫—É—â–µ–º —Ñ–∏–ª–∏–∞–ª–µ –∫–ª–∏–µ–Ω—Ç–∞, –Ω–æ –∏ –≤ –¥—Ä—É–≥–∏—Ö —Ñ–∏–ª–∏–∞–ª–∞—Ö, —É—á–∏—Ç—ã–≤–∞—è:
- **–ë—É–¥—É—â–∏–π —Ñ–∏–ª–∏–∞–ª** –º–∞—à–∏–Ω—ã (–∫—É–¥–∞ –æ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –≤–µ—Ä–Ω—É—Ç—å—Å—è –ø–æ —Å–ª–µ–¥—É—é—â–µ–π –±—Ä–æ–Ω–∏)
- **–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏** –∏–∑ —Ñ–∏–ª–∏–∞–ª–∞ –º–∞—à–∏–Ω—ã –≤ –≥–æ—Ä–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞
- **–°—Ç–æ–∏–º–æ—Å—Ç—å –≤–æ–∑–≤—Ä–∞—Ç–∞** (–¥–ª—è –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–π –∞—Ä–µ–Ω–¥—ã) —Å —É—á—ë—Ç–æ–º —Å–∫–∏–¥–æ–∫
- **–î–æ–ø–ª–∞—Ç—É –∑–∞ –Ω–µ—Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è** (–≤—ã–¥–∞—á–∞/–ø—Ä–∏—ë–º –≤–Ω–µ 09:00-20:00)

## –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è

### –§–∏–ª–∏–∞–ª—ã –º–∞—à–∏–Ω

- **current_branch_id** ‚Äî –≥–¥–µ –º–∞—à–∏–Ω–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–µ–π—á–∞—Å
- **future_branch_id** ‚Äî –∫—É–¥–∞ –º–∞—à–∏–Ω–∞ –¥–æ–ª–∂–Ω–∞ –≤–µ—Ä–Ω—É—Ç—å—Å—è –ø–æ –±–ª–∏–∂–∞–π—à–µ–π –±—É–¥—É—â–µ–π –±—Ä–æ–Ω–∏
- **desired_branch_id** ‚Äî –∫—É–¥–∞ —Ö–æ—Ç–∏–º –ø–µ—Ä–µ–≥–Ω–∞—Ç—å –º–∞—à–∏–Ω—É (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–ª–∏ –≤—Ä—É—á–Ω—É—é)
- **home_branch_id** ‚Äî —Ä–æ–¥–Ω–æ–π —Ñ–∏–ª–∏–∞–ª –º–∞—à–∏–Ω—ã (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)

**–í–∞–∂–Ω–æ:** –ü—Ä–∏ –ø–æ–∏—Å–∫–µ –º–∞—à–∏–Ω –¥–ª—è –±—É–¥—É—â–∏—Ö –¥–∞—Ç –∏—Å–ø–æ–ª—å–∑—É–π **future_branch_id**, –∞ –Ω–µ current_branch_id!

### –¢–∏–ø—ã –¥–æ—Å—Ç–∞–≤–∫–∏

- **city** ‚Äî –≤–Ω—É—Ç—Ä–∏ –≥–æ—Ä–æ–¥–∞ ($10)
- **airport** ‚Äî –¥–æ –∞—ç—Ä–æ–ø–æ—Ä—Ç–∞ ($20)
- **intercity** ‚Äî –º–µ–∂–¥—É –≥–æ—Ä–æ–¥–∞–º–∏ (—Ü–µ–Ω–∞ –∏–∑ `routes.xlsx`)

### –°–∫–∏–¥–∫–∏ –Ω–∞ –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω—é—é –∞—Ä–µ–Ω–¥—É

- **100% —Å–∫–∏–¥–∫–∞** (–±–µ—Å–ø–ª–∞—Ç–Ω–æ):
  - –í–æ–∑–≤—Ä–∞—Ç –≤ `home_branch`
  - –í–æ–∑–≤—Ä–∞—Ç –≤ `desired_branch`
  - –î–æ —Å–ª–µ–¥—É—é—â–µ–π –±—Ä–æ–Ω–∏ <7 –¥–Ω–µ–π
- **50% —Å–∫–∏–¥–∫–∞**:
  - –î–æ —Å–ª–µ–¥—É—é—â–µ–π –±—Ä–æ–Ω–∏ 7-14 –¥–Ω–µ–π
- **0% —Å–∫–∏–¥–∫–∞** (–ø–æ–ª–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å):
  - –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–ª—É—á–∞–∏

### –î–æ–ø–ª–∞—Ç–∞ –∑–∞ –Ω–µ—Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è

- **$20** –∑–∞ –∫–∞–∂–¥—É—é –æ–ø–µ—Ä–∞—Ü–∏—é (–≤—ã–¥–∞—á–∞ –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—Ç)
- **–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è:** 09:00 - 20:00 (Asia/Tbilisi)
- **–ù–µ—Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è:** –¥–æ 09:00 –∏–ª–∏ –ø–æ—Å–ª–µ 20:00

## –ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ–∏—Å–∫–∞ –∏ —Ä–∞—Å—á—ë—Ç–∞

### –®–∞–≥ 1: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ü–µ–ª–µ–≤–æ–π —Ñ–∏–ª–∏–∞–ª/–≥–æ—Ä–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞

```javascript
// –ö–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –º–∞—à–∏–Ω—É –≤ –≥–æ—Ä–æ–¥–µ "–¢–±–∏–ª–∏—Å–∏"
const targetCity = "–¢–±–∏–ª–∏—Å–∏";
const targetBranchCode = "tbilisi"; // –∏–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á–µ—Ä–µ–∑ cities

// –î–∞—Ç—ã –∞—Ä–µ–Ω–¥—ã
const issueDate = "2025-02-01 10:00:00+04";
const returnDate = "2025-02-05 18:00:00+04";
const isOneWay = false; // –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω—è—è –∞—Ä–µ–Ω–¥–∞?
```

### –®–∞–≥ 2: –ù–∞–π—Ç–∏ —Å–≤–æ–±–æ–¥–Ω—ã–µ –º–∞—à–∏–Ω—ã

**–í–∞–∂–Ω–æ:** –ò—Å–ø–æ–ª—å–∑—É–π `future_branch_id` –¥–ª—è –ø–æ–∏—Å–∫–∞, –µ—Å–ª–∏ –ø–µ—Ä–∏–æ–¥ –∞—Ä–µ–Ω–¥—ã –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç –∏–ª–∏ –∏–¥—ë—Ç –ø–æ—Å–ª–µ —Å–ª–µ–¥—É—é—â–µ–π –±—Ä–æ–Ω–∏ –º–∞—à–∏–Ω—ã.

```sql
-- –ü–æ–∏—Å–∫ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –º–∞—à–∏–Ω —Å —É—á—ë—Ç–æ–º –±—É–¥—É—â–µ–≥–æ —Ñ–∏–ª–∏–∞–ª–∞
SELECT DISTINCT
  c.id AS car_id,
  c.plate AS car_plate,
  c.model AS car_model,
  
  -- –°—Ç–∞—Ç—É—Å—ã —Ñ–∏–ª–∏–∞–ª–æ–≤
  COALESCE(cbs.future_branch_id, cbs.current_branch_id, c.branch_id) AS effective_branch_id,
  COALESCE(cbs.future_branch_code, cbs.current_branch_code, b.code) AS effective_branch_code,
  cbs.current_branch_id,
  cbs.current_branch_code,
  cbs.future_branch_id,
  cbs.future_branch_code,
  cbs.home_branch_id,
  cbs.desired_branch_id,
  cbs.days_until_future_booking,
  
  -- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
  CASE
    -- –ï—Å–ª–∏ –µ—Å—Ç—å –±—É–¥—É—â–∞—è –±—Ä–æ–Ω—å, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Ä–∞–Ω—å—à–µ –∏–ª–∏ –≤ —Ç–æ—Ç –∂–µ –¥–µ–Ω—å
    WHEN cbs.future_booking_start_at IS NOT NULL 
         AND cbs.future_booking_start_at <= $1::TIMESTAMPTZ THEN
      cbs.future_branch_id
    -- –ò–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π —Ñ–∏–ª–∏–∞–ª
    ELSE COALESCE(cbs.current_branch_id, c.branch_id)
  END AS search_branch_id
  
FROM cars c
LEFT JOIN branches b ON c.branch_id = b.id
LEFT JOIN car_branch_states cbs ON c.id = cbs.car_id
LEFT JOIN bookings existing ON c.id = existing.car_id
  AND existing.status NOT IN ('cancelled', 'rejected', 'deleted')
  AND (
    (existing.start_at <= $1::TIMESTAMPTZ AND existing.end_at >= $1::TIMESTAMPTZ) OR
    (existing.start_at <= $2::TIMESTAMPTZ AND existing.end_at >= $2::TIMESTAMPTZ) OR
    (existing.start_at >= $1::TIMESTAMPTZ AND existing.end_at <= $2::TIMESTAMPTZ)
  )
WHERE existing.id IS NULL -- –ù–µ—Ç –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏—Ö—Å—è –±—Ä–æ–Ω–µ–π
  AND c.available = TRUE
  AND (
    -- –ú–∞—à–∏–Ω–∞ –≤ —Ü–µ–ª–µ–≤–æ–º —Ñ–∏–ª–∏–∞–ª–µ
    COALESCE(cbs.future_branch_id, cbs.current_branch_id, c.branch_id) = (
      SELECT id FROM branches WHERE code = $3
    )
    OR
    -- –ò–ª–∏ –º–æ–∂–Ω–æ –¥–æ—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –¥—Ä—É–≥–æ–≥–æ —Ñ–∏–ª–∏–∞–ª–∞
    EXISTS (
      SELECT 1 FROM city_delivery_pricing cdp
      WHERE cdp.delivery_branch_id = COALESCE(cbs.future_branch_id, cbs.current_branch_id, c.branch_id)
        AND cdp.city_id = (SELECT id FROM cities WHERE name = $4)
        AND cdp.is_active = TRUE
    )
  )
ORDER BY 
  -- –°–Ω–∞—á–∞–ª–∞ –º–∞—à–∏–Ω—ã –≤ —Ü–µ–ª–µ–≤–æ–º —Ñ–∏–ª–∏–∞–ª–µ (–±–µ–∑ –¥–æ—Å—Ç–∞–≤–∫–∏)
  CASE WHEN COALESCE(cbs.future_branch_id, cbs.current_branch_id, c.branch_id) = 
            (SELECT id FROM branches WHERE code = $3) THEN 0 ELSE 1 END,
  c.plate;
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `$1` ‚Äî `issueDate` (TIMESTAMPTZ)
- `$2` ‚Äî `returnDate` (TIMESTAMPTZ)
- `$3` ‚Äî `targetBranchCode` (TEXT)
- `$4` ‚Äî `targetCity` (TEXT)

### –®–∞–≥ 3: –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –¥–æ—Å—Ç–∞–≤–∫–µ –¥–ª—è –∫–∞–∂–¥–æ–π –º–∞—à–∏–Ω—ã

–ò—Å–ø–æ–ª—å–∑—É–π VIEW `car_delivery_options_view`:

```sql
SELECT 
  car_id,
  car_plate,
  current_branch_code,
  future_branch_code,
  target_branch_code,
  delivery_scope,
  
  -- –°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏
  final_delivery_fee_usd,
  
  -- –°—Ç–æ–∏–º–æ—Å—Ç—å –≤–æ–∑–≤—Ä–∞—Ç–∞ (–¥–ª—è –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–π –∞—Ä–µ–Ω–¥—ã)
  final_one_way_fee_usd,
  discount_percent,
  can_offer_without_fee,
  
  -- –î–æ–ø–ª–∞—Ç–∞ –∑–∞ –Ω–µ—Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è (—Ä–∞–∑–º–µ—Ä, –Ω–µ —Ä–∞—Å—á—ë—Ç)
  out_of_hours_fee_usd,
  
  days_until_future_booking
  
FROM car_delivery_options_view
WHERE car_id = $1
  AND target_branch_code = $2;
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `$1` ‚Äî `carId` (UUID)
- `$2` ‚Äî `targetBranchCode` (TEXT)

### –®–∞–≥ 4: –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–æ–ø–ª–∞—Ç—É –∑–∞ –Ω–µ—Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è

```sql
SELECT calculate_out_of_hours_fee(
  $1::TIMESTAMPTZ, -- issue_time
  $2::TIMESTAMPTZ  -- return_time
) AS out_of_hours_fee;
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `$1` ‚Äî `issueDate` (TIMESTAMPTZ)
- `$2` ‚Äî `returnDate` (TIMESTAMPTZ)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** `0`, `20` –∏–ª–∏ `40` (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏)

### –®–∞–≥ 5: –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å

```javascript
// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –¥–æ—Å—Ç–∞–≤–∫–µ
const deliveryData = await sql`
  SELECT 
    final_delivery_fee_usd,
    final_one_way_fee_usd,
    discount_percent,
    can_offer_without_fee,
    delivery_scope
  FROM car_delivery_options_view
  WHERE car_id = ${carId}
    AND target_branch_code = ${targetBranchCode}
`;

// –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–æ–ø–ª–∞—Ç—É –∑–∞ –Ω–µ—Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è
const outOfHoursFee = await sql`
  SELECT calculate_out_of_hours_fee(
    ${issueDate}::TIMESTAMPTZ,
    ${returnDate}::TIMESTAMPTZ
  ) AS fee
`;

// –ë–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∞—Ä–µ–Ω–¥—ã (–∏–∑ –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º—ã)
const baseRentalPrice = 100; // USD

// –°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏
const deliveryFee = deliveryData.final_delivery_fee_usd || 0;

// –°—Ç–æ–∏–º–æ—Å—Ç—å –≤–æ–∑–≤—Ä–∞—Ç–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–π –∞—Ä–µ–Ω–¥—ã)
const returnFee = isOneWay ? (deliveryData.final_one_way_fee_usd || 0) : 0;

// –î–æ–ø–ª–∞—Ç–∞ –∑–∞ –Ω–µ—Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è
const outOfHoursFeeAmount = outOfHoursFee.fee || 0;

// –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å
const totalPrice = baseRentalPrice + deliveryFee + returnFee + outOfHoursFeeAmount;

// –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
const priceBreakdown = {
  baseRental: baseRentalPrice,
  delivery: {
    amount: deliveryFee,
    type: deliveryData.delivery_scope, // 'city', 'airport', 'intercity'
    note: deliveryFee === 0 ? '–ú–∞—à–∏–Ω–∞ –≤ –≤–∞—à–µ–º –≥–æ—Ä–æ–¥–µ' : 
          deliveryData.delivery_scope === 'city' ? '–î–æ—Å—Ç–∞–≤–∫–∞ –≤ –≥–æ—Ä–æ–¥–µ' :
          deliveryData.delivery_scope === 'airport' ? '–î–æ—Å—Ç–∞–≤–∫–∞ –¥–æ –∞—ç—Ä–æ–ø–æ—Ä—Ç–∞' :
          '–î–æ—Å—Ç–∞–≤–∫–∞ –∏–∑ –¥—Ä—É–≥–æ–≥–æ –≥–æ—Ä–æ–¥–∞'
  },
  return: isOneWay ? {
    amount: returnFee,
    discount: deliveryData.discount_percent,
    note: deliveryData.can_offer_without_fee ? 
          '–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç (–º–∞—à–∏–Ω–∞ –≤–µ—Ä–Ω—ë—Ç—Å—è –≤ –Ω—É–∂–Ω—ã–π —Ñ–∏–ª–∏–∞–ª)' :
          deliveryData.discount_percent > 0 ?
          `–°–∫–∏–¥–∫–∞ ${deliveryData.discount_percent}% –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç` :
          '–°—Ç–æ–∏–º–æ—Å—Ç—å –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ —Ñ–∏–ª–∏–∞–ª –≤—ã–¥–∞—á–∏'
  } : null,
  outOfHours: outOfHoursFeeAmount > 0 ? {
    amount: outOfHoursFeeAmount,
    note: '–î–æ–ø–ª–∞—Ç–∞ –∑–∞ –≤—ã–¥–∞—á—É/–ø—Ä–∏—ë–º –≤–Ω–µ —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ (09:00-20:00)'
  } : null,
  total: totalPrice
};
```

## –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –∞–≥–µ–Ω—Ç–∞

```sql
-- –ü–æ–∏—Å–∫ –º–∞—à–∏–Ω —Å –ø–æ–ª–Ω—ã–º —Ä–∞—Å—á—ë—Ç–æ–º —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏
WITH available_cars AS (
  -- –ù–∞—Ö–æ–¥–∏–º —Å–≤–æ–±–æ–¥–Ω—ã–µ –º–∞—à–∏–Ω—ã
  SELECT DISTINCT
    c.id AS car_id,
    c.plate,
    c.model,
    COALESCE(cbs.future_branch_id, cbs.current_branch_id, c.branch_id) AS effective_branch_id,
    COALESCE(cbs.future_branch_code, cbs.current_branch_code, b.code) AS effective_branch_code,
    cbs.days_until_future_booking,
    cbs.home_branch_id,
    cbs.desired_branch_id
  FROM cars c
  LEFT JOIN branches b ON c.branch_id = b.id
  LEFT JOIN car_branch_states cbs ON c.id = cbs.car_id
  WHERE c.available = TRUE
    AND NOT EXISTS (
      SELECT 1 FROM bookings bk
      WHERE bk.car_id = c.id
        AND bk.status NOT IN ('cancelled', 'rejected', 'deleted')
        AND (
          (bk.start_at <= $1::TIMESTAMPTZ AND bk.end_at >= $1::TIMESTAMPTZ) OR
          (bk.start_at <= $2::TIMESTAMPTZ AND bk.end_at >= $2::TIMESTAMPTZ) OR
          (bk.start_at >= $1::TIMESTAMPTZ AND bk.end_at <= $2::TIMESTAMPTZ)
        )
    )
),
delivery_options AS (
  -- –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –¥–æ—Å—Ç–∞–≤–∫–µ
  SELECT 
    ac.*,
    cdp.delivery_scope,
    CASE 
      WHEN cdp.delivery_scope = 'city' THEN cdp.in_city_fee_usd
      WHEN cdp.delivery_scope = 'airport' THEN cdp.airport_fee_usd
      ELSE cdp.intercity_fee_usd
    END AS delivery_fee,
    cdp.return_fee_usd,
    cdp.one_way_allowed,
    -- –†–∞—Å—á—ë—Ç —Å–∫–∏–¥–∫–∏
    CASE
      WHEN ac.home_branch_id = (SELECT id FROM branches WHERE code = $3) THEN 100.00
      WHEN ac.desired_branch_id = (SELECT id FROM branches WHERE code = $3) THEN 100.00
      WHEN ac.days_until_future_booking IS NOT NULL 
           AND ac.days_until_future_booking >= 7 
           AND ac.days_until_future_booking <= 14 THEN 50.00
      WHEN ac.days_until_future_booking IS NOT NULL 
           AND ac.days_until_future_booking < 7 THEN 100.00
      ELSE 0.00
    END AS discount_percent
  FROM available_cars ac
  LEFT JOIN city_delivery_pricing cdp ON 
    cdp.delivery_branch_id = ac.effective_branch_id
    AND cdp.city_id = (SELECT id FROM cities WHERE name = $4)
    AND cdp.is_active = TRUE
  WHERE 
    -- –ú–∞—à–∏–Ω–∞ –≤ —Ü–µ–ª–µ–≤–æ–º —Ñ–∏–ª–∏–∞–ª–µ (–±–µ–∑ –¥–æ—Å—Ç–∞–≤–∫–∏)
    ac.effective_branch_id = (SELECT id FROM branches WHERE code = $3)
    OR
    -- –ò–ª–∏ –º–æ–∂–Ω–æ –¥–æ—Å—Ç–∞–≤–∏—Ç—å
    cdp.id IS NOT NULL
)
SELECT 
  car_id,
  plate,
  model,
  effective_branch_code,
  delivery_scope,
  delivery_fee,
  return_fee_usd * (1 - discount_percent / 100.0) AS return_fee_with_discount,
  discount_percent,
  days_until_future_booking,
  -- –§–ª–∞–≥: –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ (–º–∞—à–∏–Ω–∞ –≤ —Ü–µ–ª–µ–≤–æ–º —Ñ–∏–ª–∏–∞–ª–µ)
  CASE WHEN effective_branch_id = (SELECT id FROM branches WHERE code = $3) THEN TRUE ELSE FALSE END AS is_local
FROM delivery_options
ORDER BY 
  -- –°–Ω–∞—á–∞–ª–∞ –ª–æ–∫–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã
  is_local DESC,
  -- –ü–æ—Ç–æ–º –ø–æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏
  delivery_fee ASC;
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `$1` ‚Äî `issueDate` (TIMESTAMPTZ)
- `$2` ‚Äî `returnDate` (TIMESTAMPTZ)
- `$3` ‚Äî `targetBranchCode` (TEXT, –Ω–∞–ø—Ä–∏–º–µ—Ä 'tbilisi')
- `$4` ‚Äî `targetCity` (TEXT, –Ω–∞–ø—Ä–∏–º–µ—Ä '–¢–±–∏–ª–∏—Å–∏')

## –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–æ–¥–µ –∞–≥–µ–Ω—Ç–∞

```javascript
import postgres from 'postgres';

const sql = postgres(CONNECTION_STRING);

async function searchCarsWithDelivery(options) {
  const {
    targetCity,        // "–¢–±–∏–ª–∏—Å–∏"
    targetBranchCode, // "tbilisi"
    issueDate,        // "2025-02-01 10:00:00+04"
    returnDate,       // "2025-02-05 18:00:00+04"
    isOneWay = false  // –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω—è—è –∞—Ä–µ–Ω–¥–∞?
  } = options;
  
  // 1. –ù–∞—Ö–æ–¥–∏–º —Å–≤–æ–±–æ–¥–Ω—ã–µ –º–∞—à–∏–Ω—ã
  const cars = await sql`
    -- –ò—Å–ø–æ–ª—å–∑—É–π –∑–∞–ø—Ä–æ—Å –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ "–ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞"
    ...
  `;
  
  // 2. –î–ª—è –∫–∞–∂–¥–æ–π –º–∞—à–∏–Ω—ã —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–ª–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
  const carsWithPricing = await Promise.all(
    cars.map(async (car) => {
      // –î–æ–ø–ª–∞—Ç–∞ –∑–∞ –Ω–µ—Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è
      const [outOfHours] = await sql`
        SELECT calculate_out_of_hours_fee(
          ${issueDate}::TIMESTAMPTZ,
          ${returnDate}::TIMESTAMPTZ
        ) AS fee
      `;
      
      // –ë–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∞—Ä–µ–Ω–¥—ã (–∏–∑ –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º—ã)
      const baseRental = await calculateBaseRentalPrice(car.car_id, issueDate, returnDate);
      
      // –°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏
      const deliveryFee = car.delivery_fee || 0;
      
      // –°—Ç–æ–∏–º–æ—Å—Ç—å –≤–æ–∑–≤—Ä–∞—Ç–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–π)
      const returnFee = isOneWay ? (car.return_fee_with_discount || 0) : 0;
      
      // –î–æ–ø–ª–∞—Ç–∞ –∑–∞ –Ω–µ—Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è
      const outOfHoursFee = outOfHours.fee || 0;
      
      // –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å
      const totalPrice = baseRental + deliveryFee + returnFee + outOfHoursFee;
      
      return {
        ...car,
        pricing: {
          baseRental,
          delivery: {
            amount: deliveryFee,
            type: car.delivery_scope,
            isLocal: car.is_local
          },
          return: isOneWay ? {
            amount: returnFee,
            discount: car.discount_percent,
            originalAmount: car.return_fee_usd
          } : null,
          outOfHours: outOfHoursFee > 0 ? {
            amount: outOfHoursFee
          } : null,
          total: totalPrice
        }
      };
    })
  );
  
  // 3. –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∏—Ç–æ–≥–æ–≤–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏
  return carsWithPricing.sort((a, b) => a.pricing.total - b.pricing.total);
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
const results = await searchCarsWithDelivery({
  targetCity: "–¢–±–∏–ª–∏—Å–∏",
  targetBranchCode: "tbilisi",
  issueDate: "2025-02-01 10:00:00+04",
  returnDate: "2025-02-05 18:00:00+04",
  isOneWay: false
});

// –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
results.forEach(car => {
  console.log(`
–ú–∞—à–∏–Ω–∞: ${car.plate} (${car.model})
–§–∏–ª–∏–∞–ª: ${car.effective_branch_code}
${car.pricing.delivery.isLocal ? '‚úÖ –í –≤–∞—à–µ–º –≥–æ—Ä–æ–¥–µ (–±–µ–∑ –¥–æ—Å—Ç–∞–≤–∫–∏)' : `üöö –î–æ—Å—Ç–∞–≤–∫–∞: $${car.pricing.delivery.amount}`}
${car.pricing.return ? `üîÑ –í–æ–∑–≤—Ä–∞—Ç: $${car.pricing.return.amount}${car.pricing.return.discount > 0 ? ` (—Å–∫–∏–¥–∫–∞ ${car.pricing.return.discount}%)` : ''}` : ''}
${car.pricing.outOfHours ? `‚è∞ –î–æ–ø–ª–∞—Ç–∞ –∑–∞ –Ω–µ—Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è: $${car.pricing.outOfHours.amount}` : ''}
üí∞ –ò—Ç–æ–≥–æ: $${car.pricing.total}
  `);
});
```

## –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### 1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ future_branch_id

**–ö—Ä–∏—Ç–∏—á–Ω–æ:** –ü—Ä–∏ –ø–æ–∏—Å–∫–µ –º–∞—à–∏–Ω –¥–ª—è –±—É–¥—É—â–∏—Ö –¥–∞—Ç –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π `future_branch_id`, –µ—Å–ª–∏ –æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –ø–µ—Ä–∏–æ–¥ –∞—Ä–µ–Ω–¥—ã –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç –∏–ª–∏ –∏–¥—ë—Ç –ø–æ—Å–ª–µ —Å–ª–µ–¥—É—é—â–µ–π –±—Ä–æ–Ω–∏.

```sql
-- –ü—Ä–∞–≤–∏–ª—å–Ω–æ: —É—á–∏—Ç—ã–≤–∞–µ–º –±—É–¥—É—â–∏–π —Ñ–∏–ª–∏–∞–ª
COALESCE(cbs.future_branch_id, cbs.current_branch_id, c.branch_id) AS search_branch_id

-- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π —Ñ–∏–ª–∏–∞–ª
c.branch_id AS search_branch_id
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏

–í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π, —á—Ç–æ –º–∞—à–∏–Ω–∞ —Å–≤–æ–±–æ–¥–Ω–∞ –≤ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã–π –ø–µ—Ä–∏–æ–¥:

```sql
WHERE NOT EXISTS (
  SELECT 1 FROM bookings bk
  WHERE bk.car_id = c.id
    AND bk.status NOT IN ('cancelled', 'rejected', 'deleted')
    AND (
      (bk.start_at <= $issueDate AND bk.end_at >= $issueDate) OR
      (bk.start_at <= $returnDate AND bk.end_at >= $returnDate) OR
      (bk.start_at >= $issueDate AND bk.end_at <= $returnDate)
    )
)
```

### 3. –†–∞—Å—á—ë—Ç –¥–æ–ø–ª–∞—Ç—ã –∑–∞ –Ω–µ—Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è

–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ—É–Ω–∫—Ü–∏—é `calculate_out_of_hours_fee()`, –æ–Ω–∞ —É—á–∏—Ç—ã–≤–∞–µ—Ç —Ç–∞–π–º–∑–æ–Ω—É Asia/Tbilisi:

```sql
SELECT calculate_out_of_hours_fee($issueDate, $returnDate);
```

### 4. –°–∫–∏–¥–∫–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

VIEW `car_delivery_options_view` —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–∫–∏–¥–∫–∏. –ü—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–π `final_one_way_fee_usd` ‚Äî —Ç–∞–º —É–∂–µ —É—á—Ç–µ–Ω–∞ —Å–∫–∏–¥–∫–∞.

### 5. –¢–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏

–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ:
- –ï—Å–ª–∏ –º–∞—à–∏–Ω–∞ –≤ —Ç–æ–º –∂–µ –≥–æ—Ä–æ–¥–µ ‚Üí `city` ($10)
- –ï—Å–ª–∏ –µ—Å—Ç—å –∞—ç—Ä–æ–ø–æ—Ä—Ç –∏ –∫–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç —Ç—É–¥–∞ ‚Üí `airport` ($20)
- –ò–Ω–∞—á–µ ‚Üí `intercity` (—Ü–µ–Ω–∞ –∏–∑ routes.xlsx)

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –º–∞—à–∏–Ω—ã –∏–∑ –¥—Ä—É–≥–∏—Ö —Ñ–∏–ª–∏–∞–ª–æ–≤

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ:
1. –í —Ç–∞–±–ª–∏—Ü–µ `cities` –µ—Å—Ç—å –∑–∞–ø–∏—Å—å –¥–ª—è —Ü–µ–ª–µ–≤–æ–≥–æ –≥–æ—Ä–æ–¥–∞
2. –í —Ç–∞–±–ª–∏—Ü–µ `city_delivery_pricing` –µ—Å—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã –æ—Ç —Ñ–∏–ª–∏–∞–ª–æ–≤ –¥–æ –≥–æ—Ä–æ–¥–∞
3. –ò—Å–ø–æ–ª—å–∑—É–µ—à—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `targetBranchCode` (tbilisi, batumi, kutaisi)

### –ü—Ä–æ–±–ª–µ–º–∞: –°–∫–∏–¥–∫–∏ –Ω–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ:
1. `car_branch_states` –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (—Ç—Ä–∏–≥–≥–µ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç)
2. `home_branch_id` –∏–ª–∏ `desired_branch_id` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
3. `days_until_future_booking` —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### –ü—Ä–æ–±–ª–µ–º–∞: –î–æ–ø–ª–∞—Ç–∞ –∑–∞ –Ω–µ—Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è –Ω–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:** –£–±–µ–¥–∏—Å—å, —á—Ç–æ:
1. –í—Ä–µ–º—è –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ TIMESTAMPTZ
2. –ò—Å–ø–æ–ª—å–∑—É–µ—à—å —Ñ—É–Ω–∫—Ü–∏—é `calculate_out_of_hours_fee()`
3. –¢–∞–π–º–∑–æ–Ω–∞ —É—á—Ç–µ–Ω–∞ (Asia/Tbilisi)

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã: [docs/DELIVERY_SYSTEM.md](./DELIVERY_SYSTEM.md)
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î: [STRUCTURE.md](../STRUCTURE.md)
- –ü—Ä–∏–º–µ—Ä—ã SQL –∑–∞–ø—Ä–æ—Å–æ–≤: —Å–º. —Ä–∞–∑–¥–µ–ª "–ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞" –≤—ã—à–µ

