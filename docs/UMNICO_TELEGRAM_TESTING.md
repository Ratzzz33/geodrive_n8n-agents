# Umnico Telegram Bridge: Инструкция по тестированию

Этот документ содержит пошаговую инструкцию по тестированию интеграции Umnico с Telegram.

## Предварительные требования

1. ✅ Применена миграция БД (`sql/umnico_telegram_integration.sql`)
2. ✅ Настроены переменные окружения в `.env`:
   - `UMNICO_FORUM_CHAT_ID=-5015844768`
   - `UMNICO_POLLING_INTERVAL=5`
   - `WEB_APP_URL=https://conversations.rentflow.rentals`
   - `PLAYWRIGHT_UMNICO_URL=http://localhost:3001`
   - `TELEGRAM_BOT_TOKEN` (токен бота @n8n_alert_geodrive_bot)
3. ✅ Telegram-группа настроена как форум с включенными темами
4. ✅ Бот добавлен в группу как администратор с правами:
   - Manage Topics
   - Post Messages
   - Edit Messages
   - Pin Messages
5. ✅ Playwright Service запущен и доступен
6. ✅ Jarvis API запущен

## Тест 1: Проверка создания темы при новом сообщении

### Шаги:

1. **Отправьте тестовое сообщение в Umnico** от имени клиента (через WhatsApp/Telegram/Instagram)

2. **Проверьте логи Jarvis API:**
   ```bash
   docker logs jarvis-api --tail 50 -f
   ```
   
   Должны увидеть:
   ```
   Found X new messages in conversation CONVERSATION_ID
   Creating new topic for conversation CONVERSATION_ID
   Created topic TOPIC_ID for conversation CONVERSATION_ID
   ```

3. **Проверьте Telegram-группу:**
   - Должна появиться новая тема с названием: `Клиент | Автомобиль | Даты`
   - В теме должно быть закрепленное сообщение с:
     - Информацией о клиенте
     - Информацией о брони (если есть)
     - Кнопками "Закрыть диалог" и "Продлить на 1 час"
     - Ссылкой на веб-интерфейс
   - Сообщение клиента должно появиться в теме

### Ожидаемый результат:

✅ Новая тема создана  
✅ Закрепленное сообщение с информацией  
✅ Сообщение клиента отображается в теме

---

## Тест 2: Проверка отправки сообщения из Telegram в Umnico

### Шаги:

1. **Откройте тему диалога в Telegram-группе**

2. **Отправьте сообщение в тему** (не команду, обычный текст)

3. **Проверьте логи Jarvis API:**
   ```
   Sending message to Umnico conversation CONVERSATION_ID from Telegram topic TOPIC_ID
   Message sent successfully to conversation CONVERSATION_ID
   ```

4. **Проверьте Umnico:**
   - Сообщение должно появиться в диалоге с клиентом
   - Сообщение должно быть отправлено от имени вашего аккаунта

### Ожидаемый результат:

✅ Сообщение отправлено в Umnico  
✅ Сообщение видно клиенту  
✅ Сессия продлена на 1 час

---

## Тест 3: Проверка кнопок управления сессией

### Тест 3.1: Продление сессии

1. **Нажмите кнопку "Продлить на 1 час"** в закрепленном сообщении

2. **Проверьте логи:**
   ```
   Dialog CONVERSATION_ID extended by user USER_ID
   Extended session for conversation CONVERSATION_ID
   ```

3. **Проверьте БД:**
   ```sql
   SELECT session_expires_at 
   FROM conversations 
   WHERE umnico_conversation_id = 'CONVERSATION_ID';
   ```
   
   `session_expires_at` должен быть обновлен на +1 час от текущего времени

### Тест 3.2: Закрытие диалога

1. **Нажмите кнопку "Закрыть диалог"** в закрепленном сообщении

2. **Проверьте логи:**
   ```
   Dialog CONVERSATION_ID closed by user USER_ID
   Closed session for conversation CONVERSATION_ID
   ```

3. **Проверьте БД:**
   ```sql
   SELECT status, session_expires_at 
   FROM conversations 
   WHERE umnico_conversation_id = 'CONVERSATION_ID';
   ```
   
   `status` должен быть `'closed'`, `session_expires_at` должен быть `NULL`

4. **Проверьте Telegram:**
   - В теме должно появиться сообщение о закрытии диалога

### Ожидаемый результат:

✅ Кнопки работают корректно  
✅ Сессия продлевается/закрывается  
✅ Статус обновляется в БД

---

## Тест 4: Проверка веб-интерфейса

### Шаги:

1. **Откройте ссылку из закрепленного сообщения** в теме диалога

2. **Проверьте отображение:**
   - Информация о клиенте (имя, телефон)
   - Информация о брони (если есть)
   - Список сообщений (входящие и исходящие)
   - Правильное форматирование дат и времени

3. **Проверьте пагинацию** (если сообщений больше 50):
   - Кнопки "Назад" и "Вперед"
   - Корректное отображение количества сообщений

### Ожидаемый результат:

✅ Веб-интерфейс загружается  
✅ Все данные отображаются корректно  
✅ Пагинация работает

---

## Тест 5: Проверка автоматического закрытия сессии

### Шаги:

1. **Создайте тестовый диалог** (отправьте сообщение в Umnico)

2. **Подождите 1 час** без активности (или измените `session_expires_at` в БД на прошлое время для теста)

3. **Проверьте логи:**
   ```
   Closed session for conversation CONVERSATION_ID
   ```

4. **Проверьте БД:**
   ```sql
   SELECT status, session_expires_at 
   FROM conversations 
   WHERE umnico_conversation_id = 'CONVERSATION_ID';
   ```
   
   `status` должен быть `'closed'`

5. **Проверьте Telegram:**
   - В теме должно появиться сообщение о закрытии диалога

### Ожидаемый результат:

✅ Сессия автоматически закрывается через 1 час  
✅ Статус обновляется в БД  
✅ Уведомление отправляется в Telegram

---

## Тест 6: Проверка polling активных чатов

### Шаги:

1. **Проверьте логи UmnicoRealtimeSync:**
   ```bash
   docker logs jarvis-api --tail 100 | grep "Umnico Realtime Sync"
   ```
   
   Должны увидеть:
   ```
   Starting Umnico Realtime Sync with polling interval: 5 seconds
   Syncing X active conversations
   ```

2. **Отправьте новое сообщение в Umnico** от имени клиента

3. **Подождите до 5 секунд** и проверьте логи:
   ```
   Found 1 new messages in conversation CONVERSATION_ID
   ```

4. **Проверьте Telegram:**
   - Новое сообщение должно появиться в теме в течение 5 секунд

### Ожидаемый результат:

✅ Polling работает каждые 5 секунд  
✅ Новые сообщения обнаруживаются и обрабатываются  
✅ Сообщения появляются в Telegram быстро

---

## Тест 7: Проверка обработки ошибок

### Тест 7.1: Недоступный Playwright Service

1. **Остановите Playwright Service:**
   ```bash
   docker stop playwright-umnico
   ```

2. **Отправьте сообщение в Umnico**

3. **Проверьте логи:**
   - Должны быть ошибки подключения к Playwright Service
   - Но сервис не должен падать

4. **Запустите Playwright Service снова:**
   ```bash
   docker start playwright-umnico
   ```

5. **Проверьте восстановление:**
   - Следующие сообщения должны обрабатываться нормально

### Тест 7.2: Неверный conversationId

1. **Попробуйте отправить сообщение с несуществующим conversationId**

2. **Проверьте логи:**
   - Должна быть ошибка, но сервис не должен падать

### Ожидаемый результат:

✅ Ошибки обрабатываются gracefully  
✅ Сервис продолжает работать  
✅ Логи содержат информацию об ошибках

---

## Тест 8: Проверка создания клиентов

### Шаги:

1. **Отправьте сообщение от нового клиента** (телефон которого нет в БД)

2. **Проверьте БД:**
   ```sql
   SELECT id, name, phone 
   FROM clients 
   WHERE phone LIKE '%PHONE_NUMBER%';
   ```
   
   Должен быть создан новый клиент

3. **Проверьте логи:**
   ```
   Created new client CLIENT_ID for phone PHONE_NUMBER
   ```

### Ожидаемый результат:

✅ Новые клиенты создаются автоматически  
✅ Информация сохраняется в БД  
✅ Клиент привязывается к диалогу

---

## Чек-лист успешного тестирования

- [ ] Новые темы создаются при появлении сообщений
- [ ] Закрепленные сообщения содержат всю информацию
- [ ] Сообщения из Telegram отправляются в Umnico
- [ ] Сообщения из Umnico появляются в Telegram
- [ ] Кнопки "Продлить" и "Закрыть" работают
- [ ] Сессии автоматически закрываются через 1 час
- [ ] Веб-интерфейс отображает историю корректно
- [ ] Polling работает каждые 5 секунд
- [ ] Новые клиенты создаются автоматически
- [ ] Ошибки обрабатываются gracefully

---

## Известные ограничения

1. **Polling интервал:** Минимальный интервал 5 секунд (можно уменьшить, но не рекомендуется из-за нагрузки)
2. **Сессия:** Автоматическое закрытие через 1 час (можно изменить в коде)
3. **Playwright Service:** Требуется постоянное подключение к интернету и авторизация в Umnico

---

## Troubleshooting

### Проблема: Темы не создаются

**Решение:**
1. Проверьте права бота в Telegram-группе
2. Проверьте что группа является форумом (Topics включены)
3. Проверьте `UMNICO_FORUM_CHAT_ID` в `.env`
4. Проверьте логи на ошибки создания темы

### Проблема: Сообщения не отправляются в Umnico

**Решение:**
1. Проверьте что Playwright Service запущен и доступен
2. Проверьте `PLAYWRIGHT_UMNICO_URL` в `.env`
3. Проверьте что Playwright Service авторизован в Umnico
4. Проверьте логи Playwright Service

### Проблема: Polling не работает

**Решение:**
1. Проверьте что `UmnicoRealtimeSync` запущен (логи при старте)
2. Проверьте `UMNICO_POLLING_INTERVAL` в `.env`
3. Проверьте что есть активные диалоги в БД
4. Проверьте логи на ошибки синхронизации

---

## Дополнительная информация

- **Документация:** `docs/UMNICO_TELEGRAM_BRIDGE.md`
- **Настройка:** `setup/UMNICO_TELEGRAM_SETUP.md`
- **Веб-интерфейс:** `docs/WEB_INTERFACE_SETUP.md`

