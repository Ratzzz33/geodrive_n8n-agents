# Исправление сохранения броней и часовых поясов

## Проблемы
1. **Неверное время брони**: Брони сохранялись в UTC без учета часового пояса RentProg (Asia/Tbilisi, UTC+4). Из-за этого время "12:00" превращалось в "16:00" по Тбилиси.
2. **Отсутствие привязки RentProg ID**: Брони создавались в БД, но не имели прямой связи с `rentprog_id` в таблице `bookings` (отсутствовали обязательные колонки `rentprog_id` и `number` в схеме кода), что приводило к ошибкам или невозможности поиска.
3. **Отсутствие истории изменений**: При создании броней через `upsertBookingFromRentProg` не сохранялась информация об источнике (`updated_by_source`, `updated_by_workflow`).

## Решения

### 1. Исправление часовых поясов
- Обновлена функция `parseRentProgDate` в `src/db/upsert.ts`: теперь она явно добавляет смещение `+04:00` к датам из RentProg.
- Исправлено время для конкретной брони `515982` в базе данных.

### 2. Исправление схемы данных и привязки
- В схему таблицы `bookings` (`src/db/schema.ts`) добавлены обязательные поля `rentprog_id` и `number`.
- Обновлена функция `upsertBookingFromRentProg` в `src/db/upsert.ts`:
  - Теперь принимает параметр `changeTracking` для записи истории.
  - Заполняет поля `rentprog_id` и `number` (парсит из ID).
  - Добавляет название филиала в поле `branch`.

### 3. Тестирование
- Добавлены unit-тесты для `parseRentProgDate` в `src/db/upsert.test.ts`.
- Создан интеграционный тест `setup/check_upsert_flow.ts`, проверяющий полный цикл создания брони, привязки external_refs и записи истории.

## Результат
Теперь брони создаются с правильным временем (по Тбилиси), имеют корректные привязки к RentProg ID и сохраняют историю изменений (какой скрипт/воркфлоу их создал).

