# –ö–æ–¥—ã –æ—à–∏–±–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ (history.error_code)

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–í —Ç–∞–±–ª–∏—Ü–µ `history` –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `error_code` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π:

- **`error_code = NULL`** ‚Üí –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ ‚úÖ
- **`error_code = 'ERR_XXX'`** ‚Üí –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ –ø—Ä–æ—à–ª–∞, –∫–æ–¥ –æ—à–∏–±–∫–∏ ‚ùå

## üîç –ö–æ–¥—ã –æ—à–∏–±–æ–∫ (—Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `HISTORY_ERR_`)

–í—Å–µ –∫–æ–¥—ã –æ—à–∏–±–æ–∫ –∏–º–µ—é—Ç –ø—Ä–µ—Ñ–∏–∫—Å `HISTORY_ERR_` –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞. –ü—Ä–æ—Å—Ç–æ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ!

| –ö–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏—á–∏–Ω–∞ |
|-----|----------|---------|
| `HISTORY_ERR_EMPTY_DESCRIPTION` | –ü—É—Å—Ç–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è | –ü–æ–ª–µ `description` –ø—É—Å—Ç–æ–µ –∏–ª–∏ NULL |
| `HISTORY_ERR_PARSE_EXCEPTION` | SQL –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ | –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `parse_history_description()` |
| `HISTORY_ERR_PARSE_FAILED` | –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ | –ü–∞—Ä—Å–µ—Ä –Ω–µ —Å–º–æ–≥ –Ω–∞–π—Ç–∏ `entity_type` –∏–ª–∏ `entity_id` –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ |
| `HISTORY_ERR_APPLY_EXCEPTION` | SQL –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ | –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `apply_history_changes()` |
| `HISTORY_ERR_ENTITY_NOT_FOUND` | –°—É—â–Ω–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –ë–î | –ü–∞—Ä—Å–∏–Ω–≥ —É—Å–ø–µ—à–µ–Ω, –Ω–æ —Å—É—â–Ω–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ `external_refs` –∏–ª–∏ —Ü–µ–ª–µ–≤–æ–π —Ç–∞–±–ª–∏—Ü–µ |

## üõ†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏ —Å –æ—à–∏–±–∫–∞–º–∏

```bash
node setup/check_history_errors.mjs
```

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ—à–∏–±–æ–∫ –ø–æ –∫–æ–¥–∞–º
- –û–ø–∏—Å–∞–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–¥–∞
- –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∑–∞–ø–∏—Å–µ–π —Å –æ—à–∏–±–∫–∞–º–∏

### –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏

**–ü–æ ID:**
```bash
node setup/get_history_by_error_code.mjs 12345
```

**–ü–æ –∫–æ–¥—É –æ—à–∏–±–∫–∏ (–≤—Å–µ –∑–∞–ø–∏—Å–∏ —Å —ç—Ç–∏–º –∫–æ–¥–æ–º):**
```bash
node setup/get_history_by_error_code.mjs HISTORY_ERR_ENTITY_NOT_FOUND
```

### SQL –∑–∞–ø—Ä–æ—Å—ã

**–ù–∞–π—Ç–∏ –≤—Å–µ –∑–∞–ø–∏—Å–∏ —Å –æ—à–∏–±–∫–∞–º–∏:**
```sql
SELECT * FROM history WHERE error_code IS NOT NULL;
```

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–æ–¥–∞–º:**
```sql
SELECT error_code, COUNT(*) as count
FROM history
WHERE error_code IS NOT NULL
GROUP BY error_code
ORDER BY count DESC;
```

**–ü–æ–ª—É—á–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏:**
```sql
SELECT get_history_error_description('ERR_ENTITY_NOT_FOUND');
```

**–ù–∞–π—Ç–∏ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏:**
```sql
SELECT * FROM history 
WHERE processed = TRUE AND error_code IS NULL;
```

## üìù –ü—Ä–∏–º–µ—Ä—ã

### –ü—Ä–∏–º–µ—Ä 1: –£—Å–ø–µ—à–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

```sql
SELECT id, description, processed, error_code
FROM history
WHERE id = 624721;
```

–†–µ–∑—É–ª—å—Ç–∞—Ç:
```
id: 624721
description: "CEO Eliseev –∏–∑–º–µ–Ω–∏–ª car_class —Å –°—Ä–µ–¥–Ω–∏–π –Ω–∞ –≠–∫–æ–Ω–æ–º..."
processed: true
error_code: NULL  ‚Üê –£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ!
```

### –ü—Ä–∏–º–µ—Ä 2: –û—à–∏–±–∫–∞ - —Å—É—â–Ω–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞

```sql
SELECT id, description, processed, error_code, notes
FROM history
WHERE error_code = 'HISTORY_ERR_ENTITY_NOT_FOUND'
LIMIT 1;
```

–†–µ–∑—É–ª—å—Ç–∞—Ç:
```
id: 12345
description: "–°–æ–∑–¥–∞–Ω–∞ –±—Ä–æ–Ω—å #99999"
processed: false
error_code: HISTORY_ERR_ENTITY_NOT_FOUND  ‚Üê –ö–æ–¥ –æ—à–∏–±–∫–∏ (—Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º!)
notes: " | –ü–∞—Ä—Å–∏–Ω–≥ —É—Å–ø–µ—à–µ–Ω, –Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã (—Å—É—â–Ω–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –ë–î?)"
```

## üîß –ö–∞–∫ —Å–æ–æ–±—â–∏—Ç—å –æ–± –æ—à–∏–±–∫–µ

–ï—Å–ª–∏ –≤—ã –≤–∏–¥–∏—Ç–µ –∑–∞–ø–∏—Å—å —Å `error_code`, –ø—Ä–æ—Å—Ç–æ **—Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ –æ—à–∏–±–∫–∏** –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ!

**–ü—Ä–∏–º–µ—Ä:**
```
HISTORY_ERR_ENTITY_NOT_FOUND
```

–ò–ª–∏ –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –±—ã—Ç—å –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–º:
```
ID: 12345
–ö–æ–¥ –æ—à–∏–±–∫–∏: HISTORY_ERR_ENTITY_NOT_FOUND
```

**–ü—Ä–µ—Ñ–∏–∫—Å `HISTORY_ERR_` –ø–æ–∑–≤–æ–ª—è–µ—Ç –º–Ω–µ –±—ã—Å—Ç—Ä–æ –ø–æ–Ω—è—Ç—å:**
- –≠—Ç–æ –æ—à–∏–±–∫–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `history`
- –ù—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –∑–∞–ø–∏—Å—å –ø–æ —ç—Ç–æ–º—É –∫–æ–¥—É
- –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏

–Ø —Å–º–æ–≥—É –±—ã—Å—Ç—Ä–æ –Ω–∞–π—Ç–∏ –≤—Å–µ –∑–∞–ø–∏—Å–∏ —Å —ç—Ç–∏–º –∫–æ–¥–æ–º –∏ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ –ø—Ä–æ–±–ª–µ–º–µ!

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ—à–∏–±–æ–∫ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

```sql
-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
SELECT error_code, COUNT(*) as count
FROM history
WHERE error_code IS NOT NULL
  AND created_at > NOW() - INTERVAL '1 hour'
GROUP BY error_code;
```

–ò–ª–∏ —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç:
```bash
node setup/check_history_errors.mjs
```

