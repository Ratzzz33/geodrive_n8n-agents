# ะััะธัะตะบัััะฐ ะธะฝัะตะณัะฐัะธะธ ั AmoCRM

**ะะฐัะฐ:** 2025-11-11  
**ะกััะฐัะตะณะธั:** ะะฐะฑะพัะฐ ัะพะปัะบะพ ัะตัะตะท API (ะฒะตะฑััะบะธ + ะทะฐะฟัะพัั ะฟะพ ะฝะตะพะฑัะพะดะธะผะพััะธ)

---

## ๐ฏ ะัะธะฝัะธะฟั ัะฐะฑะพัั

### โ ะงัะพ ะผั ะดะตะปะฐะตะผ:
- **ะะตะฑััะบะธ** ะดะปั ะฟะพะปััะตะฝะธั ัะพะฑััะธะน ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ (0 API ะทะฐะฟัะพัะพะฒ)
- **API ะทะฐะฟัะพัั** ัะพะปัะบะพ ะบะพะณะดะฐ ะฝัะถะฝะพ ะฟะพะปััะธัั ะดะตัะฐะปะธ (ะฟะพ ะทะฐะฟัะพัั ะฒะตะฑััะบะฐ)
- **ะะฒัะพะผะฐัะธัะตัะบะฐั ะพะฑัะฐะฑะพัะบะฐ** ัะตัะตะท n8n โ Playwright Service โ Jarvis API โ ะะ

### โ ะงัะพ ะผั ะะ ะดะตะปะฐะตะผ:
- โ ะะฐััะพะฒัะน ะฟะฐััะธะฝะณ ะธััะพัะธะธ ัะตัะตะท API
- โ Polling (ะฟะตัะธะพะดะธัะตัะบะธะต ะทะฐะฟัะพัั ะฒัะตั ัะดะตะปะพะบ)
- โ ะัะฑะปะธัะพะฒะฐะฝะธะต ะดะฐะฝะฝัั

---

## ๐ ะะพัะพะบ ะดะฐะฝะฝัั

```
โโโโโโโโโโโโโโโ
โ   AmoCRM    โ
โ  (ะกะพะฑััะธะต)  โ
โโโโโโโโฌโโโโโโโ
       โ
       โ Webhook (POST)
       โ 0 API ะทะฐะฟัะพัะพะฒ
       โผ
โโโโโโโโโโโโโโโโโโโโโโโ
โ   n8n Workflow      โ
โ "AmoCRM Webhooks    โ
โ  Monitor"           โ
โโโโโโโโฌโโโโโโโโโโโโโโโ
       โ
       โ 1. ะะฐััะธะฝะณ ะธ ะฒะฐะปะธะดะฐัะธั
       โ 2. ะกะพััะฐะฝะตะฝะธะต ะฒ amocrm_webhook_events
       โ 3. ะะฐะฟัะพั ะดะตัะฐะปะตะน ัะตัะตะท Playwright Service
       โผ
โโโโโโโโโโโโโโโโโโโโโโโ
โ   AmoCRM API v4      โ
โ  (https://geodrive.  โ
โ  amocrm.ru/api/v4)   โ
โโโโโโโโฌโโโโโโโโโโโโโโโ
       โ
       โ GET /leads/:id?with=contacts,companies
       โ (1 API ะทะฐะฟัะพั, ะฟััะผะพะน ะฒัะทะพะฒ)
       โผ
โโโโโโโโโโโโโโโโโโโโโโโ
โ   AmoCRM API         โ
โ  (ะะพะทะฒัะฐั ะดะตัะฐะปะตะน)   โ
โโโโโโโโฌโโโโโโโโโโโโโโโ
       โ
       โ ะะตัะฐะปัะฝัะต ะดะฐะฝะฝัะต
       โผ
โโโโโโโโโโโโโโโโโโโโโโโ
โ   n8n Workflow       โ
โ  (ะฟัะพะดะพะปะถะตะฝะธะต)       โ
โโโโโโโโฌโโโโโโโโโโโโโโโ
       โ
       โ POST /amocrm/process-webhook
       โ (ั ะดะตัะฐะปัะผะธ)
       โผ
โโโโโโโโโโโโโโโโโโโโโโโ
โ   Jarvis API        โ
โ (http://localhost:  โ
โ  3000)              โ
โโโโโโโโฌโโโโโโโโโโโโโโโ
       โ
       โ ะะฑัะฐะฑะพัะบะฐ ะธ upsert
       โผ
โโโโโโโโโโโโโโโโโโโโโโโ
โ   PostgreSQL        โ
โ  (Neon DB)          โ
โ  - amocrm_deals     โ
โ  - amocrm_webhook_  โ
โ    events           โ
โโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ ะขะธะฟั ัะพะฑััะธะน

### ะกะพะฑััะธั, ะบะพัะพััะต ะผั ะพะฑัะฐะฑะฐััะฒะฐะตะผ:

**ะกะดะตะปะบะธ (Leads):**
- `lead.add` - ะฝะพะฒะฐั ัะดะตะปะบะฐ
- `lead.update` - ะพะฑะฝะพะฒะปะตะฝะธะต ัะดะตะปะบะธ
- `lead.status` - ะธะทะผะตะฝะตะฝะธะต ััะฐัััะฐ

**ะะพะฝัะฐะบัั (Contacts):**
- `contact.add` - ะฝะพะฒัะน ะบะพะฝัะฐะบั
- `contact.update` - ะพะฑะฝะพะฒะปะตะฝะธะต ะบะพะฝัะฐะบัะฐ

**ะะพะฟะพะปะฝะธัะตะปัะฝัะต:**
- `unsorted.add` - ะฝะพะฒะพะต ะฝะตัะฐะทะพะฑัะฐะฝะฝะพะต
- `note.add` - ะฝะพะฒะพะต ะฟัะธะผะตัะฐะฝะธะต
- `message.add` - ะฝะพะฒะพะต ัะพะพะฑัะตะฝะธะต
- `conversation.add` - ะฝะพะฒะฐั ะฑะตัะตะดะฐ

---

## ๐ ะะพััะตะฑะปะตะฝะธะต API

### ะะธะผะธัั AmoCRM:
- **7,000 ะทะฐะฟัะพัะพะฒ/ัะฐั**
- **250 ะทะฐะฟัะพัะพะฒ/ะผะธะฝััั**

### ะะฐัะต ะฟะพััะตะฑะปะตะฝะธะต:

**ะกัะตะฝะฐัะธะน 1: ะะธะทะบะฐั ะฐะบัะธะฒะฝะพััั (10 ัะพะฑััะธะน/ัะฐั)**
- ะะตะฑััะบะธ: 0 ะทะฐะฟัะพัะพะฒ (ะฝะต ัะฐััะพะดััั ะปะธะผะธัั)
- API ะทะฐะฟัะพัั: 10 ะทะฐะฟัะพัะพะฒ/ัะฐั (ะฟััะผะพ ะบ AmoCRM API)
- **ะัะพะณะพ: 10 ะทะฐะฟัะพัะพะฒ/ัะฐั** (6,990 ัะฒะพะฑะพะดะฝะพ)

**ะกัะตะฝะฐัะธะน 2: ะกัะตะดะฝัั ะฐะบัะธะฒะฝะพััั (50 ัะพะฑััะธะน/ัะฐั)**
- ะะตะฑััะบะธ: 0 ะทะฐะฟัะพัะพะฒ
- API ะทะฐะฟัะพัั: 50 ะทะฐะฟัะพัะพะฒ/ัะฐั
- **ะัะพะณะพ: 50 ะทะฐะฟัะพัะพะฒ/ัะฐั** (6,950 ัะฒะพะฑะพะดะฝะพ)

**ะกัะตะฝะฐัะธะน 3: ะััะพะบะฐั ะฐะบัะธะฒะฝะพััั (100 ัะพะฑััะธะน/ัะฐั)**
- ะะตะฑััะบะธ: 0 ะทะฐะฟัะพัะพะฒ
- API ะทะฐะฟัะพัั: 100 ะทะฐะฟัะพัะพะฒ/ัะฐั
- **ะัะพะณะพ: 100 ะทะฐะฟัะพัะพะฒ/ัะฐั** (6,900 ัะฒะพะฑะพะดะฝะพ)

**ะัะตะธะผััะตััะฒะฐ ะฟััะผะพะณะพ API:**
- โ ะะตั ะฟัะพะผะตะถััะพัะฝะพะณะพ ัะตัะฒะธัะฐ (Playwright)
- โ ะััััะตะต (ะผะตะฝััะต ะทะฒะตะฝัะตะฒ ะฒ ัะตะฟะพัะบะต)
- โ ะะฐะดะตะถะฝะตะต (ะผะตะฝััะต ัะพัะตะบ ะพัะบะฐะทะฐ)
- โ ะัะพัะต ะฒ ะฟะพะดะดะตัะถะบะต

**ะัะตะธะผััะตััะฒะฐ:**
- โ ะะต ัะฐััะพะดัะตะผ ะปะธะผะธัั ะฝะฐ polling
- โ ะะฐะฟัะพัั ัะพะปัะบะพ ะฟะพ ะฝะตะพะฑัะพะดะธะผะพััะธ
- โ ะะฐัััะฐะฑะธััะตััั ั ะฐะบัะธะฒะฝะพัััั

---

## ๐๏ธ ะกัััะบัััะฐ ะะ

### ะขะฐะฑะปะธัะฐ `amocrm_webhook_events`
ะฅัะฐะฝะธั ะฒัะต ัะพะฑััะธั ะฒะตะฑััะบะพะฒ ะดะปั ะดะตะดัะฟะปะธะบะฐัะธะธ ะธ ะฐัะดะธัะฐ:
```sql
- id (BIGSERIAL)
- ts (TIMESTAMPTZ)
- event_type (TEXT) - 'lead.add', 'contact.update', etc.
- entity_type (TEXT) - 'lead', 'contact', etc.
- amocrm_entity_id (TEXT) - ID ะฒ AmoCRM
- event_hash (TEXT UNIQUE) - ะดะปั ะดะตะดัะฟะปะธะบะฐัะธะธ
- payload (JSONB) - ะฟะพะปะฝัะน payload ัะพะฑััะธั
- account_id (INT) - ID ะฐะบะบะฐัะฝัะฐ AmoCRM
- processed (BOOLEAN) - ัะปะฐะณ ะพะฑัะฐะฑะพัะบะธ
```

### ะขะฐะฑะปะธัะฐ `amocrm_deals`
ะฅัะฐะฝะธั ะพะฑัะฐะฑะพัะฐะฝะฝัะต ัะดะตะปะบะธ:
```sql
- id (UUID)
- client_id (UUID) - ัะฒัะทั ั clients
- conversation_id (UUID) - ัะฒัะทั ั conversations
- amocrm_deal_id (TEXT UNIQUE) - ID ะฒ AmoCRM
- pipeline_id, status_id, price, etc.
- custom_fields (JSONB) - ะฒัะต custom fields
- deal_full_data (JSONB) - ะฟะพะปะฝัะต ะดะฐะฝะฝัะต ัะดะตะปะบะธ
- contact_custom_fields (JSONB) - ะฟะพะปั ะบะพะฝัะฐะบัะฐ
- metadata (JSONB) - ะผะตัะฐะดะฐะฝะฝัะต (RentProg ID, etc.)
```

---

## ๐ง ะะพะผะฟะพะฝะตะฝัั ัะธััะตะผั

### 1. n8n Workflow "ะะฑัะฐะฑะพัะบะฐ ะฒะตะฑััะบะพะฒ AmoCRM"
- **URL:** `https://webhook.rentflow.rentals/amocrm`
- **ะคัะฝะบัะธะธ:**
  - ะัะธะตะผ ะฒะตะฑััะบะพะฒ ะพั AmoCRM
  - ะะฐััะธะฝะณ ะธ ะฒะฐะปะธะดะฐัะธั ัะพะฑััะธะน
  - ะกะพััะฐะฝะตะฝะธะต ะฒ `amocrm_webhook_events`
  - ะะฐะฟัะพั ะดะตัะฐะปะตะน ะฝะฐะฟััะผัั ัะตัะตะท AmoCRM API v4
  - ะัะฟัะฐะฒะบะฐ ะฒ Jarvis API ะดะปั ะพะฑัะฐะฑะพัะบะธ

### 2. AmoCRM API v4
- **Base URL:** `https://geodrive.amocrm.ru/api/v4`
- **ะะฒัะพัะธะทะฐัะธั:** OAuth 2.0 (Access Token)
- **ะคัะฝะบัะธะธ:**
  - ะะพะปััะตะฝะธะต ะดะตัะฐะปะตะน ัะดะตะปะพะบ: `GET /leads/:id?with=contacts,companies`
  - ะะพะปััะตะฝะธะต ะดะตัะฐะปะตะน ะบะพะฝัะฐะบัะพะฒ: `GET /contacts/:id`
  - ะะพะปััะตะฝะธะต ะฟัะธะผะตัะฐะฝะธะน: `GET /leads/:id/notes`
  - ะ ะดััะณะธะต ะผะตัะพะดั API v4

### 3. Jarvis API
- **URL:** `http://localhost:3000`
- **Endpoint:** `POST /amocrm/process-webhook`
- **ะคัะฝะบัะธะธ:**
  - ะะฑัะฐะฑะพัะบะฐ ะฒะตะฑััะบะพะฒ ะพั n8n
  - Upsert ะดะฐะฝะฝัั ะฒ ะะ
  - ะกะฒัะทัะฒะฐะฝะธะต ั RentProg (ัะตัะตะท metadata)
  - ะะพะณะธัะพะฒะฐะฝะธะต ะธ ะผะพะฝะธัะพัะธะฝะณ

---

## โ ะัะตะธะผััะตััะฒะฐ ะฐััะธัะตะบัััั

1. **ะญะบะพะฝะพะผะธั ะปะธะผะธัะพะฒ API:**
   - ะะตะฑััะบะธ ะฝะต ัะฐััะพะดััั ะปะธะผะธัั
   - ะะฐะฟัะพัั ัะพะปัะบะพ ะฟะพ ะฝะตะพะฑัะพะดะธะผะพััะธ

2. **ะะตะฐะปัะฝะพะต ะฒัะตะผั:**
   - ะกะพะฑััะธั ะพะฑัะฐะฑะฐััะฒะฐัััั ะผะณะฝะพะฒะตะฝะฝะพ
   - ะะตั ะทะฐะดะตัะถะตะบ ะฝะฐ polling

3. **ะะฐัััะฐะฑะธััะตะผะพััั:**
   - ะะพััะตะฑะปะตะฝะธะต ัะฐััะตั ั ะฐะบัะธะฒะฝะพัััั
   - ะะตั ัะธะบัะธัะพะฒะฐะฝะฝัั ะทะฐััะฐั ะฝะฐ polling

4. **ะะฐะดะตะถะฝะพััั:**
   - ะะตะดัะฟะปะธะบะฐัะธั ัะตัะตะท `event_hash`
   - Retry ะปะพะณะธะบะฐ ะฒ n8n
   - ะะพะณะธัะพะฒะฐะฝะธะต ะฒัะตั ัะพะฑััะธะน

---

## ๐ ะัััััะน ััะฐัั

1. **ะะบัะธะฒะธัะพะฒะฐัั workflow ะฒ n8n**
2. **ะะฐัะตะณะธัััะธัะพะฒะฐัั ะฒะตะฑััะบ ะฒ AmoCRM**
3. **ะกะพะทะดะฐัั ัะตััะพะฒัั ัะดะตะปะบั**
4. **ะัะพะฒะตัะธัั ะดะฐะฝะฝัะต ะฒ ะะ**

**ะะพัะพะฒะพ!** ะกะธััะตะผะฐ ะฝะฐัะฝะตั ะฟะพะปััะฐัั ะดะฐะฝะฝัะต ะฐะฒัะพะผะฐัะธัะตัะบะธ.

---

**ะะพะบัะผะตะฝัะฐัะธั:** `docs/AMOCRM_WEBHOOK_SETUP.md`

