# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö AmoCRM —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–°–∫—Ä–∏–ø—Ç `scripts/amocrm-update-since-last-sync.mjs` –ø–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å–¥–µ–ª–∫–∏ –∏–∑ AmoCRM —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–≤–∞ —Ä–µ–∂–∏–º–∞:**
- **Playwright Service** (–ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å) - —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç Access Token
- **AmoCRM API v4** (Access Token) - –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ API

---

## üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

**–î–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Ä–∞–±–æ—Ç—ã:**

### –í–∞—Ä–∏–∞–Ω—Ç 1: Playwright Service (–ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å) ‚≠ê –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è

- **Playwright Service** –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω
- –õ–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ `.env`:
  - `AMOCRM_EMAIL=geodrive.ge@gmail.com`
  - `AMOCRM_PASSWORD=wnr3c4%UqN@jY23`
  - `AMOCRM_SUBDOMAIN=geodrive`
- URL —Å–µ—Ä–≤–∏—Å–∞: `AMOCRM_PLAYWRIGHT_URL=http://localhost:3002` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ù–µ –Ω—É–∂–µ–Ω Access Token
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å –ª–æ–≥–∏–Ω–æ–º/–ø–∞—Ä–æ–ª–µ–º
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π re-login –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–∏

### –í–∞—Ä–∏–∞–Ω—Ç 2: AmoCRM API v4 (Access Token)

- **Access Token** –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ `.env`: `AMOCRM_ACCESS_TOKEN=your_token`
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞: —Å–º. `docs/AMOCRM_API_AUTH.md`

**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:**
- –¢–∞–±–ª–∏—Ü–∞ `amocrm_deals` –¥–æ–ª–∂–Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å
- –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é –¥–∞—Ç—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ –ë–î

---

## üöÄ –ó–∞–ø—É—Å–∫

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ npm script

```bash
npm run update:amocrm:since-last
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ù–∞–ø—Ä—è–º—É—é

```bash
node scripts/amocrm-update-since-last-sync.mjs
```

---

## üîÑ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –¥–∞—Ç—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:**
   - –°–∫—Ä–∏–ø—Ç –∏—â–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É `updated_at` –≤ —Ç–∞–±–ª–∏—Ü–µ `amocrm_deals`
   - –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –±–µ—Ä–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π

2. **–ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ API:**
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `GET /api/v4/leads?filter[updated_at][from]=TIMESTAMP`
   - –ü–æ–ª—É—á–∞–µ—Ç —Å–¥–µ–ª–∫–∏ —Å –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏ –∏ –∫–æ–º–ø–∞–Ω–∏—è–º–∏ (`with=contacts,companies`)
   - –ü–∞–≥–∏–Ω–∞—Ü–∏—è: 250 —Å–¥–µ–ª–æ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É

3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:**
   - –ò–∑–≤–ª–µ–∫–∞–µ—Ç –≤—Å–µ –ø–æ–ª—è —Å–¥–µ–ª–∫–∏
   - –ò—â–µ—Ç RentProg Booking ID –≤ custom_fields (field_id: 902255)
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î —Å `ON CONFLICT DO UPDATE` (upsert)

4. **–ü—Ä–æ–≥—Ä–µ—Å—Å:**
   - –í—ã–≤–æ–¥–∏—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ –∫–æ–Ω—Å–æ–ª—å
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤—ã—Ö –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Å–¥–µ–ª–æ–∫

---

## üìä –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞

```
üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö AmoCRM —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

üìÖ –ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: 2025-11-10T12:00:00.000Z
   (Unix timestamp: 1731235200)

üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ 1...
   –ü–æ–ª—É—á–µ–Ω–æ —Å–¥–µ–ª–æ–∫: 45
   ‚úì 32249167 (RentProg: 470049)
   ‚úì 32249168
   ‚úì 32249169 (RentProg: 470050)
   ...

‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!
   –í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: 45
   –ù–æ–≤—ã—Ö: 12
   –û–±–Ω–æ–≤–ª–µ–Ω–æ: 33
```

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

**–î–ª—è Playwright Service (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):**

```env
AMOCRM_EMAIL=geodrive.ge@gmail.com
AMOCRM_PASSWORD=wnr3c4%UqN@jY23
AMOCRM_SUBDOMAIN=geodrive
AMOCRM_PLAYWRIGHT_URL=http://localhost:3002
DATABASE_URL=postgresql://...
```

**–î–ª—è –ø—Ä—è–º–æ–≥–æ API (–µ—Å–ª–∏ –µ—Å—Ç—å Access Token):**

```env
AMOCRM_ACCESS_TOKEN=your_access_token_here
AMOCRM_SUBDOMAIN=geodrive
DATABASE_URL=postgresql://...
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ï—Å–ª–∏ `AMOCRM_ACCESS_TOKEN` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Playwright Service.

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã API

–°–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:
- **Limit:** 250 —Å–¥–µ–ª–æ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É (–º–∞–∫—Å–∏–º—É–º –¥–ª—è AmoCRM API)
- **With:** `contacts,companies` (–ø–æ–ª—É—á–µ–Ω–∏–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
- **Filter:** `filter[updated_at][from]` (—Ñ–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

```sql
-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å–¥–µ–ª–∫–∏
SELECT 
  amocrm_deal_id,
  status_label,
  price,
  updated_at,
  metadata->>'rentprog_booking_id' as rentprog_id
FROM amocrm_deals
ORDER BY updated_at DESC
LIMIT 10;
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–õ–∏–º–∏—Ç—ã API:**
   - AmoCRM API: 7,000 –∑–∞–ø—Ä–æ—Å–æ–≤/—á–∞—Å, 250 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É
   - –°–∫—Ä–∏–ø—Ç –¥–µ–ª–∞–µ—Ç –∑–∞–¥–µ—Ä–∂–∫—É 500ms –º–µ–∂–¥—É —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏
   - –ü—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è

2. **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è:**
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `ON CONFLICT (amocrm_deal_id) DO UPDATE`
   - –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–¥–µ–ª–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è, –Ω–æ–≤—ã–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è

3. **RentProg ID:**
   - –ò—â–µ—Ç—Å—è –≤ custom_fields –ø–æ `field_id: 902255`
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `metadata.rentprog_booking_id`
   - –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–ª–µ –æ—Å—Ç–∞–µ—Ç—Å—è `null`

---

## üêõ –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –û—à–∏–±–∫–∞: "Playwright Service –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ Playwright Service –∑–∞–ø—É—â–µ–Ω:
   ```bash
   curl http://localhost:3002/health
   ```
2. –ï—Å–ª–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω, –∑–∞–ø—É—Å—Ç–∏—Ç–µ:
   ```bash
   npm run start:playwright
   ```
   –ò–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
   ```bash
   systemctl start playwright-amocrm
   ```
3. –ò–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `AMOCRM_ACCESS_TOKEN` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä—è–º–æ–≥–æ API

### –û—à–∏–±–∫–∞: "AMOCRM_ACCESS_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

**–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ!** –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Playwright Service.

–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä—è–º–æ–π API:
1. –ü–æ–ª—É—á–∏—Ç–µ Access Token —á–µ—Ä–µ–∑ OAuth 2.0 (—Å–º. `docs/AMOCRM_API_AUTH.md`)
2. –î–æ–±–∞–≤—å—Ç–µ –≤ `.env`: `AMOCRM_ACCESS_TOKEN=your_token`

### –û—à–∏–±–∫–∞: "API error: 401 Unauthorized"

**–†–µ—à–µ–Ω–∏–µ:**
- Access Token –∏—Å—Ç–µ–∫ –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π
- –û–±–Ω–æ–≤–∏—Ç–µ —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ OAuth 2.0 flow

### –û—à–∏–±–∫–∞: "API error: 429 Too Many Requests"

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤
- –ü–æ–¥–æ–∂–¥–∏—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –ø–æ–∑–∂–µ
- –ú–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏ –≤ –∫–æ–¥–µ

---

## üìù –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- `docs/AMOCRM_API_AUTH.md` - –ü–æ–ª—É—á–µ–Ω–∏–µ Access Token
- `docs/AMOCRM_WEBHOOK_SETUP.md` - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±—Ö—É–∫–æ–≤
- `docs/AMOCRM_ARCHITECTURE.md` - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

