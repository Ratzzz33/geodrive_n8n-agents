# ‚úÖ Entity Timeline & Event Links - –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ

**–î–∞—Ç–∞:** 2025-11-09  
**–°—Ç–∞—Ç—É—Å:** üéâ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## üìä –ò—Ç–æ–≥–∏

### Entity Timeline ‚úÖ

**–¢–∞–±–ª–∏—Ü–∞:** `entity_timeline` - –¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ª–æ–≥ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π –ø–æ —Å—É—â–Ω–æ—Å—Ç—è–º

**–°—Ç–∞—Ç—É—Å –≤ –ë–î:**
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
- ‚úÖ 10 –∏–Ω–¥–µ–∫—Å–æ–≤ —Å–æ–∑–¥–∞–Ω—ã
- ‚úÖ 2 SQL Views —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ `cleanup_old_timeline_entries()` —Å–æ–∑–¥–∞–Ω–∞

**–°—Ç–∞—Ç—É—Å API:**
- ‚úÖ –†–æ—É—Ç–µ—Ä `/entity-timeline` –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
- ‚úÖ Endpoint `/entity-timeline/stats` —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Endpoint `/entity-timeline/entity/:type/:id` —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Endpoint `/entity-timeline/related` —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–ø–∏—Å—å:**
- ‚úÖ –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π (`src/db/payments.ts`)
- ‚úÖ –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–µ–±—Ö—É–∫–æ–≤ (`src/orchestrator/rentprog-handler.ts`)
- ‚úÖ –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ GPS (`src/services/starline-monitor.ts`)

**–ü–µ—Ä–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:**
```json
{
  "ok": true,
  "data": [{
    "entity_type": "car",
    "event_type": "car.gps_updated",
    "source_type": "starline",
    "operation": "update",
    "total_events": "8",
    "unique_entities": "7",
    "first_event": "2025-11-09 13:46:08.209+00",
    "last_event": "2025-11-09 13:46:21.882+00"
  }]
}
```

---

### Event Links ‚úÖ

**–¢–∞–±–ª–∏—Ü–∞:** `event_links` - —Å–≤—è–∑–∏ –º–µ–∂–¥—É events, payments –∏ history

**–°—Ç–∞—Ç—É—Å –≤ –ë–î:**
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã
- ‚úÖ Views `event_links_stats` –∏ `unlinked_records` —Ä–∞–±–æ—Ç–∞—é—Ç

**–°—Ç–∞—Ç—É—Å API:**
- ‚úÖ –†–æ—É—Ç–µ—Ä `/event-links` –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
- ‚úÖ Endpoint `/event-links/stats` —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Endpoint `/event-links/unlinked` —Ä–∞–±–æ—Ç–∞–µ—Ç (100 –Ω–µ—Å–≤—è–∑–∞–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π)
- ‚úÖ Endpoint `/event-links/payment/:id` —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ POST endpoints –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ:**
- ‚úÖ –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ `linkPayment()`
- ‚úÖ –ü–æ–∏—Å–∫ –≤ events –∏ history —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º –æ–∫–Ω–æ–º 5 –º–∏–Ω—É—Ç
- ‚úÖ –£—Ä–æ–≤–µ–Ω—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏: high/medium/low

---

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### –ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
```bash
‚úÖ git pull --no-rebase
‚úÖ Merge –∑–∞–≤–µ—Ä—à–µ–Ω
‚úÖ –ö–æ–¥ –∞–∫—Ç—É–∞–ª–µ–Ω
```

### API –∑–∞–ø—É—â–µ–Ω:
```bash
‚úÖ –ü—Ä–æ—Ü–µ—Å—Å: npx tsx src/index.ts api-only
‚úÖ Health check: {"status":"ok","timestamp":"2025-11-09T13:46:10.526Z"}
‚úÖ –ü–æ—Ä—Ç: 3000
```

### CI —Å—Ç–∞—Ç—É—Å:
```bash
‚úÖ GitHub Actions: success
‚úÖ –ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç: "fix: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—à–∏–±–∫–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ TypeScript"
‚úÖ –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: 19s
‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã
```

---

## üì° –î–æ—Å—Ç—É–ø–Ω—ã–µ Endpoints

### Entity Timeline

**GET** `http://46.224.17.15:3000/entity-timeline/stats`
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–±—ã—Ç–∏–π –ø–æ —Ç–∏–ø–∞–º
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: `entityType`, `branchCode`, `startDate`, `endDate`

**GET** `http://46.224.17.15:3000/entity-timeline/entity/:type/:id`
- Timeline –¥–ª—è —Å—É—â–Ω–æ—Å—Ç–∏
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: `limit`, `offset`, `eventTypes`, `sourceTypes`, `startDate`, `endDate`

**POST** `http://46.224.17.15:3000/entity-timeline/related`
- Timeline –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
- Body: `{ entities: [{type, id}, ...], limit, offset, startDate, endDate }`

---

### Event Links

**GET** `http://46.224.17.15:3000/event-links/stats`
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–≤—è–∑–µ–π

**GET** `http://46.224.17.15:3000/event-links/unlinked`
- –ù–µ—Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ (payments, events, history)

**GET** `http://46.224.17.15:3000/event-links/payment/:paymentId`
- –°–≤—è–∑–∏ –¥–ª—è –ø–ª–∞—Ç–µ–∂–∞

**POST** `http://46.224.17.15:3000/event-links/link-payment`
- –†—É—á–Ω–æ–µ —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
- Body: `{ paymentId, branch, rpPaymentId, paymentDate, options }`

**POST** `http://46.224.17.15:3000/event-links/link-event`
- –†—É—á–Ω–æ–µ —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
- Body: `{ eventId, branch, entityType, rpEntityId, eventTime, options }`

---

## üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### Entity Timeline
- **–°–æ–±—ã—Ç–∏—è:** 8 GPS –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- **–ú–∞—à–∏–Ω—ã:** 7 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö
- **–ü–µ—Ä–∏–æ–¥:** 2025-11-09 13:46:08 - 13:46:21
- **–ò—Å—Ç–æ—á–Ω–∏–∫:** Starline GPS

### Event Links
- **–ù–µ—Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏:** 100 –∑–∞–ø–∏—Å–µ–π
- **–§–∏–ª–∏–∞–ª—ã:** tbilisi, batumi, kutaisi, service-center
- **–ü–µ—Ä–∏–æ–¥:** –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
- **–ê–≤—Ç–æ—Å–≤—è–∑—ã–≤–∞–Ω–∏–µ:** —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –Ω–æ–≤—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π

---

## üéØ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–ø–∏—Å—å –≤ timeline:
1. ‚úÖ **GPS –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** - –∫–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è
2. ‚úÖ **–ü–ª–∞—Ç–µ–∂–∏** - –∫–∞–∂–¥—ã–π –Ω–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å —Å —Å–≤—è–∑–∞–Ω–Ω—ã–º–∏ —Å—É—â–Ω–æ—Å—Ç—è–º–∏
3. ‚úÖ **–í–µ–±—Ö—É–∫–∏** - —Å–æ–±—ã—Ç–∏—è –æ—Ç RentProg –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —Å –¥–µ—Ç–∞–ª—è–º–∏

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ:
1. ‚úÖ **–ü–ª–∞—Ç–µ–∂–∏** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—â—É—Ç—Å—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ events –∏ history
2. ‚úÖ **–í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ** - 5 –º–∏–Ω—É—Ç –¥–æ/–ø–æ—Å–ª–µ —Å–æ–±—ã—Ç–∏—è
3. ‚úÖ **–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å** - high (—Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ), medium, low

### API:
1. ‚úÖ **–ß—Ç–µ–Ω–∏–µ timeline** - –ø–æ —Å—É—â–Ω–æ—Å—Ç–∏, –ø–æ —Å–≤—è–∑–∞–Ω–Ω—ã–º, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
2. ‚úÖ **–ß—Ç–µ–Ω–∏–µ —Å–≤—è–∑–µ–π** - –ø–æ –ø–ª–∞—Ç–µ–∂—É, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –Ω–µ—Å–≤—è–∑–∞–Ω–Ω—ã–µ
3. ‚úÖ **–†—É—á–Ω–æ–µ —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ** - –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π

---

## üìù –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **[docs/ENTITY_TIMELINE.md](./docs/ENTITY_TIMELINE.md)** - –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ Entity Timeline
- **[ENTITY_TIMELINE_IMPLEMENTATION.md](./ENTITY_TIMELINE_IMPLEMENTATION.md)** - –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- **[docs/EVENT_LINKS.md](./docs/EVENT_LINKS.md)** - –û–ø–∏—Å–∞–Ω–∏–µ Event Links
- **[EVENT_LINKS_IMPLEMENTATION.md](./EVENT_LINKS_IMPLEMENTATION.md)** - –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–≤—è–∑–µ–π

---

## üîÑ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –î–ª—è –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞:

```typescript
import { getTimelineForEntity } from './db/entityTimeline';

// –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –ø–æ –º–∞—à–∏–Ω–µ
const timeline = await getTimelineForEntity('car', carId, {
  limit: 100,
  startDate: new Date(Date.now() - 3600000), // –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
});

// –ü–æ–ª—É—á–∏—Ç—å GPS —Å–æ–±—ã—Ç–∏—è
const gpsEvents = await getTimelineForEntity('car', carId, {
  sourceTypes: ['starline'],
  eventTypes: ['car.gps_updated'],
});
```

### –î–ª—è –∞–≥–µ–Ω—Ç–æ–≤:

```typescript
import { getTimelineForRelatedEntities } from './db/entityTimeline';

// –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –ø–æ –±—Ä–æ–Ω–∏ –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–º —Å—É—â–Ω–æ—Å—Ç—è–º
const timeline = await getTimelineForRelatedEntities([
  { type: 'booking', id: bookingId },
  { type: 'car', id: carId },
  { type: 'client', id: clientId },
], { limit: 200 });
```

### –ß–µ—Ä–µ–∑ API:

```bash
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ timeline
curl http://46.224.17.15:3000/entity-timeline/stats?entityType=car

# Timeline –¥–ª—è –º–∞—à–∏–Ω—ã
curl http://46.224.17.15:3000/entity-timeline/entity/car/{carId}?limit=50

# –ù–µ—Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
curl http://46.224.17.15:3000/event-links/unlinked

# –°–≤—è–∑–∏ –¥–ª—è –ø–ª–∞—Ç–µ–∂–∞
curl http://46.224.17.15:3000/event-links/payment/{paymentId}
```

---

## ‚ú® –†–µ–∑—É–ª—å—Ç–∞—Ç

### ‚úÖ Entity Timeline —Ä–∞–±–æ—Ç–∞–µ—Ç:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –∏–∑ 3 –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (webhooks, GPS, –ø–ª–∞—Ç–µ–∂–∏)
- –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –µ–¥–∏–Ω—É—é –≤—Ä–µ–º–µ–Ω–Ω—É—é –ª–∏–Ω–∏—é –¥–ª—è –≤—Å–µ—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ —Ç–∏–ø—É, –∏—Å—Ç–æ—á–Ω–∏–∫—É, –≤—Ä–µ–º–µ–Ω–∏, —Ñ–∏–ª–∏–∞–ª—É
- –•—Ä–∞–Ω–∏—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞

### ‚úÖ Event Links —Ä–∞–±–æ—Ç–∞–µ—Ç:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≤—è–∑—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–µ–∂–∏ —Å events –∏ history
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–µ—Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –¥–ª—è —Ä—É—á–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç API –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è
- –í—ã—á–∏—Å–ª—è–µ—Ç —É—Ä–æ–≤–µ–Ω—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –≤ —Å–≤—è–∑–∏

### ‚úÖ –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –≥–æ—Ç–æ–≤:
- –ú–æ–∂–µ—Ç –ø–æ–ª—É—á–∞—Ç—å –ø–æ–ª–Ω—É—é —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—é –ø–æ –ª—é–±–æ–π —Å—É—â–Ω–æ—Å—Ç–∏
- –í–∏–¥–∏—Ç —Å–≤—è–∑–∏ –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö
- –ò–º–µ–µ—Ç –±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö JOIN

### ‚úÖ CI/CD —Ä–∞–±–æ—Ç–∞–µ—Ç:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏ push
- TypeScript –∫–æ–º–ø–∏–ª—è—Ü–∏—è
- –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç

---

## üéâ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!

**API:** http://46.224.17.15:3000  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç  
**CI:** ‚úÖ –ó–µ–ª–µ–Ω—ã–π  
**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** ‚úÖ –ì–æ—Ç–æ–≤–∞

---

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π timeline (cron)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –¥–∞—à–±–æ—Ä–¥ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ timeline
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å batch-—Å–≤—è–∑—ã–≤–∞–Ω–∏–µ –¥–ª—è 100 –Ω–µ—Å–≤—è–∑–∞–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ timeline –¥–ª—è Telegram —Å–æ–±—ã—Ç–∏–π

