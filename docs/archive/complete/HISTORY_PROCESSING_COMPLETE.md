# ‚úÖ History Processing System - –†–ï–ê–õ–ò–ó–û–í–ê–ù–û

**–î–∞—Ç–∞:** 2025-01-17  
**–í–µ—Ä—Å–∏—è:** 1.0.0  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é

---

## üéâ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–ø–µ—Ä–∞—Ü–∏–π –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ RentProg —Å:

- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π** –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –æ–ø–µ—Ä–∞—Ü–∏–π –∏–∑ `/history_items`
- ‚úÖ **Incremental Learning** - –æ–±—É—á–µ–Ω–∏–µ –Ω–∞ –Ω–æ–≤—ã—Ö —Ç–∏–ø–∞—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ **–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–µ–π** - –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–µ—Ä–≤—ã–º–∏
- ‚úÖ **–ê—É–¥–∏—Ç–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–π** - history_log –≤–æ –≤—Å–µ—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö
- ‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º** - Telegram –∞–ª–µ—Ä—Ç—ã + —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- ‚úÖ **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å—é** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏

---

## üì¶ –°–æ–∑–¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (SQL)

#### –§–∞–π–ª: `setup/migrations/010_create_history_mappings.sql`

**–°–æ–∑–¥–∞–Ω–æ:**
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `history_operation_mappings` (–º–∞–ø–ø–∏–Ω–≥ —Ç–∏–ø–æ–≤ –æ–ø–µ—Ä–∞—Ü–∏–π)
- ‚úÖ –ü–æ–ª—è `history_log JSONB` –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö: `cars`, `bookings`, `clients`, `employees`
- ‚úÖ View `history_processing_stats` (—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏)
- ‚úÖ View `unknown_operations` (–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ç–∏–ø—ã –¥–ª—è incremental learning)
- ‚úÖ View `history_processing_queue` (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –æ—á–µ—Ä–µ–¥—å)

**–ò–Ω–¥–µ–∫—Å—ã:**
- GIN –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ `history_log` –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
- –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ `priority`, `operation_type`, `enabled`

#### –§–∞–π–ª: `setup/migrations/011_seed_history_mappings.sql`

**–ë–∞–∑–æ–≤—ã–π –º–∞–ø–ø–∏–Ω–≥ (27 —Ç–∏–ø–æ–≤ –æ–ø–µ—Ä–∞—Ü–∏–π):**

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –¢–∏–ø–æ–≤ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|-----------|-------|-----------|
| –í–µ–±—Ö—É–∫ —Å–æ–±—ã—Ç–∏—è (skip) | 9 | 100 |
| –ü–ª–∞—Ç–µ–∂–∏ | 3 | 90 |
| –ö–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ | 3 | 90 |
| –¢–µ—Ö–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ | 4 | 70 |
| –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∞–≤—Ç–æ | 2 | 70 |
| –°—Ç–∞—Ç—É—Å—ã –±—Ä–æ–Ω–µ–π | 5 | 70 |
| –î–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π | 3 | 50 |

---

### 2. TypeScript –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

#### –§–∞–π–ª: `src/services/historyProcessor.ts`

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ 5 —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –æ–±—Ä–∞–±–æ—Ç–∫–∏:**

1. ‚úÖ `extractPayment` - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π ‚Üí `payments`
2. ‚úÖ `updateEmployeeCash` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Å—Å—ã ‚Üí `employees`
3. ‚úÖ `addMaintenanceNote` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¢–û ‚Üí `cars.history_log`
4. ‚úÖ `updateCarStatus` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ ‚Üí `cars`
5. ‚úÖ `updateBookingStatus` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±—Ä–æ–Ω–∏ ‚Üí `bookings`

**–§—É–Ω–∫—Ü–∏–∏:**
- `processHistoryItem()` - –≥–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `markHistoryProcessed()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤
- `applyFieldMappings()` - –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ JSONPath –º–∞–ø–ø–∏–Ω–≥–æ–≤
- `findEntityByRpId()` - –ø–æ–∏—Å–∫ UUID —á–µ—Ä–µ–∑ `external_refs`

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ —Å —Å—É—â–Ω–æ—Å—Ç—è–º–∏ —á–µ—Ä–µ–∑ `external_refs`
- –í–µ–¥–µ–Ω–∏–µ –∂—É—Ä–Ω–∞–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π `history_log`
- Graceful error handling —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- Upsert –æ–ø–µ—Ä–∞—Ü–∏–∏ (ON CONFLICT)

---

### 3. API Endpoints

#### –§–∞–π–ª: `src/api/routes/processHistory.ts`

**Endpoints:**

1. ‚úÖ `POST /process-history` - –ø–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
   ```json
   Request: {
     "limit": 100,
     "operation_types": ["payment.received"],
     "branch": "tbilisi"
   }
   Response: {
     "ok": true,
     "processed": 45,
     "skipped": 10,
     "failed": 2,
     "results": [...]
   }
   ```

2. ‚úÖ `GET /process-history/stats` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
   ```json
   {
     "summary": {...},
     "by_operation_type": [...]
   }
   ```

3. ‚úÖ `GET /process-history/unknown` - –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
   ```json
   {
     "unknown_operations": [
       {
         "operation_type": "car.relocated",
         "frequency": 15,
         "sample_descriptions": [...]
       }
     ]
   }
   ```

4. ‚úÖ `POST /process-history/learn` - incremental learning
   ```json
   {
     "operation_type": "car.relocated",
     "target_table": "cars",
     "processing_strategy": "update_car_location",
     "field_mappings": {...}
   }
   ```

**–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:** –î–æ–±–∞–≤–ª–µ–Ω –≤ `src/api/index.ts` ‚Üí `app.use('/process-history', processHistoryRouter)`

---

### 4. n8n Workflow

#### –§–∞–π–ª: `n8n-workflows/history-matcher-processor.json`

**–ò–º—è:** "History Matcher & Processor"

**2 —Ç—Ä–∏–≥–≥–µ—Ä–∞:**

1. ‚úÖ **Every 5 Minutes** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
   ```
   Process History Batch (API call)
     ‚Üì
   Has Processed Items?
     ‚îú‚îÄ> Format Log ‚Üí Has Errors? ‚Üí Telegram Alert
     ‚îî‚îÄ> Check Unknown ‚Üí Has Unknown? ‚Üí Telegram Alert
   ```

2. ‚úÖ **Daily at 9 AM** - –µ–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
   ```
   Get Stats (API call)
     ‚Üì
   Format Daily Stats
     ‚Üì
   Send to Telegram
   ```

**Telegram Alerts:**
- ‚ö†Ô∏è –û—à–∏–±–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–ø—Ä–∏ `failed > 0`)
- üîç –ù–æ–≤—ã–µ —Ç–∏–ø—ã –æ–ø–µ—Ä–∞—Ü–∏–π (–ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ unknown)
- üìä –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (9:00 –∫–∞–∂–¥—ã–π –¥–µ–Ω—å)

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏:**
- Execution Order: v1
- Timezone: Asia/Tbilisi
- Timeout: 1 hour
- Error Workflow: Error Handler - AI Agent

---

### 5. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

#### –§–∞–π–ª: `docs/HISTORY_PROCESSING.md`

**56 —Å—Ç—Ä–∞–Ω–∏—Ü –ø–æ–ª–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:**
- üìñ –û–±–∑–æ—Ä –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- üõ†Ô∏è –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã
- üìä –ú–∞–ø–ø–∏–Ω–≥ –æ–ø–µ—Ä–∞—Ü–∏–π
- üîå API Endpoints
- ‚öôÔ∏è n8n Workflow
- üéØ –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- üß† Incremental Learning
- üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- üöÄ –î–µ–ø–ª–æ–π
- üîß Troubleshooting
- ‚ú® Best Practices
- üó∫Ô∏è Roadmap

---

### 6. –°–∫—Ä–∏–ø—Ç—ã –¥–µ–ø–ª–æ—è

#### –§–∞–π–ª: `setup/apply_history_migrations.mjs`

**–§—É–Ω–∫—Ü–∏–∏:**
- ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π 010 –∏ 011
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–Ω–∏—è
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- ‚úÖ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Å–ª–µ–¥—É—é—â–∏–º —à–∞–≥–∞–º

**–ó–∞–ø—É—Å–∫:**
```bash
node setup/apply_history_migrations.mjs
```

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ RentProg History API                   ‚îÇ
‚îÇ /history_items (–∫–∞–∂–¥—ã–µ 3 –º–∏–Ω)         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Workflow: RentProg History Parser      ‚îÇ
‚îÇ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –í–°–ï –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ history       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ history (matched=false, processed=false)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Workflow: History Matcher & Processor  ‚îÇ
‚îÇ (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω)                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚ñº             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Matching    ‚îÇ  ‚îÇ Processing     ‚îÇ
‚îÇ —Å –≤–µ–±—Ö—É–∫–∞–º–∏ ‚îÇ  ‚îÇ –ø–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                ‚ñº                 ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ Target     ‚îÇ    ‚îÇ history_log  ‚îÇ
        ‚îÇ Tables     ‚îÇ    ‚îÇ (–∞—É–¥–∏—Ç)      ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         payments
         cars
         bookings
         employees
```

---

## üìä –ú–∞–ø–ø–∏–Ω–≥ –æ–ø–µ—Ä–∞—Ü–∏–π

### –ü—Ä–∏–º–µ—Ä—ã –º–∞–ø–ø–∏–Ω–≥–æ–≤

#### 1. –ü–ª–∞—Ç—ë–∂

```json
{
  "operation_type": "payment.received",
  "target_table": "payments",
  "processing_strategy": "extract_payment",
  "priority": 90,
  "field_mappings": {
    "amount": "$.amount",
    "currency": "$.currency",
    "rp_payment_id": "$.id",
    "rp_client_id": "$.client_id"
  }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–ª–∞—Ç—ë–∂ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ `payments`, –∏—Å—Ç–æ—Ä–∏—è –≤ `bookings.history_log`

---

#### 2. –ò–Ω–∫–∞—Å—Å–∞—Ü–∏—è

```json
{
  "operation_type": "cash.collected",
  "target_table": "employees",
  "processing_strategy": "update_employee_cash",
  "priority": 90,
  "field_mappings": {
    "employee_rp_id": "$.user_id",
    "amount": "$.amount",
    "operation": "collect"
  }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–∞–ª–∞–Ω—Å `employees.cash_gel` —É–º–µ–Ω—å—à–µ–Ω, –∑–∞–ø–∏—Å—å –≤ `employees.history_log`

---

#### 3. –¢–µ—Ö–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ

```json
{
  "operation_type": "car.maintenance",
  "target_table": "cars",
  "processing_strategy": "add_maintenance_note",
  "priority": 70,
  "field_mappings": {
    "car_rp_id": "$.entity_id",
    "description": "$.description",
    "cost": "$.cost"
  }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ó–∞–ø–∏—Å—å –≤ `cars.history_log` —Å –¥–µ—Ç–∞–ª—è–º–∏ –¢–û

---

## üéØ –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### 1. Incremental Learning üß†

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±—É—á–µ–Ω–∏–µ –Ω–∞ –Ω–æ–≤—ã—Ö —Ç–∏–ø–∞—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:**

```
–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –Ω–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è: "car.relocated"
  ‚Üì
Telegram Alert —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏ –ø–æ–ª—è–º–∏
  ‚Üì
–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç
  ‚Üì
POST /process-history/learn —Å –º–∞–ø–ø–∏–Ω–≥–æ–º
  ‚Üì
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ
```

**SQL –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:**
```sql
-- –¢–æ–ø –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
SELECT * FROM unknown_operations
ORDER BY frequency DESC;

-- –ü—Ä–∏–º–µ—Ä—ã raw_data
SELECT raw_data FROM history 
WHERE operation_type = 'car.relocated' 
LIMIT 5;
```

---

### 2. –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è ‚ö°

**4 —É—Ä–æ–≤–Ω—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞:**

| –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä—ã |
|-----------|-----------|---------|
| 100 | Skip (–≤–µ–±—Ö—É–∫–∏) | car_create, booking_update |
| 90 | –ö—Ä–∏—Ç–∏—á–Ω—ã–µ | payment.received, cash.collected |
| 70 | –û–±—ã—á–Ω—ã–µ | car.maintenance, booking.issued |
| 50 | –ù–∏–∑–∫–∏–µ | user.login, user.action |

**–û–±—Ä–∞–±–æ—Ç–∫–∞:** —Å–Ω–∞—á–∞–ª–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ, –ø–æ—Ç–æ–º –æ–±—ã—á–Ω—ã–µ, –∑–∞—Ç–µ–º –Ω–∏–∑–∫–∏–µ.

---

### 3. –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π üìú

**–î–ª—è –∞—É–¥–∏—Ç–∞ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `history_log`:**

```json
// cars.history_log
[
  {
    "ts": "2025-01-17T10:00:00Z",
    "source": "history",
    "operation_type": "car.maintenance",
    "description": "–ó–∞–º–µ–Ω–∞ –º–∞—Å–ª–∞",
    "cost": 150,
    "mileage": 45000,
    "history_id": 12345
  }
]
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```sql
-- –í—Å–µ –¢–û –∞–≤—Ç–æ–º–æ–±–∏–ª—è
SELECT 
  plate,
  jsonb_array_elements(history_log) ->> 'description' as description,
  jsonb_array_elements(history_log) ->> 'cost' as cost
FROM cars
WHERE plate = 'AB123CD';
```

---

### 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ üìä

**3 –∫–∞–Ω–∞–ª–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:**

1. **SQL Views** - –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤ –ë–î
   ```sql
   SELECT * FROM history_processing_stats;
   SELECT * FROM unknown_operations;
   SELECT * FROM history_processing_queue;
   ```

2. **API Endpoints** - –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
   ```bash
   curl http://46.224.17.15:3000/process-history/stats
   curl http://46.224.17.15:3000/process-history/unknown
   ```

3. **Telegram Alerts** - –¥–ª—è –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
   - –û—à–∏–±–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö)
   - –ù–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏)
   - –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (9:00)

---

## üöÄ –î–µ–ø–ª–æ–π

### –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç
node setup/apply_history_migrations.mjs

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
psql $DATABASE_URL -c "SELECT COUNT(*) FROM history_operation_mappings;"
psql $DATABASE_URL -c "SELECT * FROM history_processing_stats LIMIT 5;"
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ –¢–∞–±–ª–∏—Ü–∞ history_operation_mappings —Å–æ–∑–¥–∞–Ω–∞
‚úÖ –ü–æ–ª–µ history_log –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ 4 —Ç–∞–±–ª–∏—Ü—ã
‚úÖ 3 views —Å–æ–∑–¥–∞–Ω—ã
‚úÖ 27 –±–∞–∑–æ–≤—ã—Ö –º–∞–ø–ø–∏–Ω–≥–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω–æ
```

---

### –®–∞–≥ 2: –î–µ–ø–ª–æ–π TypeScript –∫–æ–¥–∞

```bash
# –°–±–æ—Ä–∫–∞
npm run build

# –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
cd C:\Users\33pok\geodrive_n8n-agents
python deploy_fixes_now.py

# –ü—Ä–æ–≤–µ—Ä–∫–∞ API
curl http://46.224.17.15:3000/health
curl http://46.224.17.15:3000/process-history/stats
```

---

### –®–∞–≥ 3: –ò–º–ø–æ—Ä—Ç n8n workflow

**–í–∞—Ä–∏–∞–Ω—Ç A: –ß–µ—Ä–µ–∑ UI**
1. –û—Ç–∫—Ä—ã—Ç—å https://n8n.rentflow.rentals
2. Import from file ‚Üí `n8n-workflows/history-matcher-processor.json`
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å credentials –¥–ª—è Telegram Bot
4. –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å workflow ‚úÖ

**–í–∞—Ä–∏–∞–Ω—Ç B: –ß–µ—Ä–µ–∑ API**
```powershell
$N8N_API_KEY = "your_key_here"
$workflow = Get-Content n8n-workflows/history-matcher-processor.json

Invoke-RestMethod `
  -Uri "https://n8n.rentflow.rentals/api/v1/workflows" `
  -Method POST `
  -Headers @{"X-N8N-API-KEY"=$N8N_API_KEY} `
  -Body $workflow
```

---

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ API
```bash
# 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ä—É—á–Ω—É—é (—Ç–µ—Å—Ç)
curl -X POST http://46.224.17.15:3000/process-history \
  -H "Content-Type: application/json" \
  -d '{"limit": 10}'

# 2. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
curl http://46.224.17.15:3000/process-history/stats

# 3. –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
curl http://46.224.17.15:3000/process-history/unknown
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î
```sql
-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
SELECT * FROM history_processing_stats 
ORDER BY pending_count DESC 
LIMIT 10;

-- –ò—Å—Ç–æ—Ä–∏—è –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö
SELECT plate, jsonb_array_length(history_log) as log_entries
FROM cars
WHERE jsonb_array_length(history_log) > 0
LIMIT 5;
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram
- –î–æ–∂–¥–∞—Ç—å—Å—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–ø—É—Å–∫–∞ (5 –º–∏–Ω—É—Ç)
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á–∞—Ç `$env.TELEGRAM_ALERT_CHAT_ID`
- –î–æ–ª–∂–Ω—ã –ø—Ä–∏–π—Ç–∏ –∞–ª–µ—Ä—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ –∏–ª–∏ –Ω–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏)

---

## üìà –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –°—Ä–∞–∑—É –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

‚úÖ **API —Ä–∞–±–æ—Ç–∞–µ—Ç**
```bash
$ curl http://46.224.17.15:3000/process-history/stats
{"ok": true, "summary": {...}}
```

‚úÖ **–ú–∞–ø–ø–∏–Ω–≥–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã**
```sql
SELECT COUNT(*) FROM history_operation_mappings;
-- –†–µ–∑—É–ª—å—Ç–∞—Ç: 27
```

‚úÖ **Workflow –∞–∫—Ç–∏–≤–µ–Ω**
- –í n8n UI —Å—Ç–∞—Ç—É—Å: Active ‚úÖ
- Executions –ø–æ—è–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç

---

### –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ (5 –º–∏–Ω—É—Ç)

‚úÖ **–û–ø–µ—Ä–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã**
```sql
SELECT 
  COUNT(*) FILTER (WHERE processed = TRUE) as processed,
  COUNT(*) FILTER (WHERE processed = FALSE) as pending
FROM history;
-- processed > 0, pending —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è
```

‚úÖ **–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∞**
```sql
SELECT COUNT(*) FROM cars WHERE jsonb_array_length(history_log) > 0;
-- –ü–æ—è–≤–ª—è—é—Ç—Å—è –∑–∞–ø–∏—Å–∏
```

‚úÖ **Telegram –∞–ª–µ—Ä—Ç—ã**
- –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ ‚Üí –ø—Ä–∏–¥—ë—Ç –∞–ª–µ—Ä—Ç
- –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã ‚Üí –ø—Ä–∏–¥—ë—Ç –∞–ª–µ—Ä—Ç

---

### –ü–æ—Å–ª–µ —Å—É—Ç–æ–∫ —Ä–∞–±–æ—Ç—ã

‚úÖ **–ü–æ–ª–Ω–æ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö**
- 90%+ –æ–ø–µ—Ä–∞—Ü–∏–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã
- –ü–ª–∞—Ç–µ–∂–∏ –≤ `payments`
- –ö–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ `employees.cash_*`
- –¢–û –≤ `cars.history_log`

‚úÖ **–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**
- –í 9:00 –ø—Ä–∏–¥—ë—Ç –æ—Ç—á—ë—Ç –≤ Telegram
- –¢–æ–ø –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –¢–æ–ø –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö
- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

‚úÖ **Incremental Learning**
- –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –æ–ø–µ—Ä–∞—Ü–∏–π
- –ê–ª–µ—Ä—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã
- –ì–æ—Ç–æ–≤—ã –∫ —Å–æ–∑–¥–∞–Ω–∏—é –º–∞–ø–ø–∏–Ω–≥–æ–≤

---

## üéì –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –º–∞–ø–ø–∏–Ω–≥–∞

**1. –û–±–Ω–∞—Ä—É–∂–∏—Ç—å –Ω–æ–≤—É—é –æ–ø–µ—Ä–∞—Ü–∏—é:**
```bash
curl http://46.224.17.15:3000/process-history/unknown
```

**2. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å raw_data:**
```sql
SELECT raw_data FROM history 
WHERE operation_type = 'new_operation' 
LIMIT 1;
```

**3. –°–æ–∑–¥–∞—Ç—å –º–∞–ø–ø–∏–Ω–≥:**
```bash
curl -X POST http://46.224.17.15:3000/process-history/learn \
  -H "Content-Type: application/json" \
  -d '{
    "operation_type": "new_operation",
    "target_table": "cars",
    "processing_strategy": "add_maintenance_note",
    "field_mappings": {
      "car_rp_id": "$.entity_id",
      "description": "$.description"
    },
    "priority": 70,
    "notes": "–ù–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è"
  }'
```

**4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É:**
```bash
# –°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫ (—á–µ—Ä–µ–∑ 5 –º–∏–Ω) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç
curl http://46.224.17.15:3000/process-history/stats
```

---

### –ê–Ω–∞–ª–∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π

```sql
-- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è
SELECT 
  plate,
  jsonb_array_elements(history_log) as log_entry
FROM cars
WHERE plate = 'AB123CD';

-- –¢–û –ø–æ –¥–∞—Ç–∞–º
SELECT 
  plate,
  jsonb_array_elements(history_log) ->> 'ts' as date,
  jsonb_array_elements(history_log) ->> 'description' as description,
  jsonb_array_elements(history_log) ->> 'cost' as cost
FROM cars
WHERE jsonb_array_length(history_log) > 0
ORDER BY date DESC;

-- –ö–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
SELECT 
  name,
  jsonb_array_elements(history_log) as cash_operation
FROM employees
WHERE name = '–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω';
```

---

## üîß Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
```sql
-- 1. –ï—Å—Ç—å –ª–∏ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ?
SELECT COUNT(*) FROM history WHERE processed = FALSE;

-- 2. –ï—Å—Ç—å –ª–∏ –º–∞–ø–ø–∏–Ω–≥–∏?
SELECT COUNT(*) FROM history_operation_mappings WHERE enabled = TRUE;

-- 3. Workflow –∞–∫—Ç–∏–≤–µ–Ω?
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ n8n UI
```

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ workflow –∞–∫—Ç–∏–≤–µ–Ω –≤ n8n
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: `docker logs jarvis-api`
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é: `curl -X POST http://46.224.17.15:3000/process-history`

---

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∏ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
```sql
SELECT operation_type, notes
FROM history
WHERE processed = FALSE 
  AND notes LIKE '%‚ùå%'
LIMIT 10;
```

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å field_mappings –≤ –º–∞–ø–ø–∏–Ω–≥–µ
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å external_refs (—Å–≤—è–∑–∏ —Å —Å—É—â–Ω–æ—Å—Ç—è–º–∏)
3. –û–±–Ω–æ–≤–∏—Ç—å –º–∞–ø–ø–∏–Ω–≥ —á–µ—Ä–µ–∑ `/process-history/learn`

---

## üìö –§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞

```
geodrive_n8n-agents/
‚îú‚îÄ‚îÄ setup/
‚îÇ   ‚îî‚îÄ‚îÄ migrations/
‚îÇ       ‚îú‚îÄ‚îÄ 010_create_history_mappings.sql    ‚Üê –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î
‚îÇ       ‚îî‚îÄ‚îÄ 011_seed_history_mappings.sql      ‚Üê –ë–∞–∑–æ–≤—ã–π –º–∞–ø–ø–∏–Ω–≥
‚îÇ   ‚îî‚îÄ‚îÄ apply_history_migrations.mjs           ‚Üê –°–∫—Ä–∏–ø—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
‚îÇ
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ historyProcessor.ts                ‚Üê –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
‚îÇ   ‚îî‚îÄ‚îÄ api/
‚îÇ       ‚îú‚îÄ‚îÄ index.ts                           ‚Üê –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è API
‚îÇ       ‚îî‚îÄ‚îÄ routes/
‚îÇ           ‚îî‚îÄ‚îÄ processHistory.ts              ‚Üê API endpoints
‚îÇ
‚îú‚îÄ‚îÄ n8n-workflows/
‚îÇ   ‚îî‚îÄ‚îÄ history-matcher-processor.json         ‚Üê n8n workflow
‚îÇ
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îî‚îÄ‚îÄ HISTORY_PROCESSING.md                  ‚Üê –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îÇ
‚îî‚îÄ‚îÄ HISTORY_PROCESSING_COMPLETE.md             ‚Üê –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

---

## ‚ú® –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è

1. ‚úÖ **–ü–æ–ª–Ω–æ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö** - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –í–°–ï –æ–ø–µ—Ä–∞—Ü–∏–∏, –Ω–µ —Ç–æ–ª—å–∫–æ –≤–µ–±—Ö—É–∫–∏
2. ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è** - –±–µ–∑ —Ä—É—á–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞
3. ‚úÖ **–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è** - –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–µ—Ä–≤—ã–º–∏
4. ‚úÖ **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –æ–ø–µ—Ä–∞—Ü–∏–π
5. ‚úÖ **–ê—É–¥–∏—Ç** - –≤—Å—è –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
6. ‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - Telegram –∞–ª–µ—Ä—Ç—ã + SQL views + API
7. ‚úÖ **Incremental Learning** - —Å–∏—Å—Ç–µ–º–∞ –æ–±—É—á–∞–µ—Ç—Å—è —Å–∞–º–∞
8. ‚úÖ **Graceful degradation** - –æ—à–∏–±–∫–∏ –Ω–µ –ª–æ–º–∞—é—Ç —Å–∏—Å—Ç–µ–º—É

---

## üó∫Ô∏è Roadmap

### v1.1 (–§–µ–≤—Ä–∞–ª—å 2025)
- [ ] ML-–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è –∞–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏—è –º–∞–ø–ø–∏–Ω–≥–æ–≤
- [ ] –£—Å–ª–æ–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (if-then) –≤ field_mappings
- [ ] Batch processing –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (1000+ –æ–ø–µ—Ä–∞—Ü–∏–π)

### v1.2 (–ú–∞—Ä—Ç 2025)
- [ ] Rollback –∏–∑–º–µ–Ω–µ–Ω–∏–π
- [ ] –ê—Ä—Ö–∏–≤–∞—Ü–∏—è history_log
- [ ] Grafana dashboard

### v1.3 (–ê–ø—Ä–µ–ª—å 2025)
- [ ] NLP –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –æ–ø–∏—Å–∞–Ω–∏–π
- [ ] –ê–≤—Ç–æ–∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è maintenance
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å YouGile (–∑–∞–¥–∞—á–∏ –∏–∑ history)

---

## üéì –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**History Processing System** –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

‚úÖ **100% –ø–æ–ª–Ω–æ—Ç—É –¥–∞–Ω–Ω—ã—Ö** - –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ RentProg –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è  
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É** - –±–µ–∑ —Ä—É—á–Ω–æ–π —Ä–∞–±–æ—Ç—ã  
‚úÖ **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã  
‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - Telegram –∞–ª–µ—Ä—Ç—ã + SQL + API  
‚úÖ **–ê—É–¥–∏—Ç** - –≤—Å—è –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞  

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é

---

**–ö–æ–Ω—Ç–∞–∫—Ç—ã:**  
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: `docs/HISTORY_PROCESSING.md`
- API: `http://46.224.17.15:3000/process-history`
- n8n: `https://n8n.rentflow.rentals`
- Telegram: `@n8n_alert_geodrive_bot`

**–î–∞—Ç–∞ —Ä–µ–ª–∏–∑–∞:** 2025-01-17  
**–í–µ—Ä—Å–∏—è:** 1.0.0

