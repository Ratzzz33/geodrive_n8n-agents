# ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è n8n –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞

## –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ Jarvis

#### `src/integrations/n8n.ts`
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ `sendEventToN8n()`: —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `N8N_BASE_WEBHOOK_URL` –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ `/rentprog-webhook?branch={branch}`
- ‚úÖ –§–æ—Ä–º–∞—Ç body: `{ts, type, payload:{id}, ok, reason}`
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ `sendSyncProgressToN8n()`: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `N8N_BASE_WEBHOOK_URL` –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ `/sync/progress`

#### `src/config/index.ts`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `N8N_BASE_WEBHOOK_URL` –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

#### `env.example`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `N8N_BASE_WEBHOOK_URL=http://46.224.17.15/webhook`

#### `src/bot/index.ts`
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: —Ç–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 20 –∑–∞–ø–∏—Å–µ–π (–≤–º–µ—Å—Ç–æ –∫–∞–∂–¥–æ–≥–æ –±–∞—Ç—á–∞)
- ‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –¥–ª—è cars, clients, bookings

#### `src/orchestrator/rentprog-handler.ts`
- ‚úÖ –£–∂–µ –≤—ã–∑—ã–≤–∞–µ—Ç `sendEventToN8n()` –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ upsert (—Å—Ç—Ä–æ–∫–∏ 216-222, 239-245)
- ‚úÖ –£–∂–µ –≤—ã–∑—ã–≤–∞–µ—Ç `sendEventToN8n()` –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö (—Å—Ç—Ä–æ–∫–∏ 254-261)

### 2. ‚úÖ SQL —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è —Ç–∞–±–ª–∏—Ü

#### `setup/create_n8n_tables.sql`
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã `events` (–≤–µ–±—Ö—É–∫–∏ RentProg)
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã `sync_runs` (–ø—Ä–æ–≥—Ä–µ—Å—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏)
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã `health` (health check —Å—Ç–∞—Ç—É—Å—ã)
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

#### `setup/execute_n8n_sql.ps1`
- ‚úÖ PowerShell —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL

### 3. ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

#### `N8N_SETUP_INSTRUCTIONS.md`
- ‚úÖ –ü–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ:
  - –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
  - –ò–º–ø–æ—Ä—Ç workflow
  - –°–æ–∑–¥–∞–Ω–∏–µ credentials
  - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
  - –ê–∫—Ç–∏–≤–∞—Ü–∏—è workflow
  - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  - Troubleshooting

---

## –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤—Ä—É—á–Ω—É—é

### 1. –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã –≤ Neon

–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –∏–∑ `setup/create_n8n_tables.sql` –≤ Neon:

**–í–∞—Ä–∏–∞–Ω—Ç A: –ß–µ—Ä–µ–∑ Neon Dashboard**
1. –û—Ç–∫—Ä–æ–π—Ç–µ Neon Dashboard
2. SQL Editor
3. –í—Å—Ç–∞–≤—å—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ `setup/create_n8n_tables.sql`
4. Execute

**–í–∞—Ä–∏–∞–Ω—Ç B: –ß–µ—Ä–µ–∑ psql**
```powershell
cd setup
.\execute_n8n_sql.ps1
```

**–í–∞—Ä–∏–∞–Ω—Ç C: –í—Ä—É—á–Ω—É—é**
```sql
-- –°–∫–æ–ø–∏—Ä—É–π—Ç–µ SQL –∏–∑ setup/create_n8n_tables.sql
```

### 2. –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å workflow –≤ n8n

1. –û—Ç–∫—Ä–æ–π—Ç–µ n8n: `http://46.224.17.15:5678`
2. **Workflows** ‚Üí **Import from File**
3. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –ø–æ –æ—á–µ—Ä–µ–¥–∏:
   - `n8n-workflows/rentprog-webhooks-monitor.json`
   - `n8n-workflows/sync-progress.json`
   - `n8n-workflows/health-status.json`

### 3. –°–æ–∑–¥–∞—Ç—å Credentials –≤ n8n

#### PostgreSQL
1. **Credentials** ‚Üí **Add Credential** ‚Üí **Postgres**
2. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ:
   - Host: `ep-rough-heart-ahnybmq0-pooler.c-3.us-east-1.aws.neon.tech`
   - Database: `neondb`
   - User: `neondb_owner`
   - Password: `npg_cHIT9Kxfk1Am`
   - Port: `5432`
   - SSL: –≤–∫–ª—é—á–∏—Ç—å
3. Name: `PostgreSQL`

#### Telegram Bot
1. **Credentials** ‚Üí **Add Credential** ‚Üí **Telegram**
2. Access Token: —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ `@n8n_alert_geodrive_bot` (—É @BotFather)
3. Name: `Telegram Bot`

#### –ü—Ä–∏–≤—è–∑–∞—Ç—å –∫ workflow
1. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–∞–∂–¥—ã–π workflow
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ Postgres –Ω–æ–¥–∞ ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ credential `PostgreSQL`
3. –î–ª—è –∫–∞–∂–¥–æ–≥–æ Telegram –Ω–æ–¥–∞ ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ credential `Telegram Bot`

### 4. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ n8n

–í n8n: **Settings** ‚Üí **Environment Variables**

–î–æ–±–∞–≤—å—Ç–µ:
```
RENTPROG_HEALTH_URL=http://46.224.17.15:3000/rentprog/health
TELEGRAM_ALERT_CHAT_ID=<–≤–∞—à_chat_id>
```

### 5. –û–±–Ω–æ–≤–∏—Ç—å .env –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ `.env` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ `46.224.17.15` –µ—Å—Ç—å:

```env
N8N_BASE_WEBHOOK_URL=http://46.224.17.15/webhook
```

**–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞:**
```bash
docker compose restart bot
# –∏–ª–∏
npm run dev
```

### 6. –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å workflow

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–∑ 3 workflow:
1. –û—Ç–∫—Ä–æ–π—Ç–µ workflow
2. –ù–∞–∂–º–∏—Ç–µ **Active** (–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—Å–µ –Ω–æ–¥—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –¢–µ—Å—Ç –≤–µ–±—Ö—É–∫–∞

```bash
curl -X POST "https://geodrive.netlify.app/webhooks/rentprog/tbilisi" \
  -H "Content-Type: application/json" \
  -d '{"event":"booking.issue.planned","payload":{"id":"test_123"}}'
```

**–û–∂–∏–¥–∞–Ω–∏–µ:**
- ‚úÖ n8n ‚Üí Executions ‚Üí "RentProg Webhooks Monitor" –≤–∏–¥–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `events` –ø–æ–ª—É—á–∏–ª–∞ –∑–∞–ø–∏—Å—å
- ‚úÖ –ü—Ä–∏ `ok:false` ‚Üí Telegram –∞–ª–µ—Ä—Ç

### 2. –¢–µ—Å—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

–í –±–æ—Ç–µ:
```
/sync_rentprog
```

**–û–∂–∏–¥–∞–Ω–∏–µ:**
- ‚úÖ n8n ‚Üí Executions ‚Üí "Sync Progress" –≤–∏–¥–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `sync_runs` –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–ø–∏—Å–∏ –∫–∞–∂–¥—ã–µ 20 –∑–∞–ø–∏—Å–µ–π

### 3. –¢–µ—Å—Ç Health Check

Health workflow –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç.

**–û–∂–∏–¥–∞–Ω–∏–µ:**
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `health` –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–ø–∏—Å–∏
- ‚úÖ –ü—Ä–∏ `ok:false` ‚Üí Telegram –∞–ª–µ—Ä—Ç

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞

–í –±–æ—Ç–µ:
```
/status
```

**–û–∂–∏–¥–∞–Ω–∏–µ:**
- ‚úÖ RentProg –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∑–µ–ª–µ–Ω—ã–π —Å—Ç–∞—Ç—É—Å

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `events`
```sql
SELECT * FROM events ORDER BY ts DESC LIMIT 10;
```

### –¢–∞–±–ª–∏—Ü–∞ `sync_runs`
```sql
SELECT * FROM sync_runs ORDER BY ts DESC LIMIT 10;
```

### –¢–∞–±–ª–∏—Ü–∞ `health`
```sql
SELECT * FROM health ORDER BY ts DESC LIMIT 10;
```

---

## –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ (Definition of Done)

- ‚úÖ –í n8n –≤–∏–¥–Ω—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ –¥–≤—É–º –ø—Ä–æ—Ü–µ—Å—Å–∞–º: –≤—Ö–æ–¥—è—â–∏–µ –≤–µ–±—Ö—É–∫–∏ –∏ —Å–∏–Ω–∫
- ‚úÖ –¢–∞–±–ª–∏—Ü—ã `events`, `sync_runs`, `health` –≤ Neon –ø–æ–ª—É—á–∞—é—Ç –∑–∞–ø–∏—Å–∏
- ‚úÖ Telegram –∞–ª–µ—Ä—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö (`ok:false`)
- ‚úÖ `/status` –≤ –±–æ—Ç–µ –∑–µ–ª–µ–Ω—ã–π –ø–æ RentProg, –∞ –≤ `health` —Ç–∞–±–ª–∏—Ü–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ —à–∞–≥–∏ –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ "–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤—Ä—É—á–Ω—É—é"
2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤—Å–µ 3 —Å—Ü–µ–Ω–∞—Ä–∏—è
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ —Ç–∞–±–ª–∏—Ü—ã
4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Telegram –∞–ª–µ—Ä—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç

üéâ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!**

