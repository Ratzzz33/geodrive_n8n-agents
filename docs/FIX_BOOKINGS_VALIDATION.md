# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –±—Ä–æ–Ω–µ–π –≤ n8n workflow

**–î–∞—Ç–∞:** 2025-11-19  
**–ü—Ä–æ–±–ª–µ–º–∞:** Workflow —Å–æ—Ö—Ä–∞–Ω—è—é—Ç –±—Ä–æ–Ω–∏ –±–µ–∑ `number`, –Ω–∞—Ä—É—à–∞—è UNIQUE constraint –∏ External Refs pattern  
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ –∞–ª–µ—Ä—Ç–æ–≤

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î

- [x] –£–¥–∞–ª–µ–Ω—ã 2 –º—É—Å–æ—Ä–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –±–µ–∑ `number`
- [x] –î–æ–±–∞–≤–ª–µ–Ω—ã NOT NULL constraints –Ω–∞ `number` –∏ `branch`
- [x] –¢–µ–ø–µ—Ä—å –ë–î –Ω–µ –ø—Ä–∏–º–µ—Ç –∑–∞–ø–∏—Å–∏ –±–µ–∑ —ç—Ç–∏—Ö –ø–æ–ª–µ–π

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ

---

## üîß –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ workflow

### –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ workflow (17 —à—Ç—É–∫)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ (–∞–∫—Ç–∏–≤–Ω—ã–µ):**
1. `‚úÖ–ü–∞—Ä—Å–∏–Ω–≥ –±—Ä–æ–Ω–µ–π RentProg (–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ, –ë–∞—Ç—É–º–∏)` - ID: FDMvu8P8DKilQTOK
2. `‚úÖ–ü–∞—Ä—Å–∏–Ω–≥ –±—Ä–æ–Ω–µ–π RentProg (–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ, –¢–±–∏–ª–∏—Å–∏)`
3. `‚úÖ–ü–∞—Ä—Å–∏–Ω–≥ –±—Ä–æ–Ω–µ–π RentProg (–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ, –ö—É—Ç–∞–∏—Å–∏)`
4. `‚úÖ–ü–∞—Ä—Å–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–æ–Ω–µ–π RentProg`

**–û—Å—Ç–∞–ª—å–Ω—ã–µ (–¥–ª—è –ø–æ–ª–Ω–æ—Ç—ã):**
- `rentprog-bookings-current.json`
- `rentprog-bookings-latest.json`
- `rentprog-bookings-api-direct-v2.json`
- `rentprog-bookings-api-direct.json`
- –ò –µ—â–µ 9...

---

## üìã –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### –®–∞–≥ 1: –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ –Ω–æ–¥—ã "Process All Bookings"

**–§–∞–π–ª —Å –Ω–æ–≤—ã–º –∫–æ–¥–æ–º:** `n8n-workflows/process-bookings-with-validation.js`

1. –û—Ç–∫—Ä–æ–π—Ç–µ workflow –≤ n8n: https://n8n.rentflow.rentals/workflow/FDMvu8P8DKilQTOK
2. –ù–∞–π–¥–∏—Ç–µ –Ω–æ–¥—É "Process All Bookings" (Code Node)
3. –û—Ç–∫—Ä–æ–π—Ç–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–¥–∞
4. **–í–ê–ñ–ù–û:** –û–±–Ω–æ–≤–∏—Ç–µ `branchMapping` –≤ –∫–æ–¥–µ:
   ```javascript
   // –î–ª—è Batumi (–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ):
   const branchMapping = [{ branch: 'batumi', active: false }];
   
   // –î–ª—è Tbilisi (–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ):
   const branchMapping = [{ branch: 'tbilisi', active: false }];
   
   // –î–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–æ–Ω–µ–π (–≤—Å–µ —Ñ–∏–ª–∏–∞–ª—ã):
   const branchMapping = [
     { branch: 'tbilisi', active: true },
     { branch: 'batumi', active: true },
     { branch: 'kutaisi', active: true },
     { branch: 'service-center', active: true }
   ];
   ```
5. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–µ—Å—å –∫–æ–¥ –∏–∑ `n8n-workflows/process-bookings-with-validation.js`
6. –í—Å—Ç–∞–≤—å—Ç–µ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–¥–∞ –Ω–æ–¥—ã
7. –ù–∞–∂–º–∏—Ç–µ "Save"

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ `if (!number)` –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –≤ results
- ‚úÖ –°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –±—Ä–æ–Ω–µ–π –≤ `skippedBookings[]`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ `rentprog_id` –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –±—Ä–æ–Ω–µ–π –≤ –∫–æ–Ω—Å–æ–ª—å

---

### –®–∞–≥ 2: –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–¥—É "Check Skipped Bookings"

**–§–∞–π–ª —Å –∫–æ–¥–æ–º:** `n8n-workflows/send-skipped-bookings-alert.js`

1. –í —Ç–æ–º –∂–µ workflow, –ø–æ—Å–ª–µ –Ω–æ–¥—ã "Process All Bookings"
2. –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—É—é –Ω–æ–¥—É: **Code** (—Ç–∏–ø: JavaScript)
3. –ù–∞–∑–≤–∞–Ω–∏–µ: `Check Skipped Bookings`
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ –∏–∑ `n8n-workflows/send-skipped-bookings-alert.js`
5. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ:
   - –í—Ö–æ–¥: –æ—Ç "Process All Bookings"
   - –í—ã—Ö–æ–¥: —Ä–∞–∑–¥–µ–ª–∏—Ç–µ –Ω–∞ 2 –≤–µ—Ç–∫–∏ (—Å–º. –®–∞–≥ 3)

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç –Ω–æ–¥–∞:**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –±—Ä–æ–Ω–µ–π
- –§–æ—Ä–º–∏—Ä—É–µ—Ç –∞–ª–µ—Ä—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
- –î–æ–±–∞–≤–ª—è–µ—Ç alert item –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram

---

### –®–∞–≥ 3: –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª–æ–≤–∏–µ –∏ –∞–ª–µ—Ä—Ç

#### 3.1. –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–¥—É IF

1. –ü–æ—Å–ª–µ "Check Skipped Bookings" –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–¥—É **IF**
2. –ù–∞–∑–≤–∞–Ω–∏–µ: `Has Skipped Bookings?`
3. –£—Å–ª–æ–≤–∏–µ:
   ```
   Expression: {{ $json.alert_type === 'skipped_bookings' }}
   ```

#### 3.2. True branch ‚Üí Send Alert to Telegram

1. –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–¥—É **Telegram**
2. –ù–∞–∑–≤–∞–Ω–∏–µ: `Send Skipped Bookings Alert`
3. –ù–∞—Å—Ç—Ä–æ–π–∫–∏:
   - Chat ID: `-1003484642420`
   - Text: `{{ $json.message }}`
   - Additional Fields:
     - Parse Mode: `HTML`
     - Append Attribution: `false`

#### 3.3. False branch ‚Üí Save to DB

1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –Ω–æ–¥–µ "Save to DB"
2. –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–µ –±—Ä–æ–Ω–∏

---

### –®–∞–≥ 4: –û–±–Ω–æ–≤–∏—Ç—å —Å–≤—è–∑–∏ –Ω–æ–¥

**–ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ workflow:**

```
Process All Bookings
         ‚Üì
Check Skipped Bookings
         ‚Üì
Has Skipped Bookings? (IF)
    ‚Üô        ‚Üò
True         False
  ‚Üì            ‚Üì
Send Alert   Save to DB
              ‚Üì
         (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–æ–¥—ã)
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –ù–æ—Ä–º–∞–ª—å–Ω—ã–π —Å–ª—É—á–∞–π (–≤—Å–µ –±—Ä–æ–Ω–∏ –≤–∞–ª–∏–¥–Ω—ã)

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ workflow
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ:
   - ‚úÖ –í—Å–µ –±—Ä–æ–Ω–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î
   - ‚úÖ –ê–ª–µ—Ä—Ç –ù–ï –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
   - ‚úÖ –í –ª–æ–≥–∞—Ö: `Skipped bookings: 0`

### –¢–µ—Å—Ç 2: –ï—Å—Ç—å –±—Ä–æ–Ω–∏ –±–µ–∑ number

1. –ï—Å–ª–∏ RentProg API –≤–µ—Ä–Ω–µ—Ç –±—Ä–æ–Ω–∏ –±–µ–∑ `number`:
   - ‚úÖ –≠—Ç–∏ –±—Ä–æ–Ω–∏ –ø—Ä–æ–ø—É—â–µ–Ω—ã (–Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã)
   - ‚úÖ –ê–ª–µ—Ä—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram
   - ‚úÖ –í –∞–ª–µ—Ä—Ç–µ —É–∫–∞–∑–∞–Ω—ã RentProg ID –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –±—Ä–æ–Ω–µ–π

### –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –±–µ–∑ number
SELECT COUNT(*) 
FROM bookings 
WHERE number IS NULL;
-- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 0

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ constraint
\d bookings
-- number: NOT NULL ‚úì
-- branch: NOT NULL ‚úì
```

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ê–ª–µ—Ä—Ç—ã –≤ Telegram (—á–∞—Ç -1003484642420)

**–§–æ—Ä–º–∞—Ç –∞–ª–µ—Ä—Ç–∞:**
```
‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ë—Ä–æ–Ω–∏ –±–µ–∑ –Ω–æ–º–µ—Ä–∞!

–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ 2 –±—Ä–æ–Ω–∏/–µ–π –±–µ–∑ –ø–æ–ª—è number.
–≠—Ç–∏ –±—Ä–æ–Ω–∏ –ù–ï –°–û–•–†–ê–ù–ï–ù–´ –≤ –ë–î.

–ü—Ä–∏–º–µ—Ä—ã (2 –∏–∑ 2):

1. RentProg ID: 514715
   –§–∏–ª–∏–∞–ª: batumi
   –ö–ª–∏–µ–Ω—Ç: John Doe
   –ê–≤—Ç–æ: Mercedes GLS 700
   –ü—Ä–∏—á–∏–Ω–∞: Missing number field

2. RentProg ID: 514701
   ...
```

### –õ–æ–≥–∏ n8n

–ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –±—Ä–æ–Ω–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:
```
‚ö†Ô∏è  Skipping booking without number: rentprog_id=514715, branch=batumi
```

---

## üéØ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫ –æ—Å—Ç–∞–ª—å–Ω—ã–º workflow

–î–ª—è –∫–∞–∂–¥–æ–≥–æ workflow –∏–∑ —Å–ø–∏—Å–∫–∞ 17:

1. –û—Ç–∫—Ä–æ–π—Ç–µ workflow –≤ n8n
2. –ù–∞–π–¥–∏—Ç–µ –Ω–æ–¥—É "Process All Bookings"
3. –û–±–Ω–æ–≤–∏—Ç–µ –∫–æ–¥ (–Ω–µ –∑–∞–±—É–¥—å—Ç–µ `branchMapping`!)
4. –î–æ–±–∞–≤—å—Ç–µ "Check Skipped Bookings" –∏ –∞–ª–µ—Ä—Ç
5. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ
6. –û—Ç–º–µ—Ç—å—Ç–µ –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–µ –Ω–∏–∂–µ

### –ß–µ–∫–ª–∏—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

- [ ] `‚úÖ–ü–∞—Ä—Å–∏–Ω–≥ –±—Ä–æ–Ω–µ–π RentProg (–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ, –ë–∞—Ç—É–º–∏)` - FDMvu8P8DKilQTOK
- [ ] `‚úÖ–ü–∞—Ä—Å–∏–Ω–≥ –±—Ä–æ–Ω–µ–π RentProg (–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ, –¢–±–∏–ª–∏—Å–∏)`
- [ ] `‚úÖ–ü–∞—Ä—Å–∏–Ω–≥ –±—Ä–æ–Ω–µ–π RentProg (–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ, –ö—É—Ç–∞–∏—Å–∏)`
- [ ] `‚úÖ–ü–∞—Ä—Å–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–æ–Ω–µ–π RentProg`
- [ ] `rentprog-bookings-current.json`
- [ ] `rentprog-bookings-latest.json`
- [ ] `rentprog-bookings-api-direct-v2.json`
- [ ] `rentprog-bookings-api-direct.json`
- [ ] (–µ—â–µ 9...)

---

## üö® –ß—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ –ø—Ä–∏—à–µ–ª –∞–ª–µ—Ä—Ç

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å RentProg API:**
   - –ü–µ—Ä–µ–π—Ç–∏ –≤ RentProg –∞–¥–º–∏–Ω–∫—É
   - –ù–∞–π—Ç–∏ –±—Ä–æ–Ω—å –ø–æ ID –∏–∑ –∞–ª–µ—Ä—Ç–∞
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –ª–∏ –ø–æ–ª–µ "–ù–æ–º–µ—Ä –±—Ä–æ–Ω–∏"

2. **–ï—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ –≤ RentProg:**
   - –ó–∞–ø–æ–ª–Ω–∏—Ç—å –≤—Ä—É—á–Ω—É—é
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å workflow –ø–æ–≤—Ç–æ—Ä–Ω–æ

3. **–ï—Å–ª–∏ –ø–æ–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –≤ RentProg:**
   - –ü—Ä–æ–±–ª–µ–º–∞ —Å API –ø–∞—Ä—Å–∏–Ω–≥–æ–º
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∫ RentProg API
   - –û–±–Ω–æ–≤–∏—Ç—å workflow –µ—Å–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å

4. **–£–≤–µ–¥–æ–º–∏—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞:**
   - –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –∞–ª–µ—Ä—Ç–∞
   - –°–æ–∑–¥–∞—Ç—å issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

**–§–∞–π–ª—ã:**
- `n8n-workflows/process-bookings-with-validation.js` - –ù–æ–≤—ã–π –∫–æ–¥ Process All Bookings
- `n8n-workflows/send-skipped-bookings-alert.js` - –ö–æ–¥ Check Skipped Bookings
- `setup/migrate_bookings_enforce_number_not_null.mjs` - –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î
- `docs/FIX_BOOKINGS_VALIDATION.md` - –≠—Ç–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

**–°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:**
- [External Refs Pattern](../ARCHITECTURE.md#external-refs-pattern)
- [Best Practices –¥–ª—è n8n](../.cursorrules)

---

**–°—Ç–∞—Ç—É—Å:** üìù –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –≥–æ—Ç–æ–≤–∞, –æ–∂–∏–¥–∞–µ—Ç—Å—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫ workflow

