# ‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ workflow "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ü–µ–Ω –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏"

**Workflow ID:** ihRLR0QCJySx319b  
**URL:** https://n8n.rentflow.rentals/workflow/ihRLR0QCJySx319b  
**–ù–∞–∑–≤–∞–Ω–∏–µ:** ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ü–µ–Ω –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π (RentProg) —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ê–∫—Ç–∏–≤–µ–Ω

---

## ‚úÖ –í–°–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–ò–ú–ï–ù–ï–ù–´

### 1. ‚úÖ –¢—Ä–∏–≥–≥–µ—Ä –∏—Å–ø—Ä–∞–≤–ª–µ–Ω
- **–ë—ã–ª–æ:** `"0 * * * *"` (–∫–∞–∂–¥—ã–π —á–∞—Å)
- **–°—Ç–∞–ª–æ:** `"0 2 * * *"` (—Ä–∞–∑ –≤ —Å—É—Ç–∫–∏ –≤ 2:00 –Ω–æ—á–∏)

### 2. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ü–µ–Ω
- –ù–æ–¥–∞ "Normalize Cars" –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Ü–µ–Ω—ã –∏–∑ `included` –≤ –æ—Ç–≤–µ—Ç–µ API
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –æ—Ç–≤–µ—Ç–∞
- –°–æ–∑–¥–∞–µ—Ç –º–∞–ø–ø–∏–Ω–≥ —Ü–µ–Ω –ø–æ `car_id`
- –°–æ–∑–¥–∞–µ—Ç –º–∞–ø–ø–∏–Ω–≥ —Å–µ–∑–æ–Ω–æ–≤ –ø–æ ID

### 3. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–¥—ã –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ü–µ–Ω
- **Split Cars and Prices** - —Ä–∞–∑–¥–µ–ª—è–µ—Ç –º–∞—à–∏–Ω—ã –∏ —Ü–µ–Ω—ã
- **Find Car ID** - –Ω–∞—Ö–æ–¥–∏—Ç `car_id` –ø–æ `rentprog_id`
- **Merge Car ID** - –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã —Å `car_id`
- **Format Price Values** - —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É `price_values`
- **Save Prices** - —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü—É `car_prices`

### 4. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
- –ü—Ä–æ–≤–µ—Ä–∫–∏ –≤ –Ω–æ–¥–∞—Ö "Merge Car ID" –∏ "Format Price Values"
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—É—Å—Ç—ã—Ö –º–∞—Å—Å–∏–≤–æ–≤ –∏ –Ω—É–ª–µ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π

### 5. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–¥–∞ "Merge Results"
- –û–±—ä–µ–¥–∏–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç "Save Prices" –∏ "Save Cars"
- –ü–µ—Ä–µ–¥–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ "Format Result"

### 6. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ –Ω–æ–¥–∞ "Format Result"
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç "Save Prices" –∏ "Save Cars"
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –º–∞—à–∏–Ω–∞–º –∏ —Ü–µ–Ω–∞–º

### 7. ‚úÖ Workflow –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω
- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω `active: true`

---

## üîÑ –§–ò–ù–ê–õ–¨–ù–ê–Ø –°–¢–†–£–ö–¢–£–†–ê WORKFLOW

```
Daily Trigger (2:00 –Ω–æ—á–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å)
  ‚Üì
4 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤–µ—Ç–∫–∏ (Tbilisi, Batumi, Kutaisi, Service Center):
  Context ‚Üí Get Token ‚Üí Fetch Cars ‚Üí Wrap Cars
  ‚Üì
Merge All Branches
  ‚Üì
Normalize Cars (–∏–∑–≤–ª–µ–∫–∞–µ—Ç –º–∞—à–∏–Ω—ã –ò —Ü–µ–Ω—ã)
  ‚Üì
Split Cars and Prices
  ‚îú‚îÄ True branch (—Ü–µ–Ω—ã):
  ‚îÇ   Find Car ID ‚Üí Merge Car ID ‚Üí Format Price Values ‚Üí Save Prices ‚Üí Merge Results
  ‚îÇ
  ‚îî‚îÄ False branch (–º–∞—à–∏–Ω—ã):
      Has Data?
        ‚îú‚îÄ True (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö): Format Result
        ‚îî‚îÄ False (–µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ): Save Snapshot ‚Üí Remove Price Values ‚Üí Save Cars ‚Üí Merge Results
  ‚Üì
Merge Results (–æ–±—ä–µ–¥–∏–Ω—è–µ—Ç Save Prices –∏ Save Cars)
  ‚Üì
Format Result ‚Üí If Error ‚Üí Send Alert / Success
```

---

## üõ°Ô∏è –ó–ê–©–ò–¢–ê –û–¢ –ü–£–°–¢–´–• –ó–ù–ê–ß–ï–ù–ò–ô

### –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞:

1. **–ù–æ–¥–∞ "Normalize Cars":**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ `values` –Ω–µ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –Ω–µ –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω—É–ª–µ–≤—ã–µ

2. **–ù–æ–¥–∞ "Merge Car ID":**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `car_id`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `price_id`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `season_id`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `values`

3. **–ù–æ–¥–∞ "Format Price Values":**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `car_id`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `price_id`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `season_id`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `values`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –Ω–µ –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω—É–ª–µ–≤—ã–µ

4. **–ù–æ–¥–∞ "Save Prices":**
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç upsert —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –ø–æ `(car_id, season_id)`

---

## üìã –°–û–•–†–ê–ù–ï–ù–ò–ï –¶–ï–ù

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤ `car_prices`:

```sql
INSERT INTO car_prices (
  car_id,              -- UUID –∏–∑ —Ç–∞–±–ª–∏—Ü—ã cars
  rentprog_price_id,   -- ID —Ü–µ–Ω—ã –≤ RentProg
  season_id,           -- ID —Å–µ–∑–æ–Ω–∞ –≤ RentProg
  season_name,         -- –ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ–∑–æ–Ω–∞
  season_start_date,   -- –ù–∞—á–∞–ª–æ —Å–µ–∑–æ–Ω–∞
  season_end_date,     -- –ö–æ–Ω–µ—Ü —Å–µ–∑–æ–Ω–∞
  price_values         -- JSONB —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å —Ü–µ–Ω–∞–º–∏
)
VALUES (...)
ON CONFLICT (car_id, season_id) DO UPDATE SET ...
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ `price_values`:

```json
{
  "periods": ["1-3 –¥–Ω—è", "4-7 –¥–Ω–µ–π", "8-15 –¥–Ω–µ–π", "16-30 –¥–Ω–µ–π", "31+ –¥–Ω–µ–π"],
  "values": [151, 146, 140, 135, 116, 94],
  "currency": "GEL",
  "exchange_rate": 2.7,
  "items": [
    {
      "period": "1-3 –¥–Ω—è",
      "price_per_day": 151,
      "price_gel": 151,
      "price_usd": 55.93,
      "currency": "GEL"
    },
    ...
  ],
  "season": {
    "name": "–ù–∏–∑–∫–∏–π —Å–µ–∑–æ–Ω",
    "start_date": "2025-01-01",
    "end_date": "2025-03-31"
  }
}
```

---

## ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ó–ê–ú–ï–ß–ê–ù–ò–Ø

### 1. API endpoint
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `all_cars_full` - –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ª–∏ –æ–Ω `included` —Å —Ü–µ–Ω–∞–º–∏
- –ï—Å–ª–∏ API –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ü–µ–Ω—ã, –≤–æ–∑–º–æ–∂–Ω–æ, –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π endpoint

### 2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- **–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:** –ó–∞–ø—É—Å—Ç–∏—Ç—å workflow –≤—Ä—É—á–Ω—É—é –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ü–µ–Ω—ã –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –∏–∑ API
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ü–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `car_prices`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –ë–î

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- Workflow –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏ –≤ 2:00 –Ω–æ—á–∏
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—É—Å–∫–æ–≤
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ü–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## ‚úÖ –ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê

### ‚úÖ –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
- –¢—Ä–∏–≥–≥–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏ (2:00 –Ω–æ—á–∏)
- –î–æ–±–∞–≤–ª–µ–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ü–µ–Ω –∏–∑ API –æ—Ç–≤–µ—Ç–∞
- –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–¥—ã –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ü–µ–Ω –≤ `car_prices`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–¥–∞ "Merge Results" –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ –Ω–æ–¥–∞ "Format Result" –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ—Ç Save Prices –∏ Save Cars
- Workflow –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω
- Connections –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ

### ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
- –ó–∞–ø—É—Å—Ç–∏—Ç—å workflow –≤—Ä—É—á–Ω—É—é –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ü–µ–Ω—ã –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –∏–∑ API
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ü–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `car_prices`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –ë–î

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å workflow –≤—Ä—É—á–Ω—É—é –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã.

