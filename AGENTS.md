# Агенты системы

## Описание агентов

Каждый агент - независимый модуль, выполняющий узкоспециализированную функцию. Агенты вызываются оркестратором и взаимодействуют с БД, внешними API и Telegram.

---

## 1. Агент инкассатор

**Триггеры**: Cron (регулярные проверки), событие от RentProg

**Функции**:
- Проверка касс сотрудников в RentProg (раздел "Настройки компании → Сотрудники")
- Контроль своевременной инкассации наличных
- Определение превышения лимитов

**Действия**:
- Напоминание управляющему о необходимости забрать деньги
- Напоминание сотруднику в личку о сдаче денег
- Эскалация при длительной просрочке

**Интеграции**: RentProg API, Telegram

---

## 2. Агент контролер броней

**Триггеры**: Cron, события от RentProg (`booking.issue.planned`, `booking.return.planned`)

**Функции**:
- Проверка по времени предстоящих выдач и приемок
- Контроль своевременного проведения операций в RentProg

**Действия**:
- Напоминание ответственному сотруднику о необходимости:
  - Провести операцию в RentProg
  - Собрать материалы (фото/видео)
- Эскалация при просрочке

**Интеграции**: RentProg API, Telegram

---

## 3. Агент помощник по выдаче

**Триггеры**: Событие от RentProg, сообщение от сотрудника с материалами

**Функции**:
- Проверка материалов от сотрудника на соответствие чеклисту
- Валидация полноты фото/видео
- CV-проверки (при наличии)

**Действия**:
- Формирование отчета о выдаче
- Публикация отчета и материалов в:
  - Тему авто в чате филиала
  - Тему авто в общем чате (HQ)
- Сохранение в БД:
  - Данные о платежах
  - Проданная доп страховка
  - Выданное допоборудование
  - Пробелы по чеклисту (что не сделано)

**Интеграции**: Telegram, БД, Объектное хранилище

---

## 4. Агент по темам авто

**Триггеры**: Событие `car.moved` от RentProg, создание важных сообщений

**Функции**:
- Автоматическое создание тем с названиями авто в группах филиалов
- Удаление темы при перемещении авто в другой филиал
- Создание темы в новом филиале

**Действия**:
- Создание/удаление тем в Telegram-чатах
- Пересылка важных сообщений о:
  - Поломках
  - Инцидентах
  - Проблемах с авто из отзывов клиентов
  - Чеках по ремонтам
  в главную тему по автомобилю (HQ)

**Интеграции**: Telegram Bot API, RentProg webhooks

---

## 5. Агент помощник по приемке авто

**Триггеры**: Напоминание от агента контролера броней, сообщение от сотрудника

**Функции**:
- Напоминание ответственному за приемку
- Структурирование материалов по приемке
- Контроль полноты материалов по чеклисту
- Проверка достаточности фото
- Проверка штрафов

**Действия**:
- Напоминание сотруднику предоставить материалы
- Структурирование полученных материалов
- Публикация в:
  - Общий чат (тема авто)
  - Чат филиала (тема авто)
- Запись в БД:
  - Платежи и долги по выдачам/приемкам
  - Результаты проверки штрафов

**Интеграции**: Telegram, БД, RentProg API

---

## 6. Агент по созданию счетов Stripe

**Триггеры**: Команда от сотрудника, событие от системы

**Функции**:
- Создание invoice/payment link в Stripe
- Привязка к брони/клиенту

**Действия**:
- Генерация ссылки на оплату
- Отправка ссылки в тему клиента
- Отслеживание статуса оплаты через webhooks
- Обновление статуса в БД

**Интеграции**: Stripe API, Telegram, БД

---

## 7. Агент клиентских чатов (Umnico bridge)

**Триггеры**: Webhook от Umnico (входящее сообщение)

**Функции**:
- Создание группы с ботом для каждого сотрудника (при первом сообщении)
- Создание темы по клиенту в группе сотрудника
- Зеркалирование сообщений клиента → Telegram (в тему)
- Отправка сообщений сотрудника → клиенту через Umnico
- Перевод сообщений (клиент получает на родном языке, сотрудник на русском)
- Улучшение текста и исправление ошибок сотрудников

**Действия**:
- При получении сообщения от клиента:
  - Определение ответственного сотрудника
  - Создание/поиск темы в группе сотрудника
  - Публикация сообщения в тему (жирным: имя клиента и авто)
  - Перевод на русский
- При получении ответа сотрудника:
  - Перевод на язык клиента
  - Отправка через Umnico
- Эскалация:
  - При отсутствии ответа → тема появляется у руководителя
  - При отсутствии ответа руководителя → эскалация выше
- Режим внутренней переписки:
  - Подключение коллег для консультации
  - Создание темы в режиме внутренней переписки
  - Сообщения видят только сотрудники

**Интеграции**: Umnico API, Telegram, LLM (перевод)

---

## 8. Агент контроля проведения в RentProg

**Триггеры**: Cron, событие после планируемого времени операции

**Функции**:
- Проверка своевременного проведения выдач/приемок в RentProg
- Контроль наличия задолженности
- Выявление несоответствий (операция выполнена, но не проведена)

**Действия**:
- Напоминание сотруднику о необходимости провести операцию
- Эскалация при просрочке
- Отчет о задолженностях

**Интеграции**: RentProg API, Telegram

---

## 9. Агент служебных поездок (Starline)

**Триггеры**: Cron (регулярная проверка), событие от Starline

**Функции**:
- Сверка поездок авто без броней в Starline (через браузер)
- Проверка работоспособности GPS
- Создание служебных поездок для разрешенных перемещений

**Действия**:
- Обнаружение несанкционированной поездки:
  - Сообщение руководителю
  - Публикация в чат авто филиала
  - Создание инцидента
- Обнаружение нерабочего GPS без брони:
  - Сообщение ответственному лицу
- Создание служебной поездки при необходимости

**Интеграции**: Starline (Playwright), Telegram, БД

**Примечание**: Starline не имеет API, требуется браузерная автоматизация

---

## 10. Агент контроля ТО

**Триггеры**: Cron (ежедневная проверка)

**Функции**:
- Парсинг сайта https://greenway.ge/ для проверки сроков ТО
- Проверка машин без броней, у которых подходит государственное ТО
- Учет будущих броней (не предлагать ТО если авто занято)

**Действия**:
- Напоминание в чат авто о необходимости сделать ТО
- Уведомление ответственному сотруднику
- Предложение свободных окон для ТО

**Интеграции**: Greenway.ge (Playwright), Telegram, БД

---

## 11. Агент контроля оплат страховок

**Триггеры**: Cron, события от внешних систем

**Функции**:
- Контроль оплаты страховок
- Отслеживание сроков оплаты

**Действия**:
- Напоминание о предстоящих оплатах
- Эскалация при просрочке
- Отчет о статусе страховок

**Интеграции**: БД, Telegram

---

## 12. Агент контроля страховых кейсов

**Триггеры**: Cron, события о страховых случаях

**Функции**:
- Контроль ведения страховых кейсов
- Отслеживание статусов дел

**Действия**:
- Напоминания о необходимых действиях
- Отчет о статусе кейсов

**Интеграции**: БД, Telegram

---

## 13. Агент контроля расписания сотрудников

**Триггеры**: Cron (проверка заполнения)

**Функции**:
- Контроль заполнения расписания сотрудников в YouGile
- Выявление пустых смен

**Действия**:
- Напоминание о необходимости заполнить расписание
- Эскалация при отсутствии расписания

**Интеграции**: YouGile API, Telegram

---

## 14. Агент контроля ремонтов

**Триггеры**: Cron, события от RentProg

**Функции**:
- Контроль авто со статусами "нельзя выдавать" в RentProg
- Отслеживание сроков ремонта

**Действия**:
- Напоминание о длительном простое
- Эскалация при критичных задержках
- Отчет о статусе ремонтов

**Интеграции**: RentProg API, Telegram

---

## 15. Агент контроля штрафов

**Триггеры**: Cron, события о новых штрафах

**Функции**:
- Контроль оплаты и возмещения штрафов
- Отслеживание сроков оплаты

**Действия**:
- Напоминание о необходимости оплаты
- Отчет о статусе штрафов
- Эскалация при просрочке

**Интеграции**: БД, Telegram

---

## 16. Агент таблицы продаж страховок

**Триггеры**: После каждой выдачи с проданной страховкой, Cron (консолидация)

**Функции**:
- Заполнение таблицы продаж страховок
- Аналитика по продажам

**Действия**:
- Запись данных о продаже в БД
- Генерация отчетов
- Экспорт в Google Sheets (при необходимости)

**Интеграции**: БД, Google Sheets API (опционально)

---

## 17. Агент контроля укомплектованности багажника

**Триггеры**: При приемке/выдаче, проверка чеклиста

**Функции**:
- Контроль наличия необходимого оборудования в багажнике
- Сверка по фото/чеклисту

**Действия**:
- Напоминание о недостающих предметах
- Запись недостач в БД

**Интеграции**: Telegram, БД

---

## 18. Агент контроля наличия техпаспорта

**Триггеры**: При выдаче/приемке, проверка материалов

**Функции**:
- Проверка наличия фото техпаспорта при операциях
- Валидация качества фото

**Действия**:
- Напоминание при отсутствии фото
- Эскалация при критичных случаях

**Интеграции**: Telegram, БД, CV (OCR для валидации)

---

## 19. Агент контроля состояния шин по фото

**Триггеры**: При приемке/выдаче, специальная проверка

**Функции**:
- Анализ фото шин (CV)
- Определение износа
- Выявление повреждений

**Действия**:
- Оценка состояния шин
- Рекомендации по замене
- Запись результатов в БД

**Интеграции**: Telegram, БД, CV (YOLO, сегментация)

**Статус**: Планируется

---

## 20. Агент проверки работы отдела продаж (AmoCRM)

**Триггеры**: Cron (регулярная проверка)

**Функции**:
- Проверка работы сотрудников отдела продаж в AmoCRM
- Анализ качества работы
- Оценка продаж страховок

**Действия**:
- Создание задач по сделкам
- Генерация отчетов о качестве работы
- Оценка эффективности продаж страховок

**Интеграции**: AmoCRM API, Telegram

---

## 21. Агент инструктор

**Триггеры**: Запрос от сотрудника через бота

**Функции**:
- Предоставление инструкций сотрудникам
- Ответы на вопросы по использованию системы
- Пошаговые инструкции по процессам

**Действия**:
- Поиск релевантной информации в базе знаний
- Форматирование и отправка инструкций
- Помощь в заполнении чеклистов

**Интеграции**: База знаний (RAG из rp_capture), Telegram, LLM

---

## 22. Агент генератор договоров

**Триггеры**: Команда от сотрудника, автоматически при новой брони

**Функции**:
- Генерация договоров для клиентов
- Заполнение шаблонов данными из брони

**Действия**:
- Создание договора на основе шаблона
- Заполнение данными клиента и брони
- Отправка клиенту (через Umnico или email)
- Интеграция с e-signature (планируется)

**Интеграции**: Шаблоны договоров, Umnico, e-signature API (будущее)

---

## 23. Агент контроля повреждений по фото

**Триггеры**: При выдаче/приемке, загрузка фото в тему авто

**Функции**:
- Обнаружение новых повреждений на фото (CV)
- Сравнение с историей повреждений
- Ведение карты повреждений

**Действия**:
- CV-анализ фото (YOLO + SAM2)
- Выделение новых повреждений
- Создание записи о повреждении (с флагом "требует верификации")
- Уведомление в тему авто
- В будущем: создание 3D-модели с точками повреждений

**Интеграции**: Telegram, БД, Объектное хранилище, CV (YOLO, SAM2)

**Статус**: В разработке, 3D-модель в планах

---

## 24. Агент контроля уровня топлива по фото

**Триггеры**: При выдаче/приемке, фото приборки

**Функции**:
- Определение уровня топлива по фото (OCR/Detector)
- Сравнение с ожидаемым уровнем
- Контроль соблюдения политики "полный-полный бак"

**Действия**:
- OCR цифровых приборок
- Детекция стрелки на аналоговых (угол → процент)
- Сохранение показаний в БД
- Проверка расхождения (порог 5%)
- При расхождении >5%:
  - Блокировка закрытия операции
  - Уведомление сотруднику и руководителю
  - Создание инцидента

**Интеграции**: Telegram, БД, CV (OCR, детекция)

**Политика**: Допустимое расхождение 5%, работа "полный-полный бак"

---

## 25. Агент контроля мойки по фото

**Триггеры**: Подзадача "Мойка" в дневном плане, фото от сотрудника

**Функции**:
- Проверка качества мойки по фото
- Определение чистоты/загрязненности

**Действия**:
- CV-анализ фото (классификация)
- Оценка чистоты (pass/fail)
- Автоматическое закрытие подзадачи при pass
- Запись результата в БД

**Интеграции**: Telegram, БД, CV (классификация)

**Статус**: В разработке

---

## 26. Агент контроля проверок жидкостей по фото

**Триггеры**: Подзадача "Жидкости" в дневном плане, фото от сотрудника

**Функции**:
- Проверка уровня жидкостей по фото (масло, ОЖ, тормозная)
- Детекция меток MIN/MAX

**Действия**:
- CV-анализ фото (детекция меток, определение уровня)
- Оценка по каждому типу жидкости (ok/low/critical)
- Автоматическое закрытие подзадачи при ok
- Эскалация при low/critical
- Запись результатов в БД

**Интеграции**: Telegram, БД, CV (детекция, OCR)

**Статус**: В разработке

---

## 27. Агент контроля сообщений о проблемах из чатов

**Триггеры**: Новое сообщение в теме авто филиала/HQ

**Функции**:
- Классификация сообщений (поломка/инцидент/вопрос/прочее)
- Извлечение сущностей (авто, узел, срочность)
- Использование словаря сленга для понимания

**Действия**:
- Классификация сообщения (LLM + словарь)
- Создание задачи в YouGile/внутренний реестр
- Определение срочности и ответственного
- Уведомление ответственного сотрудника
- Пересылка в главную тему авто (HQ)
- Корреляция с бронями/операциями

**Интеграции**: Telegram, БД, LLM, YouGile API, Словарь сленга

**Примечание**: Обучение на размеченных кейсах, расширяемый словарь

---

## 28. Агент контроля техобслуживания

**Триггеры**: Cron, изменение пробега, событие о пробеге от Starline

**Функции**:
- Контроль прохождения техобслуживания (не государственное ТО)
- Расчет дат обслуживания по пробегу/времени
- Учет будущих броней

**Действия**:
- Расчет следующего ТО (по пробегу и времени)
- Предложение свободных окон для ТО
- Напоминание в тему авто
- Уведомление ответственному

**Интеграции**: БД, Starline, Telegram

---

## 29. Агент контроля отдела продаж (от директора)

**Триггеры**: Cron (ежедневные/недельные отчеты)

**Функции**:
- Мониторинг KPI отдела продаж
- Контроль качества работы

**KPI**:
- SLA по ответам клиентам
- Конверсия по этапам воронки
- Продажи страховок и доп. оборудования
- Неудачные звонки, просроченные задачи

**Действия**:
- Генерация ежедневных/недельных отчетов директору
- Автоматическое создание задач при провалах
- Эскалация критичных проблем

**Интеграции**: AmoCRM, Umnico, RentProg, Telegram

---

## 30. Агент контроля отдела маркетинга (от директора)

**Триггеры**: Cron (ежедневные/недельные отчеты)

**Функции**:
- Мониторинг эффективности маркетинга
- Контроль источников лидов

**KPI**:
- Стоимость лида (CPL)
- Стоимость брони (CPA)
- Источники лидов
- Доля органики
- Скорость реакции на лиды

**Действия**:
- Генерация отчетов директору
- Алерты о провалах каналов/кампаний
- Рекомендации по оптимизации

**Интеграции**: Roistat, Umnico, AmoCRM, Telegram

---

## 31. Агент контроля кассовых операций

**Триггеры**: Cron, события о кассовых операциях

**Функции**:
- Контроль всех кассовых операций
- Сверка между RentProg, Stripe, кассовым учетом
- Контроль закрытия смен
- Выявление кассовых разрывов

**Действия**:
- Сверка операций между системами
- Выявление расхождений
- Уведомление при превышении порогов
- Отчет о кассовых операциях

**Интеграции**: RentProg API, Stripe API, БД, Telegram

**Отличие от агента инкассатора**: Контроль всех операций, не только инкассации

---

## 32. Агент генератор дневного плана

**Триггеры**: Cron (утром, перед началом дня)

**Функции**:
- Генерация плана на день по каждому филиалу
- Учет всех операций, задач, событий

**Структура плана** (кнопки по хронологии):
- Выдачи (время → авто → ответственный)
  - Подзадачи: Мойка, Заправка, Жидкости, Комплектация, Выдача
- Приемки (время → авто → ответственный)
  - Подзадачи: Фото кузова, Фото приборки, Жидкости, Комплектация, Закрытие в RentProg
- Перегоны (сервис, между филиалами)

**Действия**:
- Создание закрепленного сообщения в теме филиала
- Интерактивные кнопки с подзадачами
- Автоматическое обновление статусов при выполнении
- Отметка времени выполнения и исполнителя

**Интеграции**: Telegram, БД, RentProg API

**Примечание**: Кнопки toggle статусов подзадач, обновление сообщения без спама

---

## 33. Агент мониторинга систем (Health Check)

**Триггеры**: Cron (регулярные проверки), события от системы

**Функции**:
- Проверка работоспособности всех модулей и систем
- Мониторинг интеграций
- Проверка доступности внешних API
- Контроль очередей и БД

**Проверяемые компоненты**:
- Webhooks (RentProg, Umnico, Stripe)
- Интеграции (RentProg, Umnico, AmoCRM, Stripe, Starline, YouGile)
- База данных (подключение, миграции)
- Очереди задач
- Объектное хранилище
- Токены доступа (срок действия)

**Действия**:
- Регулярные синтетические проверки
- Генерация дашборда состояния системы
- Уведомления директору о проблемах (L1/L2)
- Автоматические рестарты при возможности
- Логирование всех проверок

**Интеграции**: Все системы, Telegram, Sentry, Healthchecks

---

## Приоритеты разработки

### MVP (Первая фаза)
1. Оркестратор (базовая версия)
2. Базовый Telegram-бот
3. Агент по темам авто
4. Агент контролер броней
5. Агент помощник по выдаче (базовая версия)
6. Агент помощник по приемке (базовая версия)
7. Агент генератор дневного плана
8. Интеграция с RentProg (API + Webhooks)

### Вторая фаза
9. Агент клиентских чатов (Umnico bridge)
10. Агент инкассатор
11. Агент контроля проведения в RentProg
12. Агент служебных поездок (Starline)
13. Агент контроля ТО (Greenway)
14. Агент контроля уровня топлива по фото

### Третья фаза
15. Агент контроля повреждений по фото
16. Агент контроля мойки по фото
17. Агент контроля жидкостей по фото
18. Агент контроля сообщений о проблемах
19. Агент контроля кассовых операций
20. Интеграции (AmoCRM, YouGile, Stripe, Roistat)

### Четвертая фаза
21. Остальные агенты контроля
22. 3D-карта повреждений (будущее)
23. Оптимизация и доработки

