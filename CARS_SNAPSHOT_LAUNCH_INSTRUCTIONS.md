# 🚀 Запуск импорта автомобилей из RentProg

**Статус:** ✅ ВСЁ ГОТОВО К ЗАПУСКУ

---

## ✅ Подготовка завершена

Все проверки пройдены успешно:

- ✅ Workflow **"RentProg Cars Snapshot"** найден в n8n
- ✅ Миграция БД выполнена (поле `data` добавлено)
- ✅ Все 4 филиала настроены в БД
- ✅ Токены филиалов загружены в код workflow

---

## 🎯 ШАГ 1: Запустите workflow

### Откройте ссылку:

```
https://n8n.rentflow.rentals/workflow/j7UEBJvTzjhHrzR4
```

### В интерфейсе n8n:

1. Найдите кнопку **"Execute Workflow"** ▶️ (правый верхний угол)
2. Или кнопку **"Test workflow"**
3. Нажмите на неё

### Что произойдёт:

```
⏱️  Время выполнения: 5-15 минут

Процесс:
1️⃣  Подготовка 4 филиалов (tbilisi, batumi, kutaisi, service-center)
2️⃣  Для каждого филиала:
    • Получение токена доступа
    • Пагинация страниц (по 20 машин)
    • Преобразование данных
    • Сохранение в БД (cars + external_refs)
3️⃣  Финальный отчет

Результат:
🚗 ~125 автомобилей из всех 4 филиалов будут импортированы
```

---

## 🔍 ШАГ 2: Проверьте результаты

### Во время выполнения:

Наблюдайте за логами в n8n UI - каждая нода будет показывать прогресс.

### После завершения:

#### Вариант 1: Через скрипт (быстро)

```bash
node setup/check_cars_import_results.mjs
```

Покажет:
- Общее количество машин
- По филиалам
- Примеры данных
- Статистику

#### Вариант 2: Через SQL (детально)

```sql
-- Всего автомобилей
SELECT COUNT(*) as total_cars FROM cars;

-- По филиалам
SELECT 
  b.code as branch,
  COUNT(c.id) as cars_count
FROM cars c
LEFT JOIN branches b ON c.branch_id = b.id
GROUP BY b.code
ORDER BY cars_count DESC;

-- Примеры с данными
SELECT 
  plate,
  model,
  data->>'car_name' as rentprog_name,
  data->>'id' as rentprog_id,
  created_at
FROM cars
LIMIT 5;
```

#### Вариант 3: Через n8n UI

```
https://n8n.rentflow.rentals/workflow/j7UEBJvTzjhHrzR4/executions
```

Найдите последнее выполнение и посмотрите:
- Ноду **"Final Report"** - там будет итоговая статистика
- Ноду **"Branch Summary"** - отчет по каждому филиалу

---

## 📊 Ожидаемый результат

### Финальный отчет в n8n:

```
═══════════════════════════════════
🎉 ИМПОРТ ЗАВЕРШЕН
═══════════════════════════════════
📊 Всего обработано филиалов: 4
🚗 Всего автомобилей: 125

Детали по филиалам:
  - tbilisi: 45 автомобилей
  - batumi: 32 автомобилей
  - kutaisi: 28 автомобилей
  - service-center: 20 автомобилей
═══════════════════════════════════
```

### В БД:

- Таблица `cars`: все автомобили с полными данными
- Таблица `external_refs`: связи с RentProg ID
- Поле `data` (JSONB): весь JSON от RentProg

---

## ⚠️ Если возникли ошибки

### 401 Unauthorized
**Причина:** Неверный токен филиала  
**Решение:** Обновите токены в коде workflow

### Timeout / Connection Error
**Причина:** Проблемы с сетью или RentProg API  
**Решение:** Подождите 5-10 минут и запустите снова

### Database Error
**Причина:** Проблемы с подключением к БД  
**Решение:** Проверьте credentials PostgreSQL в n8n

### Workflow зависает
**Причина:** Большое количество данных  
**Решение:** Подождите - пагинация может занять время

---

## 🔄 Повторный запуск

Workflow можно запускать многократно:

- ✅ Существующие записи будут **обновлены**
- ✅ Новые машины будут **добавлены**
- ✅ Дубликаты **НЕ создаются** (благодаря ON CONFLICT)

---

## 💾 Структура данных

### Таблица `cars`:

| Поле | Описание |
|------|----------|
| id | UUID (наш первичный ключ) |
| branch_id | Связь с филиалом |
| plate | Госномер |
| vin | VIN код |
| model | Модель |
| starline_id | ID в Starline |
| **data** | **Полный JSON из RentProg** |

### Таблица `external_refs`:

| Поле | Значение |
|------|----------|
| entity_type | 'car' |
| entity_id | UUID из cars |
| system | 'rentprog' |
| external_id | ID машины в RentProg |
| branch_code | Код филиала |

---

## 📚 Дополнительно

### Документация:
- `CARS_SNAPSHOT_READY_TO_RUN.md` - Полная инструкция
- `n8n-workflows/CARS_SNAPSHOT_README.md` - Краткая справка
- `docs/RENTPROG_CARS_SNAPSHOT_GUIDE.md` - Детальное руководство

### Скрипты:
- `node setup/check_cars_import_results.mjs` - Проверка результатов
- `node setup/check_branches.mjs` - Проверка филиалов
- `node setup/migrations/run_001_migration.mjs` - Миграция БД

---

## 🎯 ДЕЙСТВИЕ

### 👉 ЗАПУСТИТЕ СЕЙЧАС:

```
https://n8n.rentflow.rentals/workflow/j7UEBJvTzjhHrzR4
```

**Нажмите "Execute Workflow" ▶️**

---

**Время выполнения:** 5-15 минут  
**Результат:** ~125 автомобилей из 4 филиалов в вашей БД  
**Безопасность:** Повторный запуск не создаст дубликатов ✅

