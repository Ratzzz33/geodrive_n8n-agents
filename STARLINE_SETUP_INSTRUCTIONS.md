# Starline GPS Monitor - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø—É—Å–∫—É

**–î–∞—Ç–∞:** 2025-11-08  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É

---

## üìã –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

‚úÖ **HTTP –∫–ª–∏–µ–Ω—Ç** –¥–ª—è Starline API (`src/integrations/starline-client.ts`)  
‚úÖ **SQL –º–∏–≥—Ä–∞—Ü–∏—è** –¥–ª—è —Ç–∞–±–ª–∏—Ü gps_tracking –∏ gps_tracking_history  
‚úÖ **–°–µ—Ä–≤–∏—Å —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è** –º–∞—à–∏–Ω –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é + 3 —Ü–∏—Ñ—Ä–∞–º –Ω–æ–º–µ—Ä–∞  
‚úÖ **API endpoints** –≤ Jarvis API (`/starline/update-gps`, `/starline/match-cars`)  
‚úÖ **n8n Workflow** –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É  
‚úÖ **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** –∏ –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è  

---

## üöÄ –®–∞–≥–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞

### 1. –û–±–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

SSH –Ω–∞ —Å–µ—Ä–≤–µ—Ä:
```bash
ssh root@46.224.17.15
cd /root/geodrive_n8n-agents
```

–î–æ–±–∞–≤–∏—Ç—å –≤ `.env`:
```bash
# Starline GPS –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
STARLINE_COOKIES=userAgentId=e2bfd67ca307f71034d05bf8158d9fb3; lang=ru
STARLINE_USER_AGENT=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36
```

**–í–∞–∂–Ω–æ:** Cookies —É–∂–µ –ø–æ–ª—É—á–µ–Ω—ã –∏–∑ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏!

---

### 2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
psql postgresql://neondb_owner:npg_cHIT9Kxfk1Am@ep-rough-heart-ahnybmq0-pooler.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require \
  -f drizzle/migrations/0012_gps_tracking.sql
```

–ò–ª–∏ —á–µ—Ä–µ–∑ –ª–æ–∫–∞–ª—å–Ω—ã–π Neon Console:
1. –û—Ç–∫—Ä–æ–π—Ç–µ https://console.neon.tech/app/projects/rough-heart-ahnybmq0/sql
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ `drizzle/migrations/0012_gps_tracking.sql`
3. –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL

---

### 3. –°–æ–±—Ä–∞—Ç—å –∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç—å –∫–æ–¥

```bash
# –ò–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã
cd C:\Users\33pok\geodrive_n8n-agents
python deploy_fixes_now.py
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
```bash
cd /root/geodrive_n8n-agents
git pull
npm run build
docker compose restart jarvis-api
```

---

### 4. –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å n8n Workflow

**–ú–µ—Ç–æ–¥ 1: –ß–µ—Ä–µ–∑ UI (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**

1. –û—Ç–∫—Ä–æ–π—Ç–µ https://n8n.rentflow.rentals
2. Workflows ‚Üí Import from File
3. –í—ã–±–µ—Ä–∏—Ç–µ `n8n-workflows/starline-gps-monitor.json`
4. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ workflow

**–ú–µ—Ç–æ–¥ 2: –ß–µ—Ä–µ–∑ n8n MCP (–∏–∑ Cursor)**

```bash
# –í Cursor Agent Mode
mcp_n8n_n8n_create_workflow(...)
```

---

### 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ API

```bash
# –¢–µ—Å—Ç —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –º–∞—à–∏–Ω
curl http://46.224.17.15:3000/starline/match-cars

# –û–∂–∏–¥–∞–µ—Ç—Å—è:
# {
#   "ok": true,
#   "matches": [...],
#   "count": 25
# }
```

#### –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è GPS

```bash
curl -X POST http://46.224.17.15:3000/starline/update-gps

# –û–∂–∏–¥–∞–µ—Ç—Å—è:
# {
#   "ok": true,
#   "updated": 25,
#   "errors": []
# }
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î

```sql
-- –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ Neon DB
-- https://console.neon.tech/app/projects/rough-heart-ahnybmq0/sql

SELECT 
  c.brand,
  c.model,
  c.license_plate,
  g.status,
  g.is_moving,
  g.current_lat,
  g.current_lng,
  g.last_sync
FROM gps_tracking g
JOIN cars c ON c.id = g.car_id
ORDER BY g.last_sync DESC
LIMIT 10;
```

---

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –º–∞—à–∏–Ω

–î–æ–ª–∂–Ω—ã —Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å—Å—è –º–∞—à–∏–Ω—ã –≤–∏–¥–∞:

| Starline Alias | License Plate | Brand | Model |
|----------------|---------------|-------|-------|
| BMW 3 587 | WW587UU | BMW | 3 |
| Audi Q7 White XX950DX | XX950DX | Audi | Q7 |
| Tiguan 18 299 | WW299UU | VW | Tiguan |

### –°—Ç–∞—Ç—É—Å—ã GPS

–ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –∑–∞–ø–∏—Å–∏:

```
‚úÖ BMW 3 587: parked_off üÖøÔ∏è (—Å—Ç–æ–∏—Ç) 0m
‚úÖ Audi Q7 White: moving üöó (–¥–≤–∏–∂–µ—Ç—Å—è) 120m
‚úÖ Tiguan 18 299: gps_offline ‚ö†Ô∏è (GPS –æ—Ç–∫–ª—é—á–µ–Ω) 0m
```

---

## üîß Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: Cookies —É—Å—Ç–∞—Ä–µ–ª–∏

**–°–∏–º–ø—Ç–æ–º—ã:**
```
‚ùå Starline API error: 401 Unauthorized
```

**–†–µ—à–µ–Ω–∏–µ:**

1. –ó–∞–Ω–æ–≤–æ –ø–æ–ª—É—á–∏—Ç–µ cookies —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä:
   - –û—Ç–∫—Ä–æ–π—Ç–µ https://starline-online.ru/
   - –ó–∞–ª–æ–≥–∏–Ω—å—Ç–µ—Å—å (YtZvrNYWR / 7733Alex)
   - F12 ‚Üí Application ‚Üí Cookies ‚Üí userAgentId

2. –û–±–Ω–æ–≤–∏—Ç–µ –≤ `.env`:
```bash
STARLINE_COOKIES=userAgentId=–ù–û–í–û–ï_–ó–ù–ê–ß–ï–ù–ò–ï; lang=ru
```

3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ:
```bash
docker compose restart jarvis-api
```

---

### –ü—Ä–æ–±–ª–µ–º–∞: –ú–∞—à–∏–Ω—ã –Ω–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–∞—à–∏–Ω—ã –≤ Starline
curl http://46.224.17.15:3000/starline/match-cars

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–∞—à–∏–Ω—ã –≤ –ë–î
psql $DATABASE_URL -c "SELECT id, brand, model, license_plate FROM cars WHERE license_plate IS NOT NULL"
```

**–ü—Ä–∏—á–∏–Ω—ã:**
- –í Starline alias –Ω–µ—Ç 3 —Ü–∏—Ñ—Ä –Ω–æ–º–µ—Ä–∞
- –í –ë–î license_plate –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω
- –ù–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π

**–†–µ—à–µ–Ω–∏–µ:** –û–±–Ω–æ–≤–∏—Ç–µ –∞–ª–∏–∞—Å –≤ Starline –∏–ª–∏ license_plate –≤ –ë–î

---

### –ü—Ä–æ–±–ª–µ–º–∞: Workflow –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**

1. –û—Ç–∫—Ä–æ–π—Ç–µ https://n8n.rentflow.rentals
2. –ù–∞–π–¥–∏—Ç–µ "Starline GPS Monitor"
3. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ Active = true
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Executions ‚Üí –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É

**–ï—Å–ª–∏ –Ω–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–π:**

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Schedule Trigger (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–∞–∂–¥—É—é 1 –º–∏–Ω—É—Ç—É)
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ n8n:
```bash
docker logs n8n --tail 100 -f
```

---

## üì± Telegram –∞–ª–µ—Ä—Ç—ã

–ê–ª–µ—Ä—Ç—ã –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –≤ —á–∞—Ç **ID: `-5004140602`** –ø—Ä–∏:

‚ö†Ô∏è **–ß–∞—Å—Ç–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏** (–Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –º–∞—à–∏–Ω—ã –Ω–µ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å):
```
‚ö†Ô∏è Starline GPS Monitor: –æ—à–∏–±–∫–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏

üìä –û–±–Ω–æ–≤–ª–µ–Ω–æ: 23
‚ùå –û—à–∏–±–æ–∫: 2

–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è BMW 3 587: Timeout
–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Audi Q7: GPS offline
```

‚ùå **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞** (–≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å —É–ø–∞–ª):
```
‚ùå Starline GPS Monitor: –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞

STARLINE_COOKIES not configured in .env
```

---

## üìà –î–∞–ª—å–Ω–µ–π—à–∏–µ –¥–µ–π—Å—Ç–≤–∏—è

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –º–æ–∂–Ω–æ:

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é GPS:**
```sql
SELECT * FROM gps_tracking_history 
ORDER BY tracked_at DESC 
LIMIT 100;
```

2. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å Dashboard** (Grafana/Superset) –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç—Ä–µ–∫–æ–≤

3. **–î–æ–±–∞–≤–∏—Ç—å –∞–ª–µ—Ä—Ç—ã:**
   - GPS –æ—Ç–∫–ª—é—á–µ–Ω –±–æ–ª—å—à–µ 30 –º–∏–Ω—É—Ç
   - –ù–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–æ–µ–∑–¥–∫–∞ (–±–µ–∑ –±—Ä–æ–Ω–∏)
   - –ú–∞—à–∏–Ω–∞ –≤—ã—à–ª–∞ –∏–∑ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω–æ–π –≥–µ–æ–∑–æ–Ω—ã

4. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å RentProg:**
   - –°–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–∏—Ö –ø–æ–µ–∑–¥–æ–∫ —Å –±—Ä–æ–Ω—è–º–∏
   - –ê–ª–µ—Ä—Ç –µ—Å–ª–∏ –º–∞—à–∏–Ω–∞ –µ–¥–µ—Ç –±–µ–∑ –∞–∫—Ç–∏–≤–Ω–æ–π –±—Ä–æ–Ω–∏

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** [STARLINE_GPS_MONITOR.md](./STARLINE_GPS_MONITOR.md)
- **API Reference:** –°–º. endpoints –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- **SQL –ü—Ä–∏–º–µ—Ä—ã:** –°–º. —Ä–∞–∑–¥–µ–ª "SQL –ó–∞–ø—Ä–æ—Å—ã" –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –∑–∞–ø—É—Å–∫–∞

- [ ] –û–±–Ω–æ–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (`.env`)
- [ ] –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –ë–î (`0012_gps_tracking.sql`)
- [ ] –ö–æ–¥ —Å–æ–±—Ä–∞–Ω –∏ –∑–∞–¥–µ–ø–ª–æ–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä
- [ ] n8n Workflow –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –º–∞—à–∏–Ω (`/starline/match-cars`)
- [ ] –í—ã–ø–æ–ª–Ω–µ–Ω –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ (`/starline/update-gps`)
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –≤ –ë–î (—Ç–∞–±–ª–∏—Ü–∞ `gps_tracking`)
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –ª–æ–≥–∏ Jarvis API (–Ω–µ—Ç –æ—à–∏–±–æ–∫)
- [ ] Telegram –∞–ª–µ—Ä—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã

---

**–í—Å–µ –≥–æ—Ç–æ–≤–æ! üöÄ**

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤ —Å–∏—Å—Ç–µ–º–∞ –Ω–∞—á–Ω–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å GPS –¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É.

–°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 1 –º–∏–Ω—É—Ç—É –ø–æ—Å–ª–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ workflow.

