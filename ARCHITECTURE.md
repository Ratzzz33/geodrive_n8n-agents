# Архитектура системы "Jarvis - Telegram Бот для управления автопрокатом"

## Общее описание

Единая система управления автопрокатом Geodrive через Telegram-бот "Jarvis", который работает как персональный помощник для каждого сотрудника. Система состоит из оркестратора и множества узкоспециализированных агентов, выполняющих конкретные функции автоматизации и контроля.

## Компоненты системы

### 1. Telegram-бот "Jarvis" (Gateway + UI)
- Единый интерфейс для всех сотрудников
- Управление группами и темами в Telegram
- Интерактивные кнопки и формы для чек-листов
- Система эскалации задач по иерархии

### 2. Оркестратор (Router + Scheduler)
- Прием и классификация событий (webhooks, сообщения, cron)
- Распределение задач между агентами
- Планирование периодических проверок
- Координация работы нескольких агентов для комплексных задач

### 3. Агенты (Microservices/Workers)
- Независимые модули, каждый отвечает за узкую функцию
- Вызываются оркестратором по необходимости
- Используют LLM tools для обработки данных
- Взаимодействуют с внешними API и БД

### 4. База данных (PostgreSQL/Neon)
- Хранение всех бизнес-данных
- Нормализованная схема данных
- Outbox-паттерн для событий
- Поддержка миграций

### 5. Объектное хранилище (GCS/S3)
- Медиафайлы (фото, видео)
- Результаты CV-обработки (маски, оверлеи)
- Подписанные URL для безопасного доступа

### 6. Интеграции
- RentProg (API + Webhooks)
- Umnico (WA/TG клиентов)
- AmoCRM
- Starline (браузерная автоматизация)
- Stripe
- YouGile
- Roistat
- Greenway.ge (парсинг для ТО)

## Структура Telegram-чатов

### Рабочие форумы филиалов
- Название: `Branch_<name> (forum)`
- Темы: по автомобилям (создаются/удаляются ботом при перемещении)
- Участники: сотрудники филиала
- Модерация: бот удаляет попытки публикации медиа от пользователей

### Архивные чаты (read-only)
- Отдельные чаты для публикаций ботом
- Участники только читают
- Хранилище материалов по автомобилям

### Служебные чаты
- Руководители
- Маркетинг
- Продажи

### Персональные группы сотрудников
- Группа сотрудника + бот
- Темы по клиентам (название: `<Client Name> | <Car>`)
- Переводчик сообщений клиентов
- Эскалация неотвеченных сообщений

## Потоки данных

### Входящие события
1. Webhooks (RentProg, Umnico, Stripe)
2. Сообщения в Telegram
3. Cron-задачи (периодические проверки)
4. Результаты браузерной автоматизации (Starline, Greenway)

### Обработка
1. Оркестратор получает событие
2. Классификация и определение нужных агентов
3. Вызов агентов (последовательно или параллельно)
4. Агрегация результатов
5. Публикация в нужные каналы

### Исходящие действия
1. Сообщения в Telegram (темы, личные, группы)
2. Задачи в YouGile/AmoCRM
3. Записи в БД
4. API-вызовы во внешние системы

## Безопасность

- Хранение секретов в Vault/SSM
- Подписи webhooks
- ACL по ролям сотрудников
- Аудит-лог всех действий
- Idempotency для критичных операций

## Технологический стек

- **Backend**: TypeScript (Node.js)
- **Telegram**: Telegraf (Bot API)
- **Браузерная автоматизация**: Playwright
- **LLM**: OpenAI/Anthropic с function calling
- **БД**: PostgreSQL (Neon) + Drizzle ORM
- **Очереди**: Redis Streams (на старте - воркеры)
- **Хранилище**: GCS/S3/MinIO
- **Мониторинг**: Healthchecks, Sentry
- **CV/ML**: YOLOv8/YOLOv9, SAM2, OCR (Tesseract)

## Масштабирование

На старте: монолитное приложение с модульной структурой
При росте: микросервисы, Redis Streams для очередей, горизонтальное масштабирование воркеров

