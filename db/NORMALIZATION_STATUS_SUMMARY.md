# –°—Ç–∞—Ç—É—Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î - –ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞

**–î–∞—Ç–∞:** 2025-01-XX  
**–í–µ—Ç–∫–∞:** `ep-curly-sunset`  
**–°—Ç–∞—Ç—É—Å:** üîÑ –í –ø—Ä–æ—Ü–µ—Å—Å–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

---

## üìã –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞–¥–∏—è –∑–∞–¥–∞—á–∏

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (–∏–∑ `NORMALIZATION_COMPLETION_CRITERIA.md`):

1. ‚úÖ **–í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –Ω–∞ –≤–µ—Ç–∫–µ** - —á–∞—Å—Ç–∏—á–Ω–æ (014-016 –≥–æ—Ç–æ–≤—ã, –Ω—É–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å)
2. ‚úÖ **–í—Å–µ –≤–Ω–µ—à–Ω–∏–µ ID –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤ `external_refs`** - –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ
3. ‚úÖ **–í—Å–µ alias-–∫–æ–ª–æ–Ω–∫–∏ —É–¥–∞–ª–µ–Ω—ã** - —á–∞—Å—Ç–∏—á–Ω–æ (payments –≥–æ—Ç–æ–≤–æ, tasks –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ)
4. ‚úÖ **–í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ FK –¥–æ–±–∞–≤–ª–µ–Ω—ã** - –≤—ã–ø–æ–ª–Ω–µ–Ω–æ
5. ‚è≥ **–û—Ç—á—ë—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã** - —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
6. ‚è≥ **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞** - –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ

---

## ‚úÖ –ß—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ

### –ú–∏–≥—Ä–∞—Ü–∏–∏ (–≥–æ—Ç–æ–≤—ã –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é):
- [x] `007_add_starline_branch_foreign_keys.sql` - FK –¥–ª—è Starline
- [x] `008_add_gps_starline_event_fks.sql` - FK –¥–ª—è GPS/events
- [x] `009_index_external_refs_entity_idx.sql` - –ò–Ω–¥–µ–∫—Å external_refs
- [x] `010_drop_unused_user_id_columns.sql` - –£–¥–∞–ª–µ–Ω–∏–µ –ø—É—Å—Ç—ã—Ö user_id
- [x] `011_add_tasks_and_entity_timeline_fks.sql` - FK –¥–ª—è tasks/timeline
- [x] `012_seed_external_refs_from_aliases.sql` - –ü–µ—Ä–µ–Ω–æ—Å alias –∏–∑ payments
- [x] `013_remove_payments_alias_columns.sql` - –£–¥–∞–ª–µ–Ω–∏–µ alias –∏–∑ payments
- [x] `014_seed_external_refs_from_tasks_telegram.sql` - –ü–µ—Ä–µ–Ω–æ—Å Telegram ID –∏–∑ tasks (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞)
- [x] `015_remove_tasks_telegram_columns.sql` - –£–¥–∞–ª–µ–Ω–∏–µ Telegram –∫–æ–ª–æ–Ω–æ–∫ –∏–∑ tasks
- [x] `016_seed_external_refs_from_payments_rp.sql` - –ü–µ—Ä–µ–Ω–æ—Å rp_* –∏–∑ payments (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞)

### –°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
- ‚úÖ –£–¥–∞–ª–µ–Ω—ã alias-–∫–æ–ª–æ–Ω–∫–∏ –∏–∑ `payments` (car_id, client_id, user_id)
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ö–µ–º–∞ TypeScript (`src/db/schema.ts`)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã FK –¥–ª—è Starline, GPS, tasks, entity_timeline
- ‚úÖ –°–æ–∑–¥–∞–Ω –∏–Ω–¥–µ–∫—Å –Ω–∞ `external_refs(entity_type, entity_id)`

### –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:
- ‚úÖ `setup/apply_sql_file.mjs` - –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ SQL –º–∏–≥—Ä–∞—Ü–∏–π
- ‚úÖ `setup/run_sql_query.mjs` - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ `setup/apply_remaining_migrations.mjs` - —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –º–∏–≥—Ä–∞—Ü–∏–π
- ‚úÖ `setup/apply_migrations_sequence.ps1` - PowerShell —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

---

## üîÑ –ß—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –º–∏–≥—Ä–∞—Ü–∏–∏ (014-016)
```powershell
# –ß–µ—Ä–µ–∑ Node.js —Å–∫—Ä–∏–ø—Ç
node setup/apply_remaining_migrations.mjs

# –ò–ª–∏ —á–µ—Ä–µ–∑ PowerShell
.\setup\apply_migrations_sequence.ps1 -DatabaseUrl "postgresql://..."
```

### 2. –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç—á—ë—Ç—ã
```powershell
# –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è
.\setup\run_db_inventory.ps1 -DatabaseUrl "..." -Output db/db_inventory_curly_branch.md

# –ê–Ω–∞–ª–∏–∑ orphan –∫–æ–ª–æ–Ω–æ–∫
.\setup\run_id_analysis.ps1 -DatabaseUrl "..." -Output db/db_id_column_analysis_curly.md

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ external_refs
node setup/query_external_refs_stats.mjs
```

### 3. –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ alias-–∫–æ–ª–æ–Ω–æ–∫
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É `external_refs`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö FK

---

## üéØ –ö–æ–≥–¥–∞ –∑–∞–¥–∞—á–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–π?

**–ó–∞–¥–∞—á–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–π –∫–æ–≥–¥–∞:**

1. ‚úÖ –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (007-016) –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –Ω–∞ –≤–µ—Ç–∫–µ `ep-curly-sunset`
2. ‚úÖ –í—Å–µ –≤–Ω–µ—à–Ω–∏–µ ID –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤ `external_refs` (–ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É)
3. ‚úÖ –í—Å–µ alias-–∫–æ–ª–æ–Ω–∫–∏ —É–¥–∞–ª–µ–Ω—ã (payments, tasks)
4. ‚úÖ –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ FK –¥–æ–±–∞–≤–ª–µ–Ω—ã (Starline, GPS, tasks, timeline)
5. ‚úÖ –û—Ç—á—ë—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å
6. ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (`NORMALIZATION_COMPLETION_CRITERIA.md` —Å –æ—Ç–º–µ—á–µ–Ω–Ω—ã–º–∏ —á–µ–∫–±–æ–∫—Å–∞–º–∏)

**–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ:**
- ‚úÖ –ó–∞–¥–∞—á–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—á–∏—Ç–∞–µ—Ç—Å—è **–∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–π**
- üîÑ –ú–æ–∂–Ω–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ production
- üìö –í–µ—Ç–∫–∞ `ep-curly-sunset` —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —ç—Ç–∞–ª–æ–Ω–æ–º –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–∞–±–æ—Ç—ã

---

## üìä –¢–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å

**–í—ã–ø–æ–ª–Ω–µ–Ω–æ:** ~85%  
**–û—Å—Ç–∞–ª–æ—Å—å:** 
- –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ 014-016
- –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç—á—ë—Ç—ã
- –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 15-30 –º–∏–Ω—É—Ç (–ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π + –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç—á—ë—Ç–æ–≤)

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ 014-016 –Ω–∞ –≤–µ—Ç–∫–µ
2. –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –æ—Ç—á—ë—Ç—ã
3. –í—ã–ø–æ–ª–Ω–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º
4. –û–±–Ω–æ–≤–∏—Ç—å `NORMALIZATION_COMPLETION_CRITERIA.md` —Å –æ—Ç–º–µ—Ç–∫–∞–º–∏
5. –°—á–∏—Ç–∞—Ç—å –∑–∞–¥–∞—á—É –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–π ‚úÖ

