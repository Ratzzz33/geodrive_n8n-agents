# Оркестратор системы

## Назначение

Центральный компонент, который координирует работу всех агентов, классифицирует входящие события и распределяет задачи.

## Основные функции

### 1. Прием событий
- Webhooks от внешних систем (RentProg, Umnico, Stripe)
- Сообщения в Telegram от сотрудников
- Результаты периодических проверок (cron)
- Результаты браузерной автоматизации (Starline, Greenway)

### 2. Классификация
- LLM-классификатор для определения типа события
- Правила (rule-based) для критичных событий
- Определение набора нужных агентов для обработки

### 3. Планирование
- Cron-расписания для периодических проверок
- Приоритизация задач
- Очередь выполнения (последовательно или параллельно)

### 4. Координация агентов
- Вызов нужных агентов
- Агрегация результатов от нескольких агентов
- Обработка ошибок и ретраи

### 5. Публикация результатов
- Отправка уведомлений в нужные Telegram-каналы
- Обновление БД
- Создание задач во внешних системах (YouGile, AmoCRM)

## Типы событий

### События от RentProg (Webhooks → Нормализация → Оркестратор)

События приходят через Netlify Functions, нормализуются в `src/integrations/rentprog-webhook-parser.ts` и передаются в оркестратор:

- `booking.issue.planned` - запланированная выдача авто
- `booking.return.planned` - запланированная приемка авто
- `booking.created` - новая бронь создана
- `booking.updated` - изменение брони
- `booking.issued` - выдача авто выполнена
- `booking.returned` - приемка авто выполнена
- `car.moved` - перемещение авто между филиалами
- `cash.collected` - инкассация

**Формат внутренних событий от RentProg:**

```typescript
{
  type: 'booking.issue.planned' | 'booking.return.planned' | ...,
  timestamp: Date,
  source: 'rentprog',
  payload: {
    rentprog_id: number,        // ID из RentProg
    branch: 'tbilisi' | 'batumi' | 'kutaisi' | 'service-center',
    booking_id?: number,
    car_id?: number,
    client_id?: number,
    raw_event?: string,           // Исходное название события
    raw_action?: string,          // Исходное действие
    // ... другие поля из payload вебхука
  }
}
```

**Обработка вебхуков:**
1. Netlify Function получает вебхук: `/webhooks/rentprog/{branch}?t={secret}`
2. Валидация токена/подписи
3. Быстрый ACK (200 OK) ≤ 100ms
4. Нормализация через `normalizeRentProgWebhook()`
5. Асинхронный вызов `orchestrator.route(event)`
6. Оркестратор маршрутизирует к соответствующим агентам

### События от Umnico
- `message.incoming` - сообщение от клиента
- `message.sent` - сообщение отправлено клиенту

### События от Telegram
- `message.employee` - сообщение от сотрудника боту
- `callback.button` - нажатие кнопки
- `photo.uploaded` - загрузка фото

### Внутренние события
- `check.cash` - проверка инкассации (cron)
- `check.bookings` - проверка броней (cron)
- `check.to` - проверка ТО (cron)
- `check.starline` - проверка поездок Starline (cron)
- `daily.plan.generate` - генерация дневного плана (cron)

## Примеры маршрутизации

### Выдача авто (от RentProg webhook)
1. Webhook от RentProg: `booking_update` с данными о приближающейся выдаче
2. Нормализация: `normalizeRentProgWebhook()` → `booking.issue.planned`
3. Событие передается в оркестратор: `orchestrator.route(event)`
4. Оркестратор вызывает:
   - Агент контролер броней (напоминание ответственному)
   - Агент помощник по выдаче (проверка готовности, чеклист)

### Приемка авто (от RentProg webhook)
1. Webhook от RentProg: `booking_update` с данными о приближающейся приемке
2. Нормализация: `normalizeRentProgWebhook()` → `booking.return.planned`
3. Событие передается в оркестратор: `orchestrator.route(event)`
4. Оркестратор вызывает:
   - Агент контролер броней (напоминание ответственному)
   - Агент помощник по приемке (ожидание материалов, проверка чеклиста)

### Сообщение от клиента
1. Событие: `umnico.message.incoming`
2. Оркестратор вызывает:
   - Агент клиентских чатов (обработка, перевод, публикация в тему)
   - Агент контроля SLA (проверка времени ответа)

### Несанкционированная поездка
1. Событие: `starline.unauthorized.trip`
2. Оркестратор вызывает:
   - Агент служебных поездок (создание инцидента)
   - Публикация в тему авто филиала
   - Уведомление руководителю

## Обработка ошибок

- Retry с экспоненциальной задержкой
- Dead letter queue для неудачных задач
- Логирование всех операций
- Алерты при критичных ошибках

## Мониторинг

- Метрики производительности агентов
- Время отклика системы
- Количество обработанных событий
- Ошибки и их типы

