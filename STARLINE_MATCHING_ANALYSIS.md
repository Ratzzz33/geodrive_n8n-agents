# –ê–Ω–∞–ª–∏–∑ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è Starline —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å –º–∞—à–∏–Ω–∞–º–∏

**–î–∞—Ç–∞:** 2025-11-12  
**Workflow:** https://n8n.rentflow.rentals/workflow/Nc5GFhh5Ikhv1ivK  
**–§–∞–π–ª:** `src/services/starline-monitor.ts`

---

## üî¥ –ü–†–û–ë–õ–ï–ú–ê

–í –º–µ—Ç–æ–¥–µ `matchCars()` (—Å—Ç—Ä–æ–∫–∏ 101-184) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è**:

### –¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞ (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û):
1. –ü–æ–ª—É—á–∞–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–∑ Starline API
2. –ò–∑–≤–ª–µ–∫–∞–µ—Ç –º–æ–¥–µ–ª—å –∏ —Ü–∏—Ñ—Ä—ã –∏–∑ **alias** (–Ω–∞–∑–≤–∞–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞)
3. –ò—â–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ —Ç–∞–±–ª–∏—Ü–µ `cars` –ø–æ –º–æ–¥–µ–ª–∏ –∏ —Ü–∏—Ñ—Ä–∞–º –Ω–æ–º–µ—Ä–∞
4. **–ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É `starline_devices`**, –≥–¥–µ —É–∂–µ –µ—Å—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –ø–æ `device_id`

### –ü—Ä–æ–±–ª–µ–º—ã:
- ‚ùå –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **alias** –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è (alias –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å—Å—è!)
- ‚ùå –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É `starline_devices` —Å –≥–æ—Ç–æ–≤—ã–º–∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è–º–∏
- ‚ùå –ú–æ–∂–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å, –µ—Å–ª–∏ alias –∏–∑–º–µ–Ω–∏–ª—Å—è
- ‚ùå –ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç —Ä—É—á–Ω—ã–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∏–∑ –ë–î

---

## ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê

**–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è:** —Ç–∞–±–ª–∏—Ü–∞ `starline_devices` –ø–æ –ø–æ–ª—é `device_id`

### –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞:
1. –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–∑ Starline API (–¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–∞–π—Ç–∏ –µ–≥–æ –≤ —Ç–∞–±–ª–∏—Ü–µ `starline_devices` –ø–æ `device_id` (–Ω–µ –ø–æ alias!)
3. –ï—Å–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–æ –∏ `matched = TRUE`, –≤–∑—è—Ç—å `car_id` –æ—Ç—Ç—É–¥–∞
4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è GPS –¥–∞–Ω–Ω—ã—Ö –≤ `gps_tracking`

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **device_id** (–Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä)
- ‚úÖ –£—á–∏—Ç—ã–≤–∞–µ—Ç —Ä—É—á–Ω—ã–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∏–∑ –ë–î
- ‚úÖ –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π alias
- ‚úÖ –û–¥–Ω–∞ –º–∞—à–∏–Ω–∞ - –æ–¥–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (–ø—Ä–∞–≤–∏–ª–æ —Å–æ–±–ª—é–¥–∞–µ—Ç—Å—è)

---

## üìã –¢–ï–ö–£–©–ò–ô –ö–û–î

### –ú–µ—Ç–æ–¥ `matchCars()` (—Å—Ç—Ä–æ–∫–∏ 101-184):

```typescript
async matchCars(): Promise<CarMatch[]> {
  // –ü–æ–ª—É—á–∞–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–∑ Starline
  const devices = await scraper.getDevices();
  
  // –ü–æ–ª—É—á–∞–µ—Ç –º–∞—à–∏–Ω—ã –∏–∑ –ë–î
  const cars = await sqlConnection`SELECT ... FROM cars ...`;
  
  // ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –°–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ alias, –∞ –Ω–µ –ø–æ device_id –∏–∑ starline_devices
  for (const device of devices) {
    const { model, digits } = this.extractModelFromAlias(device.alias);
    
    // –ò—â–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ cars –ø–æ –º–æ–¥–µ–ª–∏ –∏ —Ü–∏—Ñ—Ä–∞–º
    let matchedCar = cars.find(car => {
      const carDigits = this.extractLast3Digits(car.plate);
      // ... —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ alias ...
    });
  }
}
```

### –ú–µ—Ç–æ–¥ `processDevice()` (—Å—Ç—Ä–æ–∫–∏ 285-463):

```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç device_id –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π
deviceDetails = await scraper.getDeviceDetails(match.starlineDeviceId);

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç device_id –≤ gps_tracking
INSERT INTO gps_tracking (
  car_id, starline_device_id, starline_alias, ...
) VALUES (
  ${gpsUpdate.carId}, ${gpsUpdate.starlineDeviceId}, ${gpsUpdate.starlineAlias}, ...
)
```

---

## üîß –ß–¢–û –ù–£–ñ–ù–û –ò–°–ü–†–ê–í–ò–¢–¨

### –ò–∑–º–µ–Ω–∏—Ç—å –º–µ—Ç–æ–¥ `matchCars()`:

**–ë—ã–ª–æ:**
```typescript
async matchCars(): Promise<CarMatch[]> {
  // –ü–æ–ª—É—á–∞–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–∑ Starline
  const devices = await scraper.getDevices();
  
  // –ü–æ–ª—É—á–∞–µ—Ç –º–∞—à–∏–Ω—ã –∏–∑ –ë–î
  const cars = await sqlConnection`SELECT ... FROM cars ...`;
  
  // ‚ùå –°–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ alias
  for (const device of devices) {
    // ... —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ alias ...
  }
}
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
```typescript
async matchCars(): Promise<CarMatch[]> {
  // –ü–æ–ª—É—á–∞–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–∑ Starline (–¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
  const devices = await scraper.getDevices();
  
  // ‚úÖ –ü–æ–ª—É—á–∞–µ—Ç —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∏–∑ starline_devices –ø–æ device_id
  const sqlConnection = getSqlConnection();
  const deviceMappings = await sqlConnection`
    SELECT 
      sd.device_id,
      sd.alias,
      sd.car_id,
      sd.matched,
      c.plate,
      c.car_visual_name as brand,
      c.model
    FROM starline_devices sd
    JOIN cars c ON c.id = sd.car_id
    WHERE sd.matched = TRUE
      AND sd.active = TRUE
  `;
  
  // ‚úÖ –°–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ device_id
  const matches: CarMatch[] = [];
  for (const device of devices) {
    const mapping = deviceMappings.find(m => m.device_id === device.device_id);
    
    if (mapping && mapping.matched) {
      matches.push({
        carId: mapping.car_id,
        plate: mapping.plate,
        brand: mapping.brand,
        model: mapping.model,
        starlineDeviceId: device.device_id,  // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º device_id
        starlineAlias: device.alias  // –¢–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      });
    }
  }
  
  return matches;
}
```

---

## üìä –°–¢–†–£–ö–¢–£–†–ê –î–ê–ù–ù–´–•

### –¢–∞–±–ª–∏—Ü–∞ `starline_devices`:
- `device_id` (BIGINT, UNIQUE) - **—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä**
- `alias` (TEXT) - –Ω–∞–∑–≤–∞–Ω–∏–µ (–º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å—Å—è)
- `car_id` (UUID) - —Å–≤—è–∑—å —Å –º–∞—à–∏–Ω–æ–π
- `matched` (BOOLEAN) - —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –ª–∏

### –¢–∞–±–ª–∏—Ü–∞ `gps_tracking`:
- `car_id` (UUID) - —Å–≤—è–∑—å —Å –º–∞—à–∏–Ω–æ–π
- `starline_device_id` (BIGINT) - **–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è**
- `starline_alias` (TEXT) - —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

---

## ‚úÖ –ü–†–ê–í–ò–õ–ê

1. **–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è:** `starline_devices.device_id`
2. **–ö cars –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ Device ID**, –Ω–µ alias
3. **Alias –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å—Å—è** –∏ –Ω–µ –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
4. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ GPS –¥–∞–Ω–Ω—ã—Ö** –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø–æ `device_id` –∏–∑ `starline_devices`

---

## üéØ –ò–¢–û–ì–û

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- ‚ùå –ú–µ—Ç–æ–¥ `matchCars()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç alias –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
- ‚úÖ –ú–µ—Ç–æ–¥ `processDevice()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç device_id –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –í `gps_tracking` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è device_id

**–ß—Ç–æ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:**
- ‚úÖ –ò–∑–º–µ–Ω–∏—Ç—å `matchCars()` —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `starline_devices` –ø–æ `device_id`
- ‚úÖ –£–±—Ä–∞—Ç—å –ª–æ–≥–∏–∫—É —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –ø–æ alias
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –≥–æ—Ç–æ–≤—ã–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∏–∑ –ë–î

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û** - –ú–µ—Ç–æ–¥ `matchCars()` —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É `starline_devices` –ø–æ `device_id`

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 2025-11-12

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –ú–µ—Ç–æ–¥ `matchCars()` —Ç–µ–ø–µ—Ä—å –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∏–∑ `starline_devices` –ø–æ `device_id`
- ‚úÖ –£–±—Ä–∞–Ω–∞ –ª–æ–≥–∏–∫–∞ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –ø–æ alias
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≥–æ—Ç–æ–≤—ã–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∏–∑ –ë–î
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è: `starline_devices.device_id`

