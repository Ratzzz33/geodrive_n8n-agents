#!/bin/bash
# ะะฐะฟััะบ ะฟะฐััะธะฝะณะฐ ะฒัะตั ัะพะพะฑัะตะฝะธะน Umnico ะฒ screen ัะตััะธะธ ะฝะฐ ัะตัะฒะตัะต

SCRIPT_NAME="parse_all_messages"
SCREEN_SESSION="umnico_parse"

echo "๐ ะะฐะฟััะบ ะฟะฐััะธะฝะณะฐ ะฒัะตั ัะพะพะฑัะตะฝะธะน ะฒ screen ัะตััะธะธ..."
echo "๐บ ะกะตััะธั: $SCREEN_SESSION"
echo ""

# ะัะพะฒะตััะตะผ, ัััะตััะฒัะตั ะปะธ ัะถะต ัะตััะธั
if screen -list | grep -q "$SCREEN_SESSION"; then
    echo "โ๏ธ  ะกะตััะธั $SCREEN_SESSION ัะถะต ัััะตััะฒัะตั"
    echo "๐ ะะพะดะบะปััะธัััั: screen -r $SCREEN_SESSION"
    echo "๐ ะัะบะปััะธัััั: Ctrl+A, ะทะฐัะตะผ D"
    echo ""
    read -p "ะะตัะตัะพะทะดะฐัั ัะตััะธั? (y/n): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        screen -S "$SCREEN_SESSION" -X quit
        echo "โ ะกัะฐัะฐั ัะตััะธั ะทะฐะบัััะฐ"
    else
        echo "๐บ ะะพะดะบะปััะตะฝะธะต ะบ ัััะตััะฒัััะตะน ัะตััะธะธ..."
        screen -r "$SCREEN_SESSION"
        exit 0
    fi
fi

# ะะตัะตัะพะดะธะผ ะฒ ะดะธัะตะบัะพัะธั ะฟัะพะตะบัะฐ
cd /root/geodrive_n8n-agents || {
    echo "โ ะัะธะฑะบะฐ: ะฝะต ัะดะฐะปะพัั ะฟะตัะตะนัะธ ะฒ ะดะธัะตะบัะพัะธั ะฟัะพะตะบัะฐ"
    exit 1
}

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต ัะบัะธะฟัะฐ
if [ ! -f "setup/parse_all_messages.mjs" ]; then
    echo "โ ะัะธะฑะบะฐ: ัะฐะนะป setup/parse_all_messages.mjs ะฝะต ะฝะฐะนะดะตะฝ"
    exit 1
fi

# ะกะพะทะดะฐะตะผ screen ัะตััะธั ะธ ะทะฐะฟััะบะฐะตะผ ัะบัะธะฟั
echo "๐บ ะกะพะทะดะฐะฝะธะต screen ัะตััะธะธ ะธ ะทะฐะฟััะบ ะฟะฐััะธะฝะณะฐ..."
screen -dmS "$SCREEN_SESSION" bash -c "
    echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';
    echo '๐ ะะฐััะธะฝะณ ะฒัะตั ัะพะพะฑัะตะฝะธะน ะธะท Umnico';
    echo '๐ ะะฐัะฐะปะพ: $(date)';
    echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';
    echo '';
    cd /root/geodrive_n8n-agents;
    node setup/parse_all_messages.mjs;
    echo '';
    echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';
    echo 'โ ะะฐััะธะฝะณ ะทะฐะฒะตััะตะฝ: $(date)';
    echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';
    echo '';
    echo 'ะะฐะถะผะธัะต ะปัะฑัั ะบะปะฐะฒะธัั ะดะปั ะทะฐะบัััะธั...';
    read -n 1;
"

sleep 1

# ะัะพะฒะตััะตะผ, ััะพ ัะตััะธั ัะพะทะดะฐะฝะฐ
if screen -list | grep -q "$SCREEN_SESSION"; then
    echo "โ Screen ัะตััะธั ัะพะทะดะฐะฝะฐ: $SCREEN_SESSION"
    echo ""
    echo "๐ ะะพะผะฐะฝะดั ะดะปั ัะฟัะฐะฒะปะตะฝะธั:"
    echo "   ะะพะดะบะปััะธัััั:  screen -r $SCREEN_SESSION"
    echo "   ะัะบะปััะธัััั:   Ctrl+A, ะทะฐัะตะผ D"
    echo "   ะกะฟะธัะพะบ ัะตััะธะน: screen -ls"
    echo "   ะะฐะฒะตััะธัั:     screen -S $SCREEN_SESSION -X quit"
    echo ""
    echo "๐บ ะะพะดะบะปััะฐะตะผัั ะบ ัะตััะธะธ..."
    sleep 1
    screen -r "$SCREEN_SESSION"
else
    echo "โ ะัะธะฑะบะฐ: ะฝะต ัะดะฐะปะพัั ัะพะทะดะฐัั screen ัะตััะธั"
    exit 1
fi

