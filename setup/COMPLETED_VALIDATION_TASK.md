# ‚úÖ –ó–ê–î–ê–ß–ê –í–´–ü–û–õ–ù–ï–ù–ê: –í–∞–ª–∏–¥–∞—Ü–∏—è 9 —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π –≤–µ–±—Ö—É–∫–æ–≤ RentProg

**–î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** 2025-01-16  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ –∏ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –≤ n8n

---

## üìã –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. –î–æ–±–∞–≤–ª–µ–Ω—ã –≤—Å–µ 9 —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π –≤ `knownEventTypes`:

| –¢–∏–ø —Å–æ–±—ã—Ç–∏—è | –û–ø–µ—Ä–∞—Ü–∏—è | –°—É—â–Ω–æ—Å—Ç—å |
|-------------|----------|----------|
| `client_destroy` | destroy | client |
| `car_destroy` | destroy | car |
| `booking_destroy` | destroy | booking |
| `car_update` | update | car |
| `client_update` | update | client |
| `booking_update` | update | booking |
| `client_create` | create | client |
| `booking_create` | create | booking |
| `car_create` | create | car |

### 2. –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è:

#### –ë–∞–∑–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è (–¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤):
- ‚úÖ `id` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- ‚úÖ `company_id` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)

#### –°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è:

**`*_update` (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ):**
- –•–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏–∑–º–µ–Ω—è–µ–º–æ–µ –ø–æ–ª–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å:
  - `car_update`: `mileage`, `clean_state`, `status`, `location`, `plate_number`
  - `client_update`: `name`, `phone`, `email`, `passport`, `license`
  - `booking_update`: `status`, `issue_planned_at`, `return_planned_at`, `car_id`, `client_id`

**`*_create` (—Å–æ–∑–¥–∞–Ω–∏–µ):**
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è:
  - `car_create`: `plate_number` –ò–õ–ò `model`
  - `client_create`: `name` –ò–õ–ò `phone`
  - `booking_create`: `car_id` –ò `client_id`

**`*_destroy` (—É–¥–∞–ª–µ–Ω–∏–µ):**
- –¢–æ–ª—å–∫–æ –±–∞–∑–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è (`id`, `company_id`)

### 3. –û–±–Ω–æ–≤–ª–µ–Ω workflow RentProg Webhooks Monitor

- **–ù–æ–¥–∞:** `Parse & Validate Format`
- **–§—É–Ω–∫—Ü–∏—è:** `validateEventFormat(eventType, payload, validationErrors)`
- **–õ–æ–≥–∏–∫–∞:** `isKnownFormat = true` —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ–ª–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Å–µ—Ö –ø–æ–ª–µ–π

---

## üìÅ –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **`n8n-workflows/rentprog-webhooks-monitor.json`**  
   –û—Å–Ω–æ–≤–Ω–æ–π workflow —Ñ–∞–π–ª —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º –∫–æ–¥–æ–º –≤–∞–ª–∏–¥–∞—Ü–∏–∏

2. **`setup/parse_code_with_validation.js`**  
   –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (–¥–ª—è –±—É–¥—É—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π)

3. **`setup/update_validation_code.mjs`**  
   –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è workflow —Ñ–∞–π–ª–∞

4. **`docs/WEBHOOK_EVENT_VALIDATION.md`**  
   –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏–π

5. **`setup/VALIDATION_SUMMARY.txt`**  
   –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã

---

## üîó –°—Å—ã–ª–∫–∏

- **Workflow –≤ n8n:** [https://n8n.rentflow.rentals/workflow/gNXRKIQpNubEazH7](https://n8n.rentflow.rentals/workflow/gNXRKIQpNubEazH7)
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** `docs/WEBHOOK_EVENT_VALIDATION.md`

---

## üéØ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –≤–µ–±—Ö—É–∫–æ–≤:

```
–í–µ–±—Ö—É–∫ –æ—Ç RentProg
    ‚Üì
Respond (Fast ACK) ‚Üê 200 OK < 100ms
    ‚Üì
Parse & Validate Format
    ‚Üì
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ  –¢–∏–ø —Å–æ–±—ã—Ç–∏—è –≤ —Å–ø–∏—Å–∫–µ?      ‚îÇ
  ‚îÇ  –í—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –µ—Å—Ç—å? ‚îÇ
  ‚îÇ  –§–æ—Ä–º–∞—Ç –≤–∞–ª–∏–¥–µ–Ω?            ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üì              ‚Üì
     ‚úÖ –î–ê          ‚ùå –ù–ï–¢
         ‚Üì              ‚Üì
  isKnownFormat   isKnownFormat
    = true          = false
         ‚Üì              ‚Üì
  Auto Process    Telegram Alert
  (Jarvis API)    (–¥–ª—è –æ–±—É—á–µ–Ω–∏—è)
```

### –ü—Ä–∏–º–µ—Ä—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏:

#### ‚úÖ –ò–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ‚Üí –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

**–í–µ–±—Ö—É–∫:**
```json
{
  "event": "car_update",
  "payload": "{\"id\"=>65311, \"mileage\"=>[101191, 102035], \"company_id\"=>9247}"
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- `isKnownFormat: true`
- –ú–∞—Ä—à—Ä—É—Ç: `Auto Process` ‚Üí Jarvis API `/process-webhook`
- Telegram –∞–ª–µ—Ä—Ç: **–ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è**

---

#### ‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ‚Üí Telegram –∞–ª–µ—Ä—Ç –¥–ª—è –æ–±—É—á–µ–Ω–∏—è

**–í–µ–±—Ö—É–∫:**
```json
{
  "event": "car_update",
  "payload": "{\"id\"=>65311, \"company_id\"=>9247}"
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- `isKnownFormat: false`
- `validationErrors: ["car_update: –Ω–µ—Ç –ø–æ–ª–µ–π –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–æ–∂–∏–¥–∞–µ—Ç—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏–∑: mileage, clean_state, status, location, plate_number)"]`
- –ú–∞—Ä—à—Ä—É—Ç: `Telegram Alert` ‚Üí –°–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–µ—Ç–∞–ª—è–º–∏ –∏ payload
- **–ü—Ä–∏—Ö–æ–¥–∏—Ç –∞–ª–µ—Ä—Ç –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞**

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤:

```sql
SELECT 
  COUNT(CASE WHEN ok = true THEN 1 END)::float / COUNT(*) * 100 AS known_percent
FROM events
WHERE ts > NOW() - INTERVAL '24 hours';
```

### –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–æ–ø –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:

```sql
SELECT 
  reason, 
  COUNT(*) as cnt
FROM events
WHERE ok = false
  AND ts > NOW() - INTERVAL '24 hours'
GROUP BY reason
ORDER BY cnt DESC
LIMIT 10;
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –≤–µ–±—Ö—É–∫:

```bash
node setup/send_test_webhook_simple.mjs
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

- **–ò–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç:** –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ **–ù–ï** –ø—Ä–∏—Ö–æ–¥–∏—Ç (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
- **–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç:** –ü—Ä–∏—Ö–æ–¥–∏—Ç Telegram –∞–ª–µ—Ä—Ç —Å –¥–µ—Ç–∞–ª—è–º–∏

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î:

```sql
SELECT id, ts, type, rentprog_id, company_id, ok, processed, reason
FROM events
WHERE ts > NOW() - INTERVAL '1 hour'
ORDER BY ts DESC;
```

---

## üîß –û–±—É—á–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

### –ü—Ä–æ—Ü–µ—Å—Å:

1. **–ü—Ä–∏—Ö–æ–¥–∏—Ç –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≤–µ–±—Ö—É–∫** ‚Üí Telegram –∞–ª–µ—Ä—Ç —Å payload –∏ –æ—à–∏–±–∫–∞–º–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
2. **–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É:**
   - –≠—Ç–æ –Ω–æ–≤—ã–π —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è?
   - –≠—Ç–æ –∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Å –Ω–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏?
   - –≠—Ç–æ –æ—à–∏–±–∫–∞ –æ—Ç RentProg?
3. **–û–±–Ω–æ–≤–ª—è–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é:**
   - –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Ç–∏–ø –≤ `knownEventTypes` (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
   - –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª–µ–π –≤ `validateEventFormat()`
4. **–î–µ–ø–ª–æ–∏–º:**
   ```bash
   node setup/update_validation_code.mjs
   node setup/update_workflow_via_api.mjs
   ```

---

## üìù –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–°–º–æ—Ç—Ä–∏: **`docs/WEBHOOK_EVENT_VALIDATION.md`**

–¢–∞–º –µ—Å—Ç—å:
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π
- –ü—Ä–∏–º–µ—Ä—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞
- –°—Ö–µ–º–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤
- FAQ

---

## ‚ú® –ò—Ç–æ–≥

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å —É–º–µ–µ—Ç:
- ‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç—å 9 —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π –æ—Ç RentProg
- ‚úÖ –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
- ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∞–ª–µ—Ä—Ç—ã –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –Ω–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

**–ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É! üöÄ**

