#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ Hetzner
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–±—Ä–æ—Å–∏—Ç webhook –∏ –∑–∞–ø—É—Å—Ç–∏—Ç –±–æ—Ç–∞ –≤ polling —Ä–µ–∂–∏–º–µ

SERVER_IP="46.224.17.15"
SERVER_USER="root"

echo "=========================================="
echo "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ $SERVER_IP"
echo "=========================================="
echo ""

echo "üîå –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞..."

ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} << 'EOF'
set -e
cd /root/geodrive_n8n-agents

echo "üì• –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
git pull origin master || git pull origin main || true

echo ""
echo "üîÑ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞ (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω)..."
pkill -f "tsx.*index.ts" || pkill -f "node.*dist/index.js" || true
sleep 2

echo ""
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ (webhook –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–µ–Ω)..."
cd /root/geodrive_n8n-agents
nohup npm run dev > /root/bot.log 2>&1 &

echo ""
echo "‚è≥ –ñ–¥–µ–º 3 —Å–µ–∫—É–Ω–¥—ã..."
sleep 3

echo ""
echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –±–æ—Ç–∞..."
tail -n 20 /root/bot.log

echo ""
echo "‚úÖ –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω!"
echo "üí° –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤: tail -f /root/bot.log"
EOF

if [ $? -eq 0 ]; then
    echo ""
    echo "‚úÖ –ö–æ–º–∞–Ω–¥—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
else
    echo ""
    echo "‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥"
    exit 1
fi

