# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ company_id –∫–∞–∫ –º–∞—Å—Å–∏–≤–∞ - –ó–ê–í–ï–†–®–ï–ù–û

**–î–∞—Ç–∞:** 2025-11-21  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã

---

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

–ö–æ–≥–¥–∞ RentProg –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑–º–µ–Ω–µ–Ω–∏–µ `company_id`), –ø–æ–ª–µ `company_id` –ø—Ä–∏—Ö–æ–¥–∏—Ç –∫–∞–∫ –º–∞—Å—Å–∏–≤:
```json
{
  "company_id": [11163, 9247]  // [—Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ]
}
```

**–ü—Ä–∞–≤–∏–ª–æ:** –ü–æ—Å–ª–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç –º–∞—Å—Å–∏–≤–∞ - —ç—Ç–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ (–Ω–æ–≤–æ–µ) –∑–Ω–∞—á–µ–Ω–∏–µ.

### –ß—Ç–æ –±—ã–ª–æ –Ω–µ —Ç–∞–∫:

1. ‚ùå –í n8n workflow `company_id` –∏–∑–≤–ª–µ–∫–∞–ª—Å—è –∫–∞–∫ –µ—Å—Ç—å: `parsedPayload.company_id || null`
   - –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ `[11163, 9247]` ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–ª–æ—Å—å –∫–∞–∫ –º–∞—Å—Å–∏–≤ –∏–ª–∏ –ø–µ—Ä–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
   - –í –ë–î –ø–æ–ø–∞–¥–∞–ª–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (11158 –≤–º–µ—Å—Ç–æ 9247)

2. ‚ùå –í `handleRentProgEvent` branch –æ–ø—Ä–µ–¥–µ–ª—è–ª—Å—è –∏–∑ `payload.branch` –∏–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 'tbilisi'
   - –ù–µ —É—á–∏—Ç—ã–≤–∞–ª—Å—è `company_id` –∏–∑ payload
   - –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ `company_id` branch –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª—Å—è

3. ‚ùå –ú–∞—à–∏–Ω–∞ 39736 –æ—Å—Ç–∞–ª–∞—Å—å —Å branch `service-center` –≤–º–µ—Å—Ç–æ `tbilisi`
   - –°–æ–±—ã—Ç–∏–µ –±—ã–ª–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ, –Ω–æ branch –Ω–µ –æ–±–Ω–æ–≤–∏–ª—Å—è

---

## ‚úÖ –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. n8n Workflow: "RentProg Webhooks Monitor"

**–ù–æ–¥–∞:** "Parse & Validate Format" (Code)

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```javascript
// –ë–´–õ–û:
companyId: parsedPayload.company_id || null,

// –°–¢–ê–õ–û:
companyId: (() => {
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ company_id: –µ—Å–ª–∏ –º–∞—Å—Å–∏–≤ - –±–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç (–Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
  if (parsedPayload.company_id !== undefined && parsedPayload.company_id !== null) {
    if (Array.isArray(parsedPayload.company_id)) {
      return parsedPayload.company_id.length > 0 
        ? parsedPayload.company_id[parsedPayload.company_id.length - 1] 
        : null;
    } else {
      return parsedPayload.company_id;
    }
  }
  return null;
})(),
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–µ–ø–µ—Ä—å `company_id` –≤—Å–µ–≥–¥–∞ –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ - –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç –º–∞—Å—Å–∏–≤–∞ –∏–ª–∏ —Å–∞–º–æ –∑–Ω–∞—á–µ–Ω–∏–µ.

---

### 2. Jarvis API: `handleRentProgEvent`

**–§–∞–π–ª:** `src/orchestrator/rentprog-handler.ts`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```typescript
// –ë–´–õ–û:
const branch = (payload.branch || 'tbilisi') as BranchName;

// –°–¢–ê–õ–û:
// –û–ø—Ä–µ–¥–µ–ª—è–µ–º branch –ø–æ company_id –∏–∑ payload (–µ—Å–ª–∏ –º–∞—Å—Å–∏–≤ - –±–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç)
let branch: BranchName = 'tbilisi'; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

// –ò–∑–≤–ª–µ–∫–∞–µ–º company_id —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –º–∞—Å—Å–∏–≤–∞
let companyId: number | null = null;
if (payload.company_id !== undefined && payload.company_id !== null) {
  if (Array.isArray(payload.company_id)) {
    // –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ - –±–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç (–Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
    companyId = payload.company_id.length > 0 
      ? payload.company_id[payload.company_id.length - 1] 
      : null;
  } else {
    // –ï—Å–ª–∏ —á–∏—Å–ª–æ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –µ—Å—Ç—å
    companyId = payload.company_id;
  }
}

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º branch –ø–æ company_id –∏—Å–ø–æ–ª—å–∑—É—è –º–∞–ø–ø–∏–Ω–≥
if (companyId) {
  const { getBranchByCompanyId } = await import('../config/company-branch-mapping.js');
  const branchFromCompanyId = getBranchByCompanyId(companyId);
  if (branchFromCompanyId) {
    branch = branchFromCompanyId as BranchName;
  }
}

// Fallback: –µ—Å–ª–∏ branch —É–∫–∞–∑–∞–Ω –≤ payload, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
if (payload.branch) {
  branch = payload.branch as BranchName;
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–µ–ø–µ—Ä—å branch –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ `company_id` –∏–∑ payload, –∞ –Ω–µ –∏–∑ `payload.branch`.

---

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î

**–ú–∞—à–∏–Ω–∞ 39736:**
- ‚úÖ Branch –æ–±–Ω–æ–≤–ª–µ–Ω: `service-center` ‚Üí `tbilisi`
- ‚úÖ –°–æ–±—ã—Ç–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: `company_id` 11158 ‚Üí 9247

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –î–∞–Ω–Ω—ã–µ –≤ –ë–î —Ç–µ–ø–µ—Ä—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ä–µ–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é.

---

## üìã –ü–æ—á–µ–º—É –∑–∞–ø–∏—Å—å –∏–∑ history –Ω–µ –ø–æ–ø–∞–ª–∞ –≤ events

**–û—Ç–≤–µ—Ç:** –ó–∞–ø–∏—Å—å "CEO Eliseev Aleksei –∏–∑–º–µ–Ω–∏–ª company_id —Å 11163 –Ω–∞ 9247" –ø–æ–ø–∞–ª–∞ –≤ —Ç–∞–±–ª–∏—Ü—É `history`, –∞ –Ω–µ –≤ `events`, –ø–æ—Ç–æ–º—É —á—Ç–æ:

1. **History Parser** (`xSjwtwrrWUGcBduU`) –ø–∞—Ä—Å–∏—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–∑ `/history_items` API
2. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Ö –≤ —Ç–∞–±–ª–∏—Ü—É `history` (–Ω–µ `events`)
3. `events` —Ç–∞–±–ª–∏—Ü–∞ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑ –≤–µ–±—Ö—É–∫–æ–≤ RentProg

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
- **`history`** - –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ RentProg (–ø–∞—Ä—Å–∏–Ω–≥ –∫–∞–∂–¥—ã–µ 3 –º–∏–Ω—É—Ç—ã)
- **`events`** - —Å–æ–±—ã—Ç–∏—è –∏–∑ –≤–µ–±—Ö—É–∫–æ–≤ RentProg (real-time)

**–ó–∞–ø–∏—Å—å –Ω–∞–π–¥–µ–Ω–∞ –≤ history:**
- –í—Ä–µ–º—è: 21.11.2025, 11:14:55
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: CEO Eliseev Aleksei
- –û–ø–∏—Å–∞–Ω–∏–µ: "CEO Eliseev Aleksei –∏–∑–º–µ–Ω–∏–ª , company_id —Å 11163 –Ω–∞ 9247 –≤ –∞–≤—Ç–æ ‚Ññ 39736"
- –§–∏–ª–∏–∞–ª: tbilisi
- –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ —Å events: –Ω–µ—Ç (matched = false)

**–°–æ–±—ã—Ç–∏–µ –≤ events:**
- –í—Ä–µ–º—è: 21.11.2025, 11:15:01 (—á–µ—Ä–µ–∑ 6 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ history)
- –¢–∏–ø: `car_update`
- Company ID: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω —Å 11158 –Ω–∞ 9247
- Payload: `{"company_id": [11163, 9247], ...}`

**–í—ã–≤–æ–¥:** –°–æ–±—ã—Ç–∏–µ –ø–æ–ø–∞–ª–æ –≤ `events` —á–µ—Ä–µ–∑ –≤–µ–±—Ö—É–∫, –Ω–æ `company_id` –±—ã–ª –∏–∑–≤–ª–µ—á–µ–Ω –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ (11158 –≤–º–µ—Å—Ç–æ 9247). –¢–µ–ø–µ—Ä—å —ç—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ.

---

## üîÑ –ö–∞–∫ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞—Å—Å–∏–≤–æ–≤ company_id

**–ü—Ä–∞–≤–∏–ª–æ:** –ö–æ–≥–¥–∞ `company_id` –ø—Ä–∏—Ö–æ–¥–∏—Ç –∫–∞–∫ –º–∞—Å—Å–∏–≤ `[—Å—Ç–∞—Ä–æ–µ, –Ω–æ–≤–æ–µ]`, –≤—Å–µ–≥–¥–∞ –±–µ—Ä–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç.

**–ü—Ä–∏–º–µ—Ä—ã:**
```javascript
// –ú–∞—Å—Å–∏–≤ - –±–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π
[11163, 9247] ‚Üí 9247

// –û–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –µ—Å—Ç—å
9247 ‚Üí 9247

// –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ - null
[] ‚Üí null
```

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ branch

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**
1. `company_id` –∏–∑ payload (–ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç –º–∞—Å—Å–∏–≤–∞) ‚Üí –º–∞–ø–ø–∏–Ω–≥ ‚Üí branch
2. `payload.branch` (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
3. `'tbilisi'` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

**–ú–∞–ø–ø–∏–Ω–≥:**
```typescript
9247 ‚Üí 'tbilisi'
9248 ‚Üí 'kutaisi'
9506 ‚Üí 'batumi'
11163 ‚Üí 'service-center'
```

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

1. ‚úÖ **n8n workflow** - –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ—Ç `company_id` –∏–∑ –º–∞—Å—Å–∏–≤–∞
2. ‚úÖ **Jarvis API** - –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç branch –ø–æ `company_id`
3. ‚úÖ **–ú–∞—à–∏–Ω–∞ 39736** - branch –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ `tbilisi`
4. ‚úÖ **–°–æ–±—ã—Ç–∏–µ –≤ –ë–î** - `company_id` –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ 9247

---

## üìù –î–∞–ª—å–Ω–µ–π—à–∏–µ –¥–µ–π—Å—Ç–≤–∏—è

1. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
2. ‚úÖ –î–∞–Ω–Ω—ã–µ –≤ –ë–î –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
3. ‚ö†Ô∏è **–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–µ–ø–ª–æ–π** –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ Jarvis API –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏
4. ‚ö†Ô∏è **–¢—Ä–µ–±—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** n8n workflow –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `n8n-workflows/rentprog-webhooks-monitor.json` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∫–æ–¥ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è company_id
- `src/orchestrator/rentprog-handler.ts` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è branch
- `src/config/company-branch-mapping.ts` - –º–∞–ø–ø–∏–Ω–≥ company_id ‚Üí branch
- `setup/check_history_and_fix_car_39736.mjs` - —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é

