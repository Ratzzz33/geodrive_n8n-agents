# Backfill Umnico Conversations

–°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∏–∞–ª–æ–≥–æ–≤ –∏–∑ Umnico –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–≤—è–∑–µ–π —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –∏ –±—Ä–æ–Ω—è–º–∏.

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –≤—Å–µ—Ö –¥–∏–∞–ª–æ–≥–æ–≤ –∏–∑ Umnico –≤ –ë–î:
- –°–æ–∑–¥–∞–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
- –°–æ–∑–¥–∞–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç conversations
- –°–≤—è–∑—ã–≤–∞–µ—Ç —Å –±—Ä–æ–Ω—è–º–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω—è—è –±—Ä–æ–Ω—å —É –∫–ª–∏–µ–Ω—Ç–∞)
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –¥–∏–∞–ª–æ–≥–æ–≤

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. **Playwright Umnico Service** –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω
   - URL –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `http://localhost:3001`
   - –ò–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `PLAYWRIGHT_UMNICO_URL` –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

2. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
   - –¢–∞–±–ª–∏—Ü—ã: `clients`, `conversations`, `messages`, `bookings`, `external_refs`
   - –ú–∏–≥—Ä–∞—Ü–∏—è `sql/conversations_schema.sql` –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∞

3. **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è**:
   ```bash
   DATABASE_URL=postgresql://...  # Connection string –∫ –ë–î
   PLAYWRIGHT_UMNICO_URL=http://localhost:3001  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
   ```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–æ–≤—ã–π –∑–∞–ø—É—Å–∫ (–≤—Å–µ –¥–∏–∞–ª–æ–≥–∏)

```bash
node setup/backfill_umnico_conversations.mjs
```

### –° –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞

```bash
node setup/backfill_umnico_conversations.mjs --limit 100
```

### –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∏–∞–ª–æ–≥–∏

```bash
node setup/backfill_umnico_conversations.mjs --skip-existing
```

### –ö–æ–º–±–∏–Ω–∞—Ü–∏—è –æ–ø—Ü–∏–π

```bash
node setup/backfill_umnico_conversations.mjs --limit 50 --skip-existing
```

## –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤**
   - –ó–∞–ø—Ä–æ—Å –∫ Playwright Service: `GET /api/conversations?limit=N`
   - –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–∏–∞–ª–æ–≥–æ–≤ –∏–∑ Umnico UI

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞**:
   - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π: `GET /api/conversations/{id}/messages`
   - –ü–æ–∏—Å–∫/—Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
   - –°–æ–∑–¥–∞–Ω–∏–µ `external_ref` –¥–ª—è Umnico
   - –ü–æ–∏—Å–∫ –∞–∫—Ç–∏–≤–Ω–æ–π –∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –±—Ä–æ–Ω–∏ —É –∫–ª–∏–µ–Ω—Ç–∞
   - –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `conversation`
   - –í—Å—Ç–∞–≤–∫–∞ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ `messages`
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `booking_id` –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–∞ –±—Ä–æ–Ω—å

3. **–°–≤—è–∑–∏**:
   - `clients` ‚Üê –ø–æ `phone` (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π)
   - `conversations` ‚Üê –ø–æ `umnico_conversation_id`
   - `bookings` ‚Üê —á–µ—Ä–µ–∑ `client_id` (–∞–∫—Ç–∏–≤–Ω–∞—è –∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω—è—è)
   - `messages` ‚Üê –ø—Ä–∏–≤—è–∑–∫–∞ –∫ `conversation_id` –∏ `booking_id`

## –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç –≤—ã–≤–æ–¥–∏—Ç:
- –í—Å–µ–≥–æ –¥–∏–∞–ª–æ–≥–æ–≤
- –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ / –ü—Ä–æ–ø—É—â–µ–Ω–æ / –û—à–∏–±–æ–∫
- –ö–ª–∏–µ–Ω—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω–æ / –æ–±–Ω–æ–≤–ª–µ–Ω–æ
- –î–∏–∞–ª–æ–≥–æ–≤ —Å–æ–∑–¥–∞–Ω–æ / –æ–±–Ω–æ–≤–ª–µ–Ω–æ
- –°–æ–æ–±—â–µ–Ω–∏–π –≤—Å—Ç–∞–≤–ª–µ–Ω–æ
- –ë—Ä–æ–Ω–µ–π —Å–≤—è–∑–∞–Ω–æ

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- –°–∫—Ä–∏–ø—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤
- –û—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å
- –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- –ó–∞–¥–µ—Ä–∂–∫–∞ 500ms –º–µ–∂–¥—É –¥–∏–∞–ª–æ–≥–∞–º–∏ (—á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å Playwright Service)
- Batch insert —Å–æ–æ–±—â–µ–Ω–∏–π (–ø–æ –æ–¥–Ω–æ–º—É —Å `ON CONFLICT DO NOTHING`)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–Ω–¥–µ–∫—Å—ã –ë–î –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞

## –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞

```
üöÄ Umnico Conversations Backfill
================================

üìã Fetching conversations from Umnico...
‚úÖ Found 150 conversations

üîÑ Processing 150 conversations...

[1/150]
üìû Processing conversation 61965921 (phone: +995599001665)
  üì• Fetching messages...
  ‚úÖ Got 45 messages
  üë§ Finding/creating client...
  üîó Linked to booking abc-123-def
  üí¨ Upserting conversation...
  üíæ Inserting 45 messages...
  ‚úÖ Inserted 45 messages
  ‚úÖ Conversation 61965921 processed successfully

...

üìä –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê
================================
–í—Å–µ–≥–æ –¥–∏–∞–ª–æ–≥–æ–≤:        150
–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ:            148
–ü—Ä–æ–ø—É—â–µ–Ω–æ:             0
–û—à–∏–±–æ–∫:                 2

–ö–ª–∏–µ–Ω—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω–æ:      120
–ö–ª–∏–µ–Ω—Ç–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–æ:     28
–î–∏–∞–ª–æ–≥–æ–≤ —Å–æ–∑–¥–∞–Ω–æ:       148
–î–∏–∞–ª–æ–≥–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–æ:      0
–°–æ–æ–±—â–µ–Ω–∏–π –≤—Å—Ç–∞–≤–ª–µ–Ω–æ:    3450
–ë—Ä–æ–Ω–µ–π —Å–≤—è–∑–∞–Ω–æ:         45
================================
```

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –°–∫—Ä–∏–ø—Ç –±–µ–∑–æ–ø–∞—Å–µ–Ω –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç `ON CONFLICT DO NOTHING`)
- –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω—ã (—É–±–∏—Ä–∞–µ—Ç –≤—Å–µ –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä) –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –±—Ä–æ–Ω–µ–π: —Å–Ω–∞—á–∞–ª–∞ –∞–∫—Ç–∏–≤–Ω—ã–µ (`planned`, `active`), –∑–∞—Ç–µ–º –ø–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–∞—è
- –°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è –±–ª–∞–≥–æ–¥–∞—Ä—è `UNIQUE (umnico_message_id)`

## Troubleshooting

### –û—à–∏–±–∫–∞: "Failed to fetch conversations"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ Playwright Service –∑–∞–ø—É—â–µ–Ω: `docker ps | grep playwright-umnico`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL: `curl http://localhost:3001/health`

### –û—à–∏–±–∫–∞: "Database connection failed"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `DATABASE_URL` –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ë–î

### –û—à–∏–±–∫–∞: "Table 'conversations' does not exist"
- –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é: `node setup/apply_umnico_migration.mjs`
- –ò–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ SQL: `sql/conversations_schema.sql`

