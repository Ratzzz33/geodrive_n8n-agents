# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –±—Ä–æ–Ω–µ–π

**–î–∞—Ç–∞:** 2025-11-20  
**Execution:** https://n8n.rentflow.rentals/workflow/rCCVTgR2FcWWRxpq/executions/25120

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏

### 1. –ú–∞—à–∏–Ω—ã (Cars)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç**

**–ß—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:**
- `car_name` - –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—à–∏–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "MINI Hatch")
- `car_code` - –∫–æ–¥ –º–∞—à–∏–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "Mini Hatch 916")
- `rentprog_car_id` - ID –º–∞—à–∏–Ω—ã –≤ RentProg (–Ω–∞–ø—Ä–∏–º–µ—Ä, "51098")
- `car_id` - UUID –º–∞—à–∏–Ω—ã –≤ –Ω–∞—à–µ–π –ë–î (—á–µ—Ä–µ–∑ –¥–∂–æ–π–Ω —Å `cars` –ø–æ `car_code`)

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å:**
- `car_id` (UUID): **100%** (44 –∏–∑ 44 –±—Ä–æ–Ω–µ–π)
- `rentprog_car_id`: **100%** (44 –∏–∑ 44 –±—Ä–æ–Ω–µ–π)

**–°–≤—è–∑—å —á–µ—Ä–µ–∑ external_refs:** ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç  
–ú–∞—à–∏–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–≤—è–∑—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ —Ç–∞–±–ª–∏—Ü—É `external_refs` (RentProg ID ‚Üí –Ω–∞—à UUID).

---

### 2. –¶–µ–Ω—ã (Prices)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç**

**–ß—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:**
- `total` - –æ–±—â–∞—è —Å—É–º–º–∞ –±—Ä–æ–Ω–∏
- `deposit` - –¥–µ–ø–æ–∑–∏—Ç
- `rental_cost` - —Å—Ç–æ–∏–º–æ—Å—Ç—å –∞—Ä–µ–Ω–¥—ã

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å:**
- `total`: **100%** (44 –∏–∑ 44 –±—Ä–æ–Ω–µ–π)
- `deposit`: **100%** (44 –∏–∑ 44 –±—Ä–æ–Ω–µ–π)
- `rental_cost`: **100%** (44 –∏–∑ 44 –±—Ä–æ–Ω–µ–π)

**–ü—Ä–∏–º–µ—Ä—ã:**
- –ë—Ä–æ–Ω—å 515117: total=365, deposit=0, rental_cost=265
- –ë—Ä–æ–Ω—å 515310: total=590, deposit=9, rental_cost=590
- –ë—Ä–æ–Ω—å 515049: total=1895, deposit=540, rental_cost=1840

---

### 3. –ö–ª–∏–µ–Ω—Ç—ã (Clients)

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è **–ß–∞—Å—Ç–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç** ‚Üí ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ**

#### –ß—Ç–æ –±—ã–ª–æ:

**–ü—Ä–æ–±–ª–µ–º–∞ 1:** `data->>'client_id'` –±—ã–ª **NULL**  
**–ü—Ä–∏—á–∏–Ω–∞:** –ü–æ–ª–µ `data` –≤ –ë–î –±—ã–ª–æ **–ø—É—Å—Ç—ã–º** {}

**–ü—Ä–æ–±–ª–µ–º–∞ 2:** –ú–∞–ø–ø–∏–Ω–≥ `data` –≤ –Ω–æ–¥–µ "Save to DB"  
**–ë—ã–ª–æ:** `"data": "={{ $json.data }}"` (–ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è –æ–±—ä–µ–∫—Ç, –Ω–æ n8n Postgres –Ω–æ–¥–∞ —Ç—Ä–µ–±—É–µ—Ç —Å—Ç—Ä–æ–∫—É –¥–ª—è JSONB)  
**–°—Ç–∞–ª–æ:** `"data": "={{ $json.payload_json }}"` (–ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è JSON —Å—Ç—Ä–æ–∫–∞)

#### –ß—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å–µ–π—á–∞—Å:

- `client_name` - –§–ò–û –∫–ª–∏–µ–Ω—Ç–∞ (–¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)
- `data->>'client_id'` - RentProg client ID –≤ JSONB –ø–æ–ª–µ `data`
- `data` - **–ü–û–õ–ù–´–ô JSON** —Å–æ –í–°–ï–ú–ò –ø–æ–ª—è–º–∏ –∏–∑ RentProg API

**–ü–æ–ª–µ `data` —Ç–µ–ø–µ—Ä—å —Å–æ–¥–µ—Ä–∂–∏—Ç:**
- `client_id` - RentProg ID –∫–ª–∏–µ–Ω—Ç–∞
- `car_id` - RentProg ID –º–∞—à–∏–Ω—ã
- `first_name`, `middle_name`, `last_name` - –§–ò–û
- `start_date`, `end_date` - –¥–∞—Ç—ã –±—Ä–æ–Ω–∏
- `total`, `deposit`, `rental_cost` - —Ü–µ–Ω—ã
- `location_start`, `location_end` - –ª–æ–∫–∞—Ü–∏–∏
- `state`, `in_rent`, `archive` - —Å—Ç–∞—Ç—É—Å—ã
- –ò –µ—â–µ **180+ –ø–æ–ª–µ–π** –∏–∑ RentProg

#### –°–≤—è–∑—å `client_id` (UUID):

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** `client_id` (UUID) = **NULL** (0%)  
**–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ:** –ö–æ–ª–æ–Ω–∫–∞ `client_id` –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è UUID —Å–≤—è–∑–∏ —Å —Ç–∞–±–ª–∏—Ü–µ–π `clients`.

**–ü–æ—á–µ–º—É NULL:**
1. RentProg client_id (—Å—Ç—Ä–æ–∫–∞) —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `data->>'client_id'` ‚úÖ
2. UUID —Å–≤—è–∑—å (`client_id`) –º–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∂–µ —á–µ—Ä–µ–∑ `external_refs`
3. –î–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å —Å–≤—è–∑—ã–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ –¥–∂–æ–π–Ω:
   ```sql
   UPDATE bookings b
   SET client_id = er.entity_id
   FROM external_refs er
   WHERE er.external_id = b.data->>'client_id'
   AND er.entity_type = 'client'
   AND er.system = 'rentprog'
   ```

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –°—Ç–∞—Ç—É—Å | % –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|----------|--------|--------------|------------|
| **–ú–∞—à–∏–Ω—ã** |
| `car_name` | ‚úÖ | 100% | –ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—à–∏–Ω—ã |
| `car_code` | ‚úÖ | 100% | –ö–æ–¥ –º–∞—à–∏–Ω—ã |
| `rentprog_car_id` | ‚úÖ | 100% | RentProg ID |
| `car_id` (UUID) | ‚úÖ | 100% | –°–≤—è–∑—å —á–µ—Ä–µ–∑ `external_refs` |
| **–¶–µ–Ω—ã** |
| `total` | ‚úÖ | 100% | –û–±—â–∞—è —Å—É–º–º–∞ |
| `deposit` | ‚úÖ | 100% | –î–µ–ø–æ–∑–∏—Ç |
| `rental_cost` | ‚úÖ | 100% | –°—Ç–æ–∏–º–æ—Å—Ç—å –∞—Ä–µ–Ω–¥—ã |
| **–ö–ª–∏–µ–Ω—Ç—ã** |
| `client_name` | ‚úÖ | 100% | –§–ò–û –∫–ª–∏–µ–Ω—Ç–∞ |
| `data->>'client_id'` | ‚úÖ | 100% | RentProg client ID (–ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è) |
| `client_id` (UUID) | ‚ö†Ô∏è | 0% | –¢—Ä–µ–±—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è |
| **–ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** |
| `data` (JSONB) | ‚úÖ | 100% | **–í–°–ï** –ø–æ–ª—è –∏–∑ RentProg (180+) |
| `payload_json` | ‚úÖ | 100% | –ö–æ–ø–∏—è `data` –≤ TEXT |

---

## üîÑ –†–∞—Å–∫–∏–¥—ã–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ç–∞–±–ª–∏—Ü–∞–º

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:

**–ë—Ä–æ–Ω–∏ ‚Üí –ú–∞—à–∏–Ω—ã:** ‚úÖ **–†–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏**  
- –°–≤—è–∑—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `car_code` ‚Üí `cars.code`
- UUID –º–∞—à–∏–Ω—ã –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ `bookings.car_id`

**–ë—Ä–æ–Ω–∏ ‚Üí –ö–ª–∏–µ–Ω—Ç—ã:** ‚ö†Ô∏è **–¢—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏**  
- RentProg client_id —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `data->>'client_id'` ‚úÖ
- UUID –∫–ª–∏–µ–Ω—Ç–∞ –º–æ–∂–Ω–æ —Å–≤—è–∑–∞—Ç—å —á–µ—Ä–µ–∑ `external_refs`
- –¢—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å/workflow –¥–ª—è —Å–≤—è–∑—ã–≤–∞–Ω–∏—è

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

**–í–∞—Ä–∏–∞–Ω—Ç 1: –û—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**  
- RentProg client_id —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `data` ‚úÖ
- UUID —Å–≤—è–∑—å —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- –ù–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –±—Ä–æ–Ω–∏ –≤ UI –∏–ª–∏ —Ä–∞–∑ –≤ –¥–µ–Ω—å —á–µ—Ä–µ–∑ batch update

**–í–∞—Ä–∏–∞–Ω—Ç 2: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ**  
- –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é –Ω–æ–¥—É –≤ workflow –ø–æ—Å–ª–µ "Save to DB"
- –î–µ–ª–∞—Ç—å UPDATE —á–µ—Ä–µ–∑ SQL:
  ```sql
  UPDATE bookings b
  SET client_id = er.entity_id
  FROM external_refs er
  WHERE b.data->>'client_id' IS NOT NULL
  AND er.external_id = b.data->>'client_id'
  AND er.entity_type = 'client'
  AND er.system = 'rentprog'
  AND b.client_id IS NULL
  ```

**–í–∞—Ä–∏–∞–Ω—Ç 3: –°–≤—è–∑—ã–≤–∞–Ω–∏–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –ø–∞—Ä—Å–∏–Ω–≥–∞**  
- –î–æ–±–∞–≤–∏—Ç—å –¥–∂–æ–π–Ω —Å `external_refs` –≤ –Ω–æ–¥–µ "Process All Bookings"
- –ò—Å–∫–∞—Ç—å UUID –∫–ª–∏–µ–Ω—Ç–∞ —Å—Ä–∞–∑—É –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ
- –°–æ—Ö—Ä–∞–Ω—è—Ç—å `client_id` (UUID) –≤–º–µ—Å—Ç–µ —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏

---

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:

1. ‚ùå **–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø–∏—Å–∞—Ç—å —Å—Ç—Ä–æ–∫—É –≤ UUID –ø–æ–ª–µ**
   - –ë—ã–ª–æ: `client_id: "={{ $json.rentprog_client_id }}"`
   - –°—Ç–∞–ª–æ: –£–ë–†–ê–ù–û –∏–∑ –º–∞–ø–ø–∏–Ω–≥–∞
   - –ü—Ä–∏—á–∏–Ω–∞: `client_id` - —ç—Ç–æ UUID –∫–æ–ª–æ–Ω–∫–∞ –¥–ª—è —Å–≤—è–∑–∏ —Å `clients`, –∞ –Ω–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è RentProg ID

2. ‚ùå **–ü—É—Å—Ç–æ–µ –ø–æ–ª–µ `data` –≤ –ë–î**
   - –ë—ã–ª–æ: `data: "={{ $json.data }}"` (–ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è –æ–±—ä–µ–∫—Ç)
   - –°—Ç–∞–ª–æ: `data: "={{ $json.payload_json }}"` (–ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è JSON —Å—Ç—Ä–æ–∫–∞)
   - –ü—Ä–∏—á–∏–Ω–∞: n8n Postgres –Ω–æ–¥–∞ —Ç—Ä–µ–±—É–µ—Ç —Å—Ç—Ä–æ–∫—É –¥–ª—è JSONB –ø–æ–ª–µ–π

### –°–ª–µ–¥—É—é—â–∏–µ execution:

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Å–ª–µ–¥—É—é—â–∏–π execution –¥–æ–ª–∂–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è—Ç—å:
- ‚úÖ `data` (JSONB) - –ø–æ–ª–Ω—ã–π JSON —Å –í–°–ï–ú–ò –ø–æ–ª—è–º–∏ –∏–∑ RentProg
- ‚úÖ `data->>'client_id'` - RentProg client ID –¥–æ—Å—Ç—É–ø–µ–Ω –≤ JSONB
- ‚úÖ `data->>'car_id'` - RentProg car ID –¥–æ—Å—Ç—É–ø–µ–Ω –≤ JSONB
- ‚úÖ –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ 180+ –ø–æ–ª–µ–π –∏–∑ RentProg –¥–æ—Å—Ç—É–ø–Ω—ã –≤ `data`

---

## üìå –í–∞–∂–Ω—ã–µ –≤—ã–≤–æ–¥—ã

1. **–ú–∞—à–∏–Ω—ã:** –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞—é—Ç, UUID —Å–≤—è–∑—å —á–µ—Ä–µ–∑ `external_refs` ‚úÖ
2. **–¶–µ–Ω—ã:** –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è (total, deposit, rental_cost) ‚úÖ
3. **–ö–ª–∏–µ–Ω—Ç—ã:** RentProg ID —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `data`, UUID —Å–≤—è–∑—å —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ‚ö†Ô∏è
4. **–ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:** **–í–°–ï** –ø–æ–ª—è –∏–∑ RentProg —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ JSONB `data` ‚úÖ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–ª—è —Å–≤—è–∑—ã–≤–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å UUID –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å (–í–∞—Ä–∏–∞–Ω—Ç 1 –∏–ª–∏ 2).

