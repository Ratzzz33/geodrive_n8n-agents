# –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —É–ª—É—á—à–µ–Ω–∏–π –≤–µ–±—Ö—É–∫–æ–≤

**–î–∞—Ç–∞:** 2025-01-15  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. ‚úÖ Rate Limiting –Ω–∞ —É—Ä–æ–≤–Ω–µ Nginx
- **–§–∞–π–ª:** `nginx/webhook.rentflow.rentals.conf`
- **–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
  - –î–æ–±–∞–≤–ª–µ–Ω `limit_req_zone` (30 RPS –Ω–∞ IP)
  - –î–æ–±–∞–≤–ª–µ–Ω `limit_req` –≤ `location /` —Å burst=10
- **–°—Ç–∞—Ç—É—Å:** –ü—Ä–∏–º–µ–Ω–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, Nginx –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω

### 2. ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π 200 OK –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- **–ù–æ–¥–∞:** "Respond (Fast Ack)" –≤ workflow
- **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:** –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å "Parse & Validate Format" —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ "Webhook"
- **–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### 3. ‚úÖ Event Hash –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–π –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
- **–ú–∏–≥—Ä–∞—Ü–∏—è –ë–î:** –í—ã–ø–æ–ª–Ω–µ–Ω–∞ (`setup/migrate_add_event_hash_and_error_log.mjs`)
  - –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `event_hash TEXT` –≤ —Ç–∞–±–ª–∏—Ü—É `events`
  - –°–æ–∑–¥–∞–Ω –∏–Ω–¥–µ–∫—Å `idx_events_hash`
- **Workflow:** –û–±–Ω–æ–≤–ª–µ–Ω
  - –ö–æ–¥ "Parse & Validate Format" –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SHA256 hash
  - Hash —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É `events`
- **–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç

### 4. ‚úÖ –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
- **–ú–∏–≥—Ä–∞—Ü–∏—è –ë–î:** –í—ã–ø–æ–ª–Ω–µ–Ω–∞
  - –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `webhook_error_log` —Å –ø–æ–ª–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
  - –°–æ–∑–¥–∞–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
- **Workflow:** –û–±–Ω–æ–≤–ª–µ–Ω
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–¥–∞ "Log Error to DB"
  - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫–æ –≤—Å–µ–º error paths:
    - "Alert: Parse Error" ‚Üí "Log Error to DB"
    - "Auto Process" (error) ‚Üí "Log Error to DB"
    - "Trigger Upsert Processor" (error) ‚Üí "Log Error to DB"
    - "Save Event" (error) ‚Üí "Log Error to DB"
- **–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç

---

## üìã –ü—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```nginx
# Rate limiting –∑–æ–Ω–∞
limit_req_zone $binary_remote_addr zone=webhook_limit:10m rate=30r/s;

location / {
    limit_req zone=webhook_limit burst=10 nodelay;
    limit_req_status 429;
    ...
}
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `events`: –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `event_hash`
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `webhook_error_log`: —Å–æ–∑–¥–∞–Ω–∞ —Å –ø–æ–ª–Ω—ã–º–∏ –ø–æ–ª—è–º–∏

### n8n Workflow
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `RentProg Webhooks Monitor`:
  - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è `event_hash` –≤ "Parse & Validate Format"
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ `event_hash` –≤ "Save Event"
  - –ù–æ–¥–∞ "Log Error to DB" –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö –æ—à–∏–±–æ–∫
  - "Respond (Fast Ack)" –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–≤–µ—Ç–∞

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### 1. Rate Limiting
```bash
# –û—Ç–ø—Ä–∞–≤–∫–∞ 35 –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–¥—Ä—è–¥ (–¥–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å 429 –ø–æ—Å–ª–µ 30)
for i in {1..35}; do
  curl -X POST https://webhook.rentflow.rentals/webhook/rentprog-webhook \
    -H "Content-Type: application/json" \
    -d '{"event":"test","payload":"{}"}' &
done
```

### 2. Event Hash
```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ event_hash –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è
SELECT id, ts, event_hash, type, rentprog_id
FROM events
WHERE event_hash IS NOT NULL
ORDER BY ts DESC
LIMIT 10;
```

### 3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
SELECT phase, kind, error, ts
FROM webhook_error_log
ORDER BY ts DESC
LIMIT 10;
```

---

## ‚úÖ –°—Ç–∞—Ç—É—Å

- ‚úÖ Nginx –æ–±–Ω–æ–≤–ª–µ–Ω –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
- ‚úÖ Workflow –æ–±–Ω–æ–≤–ª–µ–Ω –≤ n8n
- ‚úÖ –í—Å–µ 4 —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã

**–í—Å–µ –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ!**

