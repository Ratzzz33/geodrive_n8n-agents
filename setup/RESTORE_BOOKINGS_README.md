# Скрипт восстановления branch_code для бронирований

## Назначение

Скрипт восстанавливает отсутствующий `branch_code` для бронирований, которые были созданы до внедрения сохранения `branch_code` в таблице `external_refs`.

**Проблема:** Без `branch_code` система не может определить филиал для синхронизации бронирований через API `/all_bookings`.

## Как работает

1. **Находит все бронирования** без `branch_code`, но с RentProg ID
2. **Ищет каждое бронирование** во всех филиалах через RentProg API:
   - Использует `/search_bookings` и прямые запросы по ID
   - Проверяет все 4 филиала: tbilisi, batumi, kutaisi, service-center
3. **Обновляет `branch_code`** в таблице `external_refs`
4. **Вызывает upsert** через Jarvis API для обновления данных бронирования

## Запуск

```bash
# Из корня проекта
cd C:\Users\33pok\geodrive_n8n-agents

# Запустить скрипт
node setup/restore_missed_bookings.mjs
```

## Что ожидать

Скрипт выводит прогресс в реальном времени:
- `[X/Total] Проверка <rentprog_id>...` - проверка каждого бронирования
- `✅ найдено в <branch>` - бронирование найдено
- `→ branch_code обновлен` - обновление в БД
- `→ upsert выполнен ✅` - успешный upsert через API
- `❌ не найдено` - бронирование не найдено ни в одном филиале

После каждого батча (10 бронирований) выводится промежуточная статистика.

## Статистика

В конце скрипт выводит:
- Всего обработано
- Найдено в RentProg
- Не найдено
- Обновлено (branch_code + upsert)
- Ошибок

## Важные замечания

1. **Время выполнения:** Для 3,544 бронирований скрипт может работать несколько часов (задержки между запросами для избежания rate limiting)

2. **Jarvis API:** Должен быть доступен на `http://46.224.17.15:3000`

3. **База данных:** Использует connection string из `DATABASE_URL` или дефолтный

4. **Токены филиалов:** Хардкодятся в скрипте (для production лучше вынести в ENV)

## После выполнения

После успешного выполнения скрипта:
1. Все бронирования с RentProg ID будут иметь `branch_code`
2. Автоматическая синхронизация через n8n workflow сможет обновлять эти бронирования
3. Можно запустить полную синхронизацию для проверки

## Troubleshooting

**Ошибка: "Jarvis API недоступен"**
- Проверьте, что Jarvis API запущен: `docker ps | grep jarvis`
- Проверьте доступность: `curl http://46.224.17.15:3000/health`

**Ошибка: "Database connection failed"**
- Проверьте connection string
- Убедитесь, что Neon DB доступна

**Много "не найдено"**
- Возможно, бронирования были удалены в RentProg
- Проверьте несколько примеров вручную через RentProg UI

