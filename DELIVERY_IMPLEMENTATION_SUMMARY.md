# –†–µ–∑—é–º–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –¥–æ—Å—Ç–∞–≤–∫–∏ –∞–≤—Ç–æ –º–µ–∂–¥—É —Ñ–∏–ª–∏–∞–ª–∞–º–∏

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

### 1. –°–æ–∑–¥–∞–Ω—ã –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î (8 —Ñ–∞–π–ª–æ–≤)

- **0032_create_cities_table.sql** - –¢–∞–±–ª–∏—Ü–∞ –≥–æ—Ä–æ–¥–æ–≤ —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ —Ñ–∏–ª–∏–∞–ª–∞–º
- **0033_create_city_delivery_pricing.sql** - –¢–∞—Ä–∏—Ñ—ã –¥–æ—Å—Ç–∞–≤–∫–∏ (city/airport/intercity)
- **0034_create_car_branch_states.sql** - –°—Ç–∞—Ç—É—Å—ã —Ñ–∏–ª–∏–∞–ª–æ–≤ –¥–ª—è –º–∞—à–∏–Ω (current/future/desired/home)
- **0035_create_one_way_discount_rules.sql** - –ü—Ä–∞–≤–∏–ª–∞ —Å–∫–∏–¥–æ–∫ –Ω–∞ –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω—é—é –∞—Ä–µ–Ω–¥—É
- **0036_create_future_branch_functions.sql** - –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ future_branch_id
- **0037_create_future_branch_triggers.sql** - –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –±—Ä–æ–Ω–µ–π
- **0038_create_car_delivery_options_view.sql** - VIEW –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∞–≥–µ–Ω—Ç–∞
- **0039_create_out_of_hours_function.sql** - –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –¥–æ–ø–ª–∞—Ç—ã –∑–∞ –Ω–µ—Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è

### 2. –°–æ–∑–¥–∞–Ω—ã —Å–∫—Ä–∏–ø—Ç—ã –∏–º–ø–æ—Ä—Ç–∞

- **setup/import_cities_and_routes.mjs** - –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ Excel (cities.xlsx –∏ routes.xlsx)
- **setup/run_delivery_migrations.mjs** - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –º–∏–≥—Ä–∞—Ü–∏–π –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π

### 3. –°–æ–∑–¥–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **docs/DELIVERY_SYSTEM.md** - –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã
- **setup/DELIVERY_SETUP_README.md** - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ

## üéØ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ future_branch_id

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫—É–¥–∞ –º–∞—à–∏–Ω–∞ –¥–æ–ª–∂–Ω–∞ –≤–µ—Ä–Ω—É—Ç—å—Å—è –ø–æ –±–ª–∏–∂–∞–π—à–µ–π –±—É–¥—É—â–µ–π –±—Ä–æ–Ω–∏:
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –±—Ä–æ–Ω–∏
- –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –±—Ä–æ–Ω–∏
- –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ/—É–¥–∞–ª–µ–Ω–∏–∏ –±—Ä–æ–Ω–∏

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ desired_branch_id

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∂–µ–ª–∞–µ–º—ã–π —Ñ–∏–ª–∏–∞–ª:
- –ï—Å–ª–∏ –¥–æ –±—É–¥—É—â–µ–π –±—Ä–æ–Ω–∏ ‚â§7 –¥–Ω–µ–π ‚Üí `desired = future`
- –ï—Å–ª–∏ –µ—Å—Ç—å `home_branch` ‚Üí `desired = home`

### –†–∞—Å—á—ë—Ç —Å–∫–∏–¥–æ–∫ –Ω–∞ –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω—é—é –∞—Ä–µ–Ω–¥—É

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç —Å–∫–∏–¥–æ–∫:
- **100% —Å–∫–∏–¥–∫–∞** (–±–µ—Å–ø–ª–∞—Ç–Ω–æ):
  - –í–æ–∑–≤—Ä–∞—Ç –≤ `home_branch`
  - –í–æ–∑–≤—Ä–∞—Ç –≤ `desired_branch`
  - –î–æ —Å–ª–µ–¥—É—é—â–µ–π –±—Ä–æ–Ω–∏ <7 –¥–Ω–µ–π
- **50% —Å–∫–∏–¥–∫–∞**:
  - –î–æ —Å–ª–µ–¥—É—é—â–µ–π –±—Ä–æ–Ω–∏ 7-14 –¥–Ω–µ–π
- **0% —Å–∫–∏–¥–∫–∞** (–ø–æ–ª–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å):
  - –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–ª—É—á–∞–∏

### –¢–∞—Ä–∏—Ñ—ã –¥–æ—Å—Ç–∞–≤–∫–∏

- **–í–Ω—É—Ç—Ä–∏ –≥–æ—Ä–æ–¥–∞**: $10
- **–î–æ –∞—ç—Ä–æ–ø–æ—Ä—Ç–∞**: $20
- **–ú–µ–∂–¥—É –≥–æ—Ä–æ–¥–∞–º–∏**: –∏–∑ —Ñ–∞–π–ª–∞ `routes.xlsx` (–æ–¥–∏–Ω–∞–∫–æ–≤–∞—è —Ü–µ–Ω–∞ –¥–ª—è –æ—Ñ–∏—Å–∞/–∞—ç—Ä–æ–ø–æ—Ä—Ç–∞/–ª—é–±–æ–π —Ç–æ—á–∫–∏)

### –î–æ–ø–ª–∞—Ç–∞ –∑–∞ –Ω–µ—Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è

- **–†–∞–∑–º–µ—Ä**: $20 –∑–∞ –∫–∞–∂–¥—É—é –æ–ø–µ—Ä–∞—Ü–∏—é (–≤—ã–¥–∞—á–∞ –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—Ç)
- **–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è**: 09:00 - 20:00 (Asia/Tbilisi)
- **–ù–µ—Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è**: –¥–æ 09:00 –∏–ª–∏ –ø–æ—Å–ª–µ 20:00

## üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
node setup/run_delivery_migrations.mjs
```

### 2. –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ

```bash
node setup/import_cities_and_routes.mjs
```

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –§–∞–π–ª—ã `excel/cities.xlsx` –∏ `excel/routes.xlsx` –¥–æ–ª–∂–Ω—ã —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å
- –í —Ç–∞–±–ª–∏—Ü–µ `branches` –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–∏—Å–∏ –¥–ª—è –≤—Å–µ—Ö —Ñ–∏–ª–∏–∞–ª–æ–≤

### 3. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å –∞–≥–µ–Ω—Ç–æ–º

–ê–≥–µ–Ω—Ç –ø–æ–¥–±–æ—Ä–∞ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –∞–≤—Ç–æ –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å VIEW `car_delivery_options_view` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≥–æ—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ –¥–æ—Å—Ç–∞–≤–∫–µ.

–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:

```sql
SELECT 
  car_id,
  car_plate,
  current_branch_code,
  future_branch_code,
  target_branch_code,
  delivery_scope,
  final_delivery_fee_usd,
  final_one_way_fee_usd,
  discount_percent,
  can_offer_without_fee
FROM car_delivery_options_view
WHERE target_branch_code = 'tbilisi'
  AND delivery_scope = 'intercity'
ORDER BY final_delivery_fee_usd ASC;
```

### 4. –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—á—ë—Ç –¥–æ–ø–ª–∞—Ç—ã –∑–∞ –Ω–µ—Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è

–ü—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é:

```sql
SELECT calculate_out_of_hours_fee(
  ${issueTime},  -- –≤—Ä–µ–º—è –≤—ã–¥–∞—á–∏
  ${returnTime}  -- –≤—Ä–µ–º—è –≤–æ–∑–≤—Ä–∞—Ç–∞
);
```

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: [docs/DELIVERY_SYSTEM.md](docs/DELIVERY_SYSTEM.md)
- **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ**: [setup/DELIVERY_SETUP_README.md](setup/DELIVERY_SETUP_README.md)

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

```sql
-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Ä–æ–¥–æ–≤
SELECT COUNT(*) FROM cities;

-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∞—Ä–∏—Ñ–æ–≤
SELECT COUNT(*) FROM city_delivery_pricing;

-- –ü—Ä–∞–≤–∏–ª–∞ —Å–∫–∏–¥–æ–∫
SELECT * FROM one_way_discount_rules ORDER BY priority;

-- VIEW —Ä–∞–±–æ—Ç–∞–µ—Ç
SELECT COUNT(*) FROM car_delivery_options_view;

-- –¢—Ä–∏–≥–≥–µ—Ä—ã —Å–æ–∑–¥–∞–Ω—ã
SELECT * FROM pg_trigger WHERE tgname LIKE '%future_branch%';

-- –§—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã
SELECT proname FROM pg_proc WHERE proname LIKE '%future_branch%' OR proname LIKE '%out_of_hours%';
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–¢—Ä–∏–≥–≥–µ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** - –ø—Ä–∏ –ª—é–±–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤ `bookings` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `car_branch_states`
2. **–§–æ—Ä–º–∞—Ç Excel —Ñ–∞–π–ª–æ–≤** - —Å–∫—Ä–∏–ø—Ç –∏–º–ø–æ—Ä—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞–∑–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ
3. **–í—Ä–µ–º—è** - –≤—Å–µ —Ä–∞—Å—á—ë—Ç—ã –≤—Ä–µ–º–µ–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ç–∞–π–º–∑–æ–Ω—É `Asia/Tbilisi` (UTC+4)
4. **–°–∫–∏–¥–∫–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** - –∞–≥–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —É–∂–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ VIEW

