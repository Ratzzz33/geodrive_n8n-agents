{
  "id": "gNXRKIQpNubEazH7",
  "name": "RentProg Webhooks Monitor",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "rentprog-webhook",
        "responseMode": "responseNode",
        "options": {
          "productionUrl": "https://webhook.rentflow.rentals"
        },
        "onError": "continueRegularOutput"
      },
      "id": "webhook-node",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        250,
        400
      ],
      "webhookId": "rentprog-webhook-monitor"
    },
    {
      "parameters": {
        "jsCode": "// ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³ Ð¸ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð° Ð²ÐµÐ±Ñ…ÑƒÐºÐ° Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¾Ð¹ Ð¾ÑˆÐ¸Ð±Ð¾Ðº\ntry {\n  const body = $input.item.json.body || {};\n  const payloadStr = body.payload || '';\n  const rawEvent = body.event || body.type || 'unknown';\n\n  let rentprogId = 'unknown';\n  let isKnownFormat = false;\n  let parsedPayload = {};\n  let validationErrors = [];\n  let eventType = 'unknown';\n  let entityType = 'unknown';\n  let parseError = false;\n  let errorMessage = '';\n\n  // ========== Ð¨ÐÐ“ 1: ÐŸÐ°Ñ€ÑÐ¸Ð½Ð³ payload ==========\n  try {\n    if (typeof payloadStr === 'string' && payloadStr.length > 0) {\n      try {\n        parsedPayload = JSON.parse(payloadStr);\n      } catch (e) {\n        // ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ruby hash Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚\n        try {\n          let jsonStr = payloadStr\n            .replace(/=>/g, ':')\n            .replace(/([{, ])([a-zA-Z_][a-zA-Z0-9_]*):/g, '$1\"$2\":')\n            .replace(/nil/g, 'null')\n            .replace(/\\s+/g, ' ');\n          parsedPayload = JSON.parse(jsonStr);\n        } catch (e2) {\n          validationErrors.push('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ñ€Ð°ÑÐ¿Ð°Ñ€ÑÐ¸Ñ‚ÑŒ payload: ' + e2.message);\n        }\n      }\n    } else if (typeof payloadStr === 'object' && payloadStr !== null) {\n      parsedPayload = payloadStr;\n    }\n  } catch (e) {\n    validationErrors.push('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ payload: ' + e.message);\n  }\n\n  // ========== Ð¨ÐÐ“ 2: Ð˜Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ rentprog_id ==========\n  if (parsedPayload && Object.keys(parsedPayload).length > 0) {\n    if (parsedPayload.id !== undefined && parsedPayload.id !== null) {\n      rentprogId = String(parsedPayload.id);\n    } else if (typeof payloadStr === 'string') {\n      // ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ regex ÐµÑÐ»Ð¸ Ð½Ðµ Ñ€Ð°ÑÐ¿Ð°Ñ€ÑÐ¸Ð»Ð¾ÑÑŒ\n      const idMatch = payloadStr.match(/[\"']?id[\"']?\\s*=>\\s*(\\d+)/i);\n      if (idMatch) {\n        rentprogId = idMatch[1];\n      } else {\n        validationErrors.push('ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½ ID Ð² payload');\n      }\n    } else {\n      validationErrors.push('ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½ ID Ð² payload');\n    }\n  } else {\n    validationErrors.push('Payload Ð¿ÑƒÑÑ‚ Ð¸Ð»Ð¸ Ð½Ðµ Ñ€Ð°ÑÐ¿Ð°Ñ€ÑÐµÐ½');\n  }\n\n  // ========== Ð¨ÐÐ“ 3: ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ñ‚Ð¸Ð¿Ð° ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ ==========\n  const knownEventTypes = [\n    'car_update', 'car_create', 'car_delete',\n    'booking_update', 'booking_create', 'booking_delete',\n    'client_update', 'client_create', 'client_delete',\n    'booking.issue.planned', 'booking.returned', 'car.moved'\n  ];\n\n  const eventLower = rawEvent.toLowerCase().replace(/[._]/g, '');\n  if (knownEventTypes.includes(rawEvent)) {\n    eventType = rawEvent;\n  } else {\n    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹: car_update, carupdate, car.update\n    const matchedType = knownEventTypes.find(t => {\n      const tLower = t.replace(/[._]/g, '');\n      return eventLower.includes(tLower) || tLower.includes(eventLower);\n    });\n    if (matchedType) {\n      eventType = matchedType;\n    } else {\n      validationErrors.push(`ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ Ñ‚Ð¸Ð¿ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ: ${rawEvent}`);\n    }\n  }\n\n  // ========== Ð¨ÐÐ“ 4: ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ñ‚Ð¸Ð¿Ð° ÑÑƒÑ‰Ð½Ð¾ÑÑ‚Ð¸ ==========\n  if (eventType.startsWith('car') || eventType.includes('car') || eventType.includes('Ð°Ð²Ñ‚Ð¾Ð¼Ð¾Ð±')) {\n    entityType = 'car';\n  } else if (eventType.startsWith('booking') || eventType.includes('booking') || eventType.includes('Ð±Ñ€Ð¾Ð½Ð¸Ñ€')) {\n    entityType = 'booking';\n  } else if (eventType.startsWith('client') || eventType.includes('client') || eventType.includes('ÐºÐ»Ð¸ÐµÐ½Ñ‚')) {\n    entityType = 'client';\n  } else if (eventType !== 'unknown') {\n    validationErrors.push(`ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ñ‚Ð¸Ð¿ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚Ð¸ Ð´Ð»Ñ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ: ${eventType}`);\n  }\n\n  // ========== Ð¨ÐÐ“ 5: Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð¿Ð¾Ð»ÐµÐ¹ ==========\n  if (entityType !== 'unknown' && rentprogId === 'unknown') {\n    validationErrors.push(`ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð¿Ð¾Ð»Ðµ id Ð´Ð»Ñ ${entityType}`);\n  }\n\n  // ========== Ð˜Ð¢ÐžÐ“ÐžÐ’ÐÐ¯ ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ ==========\n  // Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¸Ð·Ð²ÐµÑÑ‚ÐµÐ½, ÐµÑÐ»Ð¸ Ð²ÑÐµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹\n  if (\n    Object.keys(parsedPayload).length > 0 &&\n    rentprogId !== 'unknown' &&\n    eventType !== 'unknown' &&\n    entityType !== 'unknown' &&\n    validationErrors.length === 0\n  ) {\n    isKnownFormat = true;\n  }\n\n  // ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ branch\n  const branch = $input.item.json.query && $input.item.json.query.branch ? $input.item.json.query.branch : (body.branch || 'unknown');\n\n  return {\n    json: {\n      ...$input.item.json,\n      rentprogId: rentprogId,\n      eventType: eventType,\n      entityType: entityType,\n      branch: branch,\n      isKnownFormat: isKnownFormat,\n      parsedPayload: parsedPayload,\n      validationErrors: validationErrors,\n      rawEvent: rawEvent,\n      parseError: parseError,\n      errorMessage: errorMessage\n    }\n  };\n} catch (error) {\n  // ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð° - Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ¾Ð¹\n  const body = $input.item.json.body || {};\n  const branch = $input.item.json.query && $input.item.json.query.branch ? $input.item.json.query.branch : (body.branch || 'unknown');\n  const rawEvent = body.event || body.type || 'unknown';\n  \n  return {\n    json: {\n      ...$input.item.json,\n      rentprogId: 'unknown',\n      eventType: 'unknown',\n      entityType: 'unknown',\n      branch: branch,\n      isKnownFormat: false,\n      parsedPayload: {},\n      validationErrors: ['ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð°: ' + (error.message || String(error))],\n      rawEvent: rawEvent,\n      parseError: true,\n      errorMessage: error.message || String(error),\n      errorStack: error.stack || ''\n    }\n  };\n}"
      },
      "id": "parse-validate-node",
      "name": "Parse & Validate Format",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        450,
        400
      ],
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "known-format-check",
              "leftValue": "={{ $json.isKnownFormat }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-known-format-node",
      "name": "If Known Format",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        650,
        400
      ],
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.ORCHESTRATOR_URL || 'http://46.224.17.15:3000' }}/process-webhook",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "event",
              "value": "={{ $json.rawEvent || $json.eventType }}"
            },
            {
              "name": "payload",
              "value": "={{ JSON.stringify($json.parsedPayload) }}"
            },
            {
              "name": "rentprog_id",
              "value": "={{ $json.rentprogId }}"
            },
            {
              "name": "branch",
              "value": "={{ $json.branch }}"
            },
            {
              "name": "entity_type",
              "value": "={{ $json.entityType }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "auto-process-node",
      "name": "Auto Process",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        850,
        300
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "needs-upsert-check",
              "leftValue": "={{ $json.needsUpsert }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-needs-upsert-node",
      "name": "If Needs Upsert",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1050,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.N8N_URL || 'http://46.224.17.15:5678' }}/webhook/upsert-processor",
        "sendBody": true,
        "contentType": "json",
        "body": "={{ { \"rentprog_id\": $('Auto Process').item.json.rentprog_id || $('Parse & Validate Format').item.json.rentprogId, \"event\": $('Auto Process').item.json.event || $('Parse & Validate Format').item.json.rawEvent, \"branch\": $('Auto Process').item.json.branch || $('Parse & Validate Format').item.json.branch, \"entity_type\": $('Auto Process').item.json.entity_type || $('Parse & Validate Format').item.json.entityType } }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "trigger-upsert-node",
      "name": "Trigger Upsert Processor",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1250,
        200
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "sendMessage",
        "chatId": "={{ $env.TELEGRAM_ALERT_CHAT_ID }}",
        "text": "=â“ ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð²ÐµÐ±Ñ…ÑƒÐºÐ° Ð¾Ñ‚ RentProg\n\nÐ’Ñ€ÐµÐ¼Ñ: {{ $now }}\nBranch: {{ $json.branch }}\nÐ¢Ð¸Ð¿ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ: {{ $json.rawEvent }}\nRentProg ID: {{ $json.rentprogId }}\n\nÐžÑˆÐ¸Ð±ÐºÐ¸ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸:\n{{ $json.validationErrors && $json.validationErrors.length > 0 ? $json.validationErrors.join('\\n') : 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°' }}\n\nÐŸÐ¾Ð»Ð½Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ:\n{{ JSON.stringify($json, null, 2) }}",
        "additionalFields": {}
      },
      "id": "debug-unknown-node",
      "name": "Debug: Unknown Format",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        850,
        500
      ],
      "credentials": {
        "telegramApi": {
          "id": "1tKryXxL5Gq395nN",
          "name": "Telegram account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "sendMessage",
        "chatId": "={{ $env.TELEGRAM_ALERT_CHAT_ID }}",
        "text": "=ðŸš¨ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐÐ¯ ÐžÐ¨Ð˜Ð‘ÐšÐ Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð° Ð²ÐµÐ±Ñ…ÑƒÐºÐ° Ð¾Ñ‚ RentProg\n\nÐ’Ñ€ÐµÐ¼Ñ: {{ $now }}\nBranch: {{ $json.branch }}\nÐ¢Ð¸Ð¿ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ: {{ $json.rawEvent }}\nRentProg ID: {{ $json.rentprogId }}\n\nÐžÑˆÐ¸Ð±ÐºÐ°: {{ $json.errorMessage || 'Unknown error' }}\n\nÐžÑˆÐ¸Ð±ÐºÐ¸ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸:\n{{ $json.validationErrors && $json.validationErrors.length > 0 ? $json.validationErrors.join('\\n') : 'ÐÐµÑ‚ Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹' }}\n\nStack trace:\n{{ $json.errorStack || 'ÐÐµÑ‚ stack trace' }}\n\nÐŸÐ¾Ð»Ð½Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ:\n{{ JSON.stringify($json, null, 2) }}",
        "additionalFields": {}
      },
      "id": "alert-parse-error-node",
      "name": "Alert: Parse Error",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        650,
        600
      ],
      "credentials": {
        "telegramApi": {
          "id": "1tKryXxL5Gq395nN",
          "name": "Telegram account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "branch",
              "name": "branch",
              "value": "={{ $json.branch || 'unknown' }}",
              "type": "stringValue"
            },
            {
              "id": "type",
              "name": "type",
              "value": "={{ $json.eventType || 'unknown' }}",
              "type": "stringValue"
            },
            {
              "id": "rentprog_id",
              "name": "rentprog_id",
              "value": "={{ $json.rentprogId || 'unknown' }}",
              "type": "stringValue"
            },
            {
              "id": "ok",
              "name": "ok",
              "value": "={{ $json.parseError ? false : ($json.isKnownFormat !== undefined ? $json.isKnownFormat : ($json.body && $json.body.ok !== false ? true : false)) }}",
              "type": "booleanValue"
            },
            {
              "id": "reason",
              "name": "reason",
              "value": "={{ $json.parseError ? ('ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð°: ' + ($json.errorMessage || 'Unknown error')) : ($json.validationErrors && $json.validationErrors.length > 0 ? $json.validationErrors.join('; ') : ($json.body && $json.body.error ? $json.body.error : ($json.body && $json.body.reason ? $json.body.reason : 'ok'))) }}",
              "type": "stringValue"
            },
            {
              "id": "processed",
              "name": "processed",
              "value": "={{ $json.parseError ? false : ($('Auto Process').item && $('Auto Process').item.json && $('Auto Process').item.json.processed === true ? true : false) }}",
              "type": "booleanValue"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "id": "set-params-node",
      "name": "Set Query Params",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1450,
        400
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO events (ts, branch, type, rentprog_id, ok, reason, processed)\nVALUES (NOW(), $1, $2, $3, $4, $5, $6)\nON CONFLICT (branch, type, rentprog_id) DO NOTHING\nRETURNING id",
        "options": {
          "queryReplacement": "={{ $json.branch }},={{ $json.type }},={{ $json.rentprog_id }},={{ $json.ok }},={{ $json.reason }},={{ $json.processed }}"
        }
      },
      "id": "data-table-node",
      "name": "Save Event",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        1650,
        400
      ],
      "credentials": {
        "postgres": {
          "id": "3I9fyXVlGg4Vl4LZ",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"ok\": true, \"received\": true, \"processed\": $json.processed || false } }}",
        "options": {}
      },
      "id": "respond-node",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1850,
        400
      ],
      "onError": "continueRegularOutput"
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Parse & Validate Format",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse & Validate Format": {
      "main": [
        [
          {
            "node": "If Known Format",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "Alert: Parse Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Known Format": {
      "main": [
        [
          {
            "node": "Auto Process",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Debug: Unknown Format",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "Alert: Parse Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Auto Process": {
      "main": [
        [
          {
            "node": "If Needs Upsert",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "Alert: Parse Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Needs Upsert": {
      "main": [
        [
          {
            "node": "Trigger Upsert Processor",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Query Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trigger Upsert Processor": {
      "main": [
        [
          {
            "node": "Set Query Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug: Unknown Format": {
      "main": [
        [
          {
            "node": "Set Query Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Alert: Parse Error": {
      "main": [
        [
          {
            "node": "Set Query Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Query Params": {
      "main": [
        [
          {
            "node": "Save Event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Event": {
      "main": [
        [
          {
            "node": "Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}