# üìä –û–¢–ß–ï–¢: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –±—Ä–æ–Ω–µ–π

**–î–∞—Ç–∞:** 2025-11-19  
**–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä:** –ü—Ä–æ–≤–µ—Ä–∫–∞ workflow `‚úÖ–ü–∞—Ä—Å–∏–Ω–≥ –±—Ä–æ–Ω–µ–π RentProg (–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ, –ë–∞—Ç—É–º–∏)`  
**URL:** https://n8n.rentflow.rentals/workflow/FDMvu8P8DKilQTOK

---

## üî¥ –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ –ë–î (–∏—Å—Ö–æ–¥–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞)

**Execution #21983** –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π –≤ –Ω–æ–¥–µ "Save to DB":
```
there is no unique or exclusion constraint matching the ON CONFLICT specification
```

**–ü—Ä–∏—á–∏–Ω–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª UNIQUE constraint –Ω–∞ `(branch, number)` –≤ —Ç–∞–±–ª–∏—Ü–µ `bookings`.

**–†–µ—à–µ–Ω–∏–µ:** ‚úÖ –°–æ–∑–¥–∞–Ω constraint `bookings_branch_number_unique`

---

### 2. –î—É–±–ª–∏–∫–∞—Ç—ã –≤ —Ç–∞–±–ª–∏—Ü–µ bookings

**–ù–∞–π–¥–µ–Ω–æ:** 7 –≥—Ä—É–ø–ø –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (14 –∑–∞–ø–∏—Å–µ–π)
- batumi: 4001, 3939, 3967, 4032
- tbilisi: 3989, 4023, 3976

**–†–µ—à–µ–Ω–∏–µ:** ‚úÖ –£–¥–∞–ª–µ–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º:
1. State = '–ê–∫—Ç–∏–≤–Ω–∞—è' > '–ù–æ–≤–∞—è'
2. is_active = true > false
3. Newest created_at

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –£–¥–∞–ª–µ–Ω–æ 7 –∑–∞–ø–∏—Å–µ–π, –æ—Å—Ç–∞–≤–ª–µ–Ω—ã –Ω–∞–∏–±–æ–ª–µ–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ.

---

### 3. –ë—Ä–æ–Ω–∏ –±–µ–∑ `number` (–∫—Ä–∏—Ç–∏—á–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞)

**–ù–∞–π–¥–µ–Ω–æ:** 2 –∑–∞–ø–∏—Å–∏ –±–µ–∑ `number`:
- RentProg ID: 514715 | branch: 'unknown'
- RentProg ID: 514701 | branch: 'unknown'

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- –í—Å–µ –ø–æ–ª—è NULL –∫—Ä–æ–º–µ `rentprog_id`
- –°–æ–∑–¥–∞–Ω—ã: 19 Nov 2025, 08:18 –∏ 08:32 UTC
- –ù–µ—Ç external_refs

**–†–µ—à–µ–Ω–∏–µ:** ‚úÖ –£–¥–∞–ª–µ–Ω—ã –∫–∞–∫ –º—É—Å–æ—Ä–Ω—ã–µ –∑–∞–ø–∏—Å–∏

---

### 4. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤ workflow

**–ù–∞–π–¥–µ–Ω–æ:** 17 workflow –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç –Ω–∞–ª–∏—á–∏–µ `number` –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ workflow:**
- `_RentProg__Active_Bookings.json`
- `_RentProg__Inactive_Batumi.json`
- `_RentProg__Inactive_Tbilisi.json`
- `_RentProg__Inactive_Kutaisi_Service.json`
- `rentprog-bookings-current.json`
- `rentprog-bookings-latest.json`
- –ò –µ—â–µ 11...

**–†–µ—à–µ–Ω–∏–µ:** üìù –°–æ–∑–¥–∞–Ω –∫–æ–¥ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –∏ –∞–ª–µ—Ä—Ç–∞–º–∏

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î (–∑–∞–≤–µ—Ä—à–µ–Ω–æ)

**–§–∞–π–ª:** `setup/migrate_bookings_add_unique_constraint.mjs`

‚úÖ **–°–æ–∑–¥–∞–Ω UNIQUE constraint:**
```sql
ALTER TABLE bookings
ADD CONSTRAINT bookings_branch_number_unique 
UNIQUE (branch, number);
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 
- –£–¥–∞–ª–µ–Ω–æ 7 –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- Constraint —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω

---

### 2. –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î - NOT NULL (–∑–∞–≤–µ—Ä—à–µ–Ω–æ)

**–§–∞–π–ª:** `setup/migrate_bookings_enforce_number_not_null.mjs`

‚úÖ **–£–¥–∞–ª–µ–Ω—ã –ø–ª–æ—Ö–∏–µ –∑–∞–ø–∏—Å–∏:**
- 2 –±—Ä–æ–Ω–∏ –±–µ–∑ `number`

‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω—ã NOT NULL constraints:**
```sql
ALTER TABLE bookings
ALTER COLUMN number SET NOT NULL;

ALTER TABLE bookings
ALTER COLUMN branch SET NOT NULL;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ë–î —Ç–µ–ø–µ—Ä—å –Ω–µ –ø—Ä–∏–º–µ—Ç –∑–∞–ø–∏—Å–∏ –±–µ–∑ `number` –∏–ª–∏ `branch`
- UNIQUE constraint –≤—Å–µ–≥–¥–∞ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

### 3. –ö–æ–¥ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π (—Å–æ–∑–¥–∞–Ω)

**–§–∞–π–ª—ã:**
- `n8n-workflows/process-bookings-with-validation.js` - –£–ª—É—á—à–µ–Ω–Ω—ã–π –∫–æ–¥ –¥–ª—è Process All Bookings
- `n8n-workflows/send-skipped-bookings-alert.js` - –ö–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∞–ª–µ—Ä—Ç–æ–≤

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è `if (!number)` –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º  
‚úÖ –°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –±—Ä–æ–Ω–µ–π  
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ `rentprog_id` –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç  
‚úÖ –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–ª–µ—Ä—Ç–æ–≤ –¥–ª—è Telegram  

**Telegram –∞–ª–µ—Ä—Ç—ã:** –û—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ —á–∞—Ç `-1003484642420`

---

### 4. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (—Å–æ–∑–¥–∞–Ω–∞)

**–§–∞–π–ª:** `docs/FIX_BOOKINGS_VALIDATION.md`

–ü–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é workflow:
- –ü–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è 17 workflow

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –°—Ä–æ—á–Ω–æ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–¥–µ–ª–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è)

1. **–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ workflow (4 —à—Ç—É–∫–∏):**
   - [ ] `‚úÖ–ü–∞—Ä—Å–∏–Ω–≥ –±—Ä–æ–Ω–µ–π RentProg (–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ, –ë–∞—Ç—É–º–∏)` - FDMvu8P8DKilQTOK
   - [ ] `‚úÖ–ü–∞—Ä—Å–∏–Ω–≥ –±—Ä–æ–Ω–µ–π RentProg (–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ, –¢–±–∏–ª–∏—Å–∏)`
   - [ ] `‚úÖ–ü–∞—Ä—Å–∏–Ω–≥ –±—Ä–æ–Ω–µ–π RentProg (–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ, –ö—É—Ç–∞–∏—Å–∏)`
   - [ ] `‚úÖ–ü–∞—Ä—Å–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–æ–Ω–µ–π RentProg`

2. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ workflow:**
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –±—Ä–æ–Ω–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
   - –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –∞–ª–µ—Ä—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç

### –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ (–≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏)

3. **–û–±–Ω–æ–≤–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ 13 workflow**
   - –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–æ—Ç –∂–µ –∫–æ–¥
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

4. **–î–æ–±–∞–≤–∏—Ç—å external_refs –¥–ª—è –≤—Å–µ—Ö bookings**
   - –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –∫–∞–∂–¥–∞—è –±—Ä–æ–Ω—å –∏–º–µ–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ RentProg

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- –ë—Ä–æ–Ω–∏ –≤ –ë–î: 2140 (91 –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö)
- –î—É–±–ª–∏–∫–∞—Ç—ã: 7 –≥—Ä—É–ø–ø (14 –∑–∞–ø–∏—Å–µ–π)
- –ë–µ–∑ `number`: 2 –∑–∞–ø–∏—Å–∏
- –ë–µ–∑ external_refs: 5 –∑–∞–ø–∏—Å–µ–π
- Workflow –±–µ–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: 17

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- ‚úÖ –ë—Ä–æ–Ω–∏ –≤ –ë–î: 89 (–≤–∞–ª–∏–¥–Ω—ã–µ)
- ‚úÖ –î—É–±–ª–∏–∫–∞—Ç—ã: 0
- ‚úÖ –ë–µ–∑ `number`: 0 (–Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –∏–∑-–∑–∞ NOT NULL)
- ‚úÖ UNIQUE constraint: —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ö–æ–¥ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π: —Å–æ–∑–¥–∞–Ω
- ‚úÖ –ê–ª–µ—Ä—Ç—ã –≤ Telegram: –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã

---

## üîß –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### –ú–∏–≥—Ä–∞—Ü–∏–∏:
- `setup/migrate_bookings_add_unique_constraint.mjs` ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ
- `setup/migrate_bookings_enforce_number_not_null.mjs` ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ
- `setup/delete_bad_bookings.mjs` (–≤—Ö–æ–¥–∏—Ç –≤ migrate_bookings_enforce)
- `setup/add_bookings_number_not_null_check.mjs` (–≤—Ö–æ–¥–∏—Ç –≤ migrate_bookings_enforce)
- `setup/fix_bookings_duplicates.mjs` (–≤—Ö–æ–¥–∏—Ç –≤ migrate_bookings_add_unique)
- `setup/add_bookings_unique_constraint.mjs` (–≤—Ö–æ–¥–∏—Ç –≤ migrate_bookings_add_unique)

### –ö–æ–¥ –¥–ª—è workflow:
- `n8n-workflows/process-bookings-with-validation.js` ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
- `n8n-workflows/send-skipped-bookings-alert.js` ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:
- `docs/FIX_BOOKINGS_VALIDATION.md` üìö –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
- `SESSION_REPORT_BOOKINGS_VALIDATION_FIX.md` üìä –≠—Ç–æ—Ç –æ—Ç—á–µ—Ç

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ:
1. ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
2. ‚ö†Ô∏è **–û–±–Ω–æ–≤–∏—Ç—å workflow "‚úÖ–ü–∞—Ä—Å–∏–Ω–≥ –±—Ä–æ–Ω–µ–π RentProg (–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ, –ë–∞—Ç—É–º–∏)"**
   - –°–ª–µ–¥–æ–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ `docs/FIX_BOOKINGS_VALIDATION.md`
   - –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç –¥–∞–ª—å–Ω–µ–π—à–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### –í –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è:
3. –û–±–Ω–æ–≤–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ 3 –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö workflow
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É –∞–ª–µ—Ä—Ç–æ–≤

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ:
5. –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ 17 workflow
6. –î–æ–±–∞–≤–∏—Ç—å –∞–Ω–∞–ª–æ–≥–∏—á–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π (cars, clients)
7. –°–æ–∑–¥–∞—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö –±—É–¥—É—â–∏—Ö workflow

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [External Refs Pattern](./ARCHITECTURE.md#external-refs-pattern)
- [Best Practices –¥–ª—è n8n](./.cursorrules)
- [–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é](./docs/FIX_BOOKINGS_VALIDATION.md)

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, –∫–æ–¥ —Å–æ–∑–¥–∞–Ω, –æ–∂–∏–¥–∞–µ—Ç—Å—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫ workflow

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –û–±–Ω–æ–≤–∏—Ç—å workflow —Å–æ–≥–ª–∞—Å–Ω–æ `docs/FIX_BOOKINGS_VALIDATION.md`

