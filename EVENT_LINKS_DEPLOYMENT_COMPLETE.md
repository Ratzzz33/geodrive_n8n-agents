# ‚úÖ Event Links - –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω

**–î–∞—Ç–∞:** 2025-11-09  
**–í—Ä–µ–º—è:** ~16:13 UTC+4  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ

---

## üéâ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î –ø—Ä–∏–º–µ–Ω–µ–Ω–∞

‚úÖ –¢–∞–±–ª–∏—Ü–∞ `event_links` —Å–æ–∑–¥–∞–Ω–∞  
‚úÖ 10 –∏–Ω–¥–µ–∫—Å–æ–≤ —Å–æ–∑–¥–∞–Ω–æ  
‚úÖ 2 SQL Views —Å–æ–∑–¥–∞–Ω—ã:
   - `event_links_stats` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–≤—è–∑–µ–π
   - `unlinked_records` - –Ω–µ—Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏

### 2. –ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω

‚úÖ –°—Ö–µ–º–∞ Drizzle ORM (`src/db/schema.ts`)  
‚úÖ –§—É–Ω–∫—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è (`src/db/eventLinks.ts`)  
‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π (`src/db/payments.ts`)  
‚úÖ API endpoints (`src/api/routes/eventLinks.ts`)  
‚úÖ –†–æ—É—Ç–µ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ API —Å–µ—Ä–≤–µ—Ä—É

### 3. API –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω

‚úÖ TypeScript —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω  
‚úÖ API —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω  
‚úÖ Health check —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## üì° –î–æ—Å—Ç—É–ø–Ω—ã–µ API Endpoints

### POST `/event-links/payment/:paymentId`
–°–≤—è–∑–∞—Ç—å –ø–ª–∞—Ç–µ–∂ —Å events –∏ history

### POST `/event-links/event/:eventId`
–°–≤—è–∑–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ —Å payments –∏ history

### GET `/event-links/payment/:paymentId`
–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å–≤—è–∑–∏ –¥–ª—è –ø–ª–∞—Ç–µ–∂–∞

### GET `/event-links/stats`
–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–≤—è–∑–µ–π

### GET `/event-links/unlinked`
–ù–µ—Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π

---

## üîÑ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ

–ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ `savePaymentFromRentProg()`:

1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—â–µ—Ç—Å—è —Å–æ–±—ã—Ç–∏–µ –≤ `events` –ø–æ:
   - `entity_type = 'payment'`
   - `rentprog_id = rpPaymentId`
   - `company_id` (—Ñ–∏–ª–∏–∞–ª)
   - –í—Ä–µ–º—è –≤ –æ–∫–Ω–µ ¬±5 –º–∏–Ω—É—Ç

2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—â–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ `history` –ø–æ:
   - `branch`
   - `entity_type = 'payment'`
   - `entity_id = rpPaymentId`
   - –í—Ä–µ–º—è –≤ –æ–∫–Ω–µ ¬±5 –º–∏–Ω—É—Ç

3. –°–æ–∑–¥–∞–µ—Ç—Å—è —Å–≤—è–∑—å –≤ `event_links` —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏:
   - `link_type` - —Ç–∏–ø —Å–≤—è–∑–∏
   - `confidence` - —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å (high/medium/low)
   - `matched_by` - 'auto'

---

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–≤—è–∑–µ–π:
```bash
curl http://localhost:3000/event-links/stats
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ—Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏:
```bash
curl http://localhost:3000/event-links/unlinked
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤—è–∑–∏ –¥–ª—è –ø–ª–∞—Ç–µ–∂–∞:
```bash
curl http://localhost:3000/event-links/payment/{paymentId}
```

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
2. ‚úÖ API –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω
3. ‚è≥ –î–æ–∂–¥–∞—Ç—å—Å—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è
4. ‚è≥ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–µ—Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è –º–µ–∂–¥—É `events`, `payments` –∏ `history` –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!

–ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ workflow "–ü–∞—Ä—Å–∏–Ω–≥ –∫–∞—Å—Å –∫–æ–º–ø–∞–Ω–∏–∏ —Ä–∞–∑ –≤ 3 –º–∏–Ω—É—Ç—ã" –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç—Å—è —Å–≤—è–∑—å –≤ —Ç–∞–±–ª–∏—Ü–µ `event_links`.

