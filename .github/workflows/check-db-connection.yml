name: Check DB Connection

on:
  workflow_dispatch:
  repository_dispatch:
    types: [check-db]

jobs:
  check-db:
    name: Test database connection
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts || true

      - name: Test DB connection
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER || 'root' }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} << 'EOF'
            cd /root/geodrive_n8n-agents
            
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é DATABASE_URL..."
            source .env 2>/dev/null || true
            
            if [ -z "$DATABASE_URL" ]; then
              echo "‚ùå DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
              exit 1
            fi
            
            # –ú–∞—Å–∫–∏—Ä—É–µ–º –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—ã–≤–æ–¥–∞
            MASKED_URL=$(echo "$DATABASE_URL" | sed 's/:[^:@]*@/:***@/')
            echo "DATABASE_URL: $MASKED_URL"
            
            echo ""
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é –ª–æ–≥–∏ –±–æ—Ç–∞ –Ω–∞ –æ—à–∏–±–∫–∏ –ë–î..."
            if [ -f /root/bot.log ]; then
              echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å—Ç—Ä–æ–∫ —Å –æ—à–∏–±–∫–∞–º–∏ –ë–î:"
              tail -n 100 /root/bot.log | grep -i -A 5 -B 5 "database\|db\|connection\|error\|ssl" || echo "–ù–µ—Ç –æ—à–∏–±–æ–∫ –ë–î –≤ –ª–æ–≥–∞—Ö"
            fi
            
            echo ""
            echo "üîç –¢–µ—Å—Ç–∏—Ä—É—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —á–µ—Ä–µ–∑ Node.js..."
            node << NODE_SCRIPT
              const postgres = require('postgres');
              const url = process.env.DATABASE_URL || '';
              
              console.log('–î–ª–∏–Ω–∞ DATABASE_URL:', url.length);
              console.log('–ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å:', url.substring(0, 20));
              
              if (!url) {
                console.error('‚ùå DATABASE_URL –ø—É—Å—Ç–æ–π');
                process.exit(1);
              }
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ sslmode
              const hasSslMode = url.includes('sslmode=');
              console.log('sslmode –≤ URL:', hasSslMode ? '–µ—Å—Ç—å' : '–Ω–µ—Ç');
              
              const options = {
                max: 1,
              };
              
              if (!hasSslMode) {
                options.ssl = { rejectUnauthorized: false };
                console.log('–î–æ–±–∞–≤–ª—è—é SSL –æ–ø—Ü–∏—é');
              }
              
              console.log('–ü—Ä–æ–±—É—é –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è...');
              
              (async () => {
                try {
                  const sql = postgres(url, options);
                  await sql\`SELECT 1\`;
                  console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —É—Å–ø–µ—à–Ω–æ!');
                  await sql.end();
                  process.exit(0);
                } catch (error) {
                  console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error.message);
                  if (error.stack) {
                    console.error('Stack:', error.stack);
                  }
                  if (error.cause) {
                    console.error('Cause:', error.cause);
                  }
                  process.exit(1);
                }
              })();
NODE_SCRIPT
          EOF

