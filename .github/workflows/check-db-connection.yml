name: Check DB Connection

on:
  workflow_dispatch:
  repository_dispatch:
    types: [check-db]

jobs:
  check-db:
    name: Test database connection
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts || true

      - name: Test DB connection
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER || 'root' }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} << 'EOF'
            cd /root/geodrive_n8n-agents
            
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é DATABASE_URL..."
            source .env 2>/dev/null || true
            
            if [ -z "$DATABASE_URL" ]; then
              echo "‚ùå DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
              exit 1
            fi
            
            # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è Node.js —Å–∫—Ä–∏–ø—Ç–∞
            export DATABASE_URL
            
            # –ú–∞—Å–∫–∏—Ä—É–µ–º –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—ã–≤–æ–¥–∞
            MASKED_URL=$(echo "$DATABASE_URL" | sed 's/:[^:@]*@/:***@/')
            echo "DATABASE_URL: $MASKED_URL"
            
            echo ""
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é –ª–æ–≥–∏ –±–æ—Ç–∞ –Ω–∞ –æ—à–∏–±–∫–∏ –ë–î..."
            if [ -f /root/bot.log ]; then
              echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å—Ç—Ä–æ–∫ —Å –æ—à–∏–±–∫–∞–º–∏ –ë–î:"
              tail -n 100 /root/bot.log | grep -i -A 5 -B 5 "database\|db\|connection\|error\|ssl" || echo "–ù–µ—Ç –æ—à–∏–±–æ–∫ –ë–î –≤ –ª–æ–≥–∞—Ö"
            fi
            
            echo ""
            echo "üîç –¢–µ—Å—Ç–∏—Ä—É—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —á–µ—Ä–µ–∑ Node.js..."
            # –ó–∞–ø—É—Å–∫–∞–µ–º –≤–Ω–µ—à–Ω–∏–π —Å–∫—Ä–∏–ø—Ç –≤–º–µ—Å—Ç–æ heredoc
            node scripts/node/test-db-connection.js
          EOF

