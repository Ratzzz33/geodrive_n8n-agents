name: Validate Workflows

on:
  push:
    paths:
      - '.github/workflows/*.yml'
      - '.github/workflows/*.yaml'
      - 'setup/validate_workflows.py'
      - 'scripts/node/*.js'
  pull_request:
    paths:
      - '.github/workflows/*.yml'
      - '.github/workflows/*.yaml'
      - 'setup/validate_workflows.py'
      - 'scripts/node/*.js'
  workflow_dispatch:

jobs:
  validate:
    name: Validate workflow files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Python dependencies
        run: |
          pip install pyyaml
      
      - name: Install actionlint
        run: |
          echo "üì• –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é actionlint..."
          wget -q https://github.com/rhysd/actionlint/releases/latest/download/actionlint_linux_amd64.tar.gz
          tar -xzf actionlint_linux_amd64.tar.gz
          sudo mv actionlint /usr/local/bin/
          actionlint -version
      
      - name: Validate all workflows
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é –≤—Å–µ workflow —Ñ–∞–π–ª—ã..."
          python setup/validate_workflows.py --verbose
      
      - name: Check for nested heredoc patterns
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é –Ω–∞–ª–∏—á–∏–µ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö heredoc..."
          
          # –ò—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö heredoc (–∏—Å–∫–ª—é—á–∞—è —ç—Ç–æ—Ç —Ñ–∞–π–ª)
          FOUND=0
          for file in .github/workflows/*.yml; do
            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∞–º –≤–∞–ª–∏–¥–∞—Ç–æ—Ä, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å–∞–º–æ—Ä–µ—Ñ–µ—Ä–µ–Ω—Ü–∏–∏
            if [ "$file" = ".github/workflows/validate-workflows.yml" ]; then
              continue
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö heredoc
            if grep -q "<<.*EOF" "$file" && grep -q "<<.*NODE_SCRIPT" "$file"; then
              echo "‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –≤–ª–æ–∂–µ–Ω–Ω—ã–µ heredoc –≤ $file"
              FOUND=1
            fi
          done
          
          if [ $FOUND -eq 1 ]; then
            echo ""
            echo "üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –≤—ã–Ω–µ—Å–∏—Ç–µ JavaScript –∫–æ–¥ –≤ scripts/node/"
            exit 1
          else
            echo "‚úÖ –í–ª–æ–∂–µ–Ω–Ω—ã–µ heredoc –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã"
          fi
      
      - name: Verify Node.js scripts exist
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é –Ω–∞–ª–∏—á–∏–µ Node.js —Å–∫—Ä–∏–ø—Ç–æ–≤..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Å–∫—Ä–∏–ø—Ç—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
          MISSING=0
          
          if grep -q "validate-rentprog-keys.js" .github/workflows/*.yml; then
            if [ -f "scripts/node/validate-rentprog-keys.js" ]; then
              echo "‚úÖ validate-rentprog-keys.js –Ω–∞–π–¥–µ–Ω"
            else
              echo "‚ùå validate-rentprog-keys.js –Ω–µ –Ω–∞–π–¥–µ–Ω"
              MISSING=1
            fi
          fi
          
          if grep -q "check-env-dotenv.js" .github/workflows/*.yml; then
            if [ -f "scripts/node/check-env-dotenv.js" ]; then
              echo "‚úÖ check-env-dotenv.js –Ω–∞–π–¥–µ–Ω"
            else
              echo "‚ùå check-env-dotenv.js –Ω–µ –Ω–∞–π–¥–µ–Ω"
              MISSING=1
            fi
          fi
          
          if grep -q "test-db-connection.js" .github/workflows/*.yml; then
            if [ -f "scripts/node/test-db-connection.js" ]; then
              echo "‚úÖ test-db-connection.js –Ω–∞–π–¥–µ–Ω"
            else
              echo "‚ùå test-db-connection.js –Ω–µ –Ω–∞–π–¥–µ–Ω"
              MISSING=1
            fi
          fi
          
          if [ $MISSING -eq 1 ]; then
            echo ""
            echo "‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç!"
            exit 1
          else
            echo ""
            echo "‚úÖ –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç"
          fi
      
      - name: Summary
        if: success()
        run: |
          echo ""
          echo "=========================================="
          echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ workflow –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
          echo "=========================================="
          echo ""
          echo "–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:"
          echo "  ‚Ä¢ YAML —Å–∏–Ω—Ç–∞–∫—Å–∏—Å"
          echo "  ‚Ä¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ workflow"
          echo "  ‚Ä¢ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö heredoc"
          echo "  ‚Ä¢ –ù–∞–ª–∏—á–∏–µ –≤–Ω–µ—à–Ω–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤"
          echo "  ‚Ä¢ actionlint –≤–∞–ª–∏–¥–∞—Ü–∏—è"

