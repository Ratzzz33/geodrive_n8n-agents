name: Restore Missing ENV Variables

on:
  workflow_dispatch:
    inputs:
      umnico_api_token:
        description: 'Umnico API Token (optional)'
        required: false
        type: string
      umnico_api_url:
        description: 'Umnico API URL (optional)'
        required: false
        type: string
      stripe_api_key:
        description: 'Stripe API Key (optional)'
        required: false
        type: string

jobs:
  restore:
    name: Restore missing env variables
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts || true

      - name: Restore variables
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER || 'root' }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
          UMNICO_API_TOKEN: ${{ github.event.inputs.umnico_api_token }}
          UMNICO_API_URL: ${{ github.event.inputs.umnico_api_url }}
          STRIPE_API_KEY: ${{ github.event.inputs.stripe_api_key }}
        run: |
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} << EOF
            cd /root/geodrive_n8n-agents
            
            echo "üìã –ü—Ä–æ–≤–µ—Ä—è—é –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ..."
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ Umnico
            if [ ! -z "$UMNICO_API_TOKEN" ]; then
              if grep -q "^UMNICO_API_TOKEN=" .env; then
                echo "‚ö†Ô∏è UMNICO_API_TOKEN —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ–±–Ω–æ–≤–ª—è—é..."
                sed -i '/^UMNICO_API_TOKEN=/d' .env
              fi
              printf 'UMNICO_API_TOKEN=%s\n' "$UMNICO_API_TOKEN" >> .env
              echo "‚úÖ UMNICO_API_TOKEN –¥–æ–±–∞–≤–ª–µ–Ω"
            elif ! grep -q "^UMNICO_API_TOKEN=" .env; then
              echo "‚ö†Ô∏è UMNICO_API_TOKEN –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ workflow)"
            fi
            
            if [ ! -z "$UMNICO_API_URL" ]; then
              if grep -q "^UMNICO_API_URL=" .env; then
                sed -i '/^UMNICO_API_URL=/d' .env
              fi
              printf 'UMNICO_API_URL=%s\n' "$UMNICO_API_URL" >> .env
              echo "‚úÖ UMNICO_API_URL –¥–æ–±–∞–≤–ª–µ–Ω"
            fi
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ Stripe
            if [ ! -z "$STRIPE_API_KEY" ]; then
              if grep -q "^STRIPE_API_KEY=" .env; then
                echo "‚ö†Ô∏è STRIPE_API_KEY —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ–±–Ω–æ–≤–ª—è—é..."
                sed -i '/^STRIPE_API_KEY=/d' .env
              fi
              printf 'STRIPE_API_KEY=%s\n' "$STRIPE_API_KEY" >> .env
              echo "‚úÖ STRIPE_API_KEY –¥–æ–±–∞–≤–ª–µ–Ω"
            elif ! grep -q "^STRIPE_API_KEY=" .env; then
              echo "‚ö†Ô∏è STRIPE_API_KEY –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ workflow)"
            fi
            
            echo ""
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é –±–æ—Ç–∞..."
            pkill -9 -f "tsx.*index.ts" || pkill -9 -f "node.*dist/index.js" || true
            sleep 3
            
            export PATH="/root/.local/bin:/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin:\$PATH"
            if [ -f ~/.bashrc ]; then source ~/.bashrc; fi
            if [ -f ~/.profile ]; then source ~/.profile; fi
            
            NODE_CMD=\$(command -v node || echo "")
            NPM_CMD=\$(command -v npm || echo "")
            
            if [ ! -z "\$NPM_CMD" ]; then
              cd /root/geodrive_n8n-agents
              nohup bash -c "cd /root/geodrive_n8n-agents && export PATH='/root/.local/bin:/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin:\$PATH' && [ -f ~/.bashrc ] && source ~/.bashrc; [ -f ~/.profile ] && source ~/.profile; npm run dev" > /root/bot.log 2>&1 &
            elif [ -f "node_modules/.bin/tsx" ]; then
              NODE_BIN=\$(find /usr -name "node" -type f 2>/dev/null | head -1 || find /opt -name "node" -type f 2>/dev/null || echo "node")
              cd /root/geodrive_n8n-agents
              nohup bash -c "cd /root/geodrive_n8n-agents && export PATH='/root/.local/bin:/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin:\$PATH' && [ -f ~/.bashrc ] && source ~/.bashrc; \$NODE_BIN ./node_modules/.bin/tsx watch src/index.ts" > /root/bot.log 2>&1 &
            fi
            
            sleep 8
            echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–æ–≤:"
            tail -n 15 /root/bot.log || echo "–õ–æ–≥–∏ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã"
          EOF
