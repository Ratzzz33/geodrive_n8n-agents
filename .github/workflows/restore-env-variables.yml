name: Restore ENV Variables

on:
  workflow_dispatch:

jobs:
  restore-env:
    name: Restore missing variables from env.example
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts || true

      - name: Restore missing variables
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER || 'root' }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} << 'EOF'
            cd /root/geodrive_n8n-agents
            
            echo "üìã –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ env.example..."
            
            # –°–æ–∑–¥–∞–µ–º backup —Ç–µ–∫—É—â–µ–≥–æ .env
            if [ -f .env ]; then
              cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
              echo "‚úÖ –°–æ–∑–¥–∞–Ω backup: .env.backup.$(date +%Y%m%d_%H%M%S)"
            fi
            
            # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –Ω–æ–≤–æ–≥–æ .env
            TEMP_ENV=$(mktemp)
            
            # –ï—Å–ª–∏ .env —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∫–æ–ø–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            if [ -f .env ]; then
              cp .env "$TEMP_ENV"
            fi
            
            # –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ env.example
            if [ -f env.example ]; then
              while IFS= read -r line; do
                # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
                if [[ ! "$line" =~ ^[[:space:]]*# ]] && [[ ! -z "${line// }" ]]; then
                  if [[ "$line" =~ ^([A-Z_][A-Z0-9_]*)= ]]; then
                    var_name="${BASH_REMATCH[1]}"
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —ç—Ç–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –≤ .env
                    if ! grep -q "^${var_name}=" "$TEMP_ENV"; then
                      echo "‚ûï –î–æ–±–∞–≤–ª—è—é: $var_name"
                      echo "$line" >> "$TEMP_ENV"
                    fi
                  fi
                fi
              done < env.example
            fi
            
            # –ó–∞–º–µ–Ω—è–µ–º .env –Ω–æ–≤—ã–º —Ñ–∞–π–ª–æ–º
            mv "$TEMP_ENV" .env
            
            echo ""
            echo "‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
            echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞:"
            var_count=$(grep -c "^[A-Z_][A-Z0-9_]*=" .env || echo "0")
            echo "–í—Å–µ–≥–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: $var_count"
            
            echo ""
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é –±–æ—Ç–∞..."
            pkill -9 -f "tsx.*index.ts" || pkill -9 -f "node.*dist/index.js" || true
            sleep 3
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ
            export PATH="/root/.local/bin:/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin:\$PATH"
            if [ -f ~/.bashrc ]; then source ~/.bashrc; fi
            if [ -f ~/.profile ]; then source ~/.profile; fi
            
            # –£–¥–∞–ª—è–µ–º webhook
            source .env 2>/dev/null || true
            if [ ! -z "\$TELEGRAM_BOT_TOKEN" ]; then
              curl -s "https://api.telegram.org/bot\${TELEGRAM_BOT_TOKEN}/deleteWebhook?drop_pending_updates=true" > /dev/null
            fi
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
            rm -f /root/bot.log
            nohup bash -c "cd /root/geodrive_n8n-agents && export PATH='/root/.local/bin:/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin:\$PATH' && [ -f ~/.bashrc ] && source ~/.bashrc; [ -f ~/.profile ] && source ~/.profile; npm run dev" > /root/bot.log 2>&1 &
            
            echo "‚è≥ –ñ–¥—É –∑–∞–ø—É—Å–∫–∞..."
            sleep 8
            
            echo ""
            echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤:"
            tail -n 20 /root/bot.log || echo "–õ–æ–≥ –ø—É—Å—Ç"
          EOF

