name: Test RentProg Token Fetching

on:
  workflow_dispatch:

jobs:
  test-tokens:
    name: Test token fetching for each branch
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts || true

      - name: Test token fetching
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER || 'root' }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} << 'EOF'
            cd /root/geodrive_n8n-agents
            
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é RENTPROG_BRANCH_KEYS..."
            source .env 2>/dev/null || true
            
            if [ -z "$RENTPROG_BRANCH_KEYS" ]; then
              echo "‚ùå RENTPROG_BRANCH_KEYS –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
              exit 1
            fi
            
            # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è Node.js —Å–∫—Ä–∏–ø—Ç–∞
            export RENTPROG_BRANCH_KEYS
            export RENTPROG_BASE_URL=${RENTPROG_BASE_URL:-https://rentprog.net/api/v1/public}
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –≤–Ω–µ—à–Ω–∏–π —Å–∫—Ä–∏–ø—Ç –≤–º–µ—Å—Ç–æ heredoc
            node scripts/node/validate-rentprog-keys.js
          EOF

