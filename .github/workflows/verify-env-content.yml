name: Verify ENV Content

on:
  workflow_dispatch:

jobs:
  verify:
    name: Verify .env content on server
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts || true

      - name: Verify .env
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER || 'root' }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} << 'EOF'
            cd /root/geodrive_n8n-agents
            
            echo "üìã –ü—Ä–æ–≤–µ—Ä—è—é —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ .env —Ñ–∞–π–ª–∞..."
            echo ""
            
            if [ ! -f .env ]; then
              echo "‚ùå –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω!"
              exit 1
            fi
            
            echo "‚úÖ –§–∞–π–ª .env –Ω–∞–π–¥–µ–Ω"
            echo ""
            echo "üìä –°—Ç—Ä–æ–∫–∏ —Å DATABASE_URL:"
            grep "DATABASE_URL" .env || echo "DATABASE_URL –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env"
            
            echo ""
            echo "üìè –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º–≤–æ–ª–æ–≤ –≤ —Å—Ç—Ä–æ–∫–µ DATABASE_URL:"
            DATABASE_LINE=$(grep "^DATABASE_URL=" .env || echo "")
            if [ ! -z "$DATABASE_LINE" ]; then
              echo "–°—Ç—Ä–æ–∫–∞: ${DATABASE_LINE:0:80}..."
              echo "–î–ª–∏–Ω–∞: ${#DATABASE_LINE} —Å–∏–º–≤–æ–ª–æ–≤"
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—É—Å—Ç–æ–µ –ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ
              VALUE=$(echo "$DATABASE_LINE" | cut -d'=' -f2-)
              if [ -z "$VALUE" ] || [ "$VALUE" = '""' ] || [ "$VALUE" = "''" ]; then
                echo "‚ùå –ó–Ω–∞—á–µ–Ω–∏–µ DATABASE_URL –ø—É—Å—Ç–æ–µ –∏–ª–∏ –≤ –∫–∞–≤—ã—á–∫–∞—Ö!"
              else
                echo "‚úÖ –ó–Ω–∞—á–µ–Ω–∏–µ DATABASE_URL –µ—Å—Ç—å (–ø–µ—Ä–≤—ã–µ 50 —Å–∏–º–≤–æ–ª–æ–≤): ${VALUE:0:50}..."
              fi
            else
              echo "‚ùå –°—Ç—Ä–æ–∫–∞ DATABASE_URL –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            fi
            
            echo ""
            echo "üîç –¢–µ—Å—Ç–∏—Ä—É—é –∑–∞–≥—Ä—É–∑–∫—É —á–µ—Ä–µ–∑ Node.js dotenv:"
            node << NODE_SCRIPT
              const dotenv = require('dotenv');
              const fs = require('fs');
              
              console.log('–¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:', process.cwd());
              console.log('–§–∞–π–ª .env —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:', fs.existsSync('.env'));
              
              if (fs.existsSync('.env')) {
                const envContent = fs.readFileSync('.env', 'utf8');
                const dbLine = envContent.split('\n').find(line => line.startsWith('DATABASE_URL='));
                console.log('–°—Ç—Ä–æ–∫–∞ DATABASE_URL –∏–∑ —Ñ–∞–π–ª–∞:', dbLine ? dbLine.substring(0, 80) + '...' : '–Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                
                const result = dotenv.config();
                if (result.error) {
                  console.error('‚ùå –û—à–∏–±–∫–∞ dotenv:', result.error.message);
                } else {
                  console.log('‚úÖ dotenv.config() —É—Å–ø–µ—à–Ω–æ');
                }
                
                console.log('process.env.DATABASE_URL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', !!process.env.DATABASE_URL);
                if (process.env.DATABASE_URL) {
                  const masked = process.env.DATABASE_URL.replace(/:[^:@]+@/, ':***@');
                  console.log('–ó–Ω–∞—á–µ–Ω–∏–µ (–ø–µ—Ä–≤—ã–µ 50 —Å–∏–º–≤–æ–ª–æ–≤):', masked.substring(0, 50) + '...');
                  console.log('–î–ª–∏–Ω–∞ –∑–Ω–∞—á–µ–Ω–∏—è:', process.env.DATABASE_URL.length);
                } else {
                  console.log('‚ùå process.env.DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                }
              }
NODE_SCRIPT
          EOF

