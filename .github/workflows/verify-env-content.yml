name: Verify ENV Content

on:
  workflow_dispatch:

jobs:
  verify:
    name: Verify .env content on server
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts || true

      - name: Verify .env
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER || 'root' }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} << 'EOF'
            cd /root/geodrive_n8n-agents
            
            echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑŽ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ .env Ñ„Ð°Ð¹Ð»Ð°..."
            echo ""
            
            if [ ! -f .env ]; then
              echo "âŒ Ð¤Ð°Ð¹Ð» .env Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
              exit 1
            fi
            
            echo "âœ… Ð¤Ð°Ð¹Ð» .env Ð½Ð°Ð¹Ð´ÐµÐ½"
            echo ""
            echo "ðŸ“Š Ð¡Ñ‚Ñ€Ð¾ÐºÐ¸ Ñ DATABASE_URL:"
            grep "DATABASE_URL" .env || echo "DATABASE_URL Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² .env"
            
            echo ""
            echo "ðŸ“ ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð² Ð² ÑÑ‚Ñ€Ð¾ÐºÐµ DATABASE_URL:"
            DATABASE_LINE=$(grep "^DATABASE_URL=" .env || echo "")
            if [ ! -z "$DATABASE_LINE" ]; then
              echo "Ð¡Ñ‚Ñ€Ð¾ÐºÐ°: ${DATABASE_LINE:0:80}..."
              echo "Ð”Ð»Ð¸Ð½Ð°: ${#DATABASE_LINE} ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²"
              # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð½Ðµ Ð¿ÑƒÑÑ‚Ð¾Ðµ Ð»Ð¸ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ
              VALUE=$(echo "$DATABASE_LINE" | cut -d'=' -f2-)
              if [ -z "$VALUE" ] || [ "$VALUE" = '""' ] || [ "$VALUE" = "''" ]; then
                echo "âŒ Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ DATABASE_URL Ð¿ÑƒÑÑ‚Ð¾Ðµ Ð¸Ð»Ð¸ Ð² ÐºÐ°Ð²Ñ‹Ñ‡ÐºÐ°Ñ…!"
              else
                echo "âœ… Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ DATABASE_URL ÐµÑÑ‚ÑŒ (Ð¿ÐµÑ€Ð²Ñ‹Ðµ 50 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²): ${VALUE:0:50}..."
              fi
            else
              echo "âŒ Ð¡Ñ‚Ñ€Ð¾ÐºÐ° DATABASE_URL Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°"
            fi
            
            echo ""
            echo "ðŸ” Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÑŽ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ Ñ‡ÐµÑ€ÐµÐ· Node.js dotenv:"
            # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð²Ð½ÐµÑˆÐ½Ð¸Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð²Ð¼ÐµÑÑ‚Ð¾ heredoc
            node scripts/node/check-env-dotenv.js
          EOF

