name: Restart Bot on Server

on:
  workflow_dispatch:
  repository_dispatch:
    types: [restart-bot]

jobs:
  restart-bot:
    name: Restart bot on Hetzner
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts || true

      - name: Restart bot on server
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER || 'root' }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} << 'EOF'
            set -e
            cd /root/geodrive_n8n-agents
            
            echo "üì• –û–±–Ω–æ–≤–ª—è—é –∫–æ–¥..."
            git pull origin master || git pull origin main || true
            
            echo "üîÑ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –±–æ—Ç–∞..."
            pkill -9 -f "tsx.*index.ts" || pkill -9 -f "node.*dist/index.js" || true
            sleep 3
            
            echo "üîß –£–¥–∞–ª—è—é webhook —á–µ—Ä–µ–∑ Telegram API..."
            source .env 2>/dev/null || true
            if [ ! -z "$TELEGRAM_BOT_TOKEN" ]; then
              curl -s "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/deleteWebhook?drop_pending_updates=true"
              echo ""
            fi
            
            echo "üßπ –û—á–∏—â–∞—é –ª–æ–≥–∏..."
            rm -f /root/bot.log
            
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ –ø—É—Ç–∏..."
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ
            if [ -f ~/.bashrc ]; then source ~/.bashrc; fi
            if [ -f ~/.profile ]; then source ~/.profile; fi
            if [ -f ~/.bash_profile ]; then source ~/.bash_profile; fi
            export PATH="/root/.local/bin:/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin:$PATH"
            
            # –ï—Å–ª–∏ –µ—Å—Ç—å nvm
            if [ -d "/root/.nvm" ]; then
              export NVM_DIR="/root/.nvm"
              [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º node –∏ npm
            NODE_CMD=$(command -v node || echo "")
            NPM_CMD=$(command -v npm || echo "")
            
            # –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ npx –∏–ª–∏ tsx –Ω–∞–ø—Ä—è–º—É—é
            if [ -z "$NODE_CMD" ]; then
              echo "‚ö†Ô∏è Node.js –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ PATH, –ø—Ä–æ–±—É—é —á–µ—Ä–µ–∑ npx/tsx..."
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ node_modules/.bin
              if [ -f "/root/geodrive_n8n-agents/node_modules/.bin/tsx" ]; then
                echo "‚úÖ –ù–∞–π–¥–µ–Ω tsx –≤ node_modules"
                NODE_CMD="node"  # tsx —Å–∞–º –Ω–∞–π–¥–µ—Ç node
              fi
            fi
            
            echo "Node: ${NODE_CMD:-–Ω–µ –Ω–∞–π–¥–µ–Ω}"
            echo "npm: ${NPM_CMD:-–Ω–µ –Ω–∞–π–¥–µ–Ω}"
            
            # –ï—Å–ª–∏ Node.js –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—ã—Ç–∞–µ–º—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
            if [ -z "$NODE_CMD" ]; then
              echo "üì¶ Node.js –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–±—É—é —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å..."
              if curl -fsSL https://deb.nodesource.com/setup_18.x | bash -; then
                apt-get install -y nodejs || true
                # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ
                export PATH="/usr/local/bin:/usr/bin:/bin:$PATH"
                NODE_CMD=$(command -v node || echo "")
                NPM_CMD=$(command -v npm || echo "")
                echo "–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ - Node: ${NODE_CMD:-–Ω–µ –Ω–∞–π–¥–µ–Ω}, npm: ${NPM_CMD:-–Ω–µ –Ω–∞–π–¥–µ–Ω}"
              else
                echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Node.js –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
              fi
            fi
            
            # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
            cd /root/geodrive_n8n-agents
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
            if [ ! -d "node_modules" ] || [ ! -f "node_modules/.bin/tsx" ]; then
              echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
              export PATH="/root/.local/bin:/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin:$PATH"
              npm install || echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
            fi
            
            if [ ! -z "$NPM_CMD" ]; then
              echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é —á–µ—Ä–µ–∑ npm..."
              nohup bash -c "cd /root/geodrive_n8n-agents && export PATH='/root/.local/bin:/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin:\$PATH' && [ -f ~/.bashrc ] && source ~/.bashrc; [ -f ~/.profile ] && source ~/.profile; npm run dev" > /root/bot.log 2>&1 &
            elif [ -f "node_modules/.bin/tsx" ]; then
              echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é —á–µ—Ä–µ–∑ tsx –Ω–∞–ø—Ä—è–º—É—é..."
              # tsx —Ç—Ä–µ–±—É–µ—Ç node, –Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ –æ–Ω –µ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ –Ω–µ –≤ PATH
              NODE_BIN=$(find /usr -name "node" -type f 2>/dev/null | head -1 || find /opt -name "node" -type f 2>/dev/null | head -1 || echo "node")
              nohup bash -c "cd /root/geodrive_n8n-agents && export PATH='/root/.local/bin:/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin:\$PATH' && [ -f ~/.bashrc ] && source ~/.bashrc; $NODE_BIN ./node_modules/.bin/tsx watch src/index.ts" > /root/bot.log 2>&1 &
            else
              echo "‚ùå npm –∏ tsx –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js –Ω–µ —É–¥–∞–ª–∞—Å—å."
              echo "üí° –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Node.js –≤—Ä—É—á–Ω—É—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
              exit 1
            fi
            
            echo "‚è≥ –ñ–¥—É –∑–∞–ø—É—Å–∫–∞..."
            sleep 5
            
            echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤:"
            tail -n 30 /root/bot.log || echo "–õ–æ–≥ —Ñ–∞–π–ª –ø—É—Å—Ç –∏–ª–∏ –Ω–µ —Å–æ–∑–¥–∞–Ω"
            
            echo ""
            echo "‚úÖ –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω!"
          EOF

      - name: Verify bot is running
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER || 'root' }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          sleep 3
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} "ps aux | grep -E 'tsx|node.*index' | grep -v grep || echo '‚ö†Ô∏è –ü—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω'"

