name: Restart Bot on Server

on:
  workflow_dispatch:
  repository_dispatch:
    types: [restart-bot]

jobs:
  restart-bot:
    name: Restart bot on Hetzner
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts || true

      - name: Restart bot on server
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER || 'root' }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} << 'EOF'
            set -e
            cd /root/geodrive_n8n-agents
            
            echo "üì• –û–±–Ω–æ–≤–ª—è—é –∫–æ–¥..."
            git pull origin master || git pull origin main || true
            
            echo "üîÑ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –±–æ—Ç–∞..."
            pkill -9 -f "tsx.*index.ts" || pkill -9 -f "node.*dist/index.js" || true
            sleep 3
            
            echo "üîß –£–¥–∞–ª—è—é webhook —á–µ—Ä–µ–∑ Telegram API..."
            source .env 2>/dev/null || true
            if [ ! -z "$TELEGRAM_BOT_TOKEN" ]; then
              curl -s "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/deleteWebhook?drop_pending_updates=true"
              echo ""
            fi
            
            echo "üßπ –û—á–∏—â–∞—é –ª–æ–≥–∏..."
            rm -f /root/bot.log
            
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é Node.js –∏ npm..."
            source ~/.bashrc 2>/dev/null || true
            source ~/.profile 2>/dev/null || true
            
            # –ò—â–µ–º node –∏ npm
            NODE_PATH=$(which node 2>/dev/null || find /usr /opt /root -name "node" -type f 2>/dev/null | head -1 || echo "")
            NPM_PATH=$(which npm 2>/dev/null || find /usr /opt /root -name "npm" -type f 2>/dev/null | head -1 || echo "")
            
            if [ -z "$NPM_PATH" ] && [ -d "/root/.nvm" ]; then
              export NVM_DIR="/root/.nvm"
              [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
              NPM_PATH=$(which npm)
            fi
            
            echo "Node.js: ${NODE_PATH:-–Ω–µ –Ω–∞–π–¥–µ–Ω}"
            echo "npm: ${NPM_PATH:-–Ω–µ –Ω–∞–π–¥–µ–Ω}"
            
            if [ -z "$NPM_PATH" ]; then
              echo "‚ùå npm –Ω–µ –Ω–∞–π–¥–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É Node.js –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
              exit 1
            fi
            
            echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é –±–æ—Ç–∞ —á–µ—Ä–µ–∑: $NPM_PATH..."
            cd /root/geodrive_n8n-agents
            export PATH="/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin:$PATH"
            nohup bash -c "source ~/.bashrc 2>/dev/null; source ~/.profile 2>/dev/null; cd /root/geodrive_n8n-agents && $NPM_PATH run dev" > /root/bot.log 2>&1 &
            
            echo "‚è≥ –ñ–¥—É –∑–∞–ø—É—Å–∫–∞..."
            sleep 5
            
            echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤:"
            tail -n 30 /root/bot.log || echo "–õ–æ–≥ —Ñ–∞–π–ª –ø—É—Å—Ç –∏–ª–∏ –Ω–µ —Å–æ–∑–¥–∞–Ω"
            
            echo ""
            echo "‚úÖ –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω!"
          EOF

      - name: Verify bot is running
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER || 'root' }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          sleep 3
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} "ps aux | grep -E 'tsx|node.*index' | grep -v grep || echo '‚ö†Ô∏è –ü—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω'"

