name: Add DATABASE_URL

on:
  workflow_dispatch:
    inputs:
      database_url:
        description: 'PostgreSQL Database URL'
        required: true
        type: string

jobs:
  add-database-url:
    name: Add DATABASE_URL to .env
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts || true

      - name: Add DATABASE_URL to .env
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER || 'root' }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
          DATABASE_URL: ${{ github.event.inputs.database_url }}
        run: |
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} << 'EOF'
            cd /root/geodrive_n8n-agents
            
            echo "üìù –î–æ–±–∞–≤–ª—è—é DATABASE_URL –≤ .env..."
            
            # –°–æ–∑–¥–∞–µ–º backup
            if [ -f .env ]; then
              cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
            fi
            
            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é DATABASE_URL –µ—Å–ª–∏ –µ—Å—Ç—å
            if grep -q "^DATABASE_URL=" .env; then
              echo "–û–±–Ω–æ–≤–ª—è—é —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π DATABASE_URL..."
              sed -i '/^DATABASE_URL=/d' .env
            fi
            
            # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é DATABASE_URL (–±–µ–∑ –∫–∞–≤—ã—á–µ–∫, postgres –ø—Ä–∏–Ω–∏–º–∞–µ—Ç URL –∫–∞–∫ –µ—Å—Ç—å)
            echo "DATABASE_URL=$DATABASE_URL" >> .env
            
            echo "‚úÖ DATABASE_URL –¥–æ–±–∞–≤–ª–µ–Ω"
            echo ""
            echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–∏—Å–∞–Ω–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è:"
            DB_LINE=$(grep "^DATABASE_URL=" .env | tail -1)
            if [ ! -z "$DB_LINE" ]; then
              DB_VALUE=$(echo "$DB_LINE" | cut -d'=' -f2-)
              if [ -z "$DB_VALUE" ]; then
                echo "‚ùå –û–®–ò–ë–ö–ê: DATABASE_URL –∑–∞–ø–∏—Å–∞–Ω –ø—É—Å—Ç—ã–º!"
                echo "–ü—Ä–æ–±—É—é –∑–∞–ø–∏—Å–∞—Ç—å —á–µ—Ä–µ–∑ printf..."
                # –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
                sed -i '/^DATABASE_URL=$/d' .env
                # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ —á–µ—Ä–µ–∑ printf
                printf 'DATABASE_URL=%s\n' "$DATABASE_URL" >> .env
                echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:"
                grep "^DATABASE_URL=" .env | tail -1 | head -c 100
                echo ""
              else
                echo "‚úÖ –ó–Ω–∞—á–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∞–Ω–æ (–¥–ª–∏–Ω–∞: ${#DB_VALUE} —Å–∏–º–≤–æ–ª–æ–≤)"
                echo "–ü–µ—Ä–≤—ã–µ 50 —Å–∏–º–≤–æ–ª–æ–≤: ${DB_VALUE:0:50}..."
              fi
            else
              echo "‚ùå –°—Ç—Ä–æ–∫–∞ DATABASE_URL –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ .env"
            fi
            echo ""
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é –±–æ—Ç–∞..."
            pkill -9 -f "tsx.*index.ts" || pkill -9 -f "node.*dist/index.js" || true
            sleep 3
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ
            export PATH="/root/.local/bin:/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin:\$PATH"
            if [ -f ~/.bashrc ]; then source ~/.bashrc; fi
            if [ -f ~/.profile ]; then source ~/.profile; fi
            
            # –£–¥–∞–ª—è–µ–º webhook
            source .env 2>/dev/null || true
            if [ ! -z "\$TELEGRAM_BOT_TOKEN" ]; then
              curl -s "https://api.telegram.org/bot\${TELEGRAM_BOT_TOKEN}/deleteWebhook?drop_pending_updates=true" > /dev/null
            fi
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
            rm -f /root/bot.log
            nohup bash -c "cd /root/geodrive_n8n-agents && export PATH='/root/.local/bin:/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin:\$PATH' && [ -f ~/.bashrc ] && source ~/.bashrc; [ -f ~/.profile ] && source ~/.profile; npm run dev" > /root/bot.log 2>&1 &
            
            echo "‚è≥ –ñ–¥—É –∑–∞–ø—É—Å–∫–∞..."
            sleep 8
            
            echo ""
            echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤:"
            tail -n 20 /root/bot.log || echo "–õ–æ–≥ –ø—É—Å—Ç"
            
            echo ""
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î:"
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ DATABASE_URL –≤ –ª–æ–≥–∞—Ö (–±–µ–∑ –ø–æ–∫–∞–∑–∞ –∑–Ω–∞—á–µ–Ω–∏—è)
            if grep -q "DATABASE_URL" .env; then
              echo "‚úÖ DATABASE_URL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            else
              echo "‚ùå DATABASE_URL –Ω–µ –Ω–∞–π–¥–µ–Ω"
            fi
          EOF

