name: Check Bot Logs

on:
  workflow_dispatch:

jobs:
  check-logs:
    name: Check bot logs on server
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts || true

      - name: Check bot status and logs
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER || 'root' }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} << 'EOF'
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞..."
            ps aux | grep -E 'tsx|node.*index' | grep -v grep || echo "‚ö†Ô∏è –ü—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω"
            
            echo ""
            echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤ –±–æ—Ç–∞:"
            echo "=========================================="
            if [ -f /root/bot.log ]; then
              tail -n 50 /root/bot.log
            else
              echo "‚ö†Ô∏è –§–∞–π–ª –ª–æ–≥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω"
            fi
            
            echo ""
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é –Ω–∞–ª–∏—á–∏–µ .env —Ñ–∞–π–ª–∞ –∏ —Ç–æ–∫–µ–Ω–∞..."
            cd /root/geodrive_n8n-agents
            if [ -f .env ]; then
              if grep -q "TELEGRAM_BOT_TOKEN" .env; then
                echo "‚úÖ TELEGRAM_BOT_TOKEN –Ω–∞–π–¥–µ–Ω –≤ .env"
                TOKEN_LENGTH=$(grep "TELEGRAM_BOT_TOKEN" .env | cut -d'=' -f2 | tr -d ' ' | wc -c)
                echo "   –î–ª–∏–Ω–∞ —Ç–æ–∫–µ–Ω–∞: $TOKEN_LENGTH —Å–∏–º–≤–æ–ª–æ–≤"
              else
                echo "‚ùå TELEGRAM_BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env"
              fi
            else
              echo "‚ùå –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω"
            fi
            
            echo ""
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Telegram API..."
            source .env 2>/dev/null || true
            if [ ! -z "$TELEGRAM_BOT_TOKEN" ]; then
              BOT_INFO=$(curl -s "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getMe" || echo "error")
              echo "$BOT_INFO"
            else
              echo "‚ö†Ô∏è TELEGRAM_BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            fi
          EOF

