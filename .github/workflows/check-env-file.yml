name: Check ENV File

on:
  workflow_dispatch:

jobs:
  check-env:
    name: Check .env file on server
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts || true

      - name: Check .env file
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER || 'root' }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} << 'EOF'
            cd /root/geodrive_n8n-agents
            
            echo "ðŸ“‹ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ .env Ñ„Ð°Ð¹Ð»Ð°:"
            echo "=========================================="
            if [ -f .env ]; then
              # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð²ÑÐµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ, ÑÐºÑ€Ñ‹Ð²Ð°Ñ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¸Ð¼ÐµÐ½Ð°)
              echo ""
              echo "ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð² .env (Ð¿ÐµÑ€Ð²Ñ‹Ðµ 100 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð² Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ð¹):"
              while IFS= read -r line; do
                if [[ $line =~ ^[A-Z_]+= ]]; then
                  var_name=$(echo "$line" | cut -d'=' -f1)
                  var_value=$(echo "$line" | cut -d'=' -f2-)
                  if [ ${#var_value} -gt 100 ]; then
                    var_value="${var_value:0:100}... (Ð´Ð»Ð¸Ð½Ð½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ)"
                  fi
                  # Ð¡ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
                  if [[ "$var_name" == *"TOKEN"* ]] || [[ "$var_name" == *"KEY"* ]] || [[ "$var_name" == *"PASSWORD"* ]] || [[ "$var_name" == *"SECRET"* ]]; then
                    if [ ${#var_value} -gt 10 ]; then
                      masked="${var_value:0:5}***${var_value: -3}"
                    else
                      masked="***"
                    fi
                    echo "$var_name=$masked"
                  else
                    echo "$var_name=$var_value"
                  fi
                fi
              done < .env
              
              echo ""
              echo "=========================================="
              echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°:"
              var_count=$(grep -c "^[A-Z_][A-Z0-9_]*=" .env || echo "0")
              echo "Ð’ÑÐµÐ³Ð¾ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ…: $var_count"
            else
              echo "âŒ Ð¤Ð°Ð¹Ð» .env Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
            fi
            
            echo ""
            echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑŽ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ .env.backup Ð¸Ð»Ð¸ Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ñ‹Ñ… ÐºÐ¾Ð¿Ð¸Ð¹..."
            ls -la /root/geodrive_n8n-agents/.env* 2>/dev/null || echo "Ð ÐµÐ·ÐµÑ€Ð²Ð½Ñ‹Ñ… ÐºÐ¾Ð¿Ð¸Ð¹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾"
          EOF

