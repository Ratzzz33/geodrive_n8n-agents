{
  "name": "Umnico Chat Scraper (Optimized)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 1
            }
          ]
        }
      },
      "id": "umnico-cron-trigger",
      "name": "Every 1 Minute",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "url": "=http://playwright-umnico:3001/api/conversations?limit=30",
        "authentication": "none",
        "options": {}
      },
      "id": "get-conversations",
      "name": "Get Top 30 Conversations",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [470, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT umnico_conversation_id, last_message_preview, last_message_at FROM conversations WHERE last_message_at > NOW() - INTERVAL '1 hour' AND status = 'active'",
        "options": {}
      },
      "id": "get-recent-conversations",
      "name": "Get Recent Conversations from DB",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [470, 120],
      "credentials": {
        "postgres": {
          "id": "neon-postgres",
          "name": "Neon PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ò–ù–ö–†–ï–ú–ï–ù–¢–ê–õ–¨–ù–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø\n// –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º lastMessage –∏–∑ UI —Å –∫–µ—à–µ–º –≤ –ë–î\n\nconst startTime = Date.now();\nconst MAX_DURATION = 50 * 1000; // 50 —Å–µ–∫—É–Ω–¥ (—Ä–µ–∑–µ—Ä–≤ 10 —Å–µ–∫)\nconst MAX_BATCH = 5; // –ú–∞–∫—Å–∏–º—É–º 5 —á–∞—Ç–æ–≤ –∑–∞ —Ü–∏–∫–ª\n\n// –î–∞–Ω–Ω—ã–µ –∏–∑ –ë–î\nconst dbConversations = $input.first().json ? [$input.first().json] : [];\nconst dbMap = new Map();\n\nfor (const dbConv of dbConversations) {\n  if (dbConv.umnico_conversation_id) {\n    dbMap.set(dbConv.umnico_conversation_id, {\n      lastPreview: dbConv.last_message_preview,\n      lastMessageAt: dbConv.last_message_at\n    });\n  }\n}\n\n// –î–∞–Ω–Ω—ã–µ –∏–∑ Umnico UI\nconst uiConversations = $input.all()[1].json.data || [];\n\n// –ù–∞–π—Ç–∏ –∏–∑–º–µ–Ω–∏–≤—à–∏–µ—Å—è/–Ω–æ–≤—ã–µ —á–∞—Ç—ã\nconst changed = [];\n\nfor (const uiConv of uiConversations) {\n  const convId = uiConv.conversationId;\n  if (!convId) continue;\n  \n  const dbConv = dbMap.get(convId);\n  \n  // –ù–æ–≤—ã–π —á–∞—Ç - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–∞—Ä—Å–∏–º\n  if (!dbConv) {\n    changed.push({\n      ...uiConv,\n      reason: 'new',\n      priority: 1\n    });\n    continue;\n  }\n  \n  // –ü—Ä–µ–≤—å—é –∏–∑–º–µ–Ω–∏–ª–æ—Å—å - –ø–∞—Ä—Å–∏–º\n  if (dbConv.lastPreview !== uiConv.lastMessage) {\n    changed.push({\n      ...uiConv,\n      reason: 'changed',\n      priority: 2\n    });\n    continue;\n  }\n  \n  // –ù–µ–¥–∞–≤–Ω–æ –æ–±–Ω–æ–≤–ª—è–ª–∏—Å—å (< 5 –º–∏–Ω—É—Ç) –∏ –ø—Ä–µ–≤—å—é –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º\n  const minutesSinceUpdate = (Date.now() - new Date(dbConv.lastMessageAt).getTime()) / (60 * 1000);\n  if (minutesSinceUpdate < 5) {\n    console.log(`‚è≠Ô∏è  Skip ${convId} - no changes, synced ${minutesSinceUpdate.toFixed(1)} min ago`);\n    continue;\n  }\n  \n  // –î–∞–≤–Ω–æ –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∏—Å—å - –ø—Ä–æ–≤–µ—Ä—è–µ–º\n  changed.push({\n    ...uiConv,\n    reason: 'stale',\n    priority: 3\n  });\n}\n\n// –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è: –Ω–æ–≤—ã–µ ‚Üí –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ ‚Üí –∑–∞—Å—Ç–∞—Ä–µ–ª—ã–µ\nchanged.sort((a, b) => a.priority - b.priority);\n\n// –í–∑—è—Ç—å —Ç–æ–ø-5\nconst batch = changed.slice(0, MAX_BATCH);\n\nconsole.log(`üìä Found ${changed.length} conversations with changes`);\nconsole.log(`üéØ Processing top ${batch.length} conversations`);\nconsole.log(`‚è±Ô∏è  Max duration: ${MAX_DURATION / 1000}s`);\n\nif (batch.length === 0) {\n  console.log('‚úÖ No conversations to process');\n  return [];\n}\n\nreturn batch.map(c => ({ \n  json: { \n    ...c, \n    _startTime: startTime,\n    _maxDuration: MAX_DURATION \n  } \n}));"
      },
      "id": "filter-changed-conversations",
      "name": "Find Changed Conversations (Smart Filter)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [690, 300]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "loop-conversations",
      "name": "Loop (Max 5)",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [910, 300]
    },
    {
      "parameters": {
        "jsCode": "// TIMEOUT GUARD\nconst startTime = $json._startTime || Date.now();\nconst maxDuration = $json._maxDuration || 50000;\nconst elapsed = Date.now() - startTime;\n\nif (elapsed > maxDuration) {\n  console.log(`‚è∞ TIMEOUT! Elapsed ${elapsed}ms, stopping loop`);\n  throw new Error('TIMEOUT_REACHED');\n}\n\nconsole.log(`‚è±Ô∏è  Time elapsed: ${(elapsed / 1000).toFixed(1)}s / ${(maxDuration / 1000).toFixed(0)}s`);\n\nreturn { json: $json };"
      },
      "id": "timeout-guard",
      "name": "Timeout Guard",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "url": "=http://playwright-umnico:3001/api/conversations/{{ $json.conversationId }}/messages",
        "authentication": "none",
        "options": {
          "timeout": 15000
        }
      },
      "id": "get-messages",
      "name": "Get Messages (Fast)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1270, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Upsert client by phone\nWITH client_upsert AS (\n  INSERT INTO clients (id, phone, name, updated_at)\n  VALUES (gen_random_uuid(), $1, $2, now())\n  ON CONFLICT (phone) DO UPDATE\n  SET name = COALESCE(EXCLUDED.name, clients.name),\n      updated_at = now()\n  RETURNING id\n),\n-- Add external ref for Umnico\nexternal_ref AS (\n  INSERT INTO external_refs (entity_type, entity_id, system, external_id)\n  SELECT 'client', client_upsert.id, 'umnico', $1\n  FROM client_upsert\n  ON CONFLICT (entity_type, system, external_id) DO NOTHING\n),\n-- Upsert conversation (WITH last_message_preview!)\nconversation_upsert AS (\n  INSERT INTO conversations (\n    id, client_id, umnico_conversation_id, channel, channel_account, status, \n    last_message_at, last_message_preview, updated_at\n  )\n  SELECT \n    gen_random_uuid(), client_upsert.id, $3, $4, $5, 'active', \n    now(), $6, now()\n  FROM client_upsert\n  ON CONFLICT (umnico_conversation_id) DO UPDATE\n  SET \n    last_message_at = now(), \n    last_message_preview = EXCLUDED.last_message_preview,\n    updated_at = now()\n  RETURNING id, client_id\n)\nSELECT * FROM conversation_upsert;",
        "options": {}
      },
      "id": "upsert-client-conversation",
      "name": "Upsert with Preview Cache",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [1490, 300],
      "credentials": {
        "postgres": {
          "id": "neon-postgres",
          "name": "Neon PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å messages –¥–ª—è batch insert (—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50!)\nconst conversationId = $input.first().json.id;\nconst clientId = $input.first().json.client_id;\nconst messages = $input.all()[1].json.data || [];\n\n// –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏\nconst recentMessages = messages.slice(-50);\n\nconst values = recentMessages.map(m => ({\n  conversation_id: conversationId,\n  client_id: clientId,\n  text: m.text,\n  direction: m.direction,\n  channel: m.channel || 'whatsapp',\n  sent_at: m.datetime || new Date().toISOString(),\n  metadata: JSON.stringify({\n    time: m.time,\n    hasAttachments: m.hasAttachments,\n    channelAccount: m.channelAccount\n  })\n}));\n\nconsole.log(`üíæ Prepared ${values.length} messages (total: ${messages.length})`);\n\nreturn values.map(v => ({ json: v }));"
      },
      "id": "prepare-messages",
      "name": "Prepare Messages (Last 50)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1710, 300]
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "messages",
        "columns": "conversation_id, client_id, text, direction, channel, sent_at, metadata",
        "options": {
          "skipOnConflict": true
        }
      },
      "id": "insert-messages",
      "name": "Insert Messages",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [1930, 300],
      "credentials": {
        "postgres": {
          "id": "neon-postgres",
          "name": "Neon PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "content": "‚ö° –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ô Umnico Scraper\n\n–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: –ö–ê–ñ–î–£–Æ –ú–ò–ù–£–¢–£ ‚è±Ô∏è\n\n–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:\n‚úÖ –ò–Ω—Ç–µ—Ä–≤–∞–ª 1 –º–∏–Ω (–≤–º–µ—Å—Ç–æ 5)\n‚úÖ –¢–æ–ø-30 —á–∞—Ç–æ–≤ (–≤–º–µ—Å—Ç–æ 50)\n‚úÖ –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ:\n   - –ù–æ–≤—ã–µ —á–∞—Ç—ã ‚Üí –ø–∞—Ä—Å–∏–º\n   - –ò–∑–º–µ–Ω–∏–ª—Å—è lastMessage ‚Üí –ø–∞—Ä—Å–∏–º  \n   - –ù–µ–¥–∞–≤–Ω–æ –æ–±–Ω–æ–≤–ª—è–ª–∏—Å—å (<5 –º–∏–Ω) ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º\n‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è: —Ç–æ–ø-5 –∑–∞ —Ü–∏–∫–ª\n‚úÖ Timeout guard: 50 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å\n‚úÖ –ö–µ—à last_message_preview –≤ –ë–î\n‚úÖ –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å–æ–æ–±—â–µ–Ω–∏–π\n\nüìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:\n- –°–ø–∏—Å–æ–∫ 30 —á–∞—Ç–æ–≤: ~3 —Å–µ–∫\n- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: ~1 —Å–µ–∫\n- –ü–∞—Ä—Å–∏–Ω–≥ 5 —á–∞—Ç–æ–≤: ~10 —Å–µ–∫ (2 —Å–µ–∫/—á–∞—Ç)\n- –ò–¢–û–ì–û: ~16 —Å–µ–∫—É–Ω–¥ ‚ú®\n\nPlaywright: http://playwright-umnico:3001",
        "height": 480,
        "width": 420
      },
      "id": "sticky-note",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [240, 500]
    }
  ],
  "connections": {
    "Every 1 Minute": {
      "main": [
        [
          {
            "node": "Get Recent Conversations from DB",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Top 30 Conversations",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Recent Conversations from DB": {
      "main": [
        [
          {
            "node": "Find Changed Conversations (Smart Filter)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Top 30 Conversations": {
      "main": [
        [
          {
            "node": "Find Changed Conversations (Smart Filter)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Changed Conversations (Smart Filter)": {
      "main": [
        [
          {
            "node": "Loop (Max 5)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop (Max 5)": {
      "main": [
        [
          {
            "node": "Timeout Guard",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Timeout Guard": {
      "main": [
        [
          {
            "node": "Get Messages (Fast)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Messages (Fast)": {
      "main": [
        [
          {
            "node": "Upsert with Preview Cache",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert with Preview Cache": {
      "main": [
        [
          {
            "node": "Prepare Messages (Last 50)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Messages (Last 50)": {
      "main": [
        [
          {
            "node": "Insert Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Messages": {
      "main": [
        [
          {
            "node": "Loop (Max 5)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all",
    "saveExecutionProgress": true,
    "timezone": "Asia/Tbilisi",
    "executionTimeout": 3600
  },
  "staticData": null,
  "tags": ["optimized", "umnico", "incremental"],
  "triggerCount": 1,
  "updatedAt": "2025-11-09T00:00:00.000Z",
  "versionId": "2"
}

