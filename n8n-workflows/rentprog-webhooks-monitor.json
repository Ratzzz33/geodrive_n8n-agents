{
  "id": "gNXRKIQpNubEazH7",
  "name": "RentProg Webhooks Monitor",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "rentprog-webhook",
        "responseMode": "responseNode",
        "options": {
          "productionUrl": "https://webhook.rentflow.rentals"
        },
        "onError": "continueRegularOutput"
      },
      "id": "webhook-node",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        250,
        400
      ],
      "webhookId": "rentprog-webhook-monitor"
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –≤–µ–±—Ö—É–∫–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π\\r\\nconst crypto = require('crypto');\\r\\n\\r\\ntry {\\r\\n  const body = $input.item.json.body || {};\\r\\n  const headers = $input.item.json.headers || {};\\r\\n  const payloadStr = body.payload || '';\\r\\n  const rawEvent = body.event || body.type || 'unknown';\\r\\n\\r\\n  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è request_id\\r\\n  const requestId = headers['x-request-id'] || headers['x-webhook-id'] || headers['x-event-id'] || \\r\\n                    (crypto.randomUUID ? crypto.randomUUID() : Date.now().toString());\\r\\n\\r\\n  let rentprogId = 'unknown';\\r\\n  let isKnownFormat = false;\\r\\n  let parsedPayload = {};\\r\\n  let validationErrors = [];\\r\\n  let eventType = 'unknown';\\r\\n  let entityType = 'unknown';\\r\\n  let operation = 'unknown';\\r\\n  let parseError = false;\\r\\n  let errorMessage = '';\\r\\n  let eventHash = '';\\r\\n\\r\\n  // ========== –®–ê–ì 0: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è event_hash –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ ==========\\r\\n  try {\\r\\n    const hashData = JSON.stringify({\\r\\n      'x-webhook-id': headers['x-webhook-id'] || '',\\r\\n      'x-event-id': headers['x-event-id'] || '',\\r\\n      'x-delivery-id': headers['x-delivery-id'] || '',\\r\\n      timestamp: headers['x-timestamp'] || headers['timestamp'] || '',\\r\\n      payload: payloadStr || ''\\r\\n    });\\r\\n    eventHash = crypto.createHash('sha256').update(hashData).digest('hex');\\r\\n  } catch (e) {\\r\\n    // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å hash, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback\\r\\n    eventHash = crypto.createHash('sha256')\\r\\n      .update((payloadStr || '') + (rawEvent || '') + Date.now())\\r\\n      .digest('hex');\\r\\n  }\\r\\n\\r\\n  // ========== –®–ê–ì 1: –ü–∞—Ä—Å–∏–Ω–≥ payload ==========\\r\\n  try {\\r\\n    if (typeof payloadStr === 'string' && payloadStr.length > 0) {\\r\\n      try {\\r\\n        parsedPayload = JSON.parse(payloadStr);\\r\\n      } catch (e) {\\r\\n        // –ü—Ä–æ–±—É–µ–º Ruby hash —Ñ–æ—Ä–º–∞—Ç\\r\\n        try {\\r\\n          let jsonStr = payloadStr\\r\\n            .replace(/=>/g, ':')\\r\\n            .replace(/([{, ])([a-zA-Z_][a-zA-Z0-9_]*):/g, '$1\\\"$2\\\":')\\r\\n            .replace(/nil/g, 'null')\\r\\n            .replace(/\\\\s+/g, ' ');\\r\\n          parsedPayload = JSON.parse(jsonStr);\\r\\n        } catch (e2) {\\r\\n          validationErrors.push('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å payload: ' + e2.message);\\r\\n        }\\r\\n      }\\r\\n    } else if (typeof payloadStr === 'object' && payloadStr !== null) {\\r\\n      parsedPayload = payloadStr;\\r\\n    }\\r\\n  } catch (e) {\\r\\n    validationErrors.push('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ payload: ' + e.message);\\r\\n  }\\r\\n\\r\\n  // ========== –®–ê–ì 2: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ rentprog_id ==========\\r\\n  if (parsedPayload && Object.keys(parsedPayload).length > 0) {\\r\\n    if (parsedPayload.id !== undefined && parsedPayload.id !== null) {\\r\\n      rentprogId = String(parsedPayload.id);\\r\\n    } else if (typeof payloadStr === 'string') {\\r\\n      // –ü—Ä–æ–±—É–µ–º regex –µ—Å–ª–∏ –Ω–µ —Ä–∞—Å–ø–∞—Ä—Å–∏–ª–æ—Å—å\\r\\n      const idMatch = payloadStr.match(/[\\\"']?id[\\\"']?\\\\s*=>\\\\s*(\\\\d+)/i);\\r\\n      if (idMatch) {\\r\\n        rentprogId = idMatch[1];\\r\\n      } else {\\r\\n        validationErrors.push('–ù–µ –Ω–∞–π–¥–µ–Ω ID –≤ payload');\\r\\n      }\\r\\n    } else {\\r\\n      validationErrors.push('–ù–µ –Ω–∞–π–¥–µ–Ω ID –≤ payload');\\r\\n    }\\r\\n  } else {\\r\\n    validationErrors.push('Payload –ø—É—Å—Ç –∏–ª–∏ –Ω–µ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω');\\r\\n  }\\r\\n\\r\\n  // ========== –®–ê–ì 3: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è ==========\\r\\n  // –í–°–ï 9 –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π\\r\\n  const knownEventTypes = [\\r\\n    'client_destroy',\\r\\n    'car_destroy',\\r\\n    'booking_destroy',\\r\\n    'car_update',\\r\\n    'client_update',\\r\\n    'booking_update',\\r\\n    'client_create',\\r\\n    'booking_create',\\r\\n    'car_create'\\r\\n  ];\\r\\n\\r\\n  const eventLower = rawEvent.toLowerCase().replace(/[._]/g, '');\\r\\n  if (knownEventTypes.includes(rawEvent)) {\\r\\n    eventType = rawEvent;\\r\\n  } else {\\r\\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã: car_update, carupdate, car.update\\r\\n    const matchedType = knownEventTypes.find(t => {\\r\\n      const tLower = t.replace(/[._]/g, '');\\r\\n      return eventLower.includes(tLower) || tLower.includes(eventLower);\\r\\n    });\\r\\n    if (matchedType) {\\r\\n      eventType = matchedType;\\r\\n    } else {\\r\\n      validationErrors.push(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è: ${rawEvent}`);\\r\\n    }\\r\\n  }\\r\\n\\r\\n  // ========== –®–ê–ì 4: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —Å—É—â–Ω–æ—Å—Ç–∏ –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ ==========\\r\\n  if (eventType.startsWith('car') || eventType.includes('car')) {\\r\\n    entityType = 'car';\\r\\n  } else if (eventType.startsWith('booking') || eventType.includes('booking')) {\\r\\n    entityType = 'booking';\\r\\n  } else if (eventType.startsWith('client') || eventType.includes('client')) {\\r\\n    entityType = 'client';\\r\\n  } else if (eventType !== 'unknown') {\\r\\n    validationErrors.push(`–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø —Å—É—â–Ω–æ—Å—Ç–∏ –¥–ª—è —Å–æ–±—ã—Ç–∏—è: ${eventType}`);\\r\\n  }\\r\\n\\r\\n  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é (update/create/destroy)\\r\\n  if (eventType.includes('update')) {\\r\\n    operation = 'update';\\r\\n  } else if (eventType.includes('create')) {\\r\\n    operation = 'create';\\r\\n  } else if (eventType.includes('destroy') || eventType.includes('delete')) {\\r\\n    operation = 'destroy';\\r\\n  } else if (eventType !== 'unknown') {\\r\\n    validationErrors.push(`–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é –¥–ª—è —Å–æ–±—ã—Ç–∏—è: ${eventType}`);\\r\\n  }\\r\\n\\r\\n  // ========== –®–ê–ì 5: –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π ==========\\r\\n  if (entityType !== 'unknown' && rentprogId === 'unknown') {\\r\\n    validationErrors.push(`–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ id –¥–ª—è ${entityType}`);\\r\\n  }\\r\\n\\r\\n  // ========== –®–ê–ì 6: –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è ==========\\r\\n  function validateEventFormat(evType, payload, errors) {\\r\\n    // –ë–∞–∑–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è: ID –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω\\r\\n    if (!payload.id) {\\r\\n      errors.push(`${evType}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ 'id'`);\\r\\n      return false;\\r\\n    }\\r\\n\\r\\n    // –°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ —Ç–∏–ø—É —Å–æ–±—ã—Ç–∏—è\\r\\n    switch (evType) {\\r\\n      case 'car_update':\\r\\n        // –î–ª—è update –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏–∑–º–µ–Ω—è–µ–º–æ–µ –ø–æ–ª–µ\\r\\n        const carUpdateFields = ['mileage', 'clean_state', 'status', 'location', 'plate_number'];\\r\\n        const hasCarUpdateField = carUpdateFields.some(f => payload[f] !== undefined);\\r\\n        if (!hasCarUpdateField) {\\r\\n          errors.push(`car_update: –Ω–µ—Ç –ø–æ–ª–µ–π –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–æ–∂–∏–¥–∞–µ—Ç—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏–∑: ${carUpdateFields.join(', ')})`);\\r\\n          return false;\\r\\n        }\\r\\n        break;\\r\\n\\r\\n      case 'client_update':\\r\\n        // –î–ª—è update –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏–∑–º–µ–Ω—è–µ–º–æ–µ –ø–æ–ª–µ\\r\\n        const clientUpdateFields = ['name', 'phone', 'email', 'passport', 'license'];\\r\\n        const hasClientUpdateField = clientUpdateFields.some(f => payload[f] !== undefined);\\r\\n        if (!hasClientUpdateField) {\\r\\n          errors.push(`client_update: –Ω–µ—Ç –ø–æ–ª–µ–π –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–æ–∂–∏–¥–∞–µ—Ç—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏–∑: ${clientUpdateFields.join(', ')})`);\\r\\n          return false;\\r\\n        }\\r\\n        break;\\r\\n\\r\\n      case 'booking_update':\\r\\n        // –î–ª—è update –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏–∑–º–µ–Ω—è–µ–º–æ–µ –ø–æ–ª–µ\\r\\n        const bookingUpdateFields = ['status', 'issue_planned_at', 'return_planned_at', 'car_id', 'client_id'];\\r\\n        const hasBookingUpdateField = bookingUpdateFields.some(f => payload[f] !== undefined);\\r\\n        if (!hasBookingUpdateField) {\\r\\n          errors.push(`booking_update: –Ω–µ—Ç –ø–æ–ª–µ–π –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–æ–∂–∏–¥–∞–µ—Ç—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏–∑: ${bookingUpdateFields.join(', ')})`);\\r\\n          return false;\\r\\n        }\\r\\n        break;\\r\\n\\r\\n      case 'car_create':\\r\\n        // –î–ª—è create –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—à–∏–Ω—ã\\r\\n        if (!payload.plate_number && !payload.model) {\\r\\n          errors.push('car_create: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (plate_number –∏–ª–∏ model)');\\r\\n          return false;\\r\\n        }\\r\\n        break;\\r\\n\\r\\n      case 'client_create':\\r\\n        // –î–ª—è create –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞\\r\\n        if (!payload.name && !payload.phone) {\\r\\n          errors.push('client_create: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (name –∏–ª–∏ phone)');\\r\\n          return false;\\r\\n        }\\r\\n        break;\\r\\n\\r\\n      case 'booking_create':\\r\\n        // –î–ª—è create –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏\\r\\n        if (!payload.car_id || !payload.client_id) {\\r\\n          errors.push('booking_create: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (car_id, client_id)');\\r\\n          return false;\\r\\n        }\\r\\n        break;\\r\\n\\r\\n      case 'car_destroy':\\r\\n      case 'client_destroy':\\r\\n      case 'booking_destroy':\\r\\n        // –î–ª—è destroy –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–ª—å–∫–æ id –∏ company_id (—É–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –≤—ã—à–µ)\\r\\n        break;\\r\\n\\r\\n      default:\\r\\n        // –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø - –Ω–µ –º–æ–∂–µ–º –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å\\r\\n        return false;\\r\\n    }\\r\\n\\r\\n    return true;\\r\\n  }\\r\\n\\r\\n  // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ñ–æ—Ä–º–∞—Ç–∞\\r\\n  let formatValid = false;\\r\\n  if (eventType !== 'unknown' && entityType !== 'unknown' && operation !== 'unknown') {\\r\\n    formatValid = validateEventFormat(eventType, parsedPayload, validationErrors);\\r\\n  }\\r\\n\\r\\n  // ========== –ò–¢–û–ì–û–í–ê–Ø –ü–†–û–í–ï–†–ö–ê ==========\\r\\n  // –§–æ—Ä–º–∞—Ç –∏–∑–≤–µ—Å—Ç–µ–Ω, –µ—Å–ª–∏:\\r\\n  // 1. Payload —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω\\r\\n  // 2. –¢–∏–ø —Å–æ–±—ã—Ç–∏—è –∏–∑–≤–µ—Å—Ç–µ–Ω (–≤ —Å–ø–∏—Å–∫–µ knownEventTypes)\\r\\n  // 3. rentprog_id –∏–∑–≤–ª–µ—á–µ–Ω\\r\\n  // 4. entityType –∏ operation –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã\\r\\n  // 5. –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏\\r\\n  // 6. –§–æ—Ä–º–∞—Ç –≤–∞–ª–∏–¥–µ–Ω –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è\\r\\n  if (\\r\\n    Object.keys(parsedPayload).length > 0 &&\\r\\n    rentprogId !== 'unknown' &&\\r\\n    eventType !== 'unknown' &&\\r\\n    entityType !== 'unknown' &&\\r\\n    operation !== 'unknown' &&\\r\\n    validationErrors.length === 0 &&\\r\\n    formatValid\\r\\n  ) {\\r\\n    isKnownFormat = true;\\r\\n  } else {\\r\\n    // –Ø–≤–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º false –¥–ª—è –≤—Å–µ—Ö –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤\\r\\n    isKnownFormat = false;\\r\\n  }\\r\\n\\r\\n  return {\\r\\n    json: {\\r\\n      ...$input.item.json,\\r\\n      requestId: requestId,\\r\\n      eventHash: eventHash,\\r\\n      rentprogId: rentprogId,\\r\\n      eventType: eventType,\\r\\n      entityType: entityType,\\r\\n      operation: operation,\\r\\n      companyId: parsedPayload.company_id || null,\\r\\n      isKnownFormat: isKnownFormat,\\r\\n      parsedPayload: parsedPayload,\\r\\n      validationErrors: validationErrors,\\r\\n      rawEvent: rawEvent,\\r\\n      parseError: parseError,\\r\\n      errorMessage: errorMessage\\r\\n    }\\r\\n  };\\r\\n} catch (error) {\\r\\n  // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å –æ—à–∏–±–∫–æ–π\\r\\n  const body = $input.item.json.body || {};\\r\\n  const headers = $input.item.json.headers || {};\\r\\n  const rawEvent = body.event || body.type || 'unknown';\\r\\n  \\r\\n  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è event_hash –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ\\r\\n  let eventHash = '';\\r\\n  try {\\r\\n    const hashData = JSON.stringify({\\r\\n      'x-webhook-id': headers['x-webhook-id'] || '',\\r\\n      'x-event-id': headers['x-event-id'] || '',\\r\\n      timestamp: Date.now().toString(),\\r\\n      payload: JSON.stringify(body)\\r\\n    });\\r\\n    eventHash = crypto.createHash('sha256').update(hashData).digest('hex');\\r\\n  } catch {\\r\\n    eventHash = crypto.createHash('sha256')\\r\\n      .update((JSON.stringify(body) || '') + Date.now())\\r\\n      .digest('hex');\\r\\n  }\\r\\n  \\r\\n  return {\\r\\n    json: {\\r\\n      ...$input.item.json,\\r\\n      requestId: headers['x-request-id'] || Date.now().toString(),\\r\\n      eventHash: eventHash,\\r\\n      rentprogId: 'unknown',\\r\\n      eventType: 'unknown',\\r\\n      entityType: 'unknown',\\r\\n      operation: 'unknown',\\r\\n      companyId: null,\\r\\n      isKnownFormat: false,\\r\\n      parsedPayload: {},\\r\\n      validationErrors: ['–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ' + (error.message || String(error))],\\r\\n      rawEvent: rawEvent,\\r\\n      parseError: true,\\r\\n      errorMessage: error.message || String(error),\\r\\n      errorStack: error.stack || ''\\r\\n    }\\r\\n  };\\r\\n}\\r\\n\\r\\n"
      },
      "id": "parse-validate-node",
      "name": "Parse & Validate Format",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        450,
        400
      ],
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "known-format-check",
              "leftValue": "={{ $json.isKnownFormat === true }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-known-format-node",
      "name": "If Known Format",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        650,
        400
      ],
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.ORCHESTRATOR_URL || 'http://46.224.17.15:3000' }}/process-webhook",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "event",
              "value": "={{ $json.rawEvent || $json.eventType }}"
            },
            {
              "name": "payload",
              "value": "={{ JSON.stringify($json.parsedPayload) }}"
            },
            {
              "name": "rentprog_id",
              "value": "={{ $json.rentprogId }}"
            },
            {
              "name": "entity_type",
              "value": "={{ $json.entityType }}"
            },
            {
              "name": "operation",
              "value": "={{ $json.operation }}"
            },
            {
              "name": "company_id",
              "value": "={{ $json.companyId }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "auto-process-node",
      "name": "Auto Process",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        850,
        300
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "needs-upsert-check",
              "leftValue": "={{ $json.needsUpsert }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-needs-upsert-node",
      "name": "If Needs Upsert",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1050,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.N8N_URL || 'https://n8n.rentflow.rentals' }}/webhook/upsert-processor",
        "sendBody": true,
        "contentType": "json",
        "body": "={{ { \"rentprog_id\": $('Auto Process').item.json.rentprog_id || $('Parse & Validate Format').item.json.rentprogId, \"event\": $('Auto Process').item.json.event || $('Parse & Validate Format').item.json.rawEvent, \"branch\": $('Auto Process').item.json.branch || $('Parse & Validate Format').item.json.branch, \"entity_type\": $('Auto Process').item.json.entity_type || $('Parse & Validate Format').item.json.entityType } }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "trigger-upsert-node",
      "name": "Trigger Upsert Processor",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1250,
        200
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "sendMessage",
        "chatId": "={{ $env.TELEGRAM_ALERT_CHAT_ID }}",
        "text": "=<b>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤–µ–±—Ö—É–∫–∞ –æ—Ç RentProg</b>\n\n<b>–¢–∏–ø —Å–æ–±—ã—Ç–∏—è:</b> {{ $json.rawEvent }}\n<b>RentProg ID:</b> {{ $json.rentprogId }}\n<b>Company ID:</b> {{ $json.companyId || \"–Ω–µ —É–∫–∞–∑–∞–Ω\" }}\n\n<b>–û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:</b>\n{{ $json.validationErrors && $json.validationErrors.length > 0 ? $json.validationErrors.join(', ') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞' }}\n\n<b>Payload (Ruby hash):</b>\n<pre>{{ $json.body.payload }}</pre>\n\n<b>Parsed payload (JSON):</b>\n<pre>{{ JSON.stringify($json.parsedPayload, null, 2) }}</pre>",
        "additionalFields": {
          "parse_mode": "HTML"
        }
      },
      "id": "debug-unknown-node",
      "name": "Debug: Unknown Format",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        850,
        500
      ],
      "credentials": {
        "telegramApi": {
          "id": "1tKryXxL5Gq395nN",
          "name": "Telegram account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "sendMessage",
        "chatId": "={{ $env.TELEGRAM_ALERT_CHAT_ID }}",
        "text": "=üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤–µ–±—Ö—É–∫–∞ –æ—Ç RentProg\n\n–í—Ä–µ–º—è: {{ $now }}\nBranch: {{ $json.branch }}\n–¢–∏–ø —Å–æ–±—ã—Ç–∏—è: {{ $json.rawEvent }}\nRentProg ID: {{ $json.rentprogId }}\n\n–û—à–∏–±–∫–∞: {{ $json.errorMessage || 'Unknown error' }}\n\n–û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:\n{{ $json.validationErrors && $json.validationErrors.length > 0 ? $json.validationErrors.join('\\n') : '–ù–µ—Ç –¥–µ—Ç–∞–ª–µ–π' }}\n\nStack trace:\n{{ $json.errorStack || '–ù–µ—Ç stack trace' }}\n\n–ü–æ–ª–Ω—ã–π –∑–∞–ø—Ä–æ—Å:\n{{ JSON.stringify($json, null, 2) }}",
        "additionalFields": {}
      },
      "id": "alert-parse-error-node",
      "name": "Alert: Parse Error",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        650,
        600
      ],
      "credentials": {
        "telegramApi": {
          "id": "1tKryXxL5Gq395nN",
          "name": "Telegram account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO webhook_error_log (ts, phase, kind, error, payload, meta, request_id, event_hash, company_id, event_type, rentprog_id)\nVALUES (NOW(), $1, $2, $3, $4::jsonb, $5::jsonb, NULLIF($6, ''), NULLIF($7, ''), $8, NULLIF($9, ''), NULLIF($10, ''))\nRETURNING id",
        "options": {
          "queryReplacement": "={{ $json.parseError ? 'parse' : ($json.errorMessage ? 'sync' : ($json.validationErrors && $json.validationErrors.length > 0 ? 'validation' : 'unknown')) }},={{ $json.parseError ? 'error' : ($json.validationErrors && $json.validationErrors.length > 0 ? 'warn' : 'info') }},={{ $json.errorMessage || ($json.validationErrors && $json.validationErrors.length > 0 ? $json.validationErrors.join('; ') : 'Unknown error') }},={{ JSON.stringify($json.body || {}) }},={{ JSON.stringify({ validationErrors: $json.validationErrors || [], errorStack: $json.errorStack || '', rawEvent: $json.rawEvent || '' }) }},={{ $json.requestId || '' }},={{ $json.eventHash || '' }},={{ $json.companyId || null }},={{ $json.rawEvent || 'unknown' }},={{ $json.rentprogId || 'unknown' }}"
        }
      },
      "id": "log-error-node",
      "name": "Log Error to DB",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        650,
        700
      ],
      "credentials": {
        "postgres": {
          "id": "3I9fyXVlGg4Vl4LZ",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "company_id",
              "name": "company_id",
              "value": "={{ $json.companyId || null }}",
              "type": "numberValue"
            },
            {
              "id": "type",
              "name": "type",
              "value": "={{ $json.eventType || 'unknown' }}",
              "type": "stringValue"
            },
            {
              "id": "rentprog_id",
              "name": "rentprog_id",
              "value": "={{ $json.rentprogId || 'unknown' }}",
              "type": "stringValue"
            },
            {
              "id": "ok",
              "name": "ok",
              "value": "={{ $json.parseError ? false : ($json.isKnownFormat !== undefined ? $json.isKnownFormat : ($json.body && $json.body.ok !== false ? true : false)) }}",
              "type": "booleanValue"
            },
            {
              "id": "reason",
              "name": "reason",
              "value": "={{ $json.parseError ? ('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ' + ($json.errorMessage || 'Unknown error')) : ($json.validationErrors && $json.validationErrors.length > 0 ? $json.validationErrors.join('; ') : ($json.body && $json.body.error ? $json.body.error : ($json.body && $json.body.reason ? $json.body.reason : 'ok'))) }}",
              "type": "stringValue"
            },
            {
              "id": "processed",
              "name": "processed",
              "value": "={{ $json.parseError ? false : false }}",
              "type": "booleanValue"
            },
            {
              "id": "event_hash",
              "name": "event_hash",
              "value": "={{ $json.eventHash || '' }}",
              "type": "stringValue"
            },
            {
              "id": "request_id",
              "name": "request_id",
              "value": "={{ $json.requestId || '' }}",
              "type": "stringValue"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "id": "set-params-node",
      "name": "Set Query Params",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1450,
        400
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO events (ts, company_id, type, rentprog_id, ok, reason, processed, event_hash)\nVALUES (NOW(), $1, $2, $3, $4, $5, $6, NULLIF($7, ''))\nON CONFLICT (company_id, type, rentprog_id) DO NOTHING\nRETURNING id",
        "options": {
          "queryReplacement": "={{ $json.company_id }},={{ $json.type }},={{ $json.rentprog_id }},={{ $json.ok }},={{ $json.reason }},={{ $json.processed }},={{ $json.event_hash || '' }}"
        }
      },
      "id": "data-table-node",
      "name": "Save Event",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        1650,
        400
      ],
      "credentials": {
        "postgres": {
          "id": "3I9fyXVlGg4Vl4LZ",
          "name": "Postgres account"
        }
      }
    },
    {
      "id": "fast-respond-node",
      "name": "Respond (Fast Ack)",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        460,
        300
      ],
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"ok\": true, \"received\": true } }}"
      },
      "onError": "continueRegularOutput"
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Parse & Validate Format",
            "type": "main",
            "index": 0
          },
          {
            "node": "Respond (Fast Ack)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse & Validate Format": {
      "main": [
        [
          {
            "node": "If Known Format",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "Alert: Parse Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Known Format": {
      "main": [
        [
          {
            "node": "Auto Process",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Debug: Unknown Format",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "Alert: Parse Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Auto Process": {
      "main": [
        [
          {
            "node": "If Needs Upsert",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "Log Error to DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Needs Upsert": {
      "main": [
        [
          {
            "node": "Trigger Upsert Processor",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Query Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trigger Upsert Processor": {
      "main": [
        [
          {
            "node": "Set Query Params",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "Log Error to DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug: Unknown Format": {
      "main": [
        [
          {
            "node": "Set Query Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Alert: Parse Error": {
      "main": [
        [
          {
            "node": "Log Error to DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Query Params": {
      "main": [
        [
          {
            "node": "Save Event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Event": {
      "main": [
        []
      ],
      "error": [
        [
          {
            "node": "Log Error to DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Error to DB": {
      "main": [
        []
      ],
      "error": [
        []
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-01-15T00:00:00.000Z",
  "versionId": "1"
}