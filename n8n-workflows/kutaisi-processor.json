{
  "name": "Kutaisi Processor Rentprog",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "kutaisi-webhook",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-node",
      "name": "Webhook (Kutaisi)",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [
        240,
        400
      ],
      "webhookId": "kutaisi-webhook"
    },
    {
      "parameters": {
        "jsCode": "const body = $input.item.json.body || $input.item.json;\nconst eventName = body.event || 'unknown';\nlet payloadStr = body.payload || '{}';\nlet parsedPayload = {};\n\ntry {\n  if (typeof payloadStr === 'string') {\n    try {\n      parsedPayload = JSON.parse(payloadStr);\n    } catch {\n      let jsonStr = payloadStr.replace(/=>/g, ':').replace(/([{, ])([a-zA-Z_][a-zA-Z0-9_]*):/g, '$1\"$2\":').replace(/nil/g, 'null');\n      parsedPayload = JSON.parse(jsonStr);\n    }\n  } else {\n    parsedPayload = payloadStr;\n  }\n} catch (e) {\n  parsedPayload = { error: 'Failed to parse payload', raw: payloadStr };\n}\n\nlet entityType = 'unknown';\nlet operation = 'unknown';\n\nif (eventName.includes('car')) entityType = 'car';\nelse if (eventName.includes('client')) entityType = 'client';\nelse if (eventName.includes('booking')) entityType = 'booking';\n\nif (eventName.includes('create')) operation = 'create';\nelse if (eventName.includes('update')) operation = 'update';\nelse if (eventName.includes('destroy')) operation = 'destroy';\n\nconst rentprogId = parsedPayload.id ? String(parsedPayload.id) : 'unknown';\nconst eventHash = `kutaisi_${eventName}_${rentprogId}_${body?.payload?.updated_at || body?.payload?.id || Date.now()}`;\n\nreturn {\n  json: {\n    execution_id: $execution.id,\n    execution_url: `${$env.N8N_HOST || 'https://n8n.rentflow.rentals'}/workflow/${$workflow.id}/executions/${$execution.id}`,\n    event_name: eventName,\n    entity_type: entityType,\n    operation: operation,\n    rentprog_id: rentprogId,\n    company_id: 9360,\n    payload: parsedPayload,\n    metadata: {\n      source: 'webhook',\n      branch: 'kutaisi',\n      received_at: new Date().toISOString()\n    },\n    event_hash: eventHash\n  }\n};"
      },
      "id": "parse-webhook",
      "name": "Parse Webhook",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        448,
        400
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO events (\n  event_name,\n  entity_type,\n  operation,\n  rentprog_id,\n  company_id,\n  type,\n  payload,\n  metadata,\n  event_hash,\n  execution_id,\n  execution_url,\n  processed\n)\nVALUES (\n  $1, $2, $3, $4, $5, $6, $7::jsonb, $8::jsonb, $9, $10, $11, false\n)\nON CONFLICT (company_id, type, rentprog_id) \nDO UPDATE SET\n  event_name = EXCLUDED.event_name,\n  payload = EXCLUDED.payload,\n  metadata = EXCLUDED.metadata\nRETURNING *;",
        "options": {
          "queryReplacement": "={{ $json.event_name }},={{ $json.entity_type }},={{ $json.operation }},={{ $json.rentprog_id }},={{ $json.company_id }},={{ $json.operation }},={{ JSON.stringify($json.payload) }},={{ JSON.stringify($json.metadata) }},={{ $json.event_hash }},={{ $json.execution_id }},={{ $json.execution_url }}"
        }
      },
      "id": "save-to-events",
      "name": "Save to Events",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        640,
        400
      ],
      "credentials": {
        "postgres": {
          "id": "3I9fyXVlGg4Vl4LZ",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const parsed = $('Parse Webhook').first().json;\nreturn { json: parsed };"
      },
      "id": "pass-data",
      "name": "Pass Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        848,
        400
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.operation }}",
                    "rightValue": "create",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "create"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.operation }}",
                    "rightValue": "update",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "update"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.operation }}",
                    "rightValue": "destroy",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "destroy"
            }
          ]
        },
        "options": {}
      },
      "id": "switch-operation",
      "name": "Switch by Operation",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        1040,
        400
      ]
    },
    {
      "parameters": {
        "jsCode": "const entityType = $json.entity_type;\nconst payload = $json.payload;\nconst rentprogId = $json.rentprog_id;\n\nconst tableMap = {\n  'car': 'cars',\n  'client': 'clients',\n  'booking': 'bookings'\n};\n\nconst tableName = tableMap[entityType];\n\nif (!tableName) {\n  throw new Error(`Unknown entity_type: ${entityType}`);\n}\n\nreturn {\n  json: {\n    table_name: tableName,\n    rentprog_id: rentprogId,\n    company_id: 9360,\n    data: payload,\n    payload_json: JSON.stringify(payload)\n  }\n};"
      },
      "id": "prepare-create",
      "name": "Prepare Create",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1200,
        -32
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM dynamic_upsert_entity(\n  $1::TEXT,\n  $2::TEXT,\n  $3::JSONB\n);",
        "options": {
          "queryReplacement": "={{ $json.table_name }},={{ $json.rentprog_id }},={{ $json.payload_json }}"
        }
      },
      "id": "insert-entity",
      "name": "Insert Entity",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        1440,
        -16
      ],
      "credentials": {
        "postgres": {
          "id": "3I9fyXVlGg4Vl4LZ",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  COALESCE(\n    (SELECT entity_id FROM external_refs WHERE system = 'rentprog' AND external_id = $1 LIMIT 1),\n    NULL\n  ) as entity_id,\n  EXISTS(SELECT 1 FROM external_refs WHERE system = 'rentprog' AND external_id = $1) as exists;",
        "options": {
          "queryReplacement": "={{ $json.rentprog_id }}"
        }
      },
      "id": "check-exists",
      "name": "Check Exists",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        1248,
        400
      ],
      "credentials": {
        "postgres": {
          "id": "3I9fyXVlGg4Vl4LZ",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "exists-check",
              "leftValue": "={{ $json.exists }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-exists",
      "name": "If Exists",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1440,
        400
      ]
    },
    {
      "parameters": {
        "jsCode": "const payload = $('Pass Data').first().json.payload;\nconst updates = {};\n\nfor (const [key, value] of Object.entries(payload)) {\n  if (Array.isArray(value) && value.length === 2) {\n    updates[key] = value[1];\n  } else if (key !== 'id') {\n    updates[key] = value;\n  }\n}\n\nconst entityId = $json.entity_id;\n\nreturn {\n  json: {\n    entity_id: entityId,\n    updates: updates,\n    updates_json: JSON.stringify(updates)\n  }\n};"
      },
      "id": "prepare-update",
      "name": "Prepare Update",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1648,
        192
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE external_refs\nSET\n  data = data || $1::jsonb,\n  updated_at = NOW()\nWHERE entity_id = $2\nRETURNING entity_id;",
        "options": {
          "queryReplacement": "={{ $json.updates_json }},={{ $json.entity_id }}"
        }
      },
      "id": "update-entity",
      "name": "Update Entity",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        1840,
        256
      ],
      "credentials": {
        "postgres": {
          "id": "3I9fyXVlGg4Vl4LZ",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const companyToken = '5599ebb7b94827fdfd49ca3a5b7e259cfa99d8ea78edeb50';\nconst baseUrl = 'https://rentprog.net/api/v1/public';\n\ntry {\n  const tokenResponse = await this.helpers.httpRequest({\n    method: 'GET',\n    url: `${baseUrl}/get_token`,\n    qs: { company_token: companyToken },\n    json: true,\n    timeout: 10000\n  });\n  \n  const requestToken = tokenResponse?.token;\n  \n  if (!requestToken) {\n    throw new Error('Failed to get token');\n  }\n  \n  const data = $('Pass Data').first().json;\n  \n  return {\n    json: {\n      request_token: requestToken,\n      entity_type: data.entity_type,\n      rentprog_id: data.rentprog_id,\n      payload: data.payload\n    }\n  };\n} catch (error) {\n  throw new Error(`Token error: ${error.message}`);\n}"
      },
      "id": "get-token",
      "name": "Get RentProg Token",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1568,
        720
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.entity_type }}",
                    "rightValue": "car",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "car"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.entity_type }}",
                    "rightValue": "client",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "client"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.entity_type }}",
                    "rightValue": "booking",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "booking"
            }
          ]
        },
        "options": {}
      },
      "id": "switch-entity",
      "name": "Switch by Entity",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        1760,
        608
      ]
    },
    {
      "parameters": {
        "url": "=https://rentprog.net/api/v1/public/search_cars",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ $json.rentprog_id }}"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.request_token }}"
            }
          ]
        },
        "options": {}
      },
      "id": "fetch-car",
      "name": "Fetch Car",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2048,
        336
      ]
    },
    {
      "parameters": {
        "url": "=https://rentprog.net/api/v1/public/search_clients",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ $json.rentprog_id }}"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.request_token }}"
            }
          ]
        },
        "options": {}
      },
      "id": "fetch-client",
      "name": "Fetch Client",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2064,
        512
      ]
    },
    {
      "parameters": {
        "url": "=https://rentprog.net/api/v1/public/search_bookings",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ $json.rentprog_id }}"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.request_token }}"
            }
          ]
        },
        "options": {}
      },
      "id": "fetch-booking",
      "name": "Fetch Booking",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2064,
        704
      ]
    },
    {
      "parameters": {
        "jsCode": "const results = Array.isArray($json) ? $json : [$json];\nconst found = results.find(item => item.id == $('Get RentProg Token').first().json.rentprog_id);\n\nif (!found) {\n  throw new Error('Entity not found in RentProg');\n}\n\nconst data = $('Get RentProg Token').first().json;\n\nconst tableMap = {\n  'car': 'cars',\n  'client': 'clients',\n  'booking': 'bookings'\n};\n\nconst tableName = tableMap[data.entity_type] || data.entity_type + 's';\n\nreturn {\n  json: {\n    entity_type: data.entity_type,\n    rentprog_id: data.rentprog_id,\n    table_name: tableName,\n    data: found,\n    data_json: JSON.stringify(found)\n  }\n};"
      },
      "id": "extract-result",
      "name": "Extract Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2240,
        512
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM dynamic_upsert_entity(\n  $1::TEXT,\n  $2::TEXT,\n  $3::JSONB\n);",
        "options": {
          "queryReplacement": "={{ $json.table_name }},={{ $json.rentprog_id }},={{ $json.data_json }}"
        }
      },
      "id": "insert-fetched",
      "name": "Insert Fetched Entity",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        2448,
        512
      ],
      "credentials": {
        "postgres": {
          "id": "3I9fyXVlGg4Vl4LZ",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE external_refs\nSET\n  data = jsonb_set(\n    COALESCE(data, '{}'::jsonb),\n    '{_deleted}',\n    'true'::jsonb\n  ),\n  updated_at = NOW()\nWHERE system = 'rentprog'\n  AND external_id = $1\nRETURNING entity_id;",
        "options": {
          "queryReplacement": "={{ $json.rentprog_id }}"
        }
      },
      "id": "mark-deleted",
      "name": "Mark as Deleted",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        1952,
        1216
      ],
      "credentials": {
        "postgres": {
          "id": "3I9fyXVlGg4Vl4LZ",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { ok: true, operation: $json.operation || 'completed', entity_id: $json.entity_id || null } }}",
        "options": {}
      },
      "id": "respond-success",
      "name": "Respond Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        4496,
        80
      ]
    }
  ],
  "connections": {
    "Webhook (${branch.name})": {
      "main": [
        [
          {
            "node": "Parse Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Webhook": {
      "main": [
        [
          {
            "node": "Save to Events",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save to Events": {
      "main": [
        [
          {
            "node": "Pass Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pass Data": {
      "main": [
        [
          {
            "node": "Switch by Operation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch by Operation": {
      "main": [
        [
          {
            "node": "Prepare Create",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Check Exists",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mark as Deleted",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Create": {
      "main": [
        [
          {
            "node": "Insert Entity",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Entity": {
      "main": [
        [
          {
            "node": "Respond Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Exists": {
      "main": [
        [
          {
            "node": "If Exists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Exists": {
      "main": [
        [
          {
            "node": "Prepare Update",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get RentProg Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Update": {
      "main": [
        [
          {
            "node": "Update Entity",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Entity": {
      "main": [
        [
          {
            "node": "Respond Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get RentProg Token": {
      "main": [
        [
          {
            "node": "Switch by Entity",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch by Entity": {
      "main": [
        [
          {
            "node": "Fetch Car",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fetch Client",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fetch Booking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Car": {
      "main": [
        [
          {
            "node": "Extract Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Client": {
      "main": [
        [
          {
            "node": "Extract Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Booking": {
      "main": [
        [
          {
            "node": "Extract Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Result": {
      "main": [
        [
          {
            "node": "Insert Fetched Entity",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Fetched Entity": {
      "main": [
        [
          {
            "node": "Respond Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark as Deleted": {
      "main": [
        [
          {
            "node": "Respond Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}