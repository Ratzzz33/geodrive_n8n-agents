{
  "name": "History Matcher & Processor",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 5
            }
          ]
        }
      },
      "id": "cron-trigger",
      "name": "Every 5 Minutes",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [240, 400]
    },
    {
      "parameters": {
        "url": "http://46.224.17.15:3000/process-history",
        "authentication": "none",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"limit\": 100\n}",
        "options": {
          "timeout": 60000
        }
      },
      "id": "process-history",
      "name": "Process History Batch",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [440, 400]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-results",
              "leftValue": "={{ $json.processed + $json.failed }}",
              "rightValue": "0",
              "operator": {
                "type": "number",
                "operation": "gt",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "has-work",
      "name": "Has Processed Items?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [640, 400]
    },
    {
      "parameters": {
        "jsCode": "// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –ª–æ–≥–∞\nconst result = $json;\n\nconst summary = `\nüìä *History Processing Completed*\n\n‚úÖ Processed: ${result.processed}\n‚è≠Ô∏è Skipped: ${result.skipped}\n‚ùå Failed: ${result.failed}\n\nüìà Total operations: ${result.results?.length || 0}\n`;\n\nlet details = '';\n\n// –¢–æ–ø –æ–ø–µ—Ä–∞—Ü–∏–π\nif (result.results && result.results.length > 0) {\n  const byType = {};\n  result.results.forEach(r => {\n    if (!byType[r.operation_type]) {\n      byType[r.operation_type] = { ok: 0, failed: 0 };\n    }\n    if (r.result.ok) {\n      byType[r.operation_type].ok++;\n    } else {\n      byType[r.operation_type].failed++;\n    }\n  });\n  \n  details += '\\nüîπ *By operation type:*\\n';\n  Object.entries(byType).forEach(([type, counts]) => {\n    details += `  ‚Ä¢ ${type}: ${counts.ok} ok, ${counts.failed} failed\\n`;\n  });\n}\n\n// –û—à–∏–±–∫–∏\nif (result.errors && result.errors.length > 0) {\n  details += '\\n‚ö†Ô∏è *Errors:*\\n';\n  result.errors.slice(0, 5).forEach(err => {\n    details += `  ‚Ä¢ ${err}\\n`;\n  });\n  if (result.errors.length > 5) {\n    details += `  ... –∏ –µ—â–µ ${result.errors.length - 5} –æ—à–∏–±–æ–∫\\n`;\n  }\n}\n\nreturn [{\n  json: {\n    summary,\n    details,\n    full_message: summary + details,\n    has_errors: result.failed > 0,\n    result\n  }\n}];"
      },
      "id": "format-log",
      "name": "Format Log",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [840, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-errors",
              "leftValue": "={{ $json.has_errors }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "has-errors",
      "name": "Has Errors?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1040, 300]
    },
    {
      "parameters": {
        "authentication": "generic",
        "genericAuthType": "httpHeaderAuth",
        "chatId": "={{ $env.TELEGRAM_ALERT_CHAT_ID }}",
        "text": "=‚ö†Ô∏è *History Processing Errors*\\n\\n{{ $json.full_message }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "send-error-alert",
      "name": "Send Error Alert",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1240, 200],
      "credentials": {
        "telegramApi": {
          "id": "telegram_bot_credentials_id",
          "name": "Telegram Bot @n8n_alert_geodrive_bot"
        }
      }
    },
    {
      "parameters": {
        "url": "http://46.224.17.15:3000/process-history/unknown",
        "authentication": "none",
        "options": {
          "timeout": 30000
        }
      },
      "id": "check-unknown",
      "name": "Check Unknown Operations",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [840, 500]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-unknown",
              "leftValue": "={{ $json.count }}",
              "rightValue": "0",
              "operator": {
                "type": "number",
                "operation": "gt",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "has-unknown",
      "name": "Has Unknown?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1040, 500]
    },
    {
      "parameters": {
        "jsCode": "// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏\nconst data = $json;\n\nif (!data.unknown_operations || data.unknown_operations.length === 0) {\n  return [];\n}\n\nlet message = 'üîç *–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –æ–ø–µ—Ä–∞—Ü–∏–π –≤ History*\\n\\n';\nmessage += `–í—Å–µ–≥–æ: ${data.count} –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Ç–∏–ø–æ–≤\\n\\n`;\n\n// –¢–æ–ø-10 –ø–æ —á–∞—Å—Ç–æ—Ç–µ\nconst top = data.unknown_operations.slice(0, 10);\ntop.forEach((op, idx) => {\n  message += `${idx + 1}. *${op.operation_type}*\\n`;\n  message += `   ‚Ä¢ –ß–∞—Å—Ç–æ—Ç–∞: ${op.frequency}\\n`;\n  message += `   ‚Ä¢ –§–∏–ª–∏–∞–ª—ã: ${op.branches_count}\\n`;\n  message += `   ‚Ä¢ Entity: ${op.entity_type || 'N/A'}\\n`;\n  if (op.sample_descriptions && op.sample_descriptions.length > 0) {\n    message += `   ‚Ä¢ –ü—Ä–∏–º–µ—Ä—ã: ${op.sample_descriptions.slice(0, 2).join(', ')}\\n`;\n  }\n  message += '\\n';\n});\n\nif (data.unknown_operations.length > 10) {\n  message += `... –∏ –µ—â–µ ${data.unknown_operations.length - 10} —Ç–∏–ø–æ–≤\\n\\n`;\n}\n\nmessage += 'üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/process-history/learn` API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∞–ø–ø–∏–Ω–≥–æ–≤';\n\nreturn [{\n  json: {\n    message,\n    unknown_operations: data.unknown_operations\n  }\n}];"
      },
      "id": "format-unknown",
      "name": "Format Unknown Alert",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1240, 500]
    },
    {
      "parameters": {
        "authentication": "generic",
        "genericAuthType": "httpHeaderAuth",
        "chatId": "={{ $env.TELEGRAM_ALERT_CHAT_ID }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "send-unknown-alert",
      "name": "Send Unknown Alert",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1440, 500],
      "credentials": {
        "telegramApi": {
          "id": "telegram_bot_credentials_id",
          "name": "Telegram Bot @n8n_alert_geodrive_bot"
        }
      }
    },
    {
      "parameters": {},
      "id": "no-work",
      "name": "No Work",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [840, 600]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 9 * * *"
            }
          ]
        }
      },
      "id": "daily-cron",
      "name": "Daily at 9 AM",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [240, 800]
    },
    {
      "parameters": {
        "url": "http://46.224.17.15:3000/process-history/stats",
        "authentication": "none",
        "options": {
          "timeout": 30000
        }
      },
      "id": "get-stats",
      "name": "Get Stats",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [440, 800]
    },
    {
      "parameters": {
        "jsCode": "// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É\nconst data = $json;\nconst summary = data.summary;\n\nlet message = 'üìä *History Processing - Daily Report*\\n\\n';\n\n// –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\nmessage += 'üî¢ *–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:*\\n';\nmessage += `  ‚Ä¢ –í—Å–µ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π: ${summary.total_processed + summary.total_pending}\\n`;\nmessage += `  ‚Ä¢ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${summary.total_processed} (${((summary.total_processed / (summary.total_processed + summary.total_pending)) * 100).toFixed(1)}%)\\n`;\nmessage += `  ‚Ä¢ –û–∂–∏–¥–∞—é—Ç: ${summary.total_pending}\\n`;\nmessage += `  ‚Ä¢ –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ —Å –≤–µ–±—Ö—É–∫–∞–º–∏: ${summary.total_matched}\\n`;\nmessage += `  ‚Ä¢ –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–∏–ø–æ–≤: ${summary.unique_operation_types}\\n`;\nmessage += `  ‚Ä¢ –§–∏–ª–∏–∞–ª–æ–≤: ${summary.branches_count}\\n\\n`;\n\n// –¢–æ–ø –æ–ø–µ—Ä–∞—Ü–∏–π —Å –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º–∏\nmessage += '‚è≥ *–¢–æ–ø –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:*\\n';\nconst topPending = data.by_operation_type\n  .filter(op => op.pending_count > 0)\n  .sort((a, b) => b.pending_count - a.pending_count)\n  .slice(0, 10);\n\nif (topPending.length > 0) {\n  topPending.forEach((op, idx) => {\n    message += `${idx + 1}. *${op.operation_type}*: ${op.pending_count} –æ–∂–∏–¥–∞—é—Ç\\n`;\n    if (op.target_table && op.target_table !== 'skip') {\n      message += `   ‚Üí ${op.target_table} (${op.processing_strategy})\\n`;\n    }\n  });\n} else {\n  message += '‚úÖ –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã!\\n';\n}\n\nmessage += '\\n';\n\n// –¢–æ–ø —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö\nmessage += '‚úÖ *–¢–æ–ø –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö (–∑–∞ –≤—Å—ë –≤—Ä–µ–º—è):*\\n';\nconst topProcessed = data.by_operation_type\n  .filter(op => op.processed_count > 0)\n  .sort((a, b) => b.processed_count - a.processed_count)\n  .slice(0, 5);\n\ntopProcessed.forEach((op, idx) => {\n  message += `${idx + 1}. ${op.operation_type}: ${op.processed_count}\\n`;\n});\n\nmessage += '\\n---\\n';\nmessage += `üïê –ü–µ—Ä–∏–æ–¥: ${new Date(summary.oldest_operation).toLocaleDateString()} - ${new Date(summary.newest_operation).toLocaleDateString()}`;\n\nreturn [{\n  json: {\n    message,\n    stats: data\n  }\n}];"
      },
      "id": "format-daily-stats",
      "name": "Format Daily Stats",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [640, 800]
    },
    {
      "parameters": {
        "authentication": "generic",
        "genericAuthType": "httpHeaderAuth",
        "chatId": "={{ $env.TELEGRAM_ALERT_CHAT_ID }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "send-daily-stats",
      "name": "Send Daily Stats",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [840, 800],
      "credentials": {
        "telegramApi": {
          "id": "telegram_bot_credentials_id",
          "name": "Telegram Bot @n8n_alert_geodrive_bot"
        }
      }
    }
  ],
  "connections": {
    "Every 5 Minutes": {
      "main": [
        [
          {
            "node": "Process History Batch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process History Batch": {
      "main": [
        [
          {
            "node": "Has Processed Items?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Processed Items?": {
      "main": [
        [
          {
            "node": "Format Log",
            "type": "main",
            "index": 0
          },
          {
            "node": "Check Unknown Operations",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Work",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Log": {
      "main": [
        [
          {
            "node": "Has Errors?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Errors?": {
      "main": [
        [
          {
            "node": "Send Error Alert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Unknown Operations": {
      "main": [
        [
          {
            "node": "Has Unknown?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Unknown?": {
      "main": [
        [
          {
            "node": "Format Unknown Alert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Unknown Alert": {
      "main": [
        [
          {
            "node": "Send Unknown Alert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Daily at 9 AM": {
      "main": [
        [
          {
            "node": "Get Stats",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Stats": {
      "main": [
        [
          {
            "node": "Format Daily Stats",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Daily Stats": {
      "main": [
        [
          {
            "node": "Send Daily Stats",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "timezone": "Asia/Tbilisi",
    "saveManualExecutions": true,
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all",
    "saveExecutionProgress": true,
    "timeout": 3600,
    "errorWorkflow": "H3UBEp425F5SMyrX"
  }
}

