{
  "name": "–ü–∞—Ä—Å–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–æ–Ω–µ–π —Ä–∞–∑ –≤ —á–∞—Å",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 1
            }
          ],
          "hours": {
            "start": 8,
            "end": 23
          }
        },
        "timezone": "Asia/Tbilisi"
      },
      "id": "cron-hourly",
      "name": "Every hour (8-23)",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [250, 300],
      "notes": "–¢—Ä–∏–≥–≥–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç workflow –∫–∞–∂–¥—ã–π —á–∞—Å —Å 8:00 –¥–æ 23:00 –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.ORCHESTRATOR_URL || 'http://46.224.17.15:3000' }}/sync-bookings",
        "sendBody": false,
        "options": {
          "timeout": 3600000,
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "call-jarvis-api",
      "name": "Call Jarvis API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [450, 300],
      "notes": "–í—ã–∑—ã–≤–∞–µ—Ç Jarvis API endpoint /sync-bookings –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤—Å–µ—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π (–∞–∫—Ç–∏–≤–Ω—ã—Ö –∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö) –∏–∑ –≤—Å–µ—Ö —Ñ–∏–ª–∏–∞–ª–æ–≤ RentProg. Endpoint –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î."
    },
    {
      "parameters": {
        "mode": "runOnceForAllItems",
        "jsCode": "// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏\nconst response = $input.all()[0].json;\n\nconst timestamp = new Date().toLocaleString('ru-RU', { timeZone: 'Asia/Tbilisi' });\n\nlet reportText = `üìä –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ë–†–û–ù–ò–†–û–í–ê–ù–ò–ô\\n`;\nreportText += `–í—Ä–µ–º—è: ${timestamp}\\n\\n`;\n\nif (response.success) {\n  reportText += `‚úÖ –°—Ç–∞—Ç—É—Å: –£—Å–ø–µ—à–Ω–æ\\n`;\n  reportText += `üì¶ –í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${response.summary.total_bookings} –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π\\n`;\n  reportText += `‚ûï –°–æ–∑–¥–∞–Ω–æ –Ω–æ–≤—ã—Ö: ${response.summary.total_created}\\n`;\n  reportText += `üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–æ: ${response.summary.total_updated}\\n`;\n  reportText += `‚ùå –û—à–∏–±–æ–∫: ${response.summary.total_errors}\\n\\n`;\n  \n  reportText += `üìã –ü–æ —Ñ–∏–ª–∏–∞–ª–∞–º:\\n`;\n  if (response.per_branch) {\n    response.per_branch.forEach(branch => {\n      const status = branch.errors === 0 ? '‚úÖ' : '‚ö†Ô∏è';\n      reportText += `${status} ${branch.branch.toUpperCase()}: ${branch.total} (—Å–æ–∑–¥–∞–Ω–æ: ${branch.created}, –æ–±–Ω–æ–≤–ª–µ–Ω–æ: ${branch.updated}, –æ—à–∏–±–æ–∫: ${branch.errors})\\n`;\n    });\n  }\n  \n  if (response.summary.total_errors > 0) {\n    reportText += `\\n‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ ${response.summary.total_errors} –æ—à–∏–±–æ–∫. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.`;\n  }\n} else {\n  reportText += `‚ùå –°—Ç–∞—Ç—É—Å: –û—à–∏–±–∫–∞\\n`;\n  reportText += `–û—à–∏–±–∫–∞: ${response.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}\\n`;\n}\n\nreturn {\n  json: {\n    reportText,\n    success: response.success,\n    total: response.summary?.total_bookings || 0,\n    errors: response.summary?.total_errors || 0\n  }\n};"
      },
      "id": "format-report",
      "name": "Format Report",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 300],
      "notes": "–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç Jarvis API –≤ —á–∏—Ç–∞–µ–º—ã–π –æ—Ç—á–µ—Ç –¥–ª—è Telegram. –í–∫–ª—é—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º –∏ –æ–±—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é."
    },
    {
      "parameters": {
        "chatId": "={{ $env.TELEGRAM_ALERT_CHAT_ID || '-5004140602' }}",
        "text": "={{ $json.reportText }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "send-telegram",
      "name": "Send Telegram Alert",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [850, 300],
      "credentials": {
        "telegramApi": {
          "id": "telegram_alert_bot",
          "name": "Telegram Alert Bot"
        }
      },
      "notes": "–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç—á–µ—Ç –æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤ Telegram."
    }
  ],
  "connections": {
    "Every hour (8-23)": {
      "main": [
        [
          {
            "node": "Call Jarvis API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call Jarvis API": {
      "main": [
        [
          {
            "node": "Format Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Report": {
      "main": [
        [
          {
            "node": "Send Telegram Alert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "timezone": "Asia/Tbilisi"
  }
}

