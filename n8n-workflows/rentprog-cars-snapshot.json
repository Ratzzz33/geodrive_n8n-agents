{
  "name": "RentProg Cars Snapshot",
  "nodes": [
    {
      "parameters": {},
      "id": "manual-trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "mode": "runOnceForAllItems",
        "jsCode": "// –¢–æ–∫–µ–Ω—ã —Ñ–∏–ª–∏–∞–ª–æ–≤ RentProg (–∏–∑ env.example)\nconst branchKeys = {\n  \"tbilisi\": \"91b83b93963633649f29a04b612bab3f9fbb0471b5928622\",\n  \"batumi\": \"7ad345720f8d92f10c187122427c6a2c2bb9494c6bf14e8d\",\n  \"kutaisi\": \"5599ebb7b94827fdfd49ca3a5b7e259cfa99d8ea78edeb50\",\n  \"service-center\": \"5y4j4gcs75o9n5s1e2vrxx4a\"\n};\n\nconst branches = ['tbilisi', 'batumi', 'kutaisi', 'service-center'];\nconst result = [];\n\nfor (const branch of branches) {\n  const companyToken = branchKeys[branch];\n  if (!companyToken) {\n    console.warn(`‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç token –¥–ª—è —Ñ–∏–ª–∏–∞–ª–∞: ${branch}`);\n    continue;\n  }\n\n  result.push({ branch, companyToken });\n}\n\nif (result.length === 0) {\n  throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –≤–∞–ª–∏–¥–Ω–æ–≥–æ —Ñ–∏–ª–∏–∞–ª–∞ —Å —Ç–æ–∫–µ–Ω–æ–º');\n}\n\nconsole.log(`‚úì –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ —Ñ–∏–ª–∏–∞–ª–æ–≤: ${result.length}`);\nreturn result.map(item => ({ json: item }));"
      },
      "id": "prepare-branches",
      "name": "Prepare Branches",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300],
      "notes": "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ —Ñ–∏–ª–∏–∞–ª–æ–≤ –∏ —Ç–æ–∫–µ–Ω–æ–≤"
    },
    {
      "parameters": {
        "mode": "runOnceForAllItems",
        "jsCode": "const branchItems = $input.all();\nconst baseUrl = 'https://rentprog.net/api/v1/public';\nconst RATE_DELAY_MS = 400; // –≤—Ä–µ–º–µ–Ω–Ω–æ —É—Å–∫–æ—Ä—è–µ–º –¥–æ ~150 req/min\nconst MAX_PAGES = 200;\nconst PAGE_SIZE = 20;\n\nconst results = [];\nconst delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));\nconst log = (message) => {\n  this.sendMessageToUI({ type: 'notice', message });\n  console.log(message);\n};\n\nfor (const item of branchItems) {\n  const { branch, companyToken } = item.json;\n  if (!companyToken) {\n    log(`‚ö†Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞—é —Ñ–∏–ª–∏–∞–ª ${branch}: –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞`);
    continue;
  }

  if (branch !== 'tbilisi') {
    log(`‚Ü©Ô∏è –í—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ñ–∏–ª–∏–∞–ª ${branch}`);
    continue;
  }

  log(`\n==============================`);
  log(`üîÑ –§–∏–ª–∏–∞–ª: ${branch}`);
  log('–ü–æ–ª—É—á–∞–µ–º request token...');

  let requestToken;
  try {
    const tokenResponse = await this.helpers.httpRequest({
      method: 'GET',
      url: `${baseUrl}/get_token`,
      qs: { company_token: companyToken },
      json: true,
      timeout: 15000
    });
    requestToken = tokenResponse?.token;
  } catch (error) {
    log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –¥–ª—è ${branch}: ${error.message}`);
    throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –¥–ª—è —Ñ–∏–ª–∏–∞–ª–∞ ${branch}`);
  }

  if (!requestToken) {
    throw new Error(`–ü—É—Å—Ç–æ–π —Ç–æ–∫–µ–Ω –¥–ª—è —Ñ–∏–ª–∏–∞–ª–∞ ${branch}`);
  }

  log('‚úì –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω. –ù–∞—á–∏–Ω–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é...');

  const cars = [];
  for (let page = 1; page <= MAX_PAGES; page++) {
    await delay(RATE_DELAY_MS);

    let pageResponse;
    try {
      pageResponse = await this.helpers.httpRequest({
        method: 'GET',
        url: `${baseUrl}/all_cars_full`,
        qs: { limit: PAGE_SIZE, page },
        headers: { Authorization: `Bearer ${requestToken}` },
        json: true,
        timeout: 15000
      });
    } catch (error) {
      log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${page} –¥–ª—è ${branch}: ${error.message}`);
      throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É ${page} –¥–ª—è —Ñ–∏–ª–∏–∞–ª–∞ ${branch}`);
    }

    const carsPage = Array.isArray(pageResponse)
      ? pageResponse
      : Array.isArray(pageResponse?.data)
        ? pageResponse.data
        : Array.isArray(pageResponse?.cars)
          ? pageResponse.cars
          : [];

    log(`üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ ${page}: ${carsPage.length} –∞–≤—Ç–æ`);

    if (!carsPage.length) {
      log(`‚úì –ü–∞–≥–∏–Ω–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –¥–ª—è ${branch}.`);
      break;
    }

    cars.push(...carsPage);

    if (carsPage.length < PAGE_SIZE) {
      log('‚úì –ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞ (–º–µ–Ω–µ–µ –ª–∏–º–∏—Ç–∞).');
      break;
    }
  }

  log(`‚û°Ô∏è –í—Å–µ–≥–æ —Å–æ–±—Ä–∞–Ω–æ ${cars.length} –∞–≤—Ç–æ –¥–ª—è —Ñ–∏–ª–∏–∞–ª–∞ ${branch}`);

  results.push({
    json: {
      branch,
      cars,
      totalCount: cars.length
    }
  });
}

return results;"
      },
      "id": "fetch-branch-cars",
      "name": "Fetch Branch Cars",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [700, 300],
      "notes": "–ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π RentProg –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π"
    },
    {
      "parameters": {
        "jsCode": "const branch = $json.branch;\nconst cars = $json.cars || [];\n\nconst transformed = cars.map(car => ({\n  rentprog_id: String(car.id),\n  branch_code: branch,\n  plate: car.car_number || car.number || null,\n  vin: car.vin || null,\n  model: car.car_name || car.model || null,\n  starline_id: car.starline_id || null,\n  data: car\n}));\n\nconsole.log(`üîÑ –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ ${transformed.length} –∞–≤—Ç–æ –¥–ª—è upsert (—Ñ–∏–ª–∏–∞–ª: ${branch})`);\n\nreturn [{\n  json: {\n    branch,\n    cars: transformed,\n    carsCount: transformed.length\n  }\n}];"
      },
      "id": "transform-for-upsert",
      "name": "Transform For Upsert",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [950, 300],
      "notes": "–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤ –ë–î"
    },
    {
      "parameters": {
        "jsCode": "const branch = $json.branch;\nconst cars = $json.cars || [];\n\nif (cars.length === 0) {\n  console.warn(`‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è upsert (—Ñ–∏–ª–∏–∞–ª: ${branch})`);\n  return [{ json: { branch, sql: 'SELECT 1;', carsCount: 0, carsData: [] } }];\n}\n\nconst values = cars.map(car => {\n  const esc = (val) => val ? `'${String(val).replace(/'/g, "''")}'` : 'NULL';\n  const jsonData = JSON.stringify(car.data).replace(/'/g, "''");\n\n  return `(\n    gen_random_uuid(),\n    (SELECT id FROM branches WHERE code = '${branch}' LIMIT 1),\n    ${esc(car.plate)},\n    ${esc(car.vin)},\n    ${esc(car.model)},\n    ${esc(car.starline_id)},\n    '${jsonData}'::jsonb,\n    NOW(),\n    NOW()\n  )`;\n}).join(',\\n');\n\nconst sql = `\n-- Upsert –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –¥–ª—è —Ñ–∏–ª–∏–∞–ª–∞ ${branch}\nINSERT INTO cars (\n  id, branch_id, plate, vin, model, starline_id, data, created_at, updated_at\n)\nVALUES\n${values}\nON CONFLICT (data->>'id') DO UPDATE SET\n  branch_id = EXCLUDED.branch_id,\n  plate = EXCLUDED.plate,\n  vin = EXCLUDED.vin,\n  model = EXCLUDED.model,\n  starline_id = EXCLUDED.starline_id,\n  data = EXCLUDED.data,\n  updated_at = NOW();\n`;\n\nconsole.log(`üßæ SQL upsert –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω (${cars.length} –∞–≤—Ç–æ, —Ñ–∏–ª–∏–∞–ª: ${branch})`);\n\nreturn [{ json: { branch, sql, carsCount: cars.length, carsData: cars } }];"
      },
      "id": "generate-upsert-sql",
      "name": "Generate Upsert SQL",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1200, 300],
      "notes": "SQL –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.sql }}",
        "options": {}
      },
      "id": "upsert-cars-postgres",
      "name": "Upsert Cars to PostgreSQL",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [1450, 300],
      "credentials": {
        "postgres": {
          "id": "3I9fyXVlGg4Vl4LZ",
          "name": "Postgres account"
        }
      },
      "notes": "–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã cars"
    },
    {
      "parameters": {
        "jsCode": "const branch = $json.branch;\nconst carsData = $json.carsData || [];\n\nif (carsData.length === 0) {\n  return [{ json: { branch, sql: 'SELECT 1;', externalRefsCount: 0 } }];\n}\n\nconst values = carsData.map(car => {\n  const esc = (val) => val ? `'${String(val).replace(/'/g, "''")}'` : 'NULL';\n  const rentprogId = esc(car.rentprog_id);\n  const meta = JSON.stringify({ branch, synced_at: new Date().toISOString() }).replace(/'/g, "''");\n\n  return `(\n    gen_random_uuid(),\n    'car',\n    (SELECT id FROM cars WHERE data->>'id' = ${rentprogId} LIMIT 1),\n    'rentprog',\n    ${rentprogId},\n    '${branch}',\n    '${meta}'::jsonb,\n    NOW(),\n    NOW()\n  )`;\n}).join(',\\n');\n\nconst sql = `\n-- Upsert external_refs –¥–ª—è —Ñ–∏–ª–∏–∞–ª–∞ ${branch}\nINSERT INTO external_refs (\n  id, entity_type, entity_id, system, external_id, branch_code, meta, created_at, updated_at\n)\nVALUES\n${values}\nON CONFLICT (system, external_id) DO UPDATE SET\n  entity_id = EXCLUDED.entity_id,\n  branch_code = EXCLUDED.branch_code,\n  meta = EXCLUDED.meta,\n  updated_at = NOW();\n`;\n\nconsole.log(`üîó SQL external_refs –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω (${carsData.length} –∞–≤—Ç–æ, —Ñ–∏–ª–∏–∞–ª: ${branch})`);\n\nreturn [{ json: { branch, sql, externalRefsCount: carsData.length } }];"
      },
      "id": "generate-external-refs-sql",
      "name": "Generate External Refs SQL",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1700, 300],
      "notes": "SQL –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã external_refs"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.sql }}",
        "options": {}
      },
      "id": "upsert-external-refs",
      "name": "Upsert External Refs",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [1950, 300],
      "credentials": {
        "postgres": {
          "id": "3I9fyXVlGg4Vl4LZ",
          "name": "Postgres account"
        }
      },
      "notes": "–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL –¥–ª—è external_refs"
    },
    {
      "parameters": {
        "jsCode": "const branch = $json.branch;\nconst imported = $json.carsCount || 0;\n\nconsole.log(`‚úÖ –§–∏–ª–∏–∞–ª ${branch}: –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${imported} –∞–≤—Ç–æ`);\n\nreturn [{ json: { branch, imported, timestamp: new Date().toISOString() } }];"
      },
      "id": "branch-summary",
      "name": "Branch Summary",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2200, 300],
      "notes": "–ò—Ç–æ–≥ –ø–æ —Ñ–∏–ª–∏–∞–ª—É"
    },
    {
      "parameters": {
        "mode": "runOnceForAllItems",
        "jsCode": "const items = $input.all();\nconst summary = items.map(item => item.json);\nconst totalImported = summary.reduce((acc, curr) => acc + (curr.imported || 0), 0);\n\nconsole.log('========================================');\nconsole.log('üéâ –ò–ú–ü–û–†–¢ –ê–í–¢–û –ó–ê–í–ï–†–®–ï–ù');\nconsole.log('========================================');\nsummary.forEach(item => console.log(`${item.branch}: ${item.imported} –∞–≤—Ç–æ`));\nconsole.log('========================================');\nconsole.log(`–ò–¢–û–ì–û: ${totalImported} –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π`);\nconsole.log('========================================');\n\nreturn [{ json: { status: 'completed', totalImported, branches: summary, completedAt: new Date().toISOString() } }];"
      },
      "id": "final-report",
      "name": "Final Report",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2450, 300],
      "notes": "–§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç"
    }
  ],
  "connections": {
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Prepare Branches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Branches": {
      "main": [
        [
          {
            "node": "Fetch Branch Cars",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Branch Cars": {
      "main": [
        [
          {
            "node": "Transform For Upsert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transform For Upsert": {
      "main": [
        [
          {
            "node": "Generate Upsert SQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Upsert SQL": {
      "main": [
        [
          {
            "node": "Upsert Cars to PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert Cars to PostgreSQL": {
      "main": [
        [
          {
            "node": "Generate External Refs SQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate External Refs SQL": {
      "main": [
        [
          {
            "node": "Upsert External Refs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert External Refs": {
      "main": [
        [
          {
            "node": "Branch Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Branch Summary": {
      "main": [
        [
          {
            "node": "Final Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-11-03T00:00:00.000Z",
  "versionId": "2"
}

