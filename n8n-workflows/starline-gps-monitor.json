{
  "name": "Starline GPS Monitor (Every Minute)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "* * * * *"
            }
          ]
        }
      },
      "id": "1a2b3c4d-5e6f-7g8h-9i0j-1k2l3m4n5o6p",
      "name": "Every Minute",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [256, 304]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://172.17.0.1:3000/starline/update-gps",
        "options": {
          "timeout": 30000
        }
      },
      "id": "2b3c4d5e-6f7g-8h9i-0j1k-2l3m4n5o6p7q",
      "name": "Update GPS Data",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [464, 304]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "c1",
              "leftValue": "={{ $json.ok }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            },
            {
              "id": "c2",
              "leftValue": "={{ $json.errors.length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "3c4d5e6f-7g8h-9i0j-1k2l-3m4n5o6p7q8r",
      "name": "Check Status",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [656, 304]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a1",
              "name": "status",
              "value": "success",
              "type": "string"
            },
            {
              "id": "a2",
              "name": "updated",
              "value": "={{ $json.updated }}",
              "type": "number"
            },
            {
              "id": "a3",
              "name": "error_count",
              "value": "0",
              "type": "number"
            },
            {
              "id": "a4",
              "name": "timestamp",
              "value": "={{ $json.timestamp }}",
              "type": "string"
            },
            {
              "id": "a5",
              "name": "full_response",
              "value": "={{ $json }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "id": "4d5e6f7g-8h9i-0j1k-2l3m-4n5o6p7q8r9s",
      "name": "Success Log",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [864, 208]
    },
    {
      "parameters": {
        "fieldToSplitOut": "full_response.details",
        "options": {}
      },
      "id": "9i0j1k2l-3m4n-5o6p-7q8r-9s0t1u2v3w4x",
      "name": "Split Cars Details",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [1100, 100]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a1",
              "name": "status",
              "value": "error",
              "type": "string"
            },
            {
              "id": "a2",
              "name": "updated",
              "value": "={{ $json.updated }}",
              "type": "number"
            },
            {
              "id": "a3",
              "name": "error_count",
              "value": "={{ $json.errors.length }}",
              "type": "number"
            },
            {
              "id": "a4",
              "name": "errors",
              "value": "={{ $json.errors }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "id": "5e6f7g8h-9i0j-1k2l-3m4n-5o6p7q8r9s0t",
      "name": "Error Log",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [864, 400]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "c1",
              "leftValue": "={{ $json.error_count }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "6f7g8h9i-0j1k-2l3m-4n5o-6p7q8r9s0t1u",
      "name": "Critical Errors?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1056, 400]
    },
    {
      "parameters": {
        "chatId": "={{ $env.TELEGRAM_ALERT_CHAT_ID }}",
        "text": "ðŸš¨ **Starline GPS Monitor - ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸**\n\nâœ… ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾: {{ $json.updated }} Ð¼Ð°ÑˆÐ¸Ð½\nâŒ ÐžÑˆÐ¸Ð±Ð¾Ðº: {{ $json.error_count }}\n\n**Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð¾ÑˆÐ¸Ð±Ð¾Ðº:**\n{{ $json.errors.join('\\n') }}\n\nðŸ• {{ $now.toISO() }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "7g8h9i0j-1k2l-3m4n-5o6p-7q8r9s0t1u2v",
      "name": "Send Telegram Alert",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1328, 544]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO health (ts, branch, ok, reason) VALUES (NOW(), 'starline', {{ $json.status === 'success' }}, '{{ $json.error_count > 0 ? \"Errors: \" + $json.error_count : \"OK\" }}')",
        "options": {}
      },
      "id": "8h9i0j1k-2l3m-4n5o-6p7q-8r9s0t1u2v3w",
      "name": "Log to Health Table",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1456, 304],
      "credentials": {
        "postgres": {
          "id": "postgres-credentials",
          "name": "PostgreSQL"
        }
      }
    }
  ],
  "connections": {
    "Every Minute": {
      "main": [[{"node": "Update GPS Data", "type": "main", "index": 0}]]
    },
    "Update GPS Data": {
      "main": [[{"node": "Check Status", "type": "main", "index": 0}]]
    },
    "Check Status": {
      "main": [
        [{"node": "Success Log", "type": "main", "index": 0}],
        [{"node": "Error Log", "type": "main", "index": 0}]
      ]
    },
    "Success Log": {
      "main": [[{"node": "Split Cars Details", "type": "main", "index": 0}, {"node": "Log to Health Table", "type": "main", "index": 0}]]
    },
    "Split Cars Details": {
      "main": []
    },
    "Error Log": {
      "main": [[{"node": "Critical Errors?", "type": "main", "index": 0}]]
    },
    "Critical Errors?": {
      "main": [
        [{"node": "Send Telegram Alert", "type": "main", "index": 0}],
        [{"node": "Log to Health Table", "type": "main", "index": 0}]
      ]
    },
    "Send Telegram Alert": {
      "main": [[{"node": "Log to Health Table", "type": "main", "index": 0}]]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all",
    "saveManualExecutions": true,
    "errorWorkflow": "H3UBEp425F5SMyrX",
    "timezone": "Asia/Tbilisi",
    "saveExecutionProgress": true,
    "executionTimeout": 3600
  }
}
