{
  "name": "Health & Status",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 5
            }
          ]
        }
      },
      "id": "cron-node",
      "name": "Cron",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [
        250,
        300
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $env.RENTPROG_HEALTH_URL || 'http://46.224.17.15:3000/rentprog/health' }}",
        "options": {}
      },
      "id": "http-node",
      "name": "HTTP Request",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        450,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// ÐŸÐ°Ñ€ÑÐ¸Ð¼ Ð¾Ñ‚Ð²ÐµÑ‚ health check\nconst response = $input.item.json;\nconst branches = ['tbilisi', 'batumi', 'kutaisi', 'service-center'];\n\nconst results = [];\n\nif (response.perBranch) {\n  for (const branch of branches) {\n    const branchStatus = response.perBranch[branch];\n    results.push({\n      json: {\n        ts: new Date().toISOString(),\n        branch,\n        ok: branchStatus.ok || false,\n        reason: branchStatus.error || 'ok'\n      }\n    });\n  }\n}\n\nreturn results;"
      },
      "id": "code-node",
      "name": "Process Health",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        650,
        300
      ]
    },
    {
      "parameters": {
        "operation": "insert",
        "tableId": "health",
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "ts": "={{ $json.ts }}",
            "branch": "={{ $json.branch }}",
            "ok": "={{ $json.ok }}",
            "reason": "={{ $json.reason }}"
          }
        },
        "options": {}
      },
      "id": "data-table-node",
      "name": "Save Health",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        850,
        300
      ],
      "credentials": {
        "postgres": {
          "id": "postgres-credentials",
          "name": "PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "health-fail",
              "leftValue": "={{ $json.ok }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "not"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-fail-node",
      "name": "If Failed",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1050,
        300
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $env.TELEGRAM_ALERT_CHAT_ID }}",
        "text": "=ðŸš¨ RentProg Health Check Failed\n\nBranch: {{ $json.branch }}\nReason: {{ $json.reason }}\nTime: {{ $json.ts }}",
        "additionalFields": {}
      },
      "id": "telegram-node",
      "name": "Telegram Alert",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        1250,
        400
      ],
      "credentials": {
        "telegramApi": {
          "id": "telegram-credentials",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "operation": "query",
        "query": "WITH config AS (SELECT * FROM (VALUES ('starline'), ('starline-api')) AS c(branch)), latest AS (SELECT DISTINCT ON (branch) branch, ts, ok, reason FROM health WHERE branch IN (SELECT branch FROM config) ORDER BY branch, ts DESC) SELECT c.branch, l.ts, l.ok, l.reason FROM config c LEFT JOIN latest l ON l.branch = c.branch;"
      },
      "id": "fetch-workflow-health",
      "name": "Fetch Workflow Health",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        450,
        100
      ],
      "credentials": {
        "postgres": {
          "id": "postgres-credentials",
          "name": "PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForAllItems",
        "jsCode": "// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ workflow Ð¿Ñ€Ð¸ÑÑ‹Ð»Ð°ÑŽÑ‚ ÑÐ²ÐµÐ¶Ð¸Ðµ ÑÑ‚Ð°Ñ‚ÑƒÑÑ‹\nconst monitored = [\n  { branch: 'starline', label: 'Starline GPS Monitor', maxLagMinutes: 6 },\n  { branch: 'starline-api', label: 'Starline API Sync', maxLagMinutes: 3 }\n];\n\nconst latestByBranch = {};\nfor (const item of $input.all()) {\n  const data = item.json;\n  if (!data.branch) continue;\n  latestByBranch[data.branch] = data;\n}\n\nconst now = Date.now();\nconst issues = [];\n\nfor (const config of monitored) {\n  const latest = latestByBranch[config.branch];\n\n  if (!latest || !latest.ts) {\n    issues.push({\n      branch: config.branch,\n      label: config.label,\n      details: 'ÐÐµÑ‚ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð² health â€” workflow Ð¼Ð¾Ð³ Ð¿ÐµÑ€ÐµÑÑ‚Ð°Ñ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ',\n      issue: 'no-data'\n    });\n    continue;\n  }\n\n  const lastTs = Date.parse(latest.ts);\n  const minutesSince = Math.round((now - lastTs) / 60000);\n\n  if (latest.ok === false) {\n    issues.push({\n      branch: config.branch,\n      label: config.label,\n      details: `ÐŸÐ¾ÑÐ»ÐµÐ´Ð½ÐµÐµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ð»Ð¾ÑÑŒ Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ¾Ð¹: ${latest.reason || 'Ð½ÐµÑ‚ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ'}`,\n      lastTs: latest.ts,\n      minutesSince,\n      issue: 'failed'\n    });\n    continue;\n  }\n\n  if (minutesSince > config.maxLagMinutes) {\n    issues.push({\n      branch: config.branch,\n      label: config.label,\n      details: `ÐÐµÑ‚ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¹ ${minutesSince} Ð¼Ð¸Ð½ (Ð»Ð¸Ð¼Ð¸Ñ‚ ${config.maxLagMinutes} Ð¼Ð¸Ð½). ÐŸÐ¾ÑÐ»ÐµÐ´Ð½ÑÑ Ð·Ð°Ð¿Ð¸ÑÑŒ: ${latest.ts || 'Ð½ÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…'}`,\n      lastTs: latest.ts,\n      minutesSince,\n      issue: 'stale'\n    });\n  }\n}\n\nif (issues.length === 0) {\n  return [];\n}\n\nconst lines = [\n  'ðŸš¨ ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ workflow: Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ñ‹ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹',\n  '',\n  ...issues.map((issue) => `â€¢ ${issue.label} â€” ${issue.details}`)\n];\n\nreturn [{\n  json: {\n    message: lines.join('\\n'),\n    issues\n  }\n}];"
      },
      "id": "evaluate-workflows",
      "name": "Evaluate Workflows",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        650,
        100
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $env.TELEGRAM_ALERT_CHAT_ID }}",
        "text": "={{ $json.message + '\\n\\nðŸ”— <a href=\"https://n8n.rentflow.rentals/workflow/' + $workflow.id + '/executions/' + $execution.id + '\">ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ execution</a>' }}",
        "additionalFields": {
          "parse_mode": "HTML"
        }
      },
      "id": "workflow-telegram-alert",
      "name": "Workflow Alert",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        850,
        100
      ],
      "credentials": {
        "telegramApi": {
          "id": "telegram-credentials",
          "name": "Telegram Bot"
        }
      }
    }
  ],
  "connections": {
    "Cron": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch Workflow Health",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Process Health",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Health": {
      "main": [
        [
          {
            "node": "Save Health",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Health": {
      "main": [
        [
          {
            "node": "If Failed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Failed": {
      "main": [
        [],
        [
          {
            "node": "Telegram Alert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Workflow Health": {
      "main": [
        [
          {
            "node": "Evaluate Workflows",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Evaluate Workflows": {
      "main": [
        [
          {
            "node": "Workflow Alert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1",
    "timezone": "Asia/Tbilisi",
    "saveExecutionProgress": true
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-01-15T00:00:00.000Z",
  "versionId": "1"
}