Running query:
SELECT pg_get_functiondef('apply_history_changes(bigint, text, text, text, text, text, jsonb, text, text, text, jsonb)'::regprocedure) as def;
{"def":"CREATE OR REPLACE FUNCTION public.apply_history_changes(history_id bigint, entity_type_value text, entity_id_value text, operation_value text, branch_code text, user_name_value text, raw_data_value jsonb, description_value text, amount_value text, currency_value text, extra_data jsonb)\n RETURNS boolean\n LANGUAGE plpgsql\nAS $function$\r\nDECLARE\r\n  internal_uuid UUID;\r\n  booking_uuid UUID;\r\n  car_uuid UUID;\r\n  client_uuid UUID;\r\n  payment_uuid UUID;\r\n  payment_ids TEXT[];\r\n  payment_id TEXT;\r\n  amount_text TEXT;\r\n  currency_text TEXT;\r\n  direction TEXT;\r\n  method TEXT;\r\n  payment_date TIMESTAMPTZ;\r\n  history_entry JSONB;\r\n  new_status TEXT;\r\n  result BOOLEAN := FALSE;\r\nBEGIN\r\n  IF entity_type_value IS NULL OR entity_id_value IS NULL OR entity_id_value = '' THEN\r\n    RETURN FALSE;\r\n  END IF;\r\n  \r\n  IF extra_data IS NULL THEN\r\n    extra_data := '{}'::jsonb;\r\n  END IF;\r\n  \r\n  -- ╨₧╨▒╤ë╨╕╨╣ ╨┐╨╛╨╕╤ü╨║ UUID\r\n  SELECT entity_id INTO internal_uuid\r\n  FROM external_refs\r\n  WHERE system = 'rentprog' \r\n    AND external_id = entity_id_value \r\n    AND entity_type = entity_type_value\r\n  LIMIT 1;\r\n  \r\n  CASE entity_type_value\r\n    WHEN 'booking' THEN\r\n      IF internal_uuid IS NULL THEN\r\n        RETURN FALSE;\r\n      END IF;\r\n      \r\n      history_entry := jsonb_strip_nulls(jsonb_build_object(\r\n        'history_id', history_id,\r\n        'operation', operation_value,\r\n        'description', description_value,\r\n        'user_name', user_name_value,\r\n        'branch', branch_code,\r\n        'extra', extra_data,\r\n        'raw', raw_data_value,\r\n        'amount', amount_value,\r\n        'currency', currency_value,\r\n        'created_at', NOW()\r\n      ));\r\n      \r\n      new_status := NULL;\r\n      IF operation_value = 'issue' THEN\r\n        new_status := 'active';\r\n      ELSIF operation_value = 'return' THEN\r\n        new_status := 'completed';\r\n      ELSIF operation_value = 'create' THEN\r\n        new_status := 'planned';\r\n      END IF;\r\n      \r\n      UPDATE bookings\r\n      SET \r\n        status = COALESCE(new_status, status),\r\n        updated_at = NOW(),\r\n        history_log = COALESCE(history_log, '[]'::jsonb) || jsonb_build_array(history_entry)\r\n      WHERE id = internal_uuid;\r\n      result := TRUE;\r\n      \r\n    WHEN 'car' THEN\r\n      IF internal_uuid IS NULL THEN\r\n        RETURN FALSE;\r\n      END IF;\r\n      \r\n      IF extra_data ? 'service' THEN\r\n        result := process_car_service_task(\r\n          history_id,\r\n          internal_uuid,\r\n          entity_id_value,\r\n          branch_code,\r\n          user_name_value,\r\n          extra_data->'service',\r\n          description_value\r\n        );\r\n      ELSIF raw_data_value IS NOT NULL AND operation_value = 'update' THEN\r\n        UPDATE cars\r\n        SET \r\n          updated_at = NOW(),\r\n          data = COALESCE(data, '{}'::jsonb) || raw_data_value\r\n        WHERE id = internal_uuid;\r\n        result := TRUE;\r\n      END IF;\r\n      \r\n    WHEN 'client' THEN\r\n      IF internal_uuid IS NULL THEN\r\n        RETURN FALSE;\r\n      END IF;\r\n      IF raw_data_value IS NOT NULL AND operation_value = 'update' THEN\r\n        UPDATE clients\r\n        SET \r\n          updated_at = NOW(),\r\n          data = COALESCE(data, '{}'::jsonb) || raw_data_value\r\n        WHERE id = internal_uuid;\r\n        result := TRUE;\r\n      END IF;\r\n      \r\n    WHEN 'payment' THEN\r\n      payment_ids := ARRAY[entity_id_value];\r\n      IF extra_data ? 'payment_ids' THEN\r\n        payment_ids := payment_ids || ARRAY(\r\n          SELECT jsonb_array_elements_text(extra_data->'payment_ids')\r\n        );\r\n      END IF;\r\n      \r\n      payment_ids := ARRAY(\r\n        SELECT DISTINCT val FROM unnest(payment_ids) AS val\r\n        WHERE val IS NOT NULL AND val <> ''\r\n      );\r\n      \r\n      IF array_length(payment_ids, 1) = 0 THEN\r\n        RETURN FALSE;\r\n      END IF;\r\n      \r\n      amount_text := COALESCE(amount_value, raw_data_value->>'sum', '0');\r\n      amount_text := replace(amount_text, ',', '.');\r\n      currency_text := COALESCE(currency_value, upper(raw_data_value->>'currency'), 'GEL');\r\n      direction := COALESCE(extra_data->>'payment_direction', CASE WHEN operation_value = 'create' THEN 'income' ELSE 'unknown' END);\r\n      method := COALESCE(extra_data->>'payment_method', 'cash');\r\n      \r\n      payment_date := NULL;\r\n      IF raw_data_value ? 'created_at' THEN\r\n        BEGIN\r\n          payment_date := (raw_data_value->>'created_at')::timestamptz;\r\n        EXCEPTION WHEN others THEN\r\n          payment_date := NULL;\r\n        END;\r\n      END IF;\r\n      payment_date := COALESCE(payment_date, NOW());\r\n      \r\n      FOR payment_id IN SELECT unnest(payment_ids)\r\n      LOOP\r\n        CONTINUE WHEN payment_id IS NULL OR payment_id = '';\r\n        BEGIN\r\n          SELECT entity_id INTO payment_uuid\r\n          FROM external_refs\r\n          WHERE system = 'rentprog'\r\n            AND entity_type = 'payment'\r\n            AND external_id = payment_id\r\n          LIMIT 1;\r\n          \r\n          IF payment_uuid IS NULL THEN\r\n            INSERT INTO payments (\r\n              branch,\r\n              payment_date,\r\n              payment_type,\r\n              payment_method,\r\n              amount,\r\n              currency,\r\n              description,\r\n              rp_payment_id,\r\n              raw_data\r\n            )\r\n            VALUES (\r\n              branch_code,\r\n              payment_date,\r\n              direction,\r\n              method,\r\n              amount_text,\r\n              currency_text,\r\n              description_value,\r\n              payment_id::int,\r\n              raw_data_value\r\n            )\r\n            ON CONFLICT (branch, rp_payment_id)\r\n            DO UPDATE SET\r\n              payment_date = EXCLUDED.payment_date,\r\n              amount = EXCLUDED.amount,\r\n              currency = EXCLUDED.currency,\r\n              description = EXCLUDED.description\r\n            RETURNING id INTO payment_uuid;\r\n            \r\n            INSERT INTO external_refs (\r\n              entity_type,\r\n              entity_id,\r\n              system,\r\n              external_id,\r\n              branch_code,\r\n              created_at,\r\n              updated_at\r\n            )\r\n            VALUES (\r\n              'payment',\r\n              payment_uuid,\r\n              'rentprog',\r\n              payment_id,\r\n              branch_code,\r\n              NOW(),\r\n              NOW()\r\n            )\r\n            ON CONFLICT DO NOTHING;\r\n          END IF;\r\n          \r\n          result := TRUE;\r\n        EXCEPTION\r\n          WHEN invalid_text_representation THEN\r\n            CONTINUE;\r\n        END;\r\n      END LOOP;\r\n      \r\n    ELSE\r\n      IF internal_uuid IS NULL THEN\r\n        RETURN FALSE;\r\n      END IF;\r\n      result := FALSE;\r\n  END CASE;\r\n  \r\n  RETURN result;\r\nEND;\r\n$function$\n"}
