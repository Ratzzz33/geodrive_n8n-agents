# üë• –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤

**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞:** 5 –Ω–æ—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ Ready to deploy

---

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
3. [–£—Å—Ç–∞–Ω–æ–≤–∫–∞](#—É—Å—Ç–∞–Ω–æ–≤–∫–∞)
4. [–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç](#–∫–∞–∫-—ç—Ç–æ-—Ä–∞–±–æ—Ç–∞–µ—Ç)
5. [–ü—Ä–∏–º–µ—Ä—ã](#–ø—Ä–∏–º–µ—Ä—ã)
6. [–ü—Ä–æ–≤–µ—Ä–∫–∞](#–ø—Ä–æ–≤–µ—Ä–∫–∞)
7. [FAQ](#faq)

---

## –û–±–∑–æ—Ä

### –ß—Ç–æ —ç—Ç–æ?

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è —Å–±–æ—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö –∏–∑ –≤–µ–±—Ö—É–∫–æ–≤ RentProg –∏ –∏–º–ø–æ—Ä—Ç–æ–≤ –¥–∞–Ω–Ω—ã—Ö.

### –ó–∞—á–µ–º?

- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä** - –Ω–µ –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
- ‚úÖ **–ò–∑ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤** - –≤–µ–±—Ö—É–∫–∏, –∏–º–ø–æ—Ä—Ç—ã, —Ä—É—á–Ω—ã–µ UPDATE
- ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –º–∞—Å—Å–∏–≤—ã `[old, new]`
- ‚úÖ **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è** - –æ–¥–∏–Ω —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ = –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å
- ‚úÖ **–ë–∞–∑–∞ –¥–ª—è –±—É–¥—É—â–µ–≥–æ** - –º–æ–∂–Ω–æ –ø–æ—Ç–æ–º –æ–±–æ–≥–∞—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ RentProg API

### –û—Ç–∫—É–¥–∞ –±–µ—Ä—É—Ç—Å—è –¥–∞–Ω–Ω—ã–µ?

**–ò–∑ –ø–æ–ª–µ–π bookings:**
- `responsible_id` + `responsible` (–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ –±—Ä–æ–Ω—å)
- `start_worker_id` + `start_worker_name` (–∫—Ç–æ –ø—Ä–æ–≤—ë–ª –≤—ã–¥–∞—á—É)
- `end_worker_id` + `end_worker_name` (–∫—Ç–æ –ø—Ä–æ–≤—ë–ª –ø—Ä–∏—ë–º–∫—É)
- `updater` (–∫—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ–±–Ω–æ–≤–∏–ª)
- `state_updater` (–∫—Ç–æ –∏–∑–º–µ–Ω–∏–ª —Å—Ç–∞—Ç—É—Å)
- `user_id` (–∫—Ç–æ —Å–æ–∑–¥–∞–ª –±—Ä–æ–Ω—å)

**–ò–∑ –ø–æ–ª–µ–π cars:**
- `user_id` (–∫—Ç–æ —Å–æ–∑–¥–∞–ª/–æ–±–Ω–æ–≤–∏–ª –º–∞—à–∏–Ω—É)

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î

```sql
-- –¢–∞–±–ª–∏—Ü–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
CREATE TABLE employees (
  id UUID PRIMARY KEY,                -- –ù–∞—à UUID
  rentprog_id TEXT UNIQUE NOT NULL,   -- ID –≤ RentProg (14714)
  name TEXT,                           -- "Toma Khabuliani"
  first_name TEXT,                     -- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –ø–æ–∑–∂–µ
  last_name TEXT,                      -- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –ø–æ–∑–∂–µ
  company_id INTEGER,                  -- –§–∏–ª–∏–∞–ª (–±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–∑–∂–µ)
  data JSONB DEFAULT '{}'::jsonb,     -- –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–¥–ª—è –±—É–¥—É—â–µ–≥–æ)
  created_at TIMESTAMPTZ,
  updated_at TIMESTAMPTZ
);

-- –°–≤—è–∑—å —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏
CREATE TABLE external_refs (
  entity_type TEXT,   -- 'employee'
  entity_id UUID,     -- UUID –∏–∑ employees
  system TEXT,        -- 'rentprog'
  external_id TEXT,   -- '14714'
  UNIQUE (system, external_id)
);
```

### –¢—Ä–∏–≥–≥–µ—Ä

```
–í–µ–±—Ö—É–∫/–ò–º–ø–æ—Ä—Ç ‚Üí INSERT/UPDATE booking
                       ‚Üì
         –¢—Ä–∏–≥–≥–µ—Ä: extract_employees_from_data()
                       ‚Üì
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ –ò–∑–≤–ª–µ–∫–∞–µ—Ç –≤—Å–µ –ø–æ–ª—è —Å ID  ‚îÇ
         ‚îÇ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤              ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –º–∞—Å—Å–∏–≤—ã     ‚îÇ
         ‚îÇ [old_id, new_id]         ‚îÇ
         ‚îÇ [old_name, new_name]     ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ  ‚îÇ
         ‚îÇ –≤ external_refs          ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ –°–æ–∑–¥–∞–µ—Ç employee –µ—Å–ª–∏    ‚îÇ
         ‚îÇ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç            ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚Üì
              employees + external_refs
```

---

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–∞

```bash
node setup/create_employees_extraction_trigger.mjs
```

**–ß—Ç–æ —Å–æ–∑–¥–∞—ë—Ç—Å—è:**
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `employees`
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ `rentprog_id` –∏ `company_id`
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `extract_employees_from_data()`
- ‚úÖ –¢—Ä–∏–≥–≥–µ—Ä –Ω–∞ `bookings`
- ‚úÖ –¢—Ä–∏–≥–≥–µ—Ä –Ω–∞ `cars`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–æ–∑–¥–∞–Ω—ã!

üìã –ß—Ç–æ —Å–æ–∑–¥–∞–Ω–æ:
   - –¢–∞–±–ª–∏—Ü–∞: employees
   - –ò–Ω–¥–µ–∫—Å—ã: rentprog_id, company_id
   - –§—É–Ω–∫—Ü–∏—è: extract_employees_from_data()
   - –¢—Ä–∏–≥–≥–µ—Ä: bookings ‚Üí extract_employees_from_bookings_trigger
   - –¢—Ä–∏–≥–≥–µ—Ä: cars ‚Üí extract_employees_from_cars_trigger
```

---

### –®–∞–≥ 2: –°–±–æ—Ä –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö

```bash
node setup/collect_historical_employees.mjs
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –±—Ä–æ–Ω–∏
- –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏–∑ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~5-10 –º–∏–Ω—É—Ç –¥–ª—è 3449 –±—Ä–æ–Ω–µ–π

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–±—Ä–∞–Ω—ã!

üìä –ò—Ç–æ–≥–æ:
   - –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –±—Ä–æ–Ω–µ–π: 3449
   - –ù–∞–π–¥–µ–Ω–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: 45
   - –ë–µ–∑ –∏–º—ë–Ω: 12
```

---

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞

```bash
node setup/check_employees_extraction.mjs
```

**–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞
- ‚úÖ –¢—Ä–∏–≥–≥–µ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –∏–∑–≤–ª–µ—á–µ–Ω—ã
- ‚úÖ external_refs —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü—Ä–∏–º–µ—Ä 1: CREATE —Å–æ–±—ã—Ç–∏—è (–Ω–æ–≤–∞—è –±—Ä–æ–Ω—å)

**–í–µ–±—Ö—É–∫:**
```json
{
  "event": "booking.create",
  "payload": {
    "id": 506503,
    "responsible_id": "14714",
    "responsible": "Toma Khabuliani",
    "start_worker_id": "11855"
  }
}
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

1. INSERT –≤ `bookings`
2. –¢—Ä–∏–≥–≥–µ—Ä —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
3. –ò–∑–≤–ª–µ–∫–∞–µ—Ç:
   - `responsible_id: "14714"` + `responsible: "Toma Khabuliani"`
   - `start_worker_id: "11855"` (–∏–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ)
4. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç external_refs
5. –°–æ–∑–¥–∞—ë—Ç –∑–∞–ø–∏—Å–∏:

```sql
-- Employee 1
INSERT INTO employees (rentprog_id, name)
VALUES ('14714', 'Toma Khabuliani');

INSERT INTO external_refs (entity_type, system, external_id)
VALUES ('employee', 'rentprog', '14714');

-- Employee 2
INSERT INTO employees (rentprog_id, name)
VALUES ('11855', 'Employee 11855');  -- –ò–º—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ

INSERT INTO external_refs (entity_type, system, external_id)
VALUES ('employee', 'rentprog', '11855');
```

---

### –ü—Ä–∏–º–µ—Ä 2: UPDATE —Å–æ–±—ã—Ç–∏—è (–∏–∑–º–µ–Ω–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ)

**–í–µ–±—Ö—É–∫:**
```json
{
  "event": "booking.update",
  "payload": {
    "id": 506503,
    "responsible_id": [null, "14714"],
    "responsible": [null, "Toma Khabuliani"]
  }
}
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

1. UPDATE –≤ `bookings`
2. –¢—Ä–∏–≥–≥–µ—Ä —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
3. –ò–∑–≤–ª–µ–∫–∞–µ—Ç –º–∞—Å—Å–∏–≤: `[null, "14714"]` + `[null, "Toma Khabuliani"]`
4. –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Å–æ–æ—Ç–Ω–æ—Å–∏—Ç:
   - OLD: `null` (–ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç)
   - NEW: `"14714"` + `"Toma Khabuliani"` (—Å–æ–∑–¥–∞—ë—Ç)
5. –°–æ–∑–¥–∞—ë—Ç employee —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º

**–í–∞–∂–Ω–æ:** `null` –ù–ï —Å–æ–∑–¥–∞—ë—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞!

---

### –ü—Ä–∏–º–µ—Ä 3: UPDATE —Å –∑–∞–º–µ–Ω–æ–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞

**–í–µ–±—Ö—É–∫:**
```json
{
  "event": "booking.update",
  "payload": {
    "id": 506503,
    "responsible_id": ["14714", "15000"],
    "responsible": ["Toma Khabuliani", "Anna Ivanova"]
  }
}
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

1. –ò–∑–≤–ª–µ–∫–∞–µ—Ç –º–∞—Å—Å–∏–≤—ã:
   - IDs: `["14714", "15000"]`
   - Names: `["Toma Khabuliani", "Anna Ivanova"]`
2. –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Å–æ–æ—Ç–Ω–æ—Å–∏—Ç:
   - OLD: `14714` ‚Üí `Toma Khabuliani`
   - NEW: `15000` ‚Üí `Anna Ivanova`
3. –°–æ–∑–¥–∞—ë—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç –æ–±–æ–∏—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤

---

## –ü—Ä–∏–º–µ—Ä—ã

### –ó–∞–ø—Ä–æ—Å –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤

```sql
SELECT 
  rentprog_id,
  name,
  created_at
FROM employees
ORDER BY created_at DESC;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
rentprog_id | name                | created_at
------------|---------------------|-------------------------
14714       | Toma Khabuliani     | 2025-11-05 18:46:23
11855       | Neverov Leonid      | 2025-11-05 18:30:15
12976       | Employee 12976      | 2025-11-05 18:15:42
```

---

### –¢–æ–ø-10 –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤

```sql
SELECT 
  e.rentprog_id,
  e.name,
  COUNT(DISTINCT b.id) as bookings_count
FROM employees e
JOIN external_refs er ON er.entity_id = e.id
JOIN bookings b ON 
  b.data->>'responsible_id' = er.external_id OR
  b.data->>'start_worker_id' = er.external_id OR
  b.data->>'end_worker_id' = er.external_id
GROUP BY e.rentprog_id, e.name
ORDER BY bookings_count DESC
LIMIT 10;
```

---

### –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –±–µ–∑ –∏–º—ë–Ω

```sql
SELECT 
  rentprog_id,
  name,
  data->>'source_field' as source
FROM employees
WHERE name IS NULL OR name LIKE 'Employee %'
ORDER BY created_at DESC;
```

**–î–ª—è –æ–±–æ–≥–∞—â–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:**  
–ó–∞–ø—É—Å—Ç–∏—Ç–µ workflow –¥–ª—è fetch –æ—Ç RentProg API `/users/{id}`

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞

```bash
node setup/check_employees_extraction.mjs
```

### –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

```sql
-- 1. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
SELECT COUNT(*) FROM employees;

-- 2. –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ
SELECT rentprog_id, name, created_at 
FROM employees 
ORDER BY created_at DESC 
LIMIT 10;

-- 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ external_refs
SELECT COUNT(*) 
FROM external_refs 
WHERE entity_type = 'employee';

-- 4. –¢—Ä–∏–≥–≥–µ—Ä—ã –∞–∫—Ç–∏–≤–Ω—ã
SELECT 
  trigger_name,
  event_object_table
FROM information_schema.triggers
WHERE trigger_name LIKE '%extract_employees%';
```

---

## FAQ

### –í–æ–ø—Ä–æ—Å: –ß—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ –∏–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ = "Employee 14714"?

**–û—Ç–≤–µ—Ç:**  
–≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –≤ –≤–µ–±—Ö—É–∫–µ –Ω–µ –±—ã–ª–æ –ø–æ–ª—è —Å –∏–º–µ–Ω–µ–º. –ò–º—è –º–æ–∂–Ω–æ:
1. –û–±–Ω–æ–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é –≤ –ë–î
2. Fetch —á–µ—Ä–µ–∑ RentProg API
3. –ü–æ–¥–æ–∂–¥–∞—Ç—å –ø–æ–∫–∞ –ø—Ä–∏–¥—ë—Ç –≤–µ–±—Ö—É–∫ —Å –ø–æ–ª–Ω—ã–º –∏–º–µ–Ω–µ–º

---

### –í–æ–ø—Ä–æ—Å: –ë—É–¥—É—Ç –ª–∏ –¥—É–±–ª–∏–∫–∞—Ç—ã?

**–û—Ç–≤–µ—Ç:**  
–ù–µ—Ç. `UNIQUE (rentprog_id)` + –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ `external_refs` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ–¥–∏–Ω —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ = –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å.

---

### –í–æ–ø—Ä–æ—Å: –û–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ª–∏ –∏–º–µ–Ω–∞?

**–û—Ç–≤–µ—Ç:**  
–î–∞, –ø—Ä–∏ `ON CONFLICT` —Ç—Ä–∏–≥–≥–µ—Ä –æ–±–Ω–æ–≤–ª—è–µ—Ç –∏–º—è –µ—Å–ª–∏ –æ–Ω–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:
```sql
ON CONFLICT (rentprog_id) DO UPDATE
SET 
  name = COALESCE(EXCLUDED.name, employees.name),
  updated_at = NOW();
```

---

### –í–æ–ø—Ä–æ—Å: –ú–æ–∂–Ω–æ –ª–∏ –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞?

**–û—Ç–≤–µ—Ç:**  
–î–∞, —Å–æ–∑–¥–∞–π—Ç–µ workflow –∫–æ—Ç–æ—Ä—ã–π:
1. –ë–µ—Ä—ë—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –±–µ–∑ –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
2. –î–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ RentProg API `/users/{id}` –∏–ª–∏ `/employees/{id}`
3. –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª–µ `data` –≤ `employees`

**–ü—Ä–∏–º–µ—Ä:**
```javascript
// –í n8n Code node
const employees = $input.all();
const results = [];

for (const emp of employees) {
  const id = emp.json.rentprog_id;
  
  // Fetch –æ—Ç RentProg API
  const userData = await fetchEmployeeData(id);
  
  results.push({
    id: emp.json.id,
    data: userData,
    first_name: userData.first_name,
    last_name: userData.last_name,
    company_id: userData.company_id
  });
}

return results;
```

---

### –í–æ–ø—Ä–æ—Å: –ß—Ç–æ –µ—Å–ª–∏ —Ç—Ä–∏–≥–≥–µ—Ä –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª?

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
node setup/check_employees_extraction.mjs
```

**–†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫:**
```bash
node setup/collect_historical_employees.mjs
```

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### 1. –û–±–æ–≥–∞—â–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–°–æ–∑–¥–∞—Ç—å n8n workflow –¥–ª—è fetch –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ—Ç RentProg API:
- –¢–µ–ª–µ—Ñ–æ–Ω
- Email
- –†–æ–ª—å
- –§–∏–ª–∏–∞–ª
- –°—Ç–∞—Ç—É—Å (active/inactive)

### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `employees` –¥–ª—è:
- –£–ø–æ–º–∏–Ω–∞–Ω–∏–π –≤ –∞–ª–µ—Ä—Ç–∞—Ö (–≤–º–µ—Å—Ç–æ ID –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏–º–µ–Ω–∞)
- –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º

### 3. –ê–Ω–∞–ª–∏—Ç–∏–∫–∞

–°–æ–∑–¥–∞—Ç—å –¥–∞—à–±–æ—Ä–¥—ã:
- –¢–æ–ø —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ –±—Ä–æ–Ω—è–º
- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º

---

## –°–∫—Ä–∏–ø—Ç—ã

| –°–∫—Ä–∏–ø—Ç | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|--------|-----------|
| `create_employees_extraction_trigger.mjs` | –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–∞ –∏ —Ç–∞–±–ª–∏—Ü—ã |
| `collect_historical_employees.mjs` | –°–±–æ—Ä –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö |
| `check_employees_extraction.mjs` | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã |

---

**–ê–≤—Ç–æ—Ä:** Cursor Agent  
**–î–∞—Ç–∞:** 5 –Ω–æ—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ Ready to deploy

