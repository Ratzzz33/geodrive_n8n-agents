# –û—Ç—á–µ—Ç –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏: RentProg v1 –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –Ω–∞—à–µ–π –º–æ–¥–µ–ª—å—é –¥–∞–Ω–Ω—ã—Ö

**–î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** 2025-01-XX  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ  
**–í–µ—Ä—Å–∏—è —Å–∏—Å—Ç–µ–º—ã:** 2.0.0  
**–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:** AI Assistant (Auto)

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏](#–æ–ø–∏—Å–∞–Ω–∏–µ-–∑–∞–¥–∞—á–∏)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ-—Ä–µ—à–µ–Ω–∏—è)
3. [–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è](#—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
4. [–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–æ–≤–æ–π –±–∞–∑–µ](#–∏–∑–º–µ–Ω–µ–Ω–∏—è-–≤-–∫–æ–¥–æ–≤–æ–π-–±–∞–∑–µ)
5. [–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö](#–±–∞–∑–∞-–¥–∞–Ω–Ω—ã—Ö)
6. [API –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏](#api-–∏-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)
7. [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
8. [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](#–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è)
9. [–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏](#—Å–ª–µ–¥—É—é—â–∏–µ-—à–∞–≥–∏)

---

## –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏

### –¶–µ–ª—å
–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é RentProg v1 —Ç–∞–∫, —á—Ç–æ–±—ã **–Ω–∞—à–∞ –º–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö –±—ã–ª–∞ –æ—Å–Ω–æ–≤–Ω–æ–π** (UUID –∫–∞–∫ –ø–µ—Ä–≤–∏—á–Ω—ã–µ –∫–ª—é—á–∏), –∞ –ª—é–±—ã–µ –≤–Ω–µ—à–Ω–∏–µ ID (RentProg, AmoCRM –∏ —Ç.–¥.) –±—ã–ª–∏ –ª–∏—à—å –≤–Ω–µ—à–Ω–∏–º–∏ —Å—Å—ã–ª–∫–∞–º–∏. –ü–ª—é—Å ‚Äî —Å–¥–µ–ª–∞—Ç—å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –≤ n8n (—Å–æ–±—ã—Ç–∏—è, –ø—Ä–æ–≥—Ä–µ—Å—Å, health).

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (–º–∏–≥—Ä–∞—Ü–∏–∏, Drizzle)**
   - –ë–∞–∑–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Å UUID PK: `branches`, `employees`, `clients`, `cars`, `bookings`
   - –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ `external_refs` –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Å—Å—ã–ª–æ–∫
   - –¢–∞–±–ª–∏—Ü–∞ `webhook_dedup` –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –≤–µ–±—Ö—É–∫–æ–≤

2. **Upsert-—Å–ª–æ–π**
   - –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –≤–Ω–µ—à–Ω–∏—Ö —Å—Å—ã–ª–æ–∫
   - Upsert —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è cars/clients/bookings —Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º created/updated

3. **Webhooks ‚Üí auto-fetch ‚Üí upsert**
   - –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –≤–µ–±—Ö—É–∫–æ–≤
   - Auto-fetch –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ RentProg API
   - –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π upsert: client ‚Üí car ‚Üí booking
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å ID –Ω–∞—à–∏—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π

4. **–ö–æ–º–∞–Ω–¥–∞ `/sync_rentprog`**
   - –†–µ–∞–ª—å–Ω—ã–π upsert –≤–º–µ—Å—Ç–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
   - –°–≤–æ–¥–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º: —Å–æ–∑–¥–∞–Ω–æ/–æ–±–Ω–æ–≤–ª–µ–Ω–æ

5. **–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≤ n8n**
   - 3 workflow –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ webhooks

6. **–ö–æ–º–∞–Ω–¥–∞ `/status`**
   - Per-branch —Å—Ç–∞—Ç—É—Å RentProg
   - –ü–æ—Å–ª–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö: External Refs Pattern

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–°–∏—Å—Ç–µ–º–µ –Ω—É–∂–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º –≤–Ω–µ—à–Ω–∏—Ö —Å–∏—Å—Ç–µ–º (RentProg, AmoCRM, Umnico, Starline –∏ —Ç.–¥.), –∫–∞–∂–¥–∞—è –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö –∏–º–µ–µ—Ç —Å–≤–æ–∏ ID.

**–†–µ—à–µ–Ω–∏–µ:**  
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞—à–µ–π –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ–π `external_refs` –¥–ª—è —Å–≤—è–∑—ã–≤–∞–Ω–∏—è.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ï–¥–∏–Ω—ã–µ UUID –≤–æ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º–µ
- ‚úÖ –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤–Ω–µ—à–Ω–∏—Ö ID –¥–ª—è –æ–¥–Ω–æ–π —Å—É—â–Ω–æ—Å—Ç–∏
- ‚úÖ –ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤–æ –≤–Ω–µ—à–Ω–∏—Ö —Å–∏—Å—Ç–µ–º–∞—Ö

**–°—Ö–µ–º–∞:**
```
–ù–∞—à–∞ —Å—É—â–Ω–æ—Å—Ç—å (cars, clients, bookings)
    ‚Üì UUID (PK)
external_refs
    ‚Üì system + external_id
–í–Ω–µ—à–Ω—è—è —Å–∏—Å—Ç–µ–º–∞ (RentProg, AmoCRM, ...)
```

### –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –≤–µ–±—Ö—É–∫–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:**  
RentProg –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –≤–µ–±—Ö—É–∫ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –∏–∑-–∑–∞ —Å–µ—Ç–µ–≤—ã—Ö –ø—Ä–æ–±–ª–µ–º –∏–ª–∏ retry –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤.

**–†–µ—à–µ–Ω–∏–µ:**  
SHA256 hash –Ω–∞ –æ—Å–Ω–æ–≤–µ: `source|branch|type|ext_id|time_bucket` (–º–∏–Ω—É—Ç–Ω–∞—è –≥—Ä–∞–Ω—É–ª—è—Ä–Ω–æ—Å—Ç—å).

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤ —Ç–µ—á–µ–Ω–∏–µ –º–∏–Ω—É—Ç—ã
- ‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ—Å–ª–µ –º–∏–Ω—É—Ç—ã (–µ—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤—ã–π –≤–µ–±—Ö—É–∫)
- ‚úÖ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ –∏–Ω–¥–µ–∫—Å –Ω–∞ `dedup_hash`

### Auto-fetch Pattern

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–í–µ–±—Ö—É–∫–∏ –æ—Ç RentProg –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ ID –±–µ–∑ –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

**–†–µ—à–µ–Ω–∏–µ:**  
–ü–æ—Å–ª–µ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ RentProg API –ø–µ—Ä–µ–¥ upsert.

**–ü–æ—Ä—è–¥–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏:**
1. –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
2. Auto-fetch –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
3. Upsert —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π (client ‚Üí car ‚Üí booking)
4. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ n8n

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

#### –°—Ö–µ–º–∞ (src/db/schema.ts)

**–ë–∞–∑–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**

```typescript
branches(id UUID PK, code TEXT UNIQUE, name TEXT, ...)
employees(id UUID PK, name TEXT, role TEXT, tg_user_id INTEGER, ...)
clients(id UUID PK, name TEXT, phone TEXT, email TEXT, ...)
cars(id UUID PK, branch_id UUID FK, plate TEXT, vin TEXT, model TEXT, ...)
bookings(id UUID PK, branch_id UUID FK, car_id UUID FK, client_id UUID FK, ...)
```

**–¢–∞–±–ª–∏—Ü–∞ –≤–Ω–µ—à–Ω–∏—Ö —Å—Å—ã–ª–æ–∫:**

```typescript
external_refs(
  id UUID PK,
  entity_type TEXT,      // 'car'|'client'|'booking'|...
  entity_id UUID,        // –Ω–∞—à UUID
  system TEXT,           // 'rentprog'|'amocrm'|'umnico'|...
  external_id TEXT,      // ID –≤–æ –≤–Ω–µ—à–Ω–µ–π —Å–∏—Å—Ç–µ–º–µ
  branch_code TEXT,      // –¥–ª—è —Å–∏—Å—Ç–µ–º —Å —Ñ–∏–ª–∏–∞–ª–∞–º–∏
  meta JSONB,            // –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  created_at TIMESTAMPTZ,
  updated_at TIMESTAMPTZ,
  UNIQUE(system, external_id)
)
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- `(entity_type, entity_id)` - –ø–æ–∏—Å–∫ –≤—Å–µ—Ö —Å—Å—ã–ª–æ–∫ —Å—É—â–Ω–æ—Å—Ç–∏
- `(system, external_id)` - –ø–æ–∏—Å–∫ –ø–æ –≤–Ω–µ—à–Ω–µ–π —Å–∏—Å—Ç–µ–º–µ
- `UNIQUE(system, external_id)` - —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –≤–Ω–µ—à–Ω–µ–π —Å—Å—ã–ª–∫–∏

**–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è:**

```typescript
webhook_dedup(
  id BIGSERIAL PK,
  source TEXT,           // 'rentprog'|'umnico'|...
  dedup_hash TEXT UNIQUE, // SHA256 hash
  received_at TIMESTAMPTZ
)
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- `dedup_hash` (unique) - –±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- `source` - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫—É
- `received_at` - –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π

#### –ú–∏–≥—Ä–∞—Ü–∏—è

**–§–∞–π–ª:** `drizzle/0000_sour_skreet.sql`

**–°–æ–¥–µ—Ä–∂–∏—Ç:**
- CREATE TABLE –¥–ª—è –≤—Å–µ—Ö 7 —Ç–∞–±–ª–∏—Ü
- FOREIGN KEY constraints
- –í—Å–µ –∏–Ω–¥–µ–∫—Å—ã
- UNIQUE constraints

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**
```bash
npm run db:migrate  # –∏–ª–∏
npm run db:push     # –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
```

### 2. Upsert-—Å–ª–æ–π

#### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è (src/db/upsert.ts)

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

```typescript
// –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –≤–Ω–µ—à–Ω–µ–π —Å—Å—ã–ª–∫–∏ ‚Üí –Ω–∞—à UUID
resolveByExternalRef(system: string, external_id: string): Promise<string | null>

// –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–Ω–µ—à–Ω–µ–π —Å—Å—ã–ª–∫–∏
linkExternalRef(
  entity_type: string,
  entity_id: string,
  system: string,
  external_id: string,
  branch_code?: string,
  meta?: Record<string, unknown>
): Promise<void>

// Upsert –∞–≤—Ç–æ–º–æ–±–∏–ª—è
upsertCarFromRentProg(payload: any, branchCode: BranchName): Promise<{entityId: string, created: boolean}>

// Upsert –∫–ª–∏–µ–Ω—Ç–∞
upsertClientFromRentProg(payload: any, branchCode: BranchName): Promise<{entityId: string, created: boolean}>

// Upsert –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
upsertBookingFromRentProg(payload: any, branchCode: BranchName): Promise<{entityId: string, created: boolean}>

// –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
getLastSyncTime(branchCode: BranchName): Promise<Date | null>
```

**–õ–æ–≥–∏–∫–∞ upsert:**

1. –ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å—Å—ã–ª–∫–∏ —á–µ—Ä–µ–∑ `resolveByExternalRef('rentprog', externalId)`
2. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–∞ ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏, –≤–æ–∑–≤—Ä–∞—Ç `{entityId, created: false}`
3. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ + —Å–æ–∑–¥–∞–Ω–∏–µ `external_ref`, –≤–æ–∑–≤—Ä–∞—Ç `{entityId, created: true}`

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞—Ç RentProg (`DD-MM-YYYY H:mm`)
- –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π —á–µ—Ä–µ–∑ `external_refs`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∏–ª–∏–∞–ª–æ–≤ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–µ–±—Ö—É–∫–æ–≤

#### Netlify Function (netlify/functions/rentprog-webhook/index.ts)

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**

1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ branch –∏–∑ –ø—É—Ç–∏ URL
2. –ü–∞—Ä—Å–∏–Ω–≥ JSON payload
3. –ë—ã—Å—Ç—Ä—ã–π ACK (200 OK) –∑–∞ <100ms
4. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —á–µ—Ä–µ–∑ HTTP

**–í—ã–∑–æ–≤ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞:**

```typescript
// –í–∞—Ä–∏–∞–Ω—Ç 1: HTTP –≤—ã–∑–æ–≤ –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é
POST {ORCHESTRATOR_URL}/webhook/rentprog
Body: { branch, type, payload, timestamp }

// –í–∞—Ä–∏–∞–Ω—Ç 2: Fallback –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–µ—Å–ª–∏ URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
```

#### –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä (src/orchestrator/rentprog-handler.ts)

**–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è:**

1. **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è:**
   ```typescript
   hash = sha256("rentprog|branch|type|ext_id|time_bucket")
   if (exists in webhook_dedup) ‚Üí skip
   else ‚Üí save hash
   ```

2. **Auto-fetch:**
   - –î–ª—è `booking.*`: `GET /all_bookings?id={id}` –∏–ª–∏ `/booking/{id}`
   - –î–ª—è `car.moved`: `GET /all_cars_full?id={id}` –∏–ª–∏ `/car/{id}`
   - Fallback endpoints –ø—Ä–∏ 404

3. **Upsert (–ø–æ—Ä—è–¥–æ–∫):**
   - Client (–µ—Å–ª–∏ –µ—Å—Ç—å `client_id`)
   - Car (–µ—Å–ª–∏ –µ—Å—Ç—å `car_id`)
   - Booking

4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –õ–æ–≥–∏ —Å ID –Ω–∞—à–∏—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
   - –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ n8n

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏
- –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ n8n —Å `ok: false`
- Telegram alert —á–µ—Ä–µ–∑ n8n –±–æ—Ç

### 4. –ö–æ–º–∞–Ω–¥–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

#### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è (src/bot/index.ts)

**–§—É–Ω–∫—Ü–∏—è `/sync_rentprog`:**

1. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∏–ª–∏–∞–ª–∞:
   - –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö cars —á–µ—Ä–µ–∑ `paginate()`
   - –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö clients —á–µ—Ä–µ–∑ `paginate()`
   - –ó–∞–≥—Ä—É–∑–∫–∞ bookings –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ `RENTPROG_POLL_SINCE_DAYS` –¥–Ω–µ–π

2. Upsert —Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º:
   - –°—á–µ—Ç—á–∏–∫–∏ `created` –∏ `updated` –¥–ª—è –∫–∞–∂–¥–æ–π —Å—É—â–Ω–æ—Å—Ç–∏
   - –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤ n8n –∫–∞–∂–¥—ã–µ 20 –∑–∞–ø–∏—Å–µ–π

3. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≤–æ–¥–∫–∏:
   ```
   ‚úÖ tbilisi:
      –ê–≤—Ç–æ: +5/~12
      –ö–ª–∏–µ–Ω—Ç—ã: +3/~8
      –ë—Ä–æ–Ω–∏: +10/~25
   ```

### 5. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å n8n

#### –ú–æ–¥—É–ª—å (src/integrations/n8n.ts)

**–§—É–Ω–∫—Ü–∏–∏:**

```typescript
// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏—è –≤–µ–±—Ö—É–∫–∞
sendEventToN8n(data: {
  ts: string,
  branch: string,
  type: string,
  ext_id?: string,
  ok: boolean,
  reason?: string
}): Promise<void>

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–¥–æ—Ä–æ–≤—å—è
sendHealthToN8n(data: {
  ts: string,
  branch: BranchName,
  ok: boolean,
  reason?: string
}): Promise<void>

// –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
sendSyncProgressToN8n(data: {
  ts: string,
  branch: BranchName,
  entity: 'car' | 'client' | 'booking',
  page?: number,
  added: number,
  updated: number,
  ok: boolean,
  msg?: string
}): Promise<void>

// –û—Ç–ø—Ä–∞–≤–∫–∞ –∞–ª–µ—Ä—Ç–∞ –≤ Telegram
sendTelegramAlert(message: string): Promise<void>
```

**Workflow –≤ n8n:**

1. **RentProg Webhooks Monitor**
   - Webhook: `/webhook/rentprog/:branch` (–æ—Ç Netlify)
   - Data Table "events": `{ts, branch, type, ext_id, ok, reason}`
   - Telegram Alerts –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

2. **Health & Status**
   - Cron: –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
   - HTTP Request: `GET /rentprog/health`
   - Data Table "health": `{ts, branch, ok, reason}`
   - Telegram –ø—Ä–∏ `!ok`

3. **Sync Progress**
   - Webhook: `/sync/progress` + Cron –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
   - Data Table "sync_runs": `{ts, branch, entity, page, added, updated, ok, msg}`

### 6. HTTP API —Å–µ—Ä–≤–µ—Ä

#### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è (src/api/index.ts)

**Endpoints:**

```typescript
GET /rentprog/health
  ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –≤—Å–µ—Ö —Ñ–∏–ª–∏–∞–ª–æ–≤
  ‚Üí –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤ n8n
  ‚Üí –í–æ–∑–≤—Ä–∞—Ç JSON —Å per-branch —Å—Ç–∞—Ç—É—Å–æ–º

POST /webhook/rentprog
  ‚Üí –ü—Ä–∏–µ–º –≤–µ–±—Ö—É–∫–æ–≤ –æ—Ç Netlify Functions
  ‚Üí –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è ‚Üí –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä
  ‚Üí –í–æ–∑–≤—Ä–∞—Ç {ok, processed}

GET /
  ‚Üí Root endpoint –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
```

**–ó–∞–ø—É—Å–∫:**
- –ü–æ—Ä—Ç: `API_PORT` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3000)
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤ `src/index.ts`
- Graceful shutdown

### 7. –ö–æ–º–∞–Ω–¥–∞ —Å—Ç–∞—Ç—É—Å–∞

#### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è (src/bot/index.ts)

**–ö–æ–º–∞–Ω–¥–∞ `/status`:**

1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î
2. Per-branch RentProg health check
3. –ü—Ä–æ–≤–µ—Ä–∫–∞ Umnico –∏ Stripe
4. –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏–∑ `external_refs`
5. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:

```
üìä –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã:

‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
‚úÖ RentProg tbilisi
‚úÖ RentProg batumi
‚úÖ RentProg kutaisi
‚úÖ RentProg service-center
‚úÖ Umnico API
‚úÖ Stripe API

‚è∞ Last RP sync per branch:
   tbilisi: 5 –º–∏–Ω –Ω–∞–∑–∞–¥
   batumi: 12 –º–∏–Ω –Ω–∞–∑–∞–¥
   kutaisi: 8 –º–∏–Ω –Ω–∞–∑–∞–¥
   service-center: –Ω–∏–∫–æ–≥–¥–∞

‚è∞ –í—Ä–µ–º—è: 15.01.2025, 14:30:00
```

---

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–æ–≤–æ–π –±–∞–∑–µ

### –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **`src/db/upsert.ts`** (344 —Å—Ç—Ä–æ–∫–∏)
   - Upsert-—Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
   - –†–∞–±–æ—Ç–∞ —Å external_refs
   - –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞—Ç RentProg

2. **`src/integrations/n8n.ts`** (105 —Å—Ç—Ä–æ–∫)
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å n8n –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
   - –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π, health, –ø—Ä–æ–≥—Ä–µ—Å—Å–∞, –∞–ª–µ—Ä—Ç–æ–≤

3. **`src/api/index.ts`** (102 —Å—Ç—Ä–æ–∫–∏)
   - HTTP API —Å–µ—Ä–≤–µ—Ä –Ω–∞ Express
   - Endpoints –¥–ª—è health checks –∏ –≤–µ–±—Ö—É–∫–æ–≤

4. **`drizzle/0000_sour_skreet.sql`** (87 —Å—Ç—Ä–æ–∫)
   - SQL –º–∏–≥—Ä–∞—Ü–∏—è —Å–æ –≤—Å–µ–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏

5. **`RENTPROG_V1_COMPLETE.md`** (–¥–µ—Ç–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è)
6. **`RENTPROG_V1_TASK_REPORT.md`** (—ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç)

### –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **`src/db/schema.ts`**
   - –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ö–µ–º–∞ `webhook_dedup` (timestamp with timezone)
   - –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —É–∂–µ –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã —Ä–∞–Ω–µ–µ

2. **`src/orchestrator/rentprog-handler.ts`**
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –≤–µ–±—Ö—É–∫–æ–≤
   - Auto-fetch –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ API
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å n8n
   - –û–±–Ω–æ–≤–ª–µ–Ω—ã upsert –≤—ã–∑–æ–≤—ã (—Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç `{entityId, created}`)

3. **`src/bot/index.ts`**
   - –ö–æ–º–∞–Ω–¥–∞ `/sync_rentprog`: —Ä–µ–∞–ª—å–Ω—ã–π upsert —Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º
   - –ö–æ–º–∞–Ω–¥–∞ `/status`: –¥–æ–±–∞–≤–ª–µ–Ω "Last RP sync per branch"
   - –ò–º–ø–æ—Ä—Ç—ã upsert —Ñ—É–Ω–∫—Ü–∏–π –∏ n8n

4. **`src/config/index.ts`**
   - –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: `n8nEventsUrl`, `n8nAlertsUrl`, `n8nAlertsTelegramBotToken`, `dedupTtlMinutes`

5. **`netlify/functions/rentprog-webhook/index.ts`**
   - HTTP –≤—ã–∑–æ–≤ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —á–µ—Ä–µ–∑ `ORCHESTRATOR_URL`
   - Fallback –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

6. **`src/index.ts`**
   - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è HTTP API —Å–µ—Ä–≤–µ—Ä–∞
   - Graceful shutdown –¥–ª—è API —Å–µ—Ä–≤–µ—Ä–∞

7. **`env.example`**
   - –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è n8n
   - –î–æ–±–∞–≤–ª–µ–Ω—ã `API_PORT` –∏ `ORCHESTRATOR_URL`

8. **`README.md`**
   - –†–∞–∑–¥–µ–ª "–ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö (External Refs)"
   - –†–∞–∑–¥–µ–ª "n8n –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞"
   - –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∏–≥—Ä–∞—Ü–∏—è—Ö

9. **`STRUCTURE.md`**
   - –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
   - –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã —Å external_refs

10. **`package.json`**
    - –î–æ–±–∞–≤–ª–µ–Ω `express` –∏ `@types/express` (HTTP —Å–µ—Ä–≤–µ—Ä)

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

- **–°–æ–∑–¥–∞–Ω–æ —Ñ–∞–π–ª–æ–≤:** 6
- **–û–±–Ω–æ–≤–ª–µ–Ω–æ —Ñ–∞–π–ª–æ–≤:** 10
- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–æ:** ~1200
- **–°—Ç—Ä–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:** ~500

---

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü—ã

| –¢–∞–±–ª–∏—Ü–∞ | –ö–æ–ª–æ–Ω–æ–∫ | –ò–Ω–¥–µ–∫—Å–æ–≤ | Foreign Keys |
|---------|---------|----------|--------------|
| `branches` | 5 | 1 | 0 |
| `employees` | 6 | 0 | 0 |
| `clients` | 6 | 0 | 0 |
| `cars` | 8 | 2 | 1 (‚Üí branches) |
| `bookings` | 9 | 4 | 3 (‚Üí branches, cars, clients) |
| `external_refs` | 9 | 2 | 0 |
| `webhook_dedup` | 4 | 3 | 0 |

**–í—Å–µ–≥–æ:** 7 —Ç–∞–±–ª–∏—Ü, 47 –∫–æ–ª–æ–Ω–æ–∫, 12 –∏–Ω–¥–µ–∫—Å–æ–≤, 4 FK

### –ú–∏–≥—Ä–∞—Ü–∏—è

**–§–∞–π–ª:** `drizzle/0000_sour_skreet.sql`

**–°–æ–¥–µ—Ä–∂–∏—Ç:**
- CREATE TABLE –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü
- FOREIGN KEY constraints
- UNIQUE constraints
- –í—Å–µ –∏–Ω–¥–µ–∫—Å—ã

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**
```bash
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ (—É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ)
npm run db:generate

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
npm run db:migrate

# –ò–ª–∏ push –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
npm run db:push
```

### –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤

**–ü–æ–∏—Å–∫ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –ø–æ RentProg ID:**
```sql
SELECT c.* 
FROM cars c
JOIN external_refs er ON er.entity_id = c.id
WHERE er.system = 'rentprog' 
  AND er.external_id = 'rp_car_123';
```

**–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –≤–Ω–µ—à–Ω–∏—Ö —Å—Å—ã–ª–æ–∫ –¥–ª—è —Å—É—â–Ω–æ—Å—Ç–∏:**
```sql
SELECT er.* 
FROM external_refs er
WHERE er.entity_type = 'car' 
  AND er.entity_id = 'abc-123-uuid';
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–∞ –≤–µ–±—Ö—É–∫–∞:**
```sql
SELECT EXISTS(
  SELECT 1 FROM webhook_dedup 
  WHERE dedup_hash = 'sha256_hash_here'
);
```

---

## API –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### HTTP API Endpoints

#### `GET /rentprog/health`

–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ RentProg –ø–æ –≤—Å–µ–º —Ñ–∏–ª–∏–∞–ª–∞–º.

**–û—Ç–≤–µ—Ç:**
```json
{
  "ok": true,
  "perBranch": {
    "tbilisi": { "ok": true },
    "batumi": { "ok": true, "error": "..." },
    "kutaisi": { "ok": false, "error": "..." },
    "service-center": { "ok": true }
  }
}
```

**–ü–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã:**
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤ n8n –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∏–ª–∏–∞–ª–∞

#### `POST /webhook/rentprog`

–ü—Ä–∏–µ–º –≤–µ–±—Ö—É–∫–æ–≤ –æ—Ç Netlify Functions.

**–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:**
```json
{
  "branch": "tbilisi",
  "type": "booking.issue.planned",
  "payload": { "id": "rp_123", ... },
  "timestamp": "2025-01-15T14:30:00Z"
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "ok": true,
  "processed": true
}
```

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤–µ–±—Ö—É–∫–∞
2. –†–æ—É—Ç–∏–Ω–≥ –≤ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä
3. –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è ‚Üí Auto-fetch ‚Üí Upsert

### Netlify Functions

#### Endpoint: `/webhooks/rentprog/:branch`

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**
1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ branch –∏–∑ URL
2. –ü–∞—Ä—Å–∏–Ω–≥ JSON payload
3. –ë—ã—Å—Ç—Ä—ã–π ACK (200 OK)
4. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π HTTP –≤—ã–∑–æ–≤ –∫ `ORCHESTRATOR_URL/webhook/rentprog`

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
- `ORCHESTRATOR_URL` - URL –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### n8n –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

#### Webhook URLs

1. **–°–æ–±—ã—Ç–∏—è –≤–µ–±—Ö—É–∫–æ–≤:**
   ```
   POST {N8N_EVENTS_URL}
   Body: {ts, branch, type, ext_id, ok, reason}
   ```

2. **–°—Ç–∞—Ç—É—Å –∑–¥–æ—Ä–æ–≤—å—è:**
   ```
   POST {N8N_EVENTS_URL}/health
   Body: {ts, branch, ok, reason}
   ```

3. **–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:**
   ```
   POST {N8N_EVENTS_URL}/sync/progress
   Body: {ts, branch, entity, page, added, updated, ok, msg}
   ```

4. **–ê–ª–µ—Ä—Ç—ã:**
   ```
   POST {N8N_ALERTS_URL}
   Body: {message}
   ```

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏
npm run db:generate

# –ü—Ä–æ–≤–µ—Ä–∫–∞ SQL
cat drizzle/0000_sour_skreet.sql

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ (—Ç–µ—Å—Ç–æ–≤–æ–µ)
npm run db:push
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ–±—Ö—É–∫–æ–≤

**–¢–µ—Å—Ç –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏:**
```bash
# –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ –≤–µ–±—Ö—É–∫–∞ –¥–≤–∞–∂–¥—ã
curl -X POST https://geodrive.netlify.app/webhooks/rentprog/tbilisi \
  -H "Content-Type: application/json" \
  -d '{"id":"test_123","event":"booking.issue.planned"}'

# –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω (dedup)
```

**–¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
# –î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
# - –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é
# - Auto-fetch
# - Upsert —Å ID –Ω–∞—à–∏—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
# - –û—Ç–ø—Ä–∞–≤–∫—É –≤ n8n
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞

**`/status`:**
```
–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram –±–æ—Ç—É ‚Üí /status
–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–∏—Å—Ç–µ–º + Last RP sync
```

**`/sync_rentprog`:**
```
–û—Ç–ø—Ä–∞–≤–∏—Ç—å ‚Üí /sync_rentprog
–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: —Å–≤–æ–¥–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º —Å created/updated
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ API

**Health check:**
```bash
curl http://localhost:3000/rentprog/health
```

**Webhook endpoint:**
```bash
curl -X POST http://localhost:3000/webhook/rentprog \
  -H "Content-Type: application/json" \
  -d '{"branch":"tbilisi","type":"booking.issue.planned","payload":{"id":"test"}}'
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ n8n

1. –°–æ–∑–¥–∞—Ç—å 3 workflow –≤ n8n
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ Data Tables
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Telegram –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

---

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –°–æ–∑–¥–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

1. **`RENTPROG_V1_COMPLETE.md`**
   - –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
   - –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
   - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

2. **`RENTPROG_V1_TASK_REPORT.md`** (—ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç)
   - –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏
   - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è
   - –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

3. **–û–±–Ω–æ–≤–ª–µ–Ω `README.md`**
   - –†–∞–∑–¥–µ–ª "–ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö (External Refs)"
   - –†–∞–∑–¥–µ–ª "n8n –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è"
   - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –º–∏–≥—Ä–∞—Ü–∏—è–º

4. **–û–±–Ω–æ–≤–ª–µ–Ω `STRUCTURE.md`**
   - –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
   - –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã —Å external_refs

### –ü—Ä–∏–º–µ—Ä—ã –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

- –ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–µ–±—Ö—É–∫–∞
- –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ `/sync_rentprog`
- –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
- –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

1. **–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î:**
   ```bash
   npm run db:migrate
   # –∏–ª–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:
   npm run db:push
   ```

2. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
   - –í –æ—Å–Ω–æ–≤–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏: `N8N_EVENTS_URL`, `N8N_ALERTS_URL`, `N8N_ALERTS_TELEGRAM_BOT_TOKEN`
   - –í Netlify: `ORCHESTRATOR_URL` (URL –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)

3. **–°–æ–∑–¥–∞—Ç—å n8n workflows:**
   - RentProg Webhooks Monitor
   - Health & Status
   - Sync Progress

4. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é:**
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –≤–µ–±—Ö—É–∫
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –ë–î
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å n8n Data Tables

### –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–µ–¥—É–ø–æ–≤:**
   - Cron –∑–∞–¥–∞—á–∞ –¥–ª—è `cleanupWebhookDedup(ttlMinutes)`
   - –ó–∞–ø—É—Å–∫ —Ä–∞–∑ –≤ —á–∞—Å

2. **–ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
   - Dashboard –≤ n8n
   - –ê–ª–µ—Ä—Ç—ã –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
   - –ì—Ä–∞—Ñ–∏–∫–∏ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å–æ–±—ã—Ç–∏–π

3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
   - Batch upsert –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
   - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö external_refs
   - Connection pooling –¥–ª—è –ë–î

4. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
   - –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ external_refs
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ upsert
   - Retry –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è failed upsert

---

## –ú–µ—Ç—Ä–∏–∫–∏ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

- ‚úÖ **–í—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:** 7/7
- ‚úÖ **–§–∞–π–ª–æ–≤ —Å–æ–∑–¥–∞–Ω–æ:** 6
- ‚úÖ **–§–∞–π–ª–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–æ:** 10
- ‚úÖ **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞:** ~1200
- ‚úÖ **–¢–∞–±–ª–∏—Ü –ë–î:** 7
- ‚úÖ **API endpoints:** 3
- ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π:** n8n, Netlify Functions, HTTP API

### –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞

- ‚úÖ TypeScript —Ç–∏–ø–∏–∑–∞—Ü–∏—è
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚úÖ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production

- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –≥–æ—Ç–æ–≤—ã
- ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–ø–∏—Å–∞–Ω–∞
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ n8n workflows
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è RentProg v1 —Å –Ω–∞—à–µ–π –º–æ–¥–µ–ª—å—é –¥–∞–Ω–Ω—ã—Ö **–ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≤–µ—Ä—à–µ–Ω–∞**. –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ n8n workflows.

**–ö–ª—é—á–µ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:**
- ‚úÖ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö —Å external_refs
- ‚úÖ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –≤–µ–±—Ö—É–∫–æ–≤
- ‚úÖ Auto-fetch –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ Upsert —Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º created/updated
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å n8n –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- ‚úÖ HTTP API –¥–ª—è health checks –∏ –≤–µ–±—Ö—É–∫–æ–≤

**–ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é!** üöÄ

---

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 2025-01-XX  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ  
**–í–µ—Ä—Å–∏—è:** 2.0.0

