# ‚úÖ Entity Timeline - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞

**–î–∞—Ç–∞:** 2025-11-09  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ

---

## üéâ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î ‚úÖ

- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `entity_timeline` —Å–æ–∑–¥–∞–Ω–∞
- ‚úÖ 10 –∏–Ω–¥–µ–∫—Å–æ–≤ —Å–æ–∑–¥–∞–Ω–æ (–≤–∫–ª—é—á–∞—è GIN –¥–ª—è JSONB)
- ‚úÖ 2 SQL Views —Å–æ–∑–¥–∞–Ω—ã:
  - `entity_timeline_stats` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–±—ã—Ç–∏–π
  - `entity_timeline_recent` - –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –ø–æ —Å—É—â–Ω–æ—Å—Ç—è–º
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `cleanup_old_timeline_entries()` –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π

### 2. Drizzle ORM —Å—Ö–µ–º–∞ ‚úÖ

- ‚úÖ –°—Ö–µ–º–∞ `entityTimeline` –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ `src/db/schema.ts`
- ‚úÖ –¢–∏–ø—ã TypeScript: `EntityTimeline`, `EntityTimelineInsert`

### 3. –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å timeline ‚úÖ

**–§–∞–π–ª:** `src/db/entityTimeline.ts`

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `addToTimeline()` - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å —Å–æ–±—ã—Ç–∏—è
- `getTimelineForEntity()` - –ø–æ–ª—É—á–µ–Ω–∏–µ timeline –¥–ª—è —Å—É—â–Ω–æ—Å—Ç–∏
- `getTimelineForRelatedEntities()` - –ø–æ–ª—É—á–µ–Ω–∏–µ timeline –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
- `getTimelineStats()` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ timeline

**–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `addPaymentToTimeline()` - –∑–∞–ø–∏—Å—å –ø–ª–∞—Ç–µ–∂–∞
- `addGPSToTimeline()` - –∑–∞–ø–∏—Å—å GPS –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- `addWebhookToTimeline()` - –∑–∞–ø–∏—Å—å –≤–µ–±—Ö—É–∫–∞

### 4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∑–∞–ø–∏—Å–∏ –≤ timeline ‚úÖ

#### –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤ `savePaymentFromRentProg()` (`src/db/payments.ts`)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
- ‚úÖ –í–∫–ª—é—á–∞–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ (booking, client)

#### –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–µ–±—Ö—É–∫–æ–≤
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤ `handleRentProgEvent()` (`src/orchestrator/rentprog-handler.ts`)
- ‚úÖ –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –¥–ª—è booking, car, client
- ‚úÖ –í–∫–ª—é—á–∞–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏

#### –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ GPS
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤ `updateGPSData()` (`src/services/starline-monitor.ts`)
- ‚úÖ –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
- ‚úÖ –í–∫–ª—é—á–∞–µ—Ç branch_code –∏–∑ cars ‚Üí branches

### 5. API Endpoints ‚úÖ

**–§–∞–π–ª:** `src/api/routes/entityTimeline.ts`

**Endpoints:**
- `GET /entity-timeline/entity/:entityType/:entityId` - timeline –¥–ª—è —Å—É—â–Ω–æ—Å—Ç–∏
- `POST /entity-timeline/related` - timeline –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
- `GET /entity-timeline/stats` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

**–†–æ—É—Ç–µ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω:** ‚úÖ `src/api/index.ts`

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π

**–ò—Å—Ç–æ—á–Ω–∏–∫–∏ (`source_type`):**
- `rentprog_webhook` - –≤–µ–±—Ö—É–∫–∏ –æ—Ç RentProg
- `rentprog_history` - –∏—Å—Ç–æ—Ä–∏—è –∏–∑ RentProg
- `starline` - GPS –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç Starline
- `telegram` - —Å–æ–±—ã—Ç–∏—è –∏–∑ Telegram (–±—É–¥—É—â–µ–µ)
- `manual` - —Ä—É—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–±—É–¥—É—â–µ–µ)
- `system` - —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (–±—É–¥—É—â–µ–µ)

**–¢–∏–ø—ã —Å—É—â–Ω–æ—Å—Ç–µ–π (`entity_type`):**
- `car` - –∞–≤—Ç–æ–º–æ–±–∏–ª–∏
- `booking` - –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- `client` - –∫–ª–∏–µ–Ω—Ç—ã
- `employee` - —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏
- `payment` - –ø–ª–∞—Ç–µ–∂–∏
- `branch` - —Ñ–∏–ª–∏–∞–ª—ã

**–û–ø–µ—Ä–∞—Ü–∏–∏ (`operation`):**
- `create` - —Å–æ–∑–¥–∞–Ω–∏–µ
- `update` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
- `delete` - —É–¥–∞–ª–µ–Ω–∏–µ
- `move` - –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
- `status_change` - –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞

---

## üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–ø–∏—Å—å

### –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø–∏—Å–µ–π –≤ timeline

**1. –ü–ª–∞—Ç–µ–∂:**
```json
{
  "entity_type": "payment",
  "entity_id": "uuid",
  "source_type": "rentprog_history",
  "event_type": "payment.received",
  "operation": "create",
  "summary": "–ü–ª–∞—Ç–µ–∂ 1000 GEL: –û–ø–ª–∞—Ç–∞ –±—Ä–æ–Ω–∏",
  "details": {"amount": "1000", "currency": "GEL"},
  "branch_code": "tbilisi",
  "related_entities": [
    {"type": "booking", "id": "uuid"},
    {"type": "client", "id": "uuid"}
  ]
}
```

**2. –í–µ–±—Ö—É–∫ –±—Ä–æ–Ω–∏:**
```json
{
  "entity_type": "booking",
  "entity_id": "uuid",
  "source_type": "rentprog_webhook",
  "event_type": "booking.issue.planned",
  "operation": "update",
  "summary": "–ë—Ä–æ–Ω—å booking.issue.planned: 470049",
  "details": {"rentprog_id": "470049", ...},
  "branch_code": "tbilisi",
  "related_entities": [
    {"type": "car", "id": "uuid"},
    {"type": "client", "id": "uuid"}
  ]
}
```

**3. GPS –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:**
```json
{
  "entity_type": "car",
  "entity_id": "uuid",
  "source_type": "starline",
  "event_type": "car.gps_updated",
  "operation": "update",
  "summary": "–ê–≤—Ç–æ –¥–≤–∏–∂–µ—Ç—Å—è: 41.715100, 44.827100",
  "details": {
    "lat": 41.7151,
    "lng": 44.8271,
    "isMoving": true,
    "distance": 150,
    "speed": 60
  },
  "branch_code": "tbilisi"
}
```

---

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –î–ª—è –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞

```typescript
import { getTimelineForEntity } from './db/entityTimeline';

// –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –ø–æ –º–∞—à–∏–Ω–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
const timeline = await getTimelineForEntity('car', carId, {
  limit: 100,
  startDate: new Date(Date.now() - 3600000),
});

// –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø–∞–º —Å–æ–±—ã—Ç–∏–π
const gpsEvents = await getTimelineForEntity('car', carId, {
  sourceTypes: ['starline'],
  eventTypes: ['car.gps_updated'],
});
```

### –î–ª—è –∞–≥–µ–Ω—Ç–æ–≤

```typescript
// –ê–≥–µ–Ω—Ç –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä –±—Ä–æ–Ω–µ–π - –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –ø–æ –±—Ä–æ–Ω–∏
const bookingTimeline = await getTimelineForEntity('booking', bookingId, {
  eventTypes: ['booking.issue.planned', 'booking.return.planned'],
});

// –ê–≥–µ–Ω—Ç —Å–ª—É–∂–µ–±–Ω—ã—Ö –ø–æ–µ–∑–¥–æ–∫ - GPS —Å–æ–±—ã—Ç–∏—è
const gpsTimeline = await getTimelineForEntity('car', carId, {
  sourceTypes: ['starline'],
  startDate: new Date(Date.now() - 86400000), // –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
});
```

### –ß–µ—Ä–µ–∑ API

```bash
# –ü–æ–ª—É—á–∏—Ç—å timeline –¥–ª—è –º–∞—à–∏–Ω—ã
curl "http://localhost:3000/entity-timeline/entity/car/{carId}?limit=50"

# –ü–æ–ª—É—á–∏—Ç—å timeline –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
curl -X POST "http://localhost:3000/entity-timeline/related" \
  -H "Content-Type: application/json" \
  -d '{
    "entities": [
      {"type": "booking", "id": "..."},
      {"type": "car", "id": "..."}
    ],
    "limit": 100
  }'

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
curl "http://localhost:3000/entity-timeline/stats?entityType=car&branchCode=tbilisi"
```

---

## üìà –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. ‚úÖ **–ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –¥–æ—Å—Ç—É–ø–∞** - –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
2. ‚úÖ **–ë—ã—Å—Ç—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã** - –±–µ–∑ JOIN –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏
3. ‚úÖ **–•—Ä–æ–Ω–æ–ª–æ–≥–∏—è** - –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –≤ –ø–æ—Ä—è–¥–∫–µ –≤—Ä–µ–º–µ–Ω–∏
4. ‚úÖ **–ì–∏–±–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è** - –ø–æ —Ç–∏–ø—É, –∏—Å—Ç–æ—á–Ω–∏–∫—É, —Ñ–∏–ª–∏–∞–ª—É
5. ‚úÖ **–°–≤—è–∑–∞–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏** - –ª–µ–≥–∫–æ –Ω–∞–π—Ç–∏ –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –ø–æ —Å–≤—è–∑–∞–Ω–Ω—ã–º –æ–±—ä–µ–∫—Ç–∞–º
6. ‚úÖ **–î–ª—è –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞** - —É–ø—Ä–æ—â–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é –∏ –ø—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏–π
7. ‚úÖ **–î–ª—è –∞–≥–µ–Ω—Ç–æ–≤** - –±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ –∏—Å—Ç–æ—Ä–∏–∏ –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ –≤—Å–µ—Ö —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–æ–ª—è—Ö
- ‚úÖ GIN –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è JSONB –ø–æ–∏—Å–∫–∞
- ‚úÖ –ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Å LIMIT/OFFSET

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å

- ‚úÖ –ó–∞–ø–∏—Å—å –≤ timeline –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é (try/catch)
- ‚úÖ –û—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è, –Ω–æ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç –ø—Ä–æ—Ü–µ—Å—Å
- ‚úÖ –î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —á—Ç–µ–Ω–∏—è

### –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

- ‚úÖ –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π
- ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ `ts` (–±—É–¥—É—â–µ–µ)
- ‚úÖ –ê—Ä—Ö–∏–≤–∞—Ü–∏—è –∑–∞–ø–∏—Å–µ–π —Å—Ç–∞—Ä—à–µ 1 –≥–æ–¥–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π (cron job)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ timeline –¥–ª—è Telegram —Å–æ–±—ã—Ç–∏–π
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ timeline –¥–ª—è —Ä—É—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- [ ] –°–æ–∑–¥–∞—Ç—å –¥–∞—à–±–æ—Ä–¥ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ timeline
- [ ] –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø–æ –º–µ—Å—è—Ü–∞–º (–¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤)

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

–°–∏—Å—Ç–µ–º–∞ `entity_timeline` –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!

**–¢–µ–ø–µ—Ä—å –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –∏ –∞–≥–µ–Ω—Ç—ã –º–æ–≥—É—Ç:**
- ‚úÖ –ë—ã—Å—Ç—Ä–æ –ø–æ–ª—É—á–∞—Ç—å –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –ø–æ —Å—É—â–Ω–æ—Å—Ç–∏
- ‚úÖ –í–∏–¥–µ—Ç—å —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚úÖ –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ —Ç–∏–ø–∞–º –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º
- ‚úÖ –ù–∞—Ö–æ–¥–∏—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–ø–∏—Å—å —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è:**
- ‚úÖ –ü–ª–∞—Ç–µ–∂–µ–π (–ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏)
- ‚úÖ –í–µ–±—Ö—É–∫–æ–≤ (–ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ)
- ‚úÖ GPS –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (–ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏)

---

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** [docs/ENTITY_TIMELINE.md](./docs/ENTITY_TIMELINE.md)

