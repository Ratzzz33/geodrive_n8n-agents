# Настройка оркестратора в n8n

Оркестратор - это центральный workflow, который управляет множеством агентов и координирует выполнение сложных задач.

## Что такое оркестратор?

Оркестратор в n8n:
- **Принимает** высокоуровневые задачи
- **Разбивает** их на подзадачи
- **Назначает** подзадачи специализированным агентам
- **Координирует** выполнение агентов
- **Собирает** результаты
- **Возвращает** финальный результат

## Архитектура оркестратора

```
┌─────────────────┐
│   Входящий      │
│   запрос        │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Оркестратор    │
│  (Анализ задачи)│
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌────────┐ ┌────────┐
│Агент 1 │ │Агент 2 │
│        │ │        │
└────┬───┘ └────┬───┘
     │         │
     └────┬────┘
          │
          ▼
┌─────────────────┐
│  Сбор результатов │
│  и ответ         │
└─────────────────┘
```

## Шаг 1: Создание базового оркестратора

Через Cursor создайте оркестратор:

```
Создай workflow-оркестратор в n8n, который:

1. Принимает задачи через Webhook
2. Анализирует задачу через AI
3. Определяет необходимых агентов
4. Создает план выполнения
5. Выполняет план
6. Возвращает результат
```

## Шаг 2: Структура оркестратора

### Базовые узлы оркестратора

```
1. Webhook Trigger
   ├─ Метод: POST
   ├─ Путь: /orchestrator/task
   └─ Тело: { "task": "...", "context": {...} }

2. AI Analysis Node
   ├─ Модель: gpt-4
   ├─ Промпт: "Проанализируй задачу и определи план"
   └─ Выход: { "plan": [...], "agents": [...] }

3. Code Node (Создание подзадач)
   ├─ Вход: план от AI
   └─ Выход: массив подзадач

4. Loop Node (Для каждой подзадачи)
   ├─ Запуск агента через HTTP Request
   └─ Сбор результатов

5. Code Node (Объединение результатов)
   └─ Создание финального ответа

6. Response Node
   └─ Возврат результата
```

## Шаг 3: Примеры оркестраторов

### Пример 1: Оркестратор для обработки документов

```
Создай оркестратор для обработки документов:

Задача: Обработать документ и создать отчет

План:
1. Агент извлечения данных → извлекает данные из документа
2. Агент анализа → анализирует данные
3. Агент форматирования → форматирует отчет
4. Агент сохранения → сохраняет отчет

Оркестратор координирует всех агентов
```

### Пример 2: Оркестратор для автоматизации разработки

```
Создай оркестратор для автоматизации разработки:

Функции:
1. Принимает описание задачи
2. Определяет необходимые шаги:
   - Анализ требований (Агент аналитики)
   - Проектирование (Агент архитектуры)
   - Генерация кода (Агент разработки)
   - Тестирование (Агент тестирования)
3. Выполняет шаги последовательно или параллельно
4. Возвращает результат
```

### Пример 3: Оркестратор для бизнес-процессов

```
Создай оркестратор для бизнес-процессов:

Пример задачи: "Обработать заказ клиента"

Шаги:
1. Валидация заказа (Агент валидации)
2. Проверка наличия (Агент склада)
3. Обработка платежа (Агент платежей)
4. Уведомление клиента (Агент коммуникаций)
5. Создание отчета (Агент отчетности)

Оркестратор управляет последовательностью и обрабатывает ошибки
```

## Шаг 4: Управление зависимостями между агентами

### Последовательное выполнение

```
Создай оркестратор с последовательным выполнением:

Агент A → Агент B → Агент C

Каждый агент ждет результат предыдущего
```

### Параллельное выполнение

```
Создай оркестратор с параллельным выполнением:

    ├─→ Агент A
    │
Задача ├─→ Агент B  → Сбор результатов
    │
    └─→ Агент C

Все агенты работают одновременно
```

### Условное выполнение

```
Создай оркестратор с условной логикой:

Задача
  ↓
Анализ (AI)
  ↓
Switch Node
  ├─ Условие 1 → Агент A, B
  ├─ Условие 2 → Агент C, D
  └─ Иначе → Агент E
```

## Шаг 5: Обработка ошибок и retry

### Базовая обработка ошибок

```
Добавь обработку ошибок в оркестратор:

1. Try-Catch блок для каждого агента
2. Логирование ошибок
3. Retry механизм (3 попытки)
4. Fallback на альтернативные агенты
5. Уведомление об ошибках
```

### Продвинутая обработка

```
Настрой продвинутую обработку ошибок:

- Retry с экспоненциальной задержкой
- Circuit breaker (отключение неработающих агентов)
- Компенсационные транзакции (rollback)
- Мониторинг и алерты
```

## Шаг 6: Мониторинг и логирование

### Логирование действий оркестратора

```
Добавь логирование в оркестратор:
- Время начала выполнения
- Статус каждого агента
- Время выполнения каждого шага
- Результаты и ошибки
- Общее время выполнения
```

### Метрики производительности

```
Настрой сбор метрик:
- Количество успешных/неуспешных выполнений
- Среднее время выполнения
- Использование ресурсов агентами
- Задержки между агентами
```

## Шаг 7: Оптимизация оркестратора

### Кэширование результатов

```
Добавь кэширование в оркестратор:
- Кэширование результатов агентов
- Проверка кэша перед запуском агента
- Инвалидация кэша при обновлении данных
```

### Приоритизация задач

```
Настрой приоритизацию:
- Очередь задач с приоритетами
- Обработка высокоприоритетных задач первыми
- Распределение нагрузки между агентами
```

## Шаг 8: Примеры команд для Cursor

### Создание оркестратора

```
Создай оркестратор для [задача] с агентами: [список агентов]
```

### Настройка параллельного выполнения

```
Настрой оркестратор ID 123 для параллельного выполнения агентов A, B, C
```

### Добавление обработки ошибок

```
Добавь обработку ошибок в оркестратор ID 123:
- Retry 3 раза с задержкой 5 секунд
- Логирование всех ошибок
- Уведомление при критических ошибках
```

### Оптимизация производительности

```
Оптимизируй оркестратор ID 123:
- Добавь кэширование результатов агентов
- Настрой параллельное выполнение где возможно
- Добавь метрики производительности
```

## Шаблон оркестратора

Создайте файл с шаблоном для быстрого создания оркестраторов:

```
Используй этот шаблон для создания оркестратора:

1. Webhook Trigger
2. AI Analysis Node (анализ задачи)
3. Code Node (создание плана)
4. Loop Node (выполнение подзадач)
   - HTTP Request к агентам
   - Обработка ответов
5. Code Node (сбор результатов)
6. Response Node
```

## Лучшие практики

1. **Разделение ответственности**: Оркестратор только координирует, агенты выполняют
2. **Идемпотентность**: Повторные запуски не должны создавать дубликаты
3. **Мониторинг**: Всегда логируйте действия оркестратора
4. **Тестирование**: Тестируйте на простых задачах перед продакшеном
5. **Масштабируемость**: Проектируйте с учетом роста нагрузки

## Следующие шаги

- [N8N_AGENTS_SETUP.md](N8N_AGENTS_SETUP.md) - Настройка агентов
- [MCP_SETUP.md](MCP_SETUP.md) - Настройка MCP для Cursor

## Полезные команды

```
- "Создай оркестратор для [задача]"
- "Оптимизируй оркестратор [ID]"
- "Добавь обработку ошибок в оркестратор [ID]"
- "Покажи структуру оркестратора [ID]"
- "Настрой параллельное выполнение в оркестраторе [ID]"
```

